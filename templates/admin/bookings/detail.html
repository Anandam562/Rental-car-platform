<!-- templates/admin/bookings/detail.html -->
{% extends "admin/base.html" %}

{% block title %}Booking #{{ booking.id }} Details{% endblock %}
{% block page_title %}Booking Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-receipt"></i> Booking #{{ booking.id }}</h5>
            </div>
            <div class="card-body">
                <!-- Booking Status -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Status</h6>
                        <span class="badge bg-{% if booking.status == 'completed' %}success
                                            {% elif booking.status == 'active' %}info
                                            {% elif booking.status == 'paid' %}primary
                                            {% elif booking.status == 'approved' %}secondary
                                            {% elif booking.status == 'pending' %}warning
                                            {% elif booking.status == 'cancelled' %}danger
                                            {% else %}light{% endif %}">
                            {{ booking.status|title }}
                        </span>
                    </div>
                    {% if booking.cancelled_by %}
                    <div class="mt-2">
                        <small class="text-muted">
                            Cancelled by: <strong>{{ booking.cancelled_by|title }}</strong>
                            {% if booking.cancelled_at %}on {{ booking.cancelled_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
                        </small>
                        {% if booking.cancellation_reason %}
                        <br><small class="text-muted">Reason: {{ booking.cancellation_reason }}</small>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Car & User Details -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Car Details</h6>
                        <p><strong>{{ booking.car.make }} {{ booking.car.model }}</strong> ({{ booking.car.year }})</p>
                        <p>{{ booking.car.transmission }} • {{ booking.car.fuel_type }} • {{ booking.car.seats }} seats</p>
                        <p>Color: {{ booking.car.color or 'N/A' }}</p>
                        <p>Mileage: {{ booking.car.mileage or 'N/A' }} km</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Customer Details</h6>
                        <p><strong>{{ booking.user.username }}</strong></p>
                        <p>Email: {{ booking.user.email }}</p>
                        <p>Phone: {{ booking.user.phone or 'N/A' }}</p>
                    </div>
                </div>

                <!-- Rental Period -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Rental Period</h6>
                        <p><i class="fas fa-calendar-start"></i> Start: {{ booking.start_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><i class="fas fa-calendar-end"></i> End: {{ booking.end_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><i class="fas fa-clock"></i> Duration: {{ booking.duration_days }} days</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Location</h6>
                        <p><i class="fas fa-map-marker-alt"></i>
                            {% if booking.car.full_address %}
                                {{ booking.car.full_address }}
                            {% else %}
                                {% if booking.car.street_address %}{{ booking.car.street_address }}, {% endif %}
                                {% if booking.car.locality %}{{ booking.car.locality }}, {% endif %}
                                {% if booking.car.city %}{{ booking.car.city }}{% endif %}
                                {% if booking.car.state %}, {{ booking.car.state }}{% endif %}
                                {% if booking.car.pincode %} - {{ booking.car.pincode }}{% endif %}
                            {% endif %}
                        </p>
                        {% if booking.car.latitude and booking.car.longitude %}
                        <div class="mt-2 text-xs text-gray-500">
                            Coordinates: {{ "%.6f"|format(booking.car.latitude) }}, {{ "%.6f"|format(booking.car.longitude) }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Financial Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Financial Summary</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td><strong>Total Amount:</strong></td>
                                        <td class="text-end">₹{{ "%.2f"|format(booking.total_price) }}</td>
                                    </tr>
                                    {% if booking.cancellation_fee_deducted > 0 %}
                                    <tr>
                                        <td><strong>Cancellation Fee (50%):</strong></td>
                                        <td class="text-end text-danger">-₹{{ "%.2f"|format(booking.cancellation_fee_deducted) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.refund_amount > 0 %}
                                    <tr>
                                        <td><strong>Refund Amount:</strong></td>
                                        <td class="text-end text-success">₹{{ "%.2f"|format(booking.refund_amount) }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr class="table-light">
                                        <td><strong>Net Amount:</strong></td>
                                        <td class="text-end">
                                            <strong>
                                                ₹{{ "%.2f"|format(booking.total_price - booking.cancellation_fee_deducted + booking.refund_amount) }}
                                            </strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Transaction Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Transaction Details</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>Payment Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.payment_status == 'completed' %}success
                                                                {% elif booking.payment_status == 'pending' %}warning
                                                                {% elif booking.payment_status == 'failed' %}danger
                                                                {% elif booking.payment_status == 'refunded' %}secondary
                                                                {% else %}light{% endif %}">
                                                {{ booking.payment_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% if booking.payment_date %}
                                    <tr>
                                        <td>Payment Date:</td>
                                        <td class="text-end">{{ booking.payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.razorpay_payment_id %}
                                    <tr>
                                        <td>Razorpay Payment ID:</td>
                                        <td class="text-end">{{ booking.razorpay_payment_id }}</td>
                                    </tr>
                                    {% endif %}
                                    <!-- Add more transaction details as needed -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Extension Details (if applicable) -->
                {% if booking.has_extension_request %}
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Extension Request</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>New End Date:</td>
                                        <td class="text-end">{{ booking.extension_new_end_date.strftime('%Y-%m-%d') }}</td>
                                    </tr>
                                    <tr>
                                        <td>Additional Days:</td>
                                        <td class="text-end">{{ booking.extension_additional_days }}</td>
                                    </tr>
                                    <tr>
                                        <td>Additional Price:</td>
                                        <td class="text-end">₹{{ "%.2f"|format(booking.extension_additional_price) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Extension Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.extension_status == 'approved' %}success
                                                                {% elif booking.extension_status == 'requested' %}warning
                                                                {% elif booking.extension_status == 'cancelled' %}danger
                                                                {% else %}light{% endif %}">
                                                {{ booking.extension_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Extension Payment Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.extension_payment_status == 'completed' %}success
                                                                {% elif booking.extension_payment_status == 'pending' %}warning
                                                                {% elif booking.extension_payment_status == 'failed' %}danger
                                                                {% elif booking.extension_payment_status == 'refunded' %}secondary
                                                                {% else %}light{% endif %}">
                                                {{ booking.extension_payment_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% if booking.extension_payment_date %}
                                    <tr>
                                        <td>Extension Payment Date:</td>
                                        <td class="text-end">{{ booking.extension_payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.extension_razorpay_payment_id %}
                                    <tr>
                                        <td>Extension Razorpay Payment ID:</td>
                                        <td class="text-end">{{ booking.extension_razorpay_payment_id }}</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Extension Actions -->
                        {% if booking.extension_status == 'requested' %}
                        <div class="mt-2">
                            <form method="POST" action="{{ url_for('admin.approve_extension', booking_id=booking.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Approve this extension request?')">
                                    <i class="fas fa-check"></i> Approve Extension
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('admin.reject_extension', booking_id=booking.id) }}" class="d-inline ms-2">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Reject this extension request?')">
                                    <i class="fas fa-times"></i> Reject Extension
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        <!-- End Extension Actions -->
                    </div>
                </div>
                {% endif %}
                <!-- End Extension Details -->

            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Admin Actions</h5>
            </div>
            <div class="card-body">
                {% if booking.can_be_approved() %}
                <form method="POST" action="{{ url_for('admin.approve_booking', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-success w-100" onclick="return confirm('Approve this booking request?')">
                        <i class="fas fa-check-circle"></i> Approve Booking
                    </button>
                </form>
                {% elif booking.status == 'approved' and booking.payment_status == 'pending' %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Waiting for customer to complete payment.
                </div>
                {% elif booking.payment_status == 'completed' and not booking.is_active %}
                <form method="POST" action="{{ url_for('admin.mark_booking_paid', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-hand-holding-usd"></i> Mark as Paid (Confirm Receipt)
                    </button>
                </form>
                {% elif booking.is_active and not booking.is_completed %}
                <form method="POST" action="{{ url_for('admin.complete_booking_trip', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-info w-100" onclick="return confirm('Mark this trip as completed?')">
                        <i class="fas fa-flag-checkered"></i> Complete Trip
                    </button>
                </form>
                {% elif booking.is_completed %}
                <button class="btn btn-secondary w-100" disabled>
                    <i class="fas fa-check-double"></i> Trip Completed
                </button>
                {% elif booking.status == 'cancelled' %}
                <button class="btn btn-danger w-100" disabled>
                    <i class="fas fa-ban"></i> Booking Cancelled
                </button>
                {% else %}
                <div class="alert alert-secondary">
                    <i class="fas fa-info-circle"></i> No actions available at this time.
                </div>
                {% endif %}

                {% if booking.status not in ['completed', 'cancelled'] %}
                <hr class="my-3">
                <form method="POST" action="{{ url_for('admin.cancel_booking', booking_id=booking.id) }}" class="d-grid gap-2">
                    <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Cancel this booking? This action cannot be undone.')">
                        <i class="fas fa-times-circle"></i> Cancel Booking
                    </button>
                </form>
                {% endif %}

                <hr class="my-3">
                <a href="{{ url_for('admin.list_bookings') }}" class="btn btn-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Back to Bookings
                </a>
            </div>
        </div>

        <!-- Car Images -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images"></i> Car Images</h5>
            </div>
            <div class="card-body">
                {% if booking.car.images %}
                    <div id="carImageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for image in booking.car.images %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                     class="d-block w-100" alt="{{ booking.car.make }} {{ booking.car.model }} Image {{ loop.index }}"
                                     style="height: 200px; object-fit: cover;">
                            </div>
                            {% endfor %}
                        </div>
                        {% if booking.car.images|length > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-image fa-3x"></i>
                        <p>No images available for this car.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
