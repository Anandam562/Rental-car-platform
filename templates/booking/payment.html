<!-- templates/booking/payment.html -->
{% extends "base.html" %}

{% block title %}Payment for Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
        <div class="bg-primary text-white p-5">
            <h1 class="text-2xl font-bold"><i class="fas fa-credit-card mr-2"></i>Secure Payment</h1>
            <p class="text-blue-100">Complete your booking for {{ booking.car.make }} {{ booking.car.model }}</p>
        </div>

        <div class="p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-car text-primary"></i> Car Details
                    </h3>
                    <p class="font-medium">{{ booking.car.make }} {{ booking.car.model }} ({{ booking.car.year }})</p>
                    <p class="text-sm text-gray-600">{{ booking.car.transmission }} • {{ booking.car.fuel_type }}</p>
                </div>
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary"></i> Rental Period
                    </h3>
                    <p class="text-sm"><strong>{{ booking.start_date.strftime('%Y-%m-%d') }}</strong> to <strong>{{ booking.end_date.strftime('%Y-%m-%d') }}</strong></p>
                    <p class="text-sm text-gray-600">{{ booking.duration_days }} days</p>
                </div>
            </div>

            <div class="border rounded-xl p-4 mb-6 bg-blue-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">Total Amount:</span>
                    <span class="text-xl font-bold text-primary">₹{{ "%.2f"|format(total_amount_rupees) }}</span>
                </div>
                <p class="text-xs text-gray-600">This amount will be charged to your payment method.</p>
            </div>

            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-primary"></i> Payment Method
                </h3>
                <div class="text-center py-4">
                    <i class="fas fa-lock text-2xl text-green-500 mb-2"></i>
                    <p class="text-sm text-gray-600 mb-3">Powered by <strong>Razorpay</strong>. Your payment is secured with 128-bit SSL encryption.</p>
                    <button id="rzp-button1" class="bg-primary text-white rounded-xl px-6 py-3 font-medium hover:bg-blue-600 transition-colors">
                        <i class="fas fa-rupee-sign mr-1"></i> Pay ₹{{ "%.2f"|format(total_amount_rupees) }}
                    </button>
                </div>
            </div>

            <div class="text-center text-xs text-gray-500">
                <p>By proceeding, you agree to our <a href="#" class="text-primary hover:underline">Terms of Service</a> and <a href="#" class="text-primary hover:underline">Privacy Policy</a>.</p>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if Razorpay key and order ID are available
    const razorpayKeyId = "{{ razorpay_key_id }}";
    const razorpayOrderId = "{{ razorpay_order_id }}";
    const totalAmountPaise = {{ total_amount_paise }};
    const totalAmountRupees = {{ total_amount_rupees }};
    const bookingId = {{ booking.id }};
    const carMakeModel = "{{ booking.car.make }} {{ booking.car.model }}";

    if (!razorpayKeyId || !razorpayOrderId || !totalAmountPaise) {
        console.error("Razorpay configuration missing.");
        alert("Payment configuration error. Please try again.");
        // window.location.href = "{{ url_for('car.home') }}"; // Redirect on error
        return;
    }

    const options = {
        "key": razorpayKeyId, // Enter the Key ID generated from the Dashboard
        "amount": totalAmountPaise, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "ZoomCar Clone",
        "description": `Booking for ${carMakeModel}`,
        "image": "https://example.com/your_logo.png", // Add your logo URL
        "order_id": razorpayOrderId, // This is a sample Order ID. Pass the `id` obtained in the previous step
        "handler": function (response){
            // This function executes after payment is successful
            // Send payment details to your server for verification
            const paymentData = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
            };

            // Submit payment data to your backend for verification
            // We'll create a simple form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("booking.handle_payment") }}'; // Your backend verification endpoint

            for (const key in paymentData) {
                if (paymentData.hasOwnProperty(key)) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = key;
                    hiddenField.value = paymentData[key];
                    form.appendChild(hiddenField);
                }
            }

            document.body.appendChild(form);
            form.submit();
        },
        "prefill": {
            "name": "{{ current_user.username }}", // Prefill user's name
            "email": "{{ current_user.email }}", // Prefill user's email
            // "contact": "" // Prefill user's contact number if available
        },
        "notes": {
            "booking_id": bookingId,
            "car": carMakeModel
        },
        "theme": {
            "color": "#00b4d8" // Primary color
        }
    };

    const rzp1 = new Razorpay(options);

    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    };

    // Handle payment failure or closure
    rzp1.on('payment.failed', function (response){
        alert(`Payment failed: ${response.error.description}`);
        console.log(response.error);
        // You can redirect to a failure page or show an error message
        // window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
    });
});
</script>
{% endblock %}