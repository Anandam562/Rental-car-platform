{% extends "base.html" %}

{% block title %}Complete Payment for Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0"><i class="fas fa-credit-card"></i> Secure Payment</h4>
                    <p class="mb-0">Complete your booking for {{ booking.car.make }} {{ booking.car.model }}</p>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-lock fa-3x text-success mb-3"></i>
                        <h5>Redirecting to secure payment gateway...</h5>
                        <p class="text-muted">Please wait while we process your payment.</p>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            Booking ID: #{{ booking.id }}<br>
                            Amount: <strong>â‚¹{{ "%.2f"|format(booking.total_price) }}</strong>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- templates/user/bookings/razorpaycheckout.html (Relevant part - Razorpay handler) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Razorpay Configuration ---
    const razorpayKeyId = "{{ razorpay_key_id }}";
    const razorpayOrderId = "{{ razorpay_order_id }}";
    const totalAmountPaise = {{ total_amount_paise }};
    const totalAmountRupees = {{ total_amount_rupees }};
    const bookingId = {{ booking.id }};
    const carMakeModel = "{{ booking.car.make }} {{ booking.car.model }}";

    if (!razorpayKeyId || !razorpayOrderId || !totalAmountPaise) {
        console.error("Razorpay configuration missing.");
        alert("Payment configuration error. Please try again.");
        window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}"; // Fallback redirect
        return;
    }
    // --- End Configuration ---

    // --- Razorpay Options ---
    const options = {
        "key": razorpayKeyId,
        "amount": totalAmountPaise,
        "currency": "INR",
        "name": "ZoomCar Clone",
        "description": `Booking for ${carMakeModel} (#${bookingId})`,
        // "image": "https://example.com/your_logo.png", // Add your logo URL if available
        "order_id": razorpayOrderId,
        "handler": function (response){
            // This function executes after payment is successful
            console.log("Razorpay Payment Response:", response);
            // Send payment details to your backend for verification
            const paymentData = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
            };

            // --- CRITICAL FIX: Use fetch for AJAX verification ---
            // Submit payment data to your backend verification endpoint
            fetch('{{ url_for("booking.handle_payment") }}', { // <-- Correct backend endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Include CSRF token if you are using Flask-WTF CSRF protection
                    // 'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(paymentData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // --- CRITICAL FIX: Redirect to correct endpoint ---
                    // BEFORE (Incorrect - booking.payment_success doesn't exist)
                    // window.location.href = "{{ url_for('booking.payment_success', booking_id=booking.id) }}";

                    // AFTER (Corrected - Redirect to booking detail page)
                    window.location.href = data.redirect_url; // Use URL from backend response
                    // OR, if backend doesn't provide redirect_url:
                    // window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
                    // --- END CRITICAL FIX ---
                } else {
                    // Handle verification failure
                    alert(data.message || "Payment verification failed. Please contact support.");
                    window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
                }
            })
            .catch(error => {
                console.error('Payment verification error:', error);
                alert("An error occurred during payment verification. Please check your booking status.");
                window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
            });
        },
        "prefill": {
            "name": "{{ current_user.username }}",
            "email": "{{ current_user.email }}",
            // "contact": "{{ current_user.phone }}" // Prefill user's contact number if available
        },
        "notes": {
            "booking_id": bookingId,
            "car": carMakeModel
        },
        "theme": {
            "color": "#00b4d8" // Primary color from your theme
        },
        "modal": {
            "ondismiss": function(){
                // Handle case where user closes the Razorpay popup without paying
                console.log("Razorpay Popup closed by user.");
                alert("Payment was not completed. You can resume payment from the booking details page.");
                window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
            }
        }
    };
    // --- End Options ---

    // --- Initialize and Open Razorpay Checkout ---
    const rzp1 = new Razorpay(options);

    // Open the checkout form automatically
    rzp1.open();
    // --- End Initialization ---
});
</script>
{% endblock %}
