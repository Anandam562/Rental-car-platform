Project Root (C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars)
│
├── New Text Document.bat (Likely Junk)
├── __pycache__
├── app.py (Main Flask Application - Note: Had reading error due to encoding)
├── codeToNotepad.py (Scanning Script)
├── code_files.txt (Output of Scanning Script)
├── config.py
├── controllers
│   ├── __init__.py
│   ├── auth_controller.py
│   ├── booking_controller.py
│   ├── car_controller.py
│   ├── host
│   │   ├── __init__.py
│   │   ├── analytics.py
│   │   └── car_manager.py
│   ├── search_controller.py
│   └── user
│       ├── __init__.py
│       └── booking_manager.py
├── forms
│   ├── __init__.py
│   ├── __pycache__
│   ├── admin.py
│   └── user.py
├── init_data.py
├── list.txt
├── models
│   ├── __init__.py
│   ├── __pycache__
│   ├── admin.py
│   ├── api.py
│   ├── booking.py
│   ├── car.py
│   ├── car_image.py
│   ├── complaint.py
│   ├── document.py
│   ├── feedback.py
│   ├── host.py
│   ├── location.py
│   ├── photo.py
│   ├── rating.py
│   ├── trip_photo.py
│   ├── user.py
│   └── wallet_transaction.py
├── models.py
├── requirements.txt
├── routes
│   ├── New Text Document.bat (Likely Junk)
│   ├── New Text Document.txt (Likely Junk)
│   ├── __pycache__
│   ├── admin
│   │   ├── __init__.py
│   │   ├── __pycache__
│   │   ├── admins.py
│   │   ├── auth.py
│   │   ├── bookings.py
│   │   ├── cars.py
│   │   ├── dashboard.py
│   │   ├── documents.py
│   │   ├── hosts.py
│   │   ├── transactions.py
│   │   └── users.py
│   ├── api.py
│   ├── auth.py
│   ├── booking.py
│   ├── car.py
│   ├── host
│   │   ├── __init__.py
│   │   ├── __pycache__
│   │   ├── analytics.py
│   │   ├── auth.py
│   │   ├── bookings.py
│   │   ├── cars.py
│   │   ├── dashboard.py
│   │   ├── payments.py
│   │   └── profile.py
│   ├── payment.py
│   ├── some_bp.py
│   └── user
│       ├── __init__.py
│       ├── __pycache__
│       ├── bookings.py
│       ├── dashboard.py
│       ├── filters
│       │   ├── __init__.py
│       │   ├── __pycache__
│       │   ├── base.py
│       │   ├── brand.py
│       │   ├── car_type.py
│       │   ├── delivery_type.py
│       │   ├── distance.py
│       │   ├── features.py
│       │   ├── filters.py
│       │   ├── fuel_type.py
│       │   ├── model_year.py
│       │   ├── price_range.py
│       │   ├── seating_capacity.py
│       │   ├── some_filter.py
│       │   └── transmission.py
│       ├── notifications.py
│       ├── profile.py
│       └── wallet.py
├── static
│   ├── css
│   │   ├── dashboard.css
│   │   ├── host.css
│   │   ├── style.css
│   │   └── user.css
│   ├── images
│   ├── js
│   │   ├── host.js
│   │   └── main.js
│   ├── style.css
│   └── uploads
├── templates
│   ├── New Text Document.txt (Likely Junk)
│   ├── admin
│   │   ├── admins
│   │   │   └── list.html
│   │   ├── base.html
│   │   ├── bookings
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── cars
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── dashboard.html
│   │   ├── documents
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── hosts
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── login.html (Note: Had reading error due to encoding)
│   │   ├── register.html (Note: Had reading error due to encoding)
│   │   ├── transactions
│   │   │   └── list.html
│   │   └── users
│   │       ├── detail.html
│   │       └── list.html
│   ├── base.html
│   ├── booking
│   │   ├── initiate.html
│   │   ├── payment.html
│   │   └── razorpay_checkout.html
│   ├── booking.html
│   ├── booking_confirmation.html
│   ├── car_detail.html
│   ├── car_list.html
│   ├── dashboard.html
│   ├── directory structre but not same as it.tct
│   ├── edit_car.html
│   ├── home.html
│   ├── host
│   │   ├── analytics
│   │   │   ├── feedbacks.html
│   │   │   └── ratings.html
│   │   ├── base.html
│   │   ├── bookings
│   │   │   └── detail.html
│   │   ├── cars
│   │   │   ├── add.html
│   │   │   ├── detail.html
│   │   │   ├── edit.html
│   │   │   ├── list.html
│   │   │   └── partials
│   │   │       ├── location_input_js.html
│   │   │       └── location_input_section.html
│   │   ├── dashboard.html
│   │   ├── login.html (Note: Had reading error due to encoding)
│   │   ├── payments
│   │   │   └── list.html
│   │   ├── profile
│   │   │   └── wallet.html
│   │   └── register.html (Note: Had reading error due to encoding)
│   ├── index.html
│   ├── login.html (Note: Had reading error due to encoding)
│   ├── my_bookings.html
│   ├── payment
│   │   └── checkout.html
│   ├── register.html (Note: Had reading error due to encoding)
│   └── user
│       ├── base.html
│       ├── bookings
│       │   ├── complete_trip.html
│       │   ├── detail.html
│       │   ├── list.html
│       │   ├── payment.html
│       │   ├── razorpaycheckout.html
│       │   └── start_trip.html
│       ├── dashboard.html
│       ├── filter
│       │   ├── car_list.html
│       │   ├── filters_sidebar.html
│       │   └── list.html
│       ├── notifications
│       │   └── list.html
│       ├── profile
│       │   ├── edit.html
│       │   └── view.html
│       └── wallet
│           ├── dashboard_widget.html
│           ├── detail.html
│           └── list.html
├── uploads
└── utils
    ├── __init__.py
    ├── __pycache__
    ├── date_utils.py
    ├── distance_calculator.py
    ├── notification_sender.py
    ├── timezone.py
    └── validators.py

============================================================
File Contents
============================================================


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\app.py ---
import os

from apscheduler.schedulers.background import BackgroundScheduler
from flask import Flask
from flask_login import LoginManager
from flask_wtf.csrf import CSRFProtect  # ✅
# from flask_wtf.csrf import CSRFProtect
from models.admin import Admin

from config import Config

# Import db first
from models import db

# Import models in correct order to resolve dependencies
from models.location import Location
from models.user import User
from models.car import Car
from models.car_image import CarImage
from models.booking import Booking

from models import db

# Import models in an order that resolves dependencies or import them all at once
# The key is they are all imported before db.create_all()
# Importing the main classes is usually sufficient, as relationships often use strings.
from models.location import Location
from models.user import User
# Import Host before Car if Car references Host via backref (like we are doing now)
# Or ensure both are imported before relationships are configured.
from models.host import Host, HostRating, HostFeedback # Import Host and related first
from models.car import Car # Then Car
from models.car_image import CarImage
from models.booking import Booking
from models.photo import Photo
from models.rating import Rating
from models.feedback import Feedback
from models.complaint import Complaint

# Import routes
from routes.auth import auth_bp
from routes.car import car_bp
from routes.booking import booking_bp
from routes.api import api_bp
from routes.host import host_bp # <-- CRUCIAL: Import the host blueprint
from routes.user import user_bp

# --- NEW IMPORTS ---
from routes.user import user_bp # If you have a separate user blueprint
from routes.payment import payment_bp
from routes.admin import admin_bp
# --- END NEW IMPORTS ---



def create_app():
    app = Flask(__name__)
    app.config.from_object(Config)

    # AFTER (Initialize CSRF with app)
    csrf = CSRFProtect(app)  # <-- Initialize CSRF protection with the app instance
    # --- END CRITICAL FIX 3 ---
    
    # Initialize extensions
    db.init_app(app)
    csrf.init_app(app)
    login_manager = LoginManager()
    login_manager.init_app(app)
    login_manager.login_view = 'auth.login'  # Default login for users/hosts

    @login_manager.user_loader
    def load_user(user_id):
        """
        Load a user by ID for Flask-Login.
        Uses Session.get() as recommended in SQLAlchemy 2.0.
        """
        try:
            # --- CRITICAL FIX 4: Use Session.get() instead of Query.get() ---
            # BEFORE (Legacy - causes warning)
            # return User.query.get(int(user_id))

            # AFTER (Modern - resolves warning)
            # Try to load as User first (most common)
            user = db.session.get(User, int(user_id))  # <-- Use Session.get()
            if user and user.is_active:
                return user

            # If not found as User, try Admin
            admin = db.session.get(Admin, int(user_id))  # <-- Use Session.get()
            if admin and admin.is_active:
                return admin

            # If not found as Admin, try Host (linked to User)
            # host = db.session.get(Host, int(user_id)) # <-- Use Session.get() if Host is a UserMixin
            # if host and host.user and host.user.is_active:
            #     return host.user # Return the associated User object for Hosts
            # OR, if Host model itself inherits UserMixin:
            # host = db.session.get(Host, int(user_id)) # <-- Use Session.get()
            # if host and host.is_active:
            #     return host # Return the Host object directly

            # User/Admin/Host not found or inactive
            return None
            # --- END CRITICAL FIX 4 ---
        except (ValueError, TypeError):
            # Handle invalid user_id (e.g., not an integer)
            return None

    # --- END CRITICAL FIX 5 ---
    # ... other initializations ..

    # Create uploads directory
    if not os.path.exists(app.config['UPLOAD_FOLDER']):
        os.makedirs(app.config['UPLOAD_FOLDER'])

    # Register blueprints
    app.register_blueprint(auth_bp, url_prefix='/auth')
    app.register_blueprint(car_bp)
    app.register_blueprint(booking_bp)
    # app.register_blueprint(booking_bp, url_prefix='/booking')
    app.register_blueprint(api_bp, url_prefix='/api')
    app.register_blueprint(host_bp, url_prefix='/host')
    app.register_blueprint(user_bp, url_prefix='/user')
    # --- NEW REGISTRATIONS ---
    app.register_blueprint(payment_bp, url_prefix='/payment')
    app.register_blueprint(admin_bp, url_prefix='/admin')
    # --- END NEW REGISTRATIONS ---

    # scheduler = BackgroundScheduler()
    # scheduler.add_job(func=Booking.auto_cancel_unapproved, trigger="interval", hours=1)  # Run every hour
    # scheduler.start()
    # app.register_blueprint(host_bp, url_prefix='/host')  # <-- CRUCIAL: Register the host blueprint

    return app


app = create_app()

# Create tables
with app.app_context():
    # db.session.execute(db.text('SET FOREIGN_KEY_CHECKS=0;'))
    # db.drop_all()
    # db.session.execute(db.text('SET FOREIGN_KEY_CHECKS=1;'))
    db.create_all()
    # --- CRITICAL FIX 8: Create Default Admin ---
    from models.admin import create_default_admin

    create_default_admin()
    # --- END CRITICAL FIX 8 ---

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\codeToNotepad.py ---
import os

# Annotations for special files
ANNOTATIONS = {
    "New Text Document": "(Likely Junk)",
    "login.html": "(Note: Had reading error due to encoding)",
    "register.html": "(Note: Had reading error due to encoding)",
    "codeToNotepad.py": "(Scanning Script)",
    "code_files.txt": "(Output of Scanning Script)",
    "app.py": "(Main Flask Application - Note: Had reading error due to encoding)"
}

# Exclude exactly these files or folders by name
EXCLUDED_NAMES = {'.idea'}
# Exclude files with these extensions (binary + pyc)
EXCLUDED_EXTENSIONS = {
    '.pyc', '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff',
    '.ico', '.pdf', '.exe', '.dll', '.so', '.zip', '.tar', '.gz', '.7z', '.rar'
}


def annotate(filename):
    """Add annotation based on known patterns."""
    for key, note in ANNOTATIONS.items():
        if key in filename:
            return f"{filename} {note}"
    return filename


def generate_tree(path, prefix=""):
    """Generate directory tree lines with arrow symbols."""
    try:
        entries = sorted(os.listdir(path))
    except PermissionError:
        return []  # Skip folders we can't open

    # Exclude hidden files/folders starting with '.', also exclude '.idea' folder and excluded file extensions
    entries = [
        e for e in entries
        if not e.startswith('.') and e not in EXCLUDED_NAMES and not e.endswith(tuple(EXCLUDED_EXTENSIONS))
    ]

    tree_lines = []

    for index, entry in enumerate(entries):
        full_path = os.path.join(path, entry)
        is_last = index == len(entries) - 1
        connector = "└── " if is_last else "├── "

        display_name = annotate(entry)
        tree_lines.append(f"{prefix}{connector}{display_name}")

        if os.path.isdir(full_path):
            new_prefix = prefix + ("    " if is_last else "│   ")
            tree_lines.extend(generate_tree(full_path, new_prefix))

    return tree_lines


def write_code_to_notepad(directory, output_file="code_files.txt"):
    with open(output_file, "w", encoding="utf-8") as f:
        # Write directory tree
        f.write(f"Project Root ({directory})\n")
        f.write("│\n")
        tree = generate_tree(directory)
        f.write("\n".join(tree))
        f.write("\n\n" + "=" * 60 + "\n")
        f.write("File Contents\n")
        f.write("=" * 60 + "\n\n")

        # Walk directory excluding unwanted folders and binary files
        for root, dirs, files in os.walk(directory):
            # Remove excluded folders (like '.idea') so walk skips them completely
            dirs[:] = [d for d in dirs if d not in EXCLUDED_NAMES and not d.startswith('.')]

            for file in files:
                # Skip excluded files (.pyc, images, binaries, hidden)
                if (file in EXCLUDED_NAMES or
                        file.startswith('.') or
                        file.endswith(tuple(EXCLUDED_EXTENSIONS))):
                    continue

                file_path = os.path.join(root, file)
                if os.path.isfile(file_path):
                    f.write(f"\n--- File: {file_path} ---\n")
                    try:
                        with open(file_path, 'r', encoding='utf-8', errors='ignore') as code_file:
                            content = code_file.read()
                            f.write(content + "\n")
                    except Exception as e:
                        f.write(f"Could not read {file_path}: {e}\n")

    print(f"✅ Directory tree and files written to '{output_file}'.")


# Set your project directory here
project_path = r"C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars"
write_code_to_notepad(project_path)


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\code_files.txt ---
Project Root (C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars)
│
├── New Text Document.bat (Likely Junk)
├── __pycache__
├── app.py (Main Flask Application - Note: Had reading error due to encoding)
├── codeToNotepad.py (Scanning Script)
├── code_files.txt (Output of Scanning Script)
├── config.py
├── controllers
│   ├── __init__.py
│   ├── auth_controller.py
│   ├── booking_controller.py
│   ├── car_controller.py
│   ├── host
│   │   ├── __init__.py
│   │   ├── analytics.py
│   │   └── car_manager.py
│   ├── search_controller.py
│   └── user
│       ├── __init__.py
│       └── booking_manager.py
├── forms
│   ├── __init__.py
│   ├── __pycache__
│   ├── admin.py
│   └── user.py
├── init_data.py
├── list.txt
├── models
│   ├── __init__.py
│   ├── __pycache__
│   ├── admin.py
│   ├── api.py
│   ├── booking.py
│   ├── car.py
│   ├── car_image.py
│   ├── complaint.py
│   ├── document.py
│   ├── feedback.py
│   ├── host.py
│   ├── location.py
│   ├── photo.py
│   ├── rating.py
│   ├── trip_photo.py
│   ├── user.py
│   └── wallet_transaction.py
├── models.py
├── requirements.txt
├── routes
│   ├── New Text Document.bat (Likely Junk)
│   ├── New Text Document.txt (Likely Junk)
│   ├── __pycache__
│   ├── admin
│   │   ├── __init__.py
│   │   ├── __pycache__
│   │   ├── admins.py
│   │   ├── auth.py
│   │   ├── bookings.py
│   │   ├── cars.py
│   │   ├── dashboard.py
│   │   ├── documents.py
│   │   ├── hosts.py
│   │   ├── transactions.py
│   │   └── users.py
│   ├── api.py
│   ├── auth.py
│   ├── booking.py
│   ├── car.py
│   ├── host
│   │   ├── __init__.py
│   │   ├── __pycache__
│   │   ├── analytics.py
│   │   ├── auth.py
│   │   ├── bookings.py
│   │   ├── cars.py
│   │   ├── dashboard.py
│   │   ├── payments.py
│   │   └── profile.py
│   ├── payment.py
│   ├── some_bp.py
│   └── user
│       ├── __init__.py
│       ├── __pycache__
│       ├── bookings.py
│       ├── dashboard.py
│       ├── filters
│       │   ├── __init__.py
│       │   ├── __pycache__
│       │   ├── base.py
│       │   ├── brand.py
│       │   ├── car_type.py
│       │   ├── delivery_type.py
│       │   ├── distance.py
│       │   ├── features.py
│       │   ├── filters.py
│       │   ├── fuel_type.py
│       │   ├── model_year.py
│       │   ├── price_range.py
│       │   ├── seating_capacity.py
│       │   ├── some_filter.py
│       │   └── transmission.py
│       ├── notifications.py
│       ├── profile.py
│       └── wallet.py
├── static
│   ├── css
│   │   ├── dashboard.css
│   │   ├── host.css
│   │   ├── style.css
│   │   └── user.css
│   ├── images
│   ├── js
│   │   ├── host.js
│   │   └── main.js
│   ├── style.css
│   └── uploads
├── templates
│   ├── New Text Document.txt (Likely Junk)
│   ├── admin
│   │   ├── admins
│   │   │   └── list.html
│   │   ├── base.html
│   │   ├── bookings
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── cars
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── dashboard.html
│   │   ├── documents
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── hosts
│   │   │   ├── detail.html
│   │   │   └── list.html
│   │   ├── login.html (Note: Had reading error due to encoding)
│   │   ├── register.html (Note: Had reading error due to encoding)
│   │   ├── transactions
│   │   │   └── list.html
│   │   └── users
│   │       ├── detail.html
│   │       └── list.html
│   ├── base.html
│   ├── booking
│   │   ├── initiate.html
│   │   ├── payment.html
│   │   └── razorpay_checkout.html
│   ├── booking.html
│   ├── booking_confirmation.html
│   ├── car_detail.html
│   ├── car_list.html
│   ├── dashboard.html
│   ├── directory structre but not same as it.tct
│   ├── edit_car.html
│   ├── home.html
│   ├── host
│   │   ├── analytics
│   │   │   ├── feedbacks.html
│   │   │   └── ratings.html
│   │   ├── base.html
│   │   ├── bookings
│   │   │   └── detail.html
│   │   ├── cars
│   │   │   ├── add.html
│   │   │   ├── detail.html
│   │   │   ├── edit.html
│   │   │   ├── list.html
│   │   │   └── partials
│   │   │       ├── location_input_js.html
│   │   │       └── location_input_section.html
│   │   ├── dashboard.html
│   │   ├── login.html (Note: Had reading error due to encoding)
│   │   ├── payments
│   │   │   └── list.html
│   │   ├── profile
│   │   │   └── wallet.html
│   │   └── register.html (Note: Had reading error due to encoding)
│   ├── index.html
│   ├── login.html (Note: Had reading error due to encoding)
│   ├── my_bookings.html
│   ├── payment
│   │   └── checkout.html
│   ├── register.html (Note: Had reading error due to encoding)
│   └── user
│       ├── base.html
│       ├── bookings
│       │   ├── complete_trip.html
│       │   ├── detail.html
│       │   ├── list.html
│       │   ├── payment.html
│       │   ├── razorpaycheckout.html
│       │   └── start_trip.html
│       ├── dashboard.html
│       ├── filter
│       │   ├── car_list.html
│       │   ├── filters_sidebar.html
│       │   └── list.html
│       ├── notifications
│       │   └── list.html
│       ├── profile
│       │   ├── edit.html
│       │   └── view.html
│       └── wallet
│           ├── dashboard_widget.html
│           ├── detail.html
│           └── list.html
├── uploads
└── utils
    ├── __init__.py
    ├── __pycache__
    ├── date_utils.py
    ├── distance_calculator.py
    ├── notification_sender.py
    ├── timezone.py
    └── validators.py

============================================================
File Contents
============================================================


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\app.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\config.py ---
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    SECRET_KEY = os.getenv('SECRET_KEY', 'your-super-secret-key-change-this-in-production-12345')
    # --- CRITICAL FIX 2: Enable CSRF Protection ---
    WTF_CSRF_ENABLED = True  # Enable CSRF protection globally
    WTF_CSRF_TIME_LIMIT = 3600  # Optional: Set CSRF token expiration (1 hour)
    WTF_CSRF_SSL_STRICT = False  # Optional: Set to True if using HTTPS
    # --- END CRITICAL FIX 2 ---


    SQLALCHEMY_DATABASE_URI = os.getenv('DATABASE_URL', 'mysql+pymysql://root:root@localhost/cars_db')
    SQLALCHEMY_TRACK_MODIFICATIONS = False


    UPLOAD_FOLDER = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'uploads')
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB max file size

    # Razorpay configuration
    RAZORPAY_KEY_ID = os.getenv('RAZORPAY_KEY_ID')
    RAZORPAY_KEY_SECRET = os.getenv('RAZORPAY_KEY_SECRET')

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\init_data.py ---
from app import app
from models import db
from models.location import Location
from models.user import User
from models.car import Car
from models.car_image import CarImage
from models.booking import Booking


def create_sample_data():
    with app.app_context():
        # Clear existing data
        db.drop_all()
        db.create_all()

        # Create sample locations
        locations = [
            Location(name='Indiranagar', city='Bangalore', address='Indiranagar, Bangalore', latitude=12.9716,
                     longitude=77.5946),
            Location(name='Koramangala', city='Bangalore', address='Koramangala, Bangalore', latitude=12.9352,
                     longitude=77.6245),
            Location(name='Whitefield', city='Bangalore', address='Whitefield, Bangalore', latitude=12.9725,
                     longitude=77.7236)
        ]

        for location in locations:
            db.session.add(location)

        # Create sample user
        user = User(username='testuser', email='test@example.com', phone='1234567890')
        user.set_password('password')
        db.session.add(user)

        # Create sample cars
        cars = [
            Car(make='Toyota', model='Innova', year=2022, price_per_day=2500, color='White', mileage=15000,
                fuel_type='Petrol', transmission='Manual', seats=7, location_id=1),
            Car(make='Hyundai', model='Creta', year=2023, price_per_day=1800, color='Blue', mileage=8000,
                fuel_type='Petrol', transmission='Automatic', seats=5, location_id=2),
            Car(make='Maruti', model='Swift', year=2021, price_per_day=1200, color='Red', mileage=22000,
                fuel_type='Petrol', transmission='Manual', seats=5, location_id=3)
        ]

        for car in cars:
            db.session.add(car)

        db.session.commit()
        print("Sample data created successfully!")


if __name__ == '__main__':
    create_sample_data()

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\list.txt ---
REM Create main files
type nul > app.py
type nul > config.py
type nul > models.py
type nul > requirements.txt

REM Create templates folder and HTML files
mkdir templates
cd templates
type nul > base.html
type nul > index.html
type nul > edit_car.html
cd ..

REM Create static folder and CSS file
mkdir static
cd static
type nul > style.css
cd ..

echo Flask project structure created successfully!
pause

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models.py ---
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime

db = SQLAlchemy()


class Car(db.Model):
    __tablename__ = 'cars'

    id = db.Column(db.Integer, primary_key=True)
    make = db.Column(db.String(100), nullable=False)
    model = db.Column(db.String(100), nullable=False)
    year = db.Column(db.Integer, nullable=False)
    price = db.Column(db.Float, nullable=False)
    color = db.Column(db.String(50))
    mileage = db.Column(db.Integer)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # Relationship with car images
    images = db.relationship('CarImage', backref='car', cascade='all, delete-orphan')

    def __repr__(self):
        return f'<Car {self.make} {self.model}>'

    def to_dict(self):
        return {
            'id': self.id,
            'make': self.make,
            'model': self.model,
            'year': self.year,
            'price': self.price,
            'color': self.color,
            'mileage': self.mileage,
            'images': [image.to_dict() for image in self.images]
        }


class CarImage(db.Model):
    __tablename__ = 'car_images'

    id = db.Column(db.Integer, primary_key=True)
    filename = db.Column(db.String(255), nullable=False)
    car_id = db.Column(db.Integer, db.ForeignKey('cars.id'), nullable=False)
    uploaded_at = db.Column(db.DateTime, default=datetime.utcnow)

    def to_dict(self):
        return {
            'id': self.id,
            'filename': self.filename
        }

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\New Text Document.bat ---
@echo off
REM Create static asset directories
mkdir static
mkdir static\css
mkdir static\js
mkdir static\images
mkdir static\uploads

REM Create CSS files
type nul > static\css\style.css
type nul > static\css\host.css
type nul > static\css\dashboard.css

REM Create JS files
type nul > static\js\main.js
type nul > static\js\host.js

echo Static asset directories and files created successfully.
pause


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\requirements.txt ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\auth_controller.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\booking_controller.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\car_controller.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\search_controller.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\__init__.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\host\analytics.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\host\car_manager.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\host\__init__.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\user\booking_manager.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\controllers\user\__init__.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\forms\admin.py ---
# forms/admin.py
from flask_wtf import FlaskForm
from werkzeug.security import check_password_hash
from wtforms import StringField, PasswordField, SelectField, BooleanField, SubmitField
from wtforms.validators import DataRequired, Email, Length

class AdminLoginForm(FlaskForm):
    """WTForm for admin login"""
    username = StringField('Username', validators=[DataRequired(), Length(min=3, max=80)])
    password = PasswordField('Password', validators=[DataRequired(), Length(min=3)])
    # Optional: Remember me checkbox
    remember_me = BooleanField('Remember Me')
    submit = SubmitField('Login as Admin')

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class AdminRegistrationForm(FlaskForm):
    """WTForm for admin registration (for super admins)"""
    username = StringField('Username', validators=[DataRequired(), Length(min=3, max=80)])
    email = StringField('Email', validators=[DataRequired(), Email(), Length(max=120)])
    password = PasswordField('Password', validators=[DataRequired(), Length(min=3)])
    confirm_password = PasswordField('Confirm Password', validators=[DataRequired()])
    # Access level selection (only for super admins)
    access_level = SelectField('Access Level', choices=[
        ('support', 'Support'),
        ('finance', 'Finance'),
        ('content', 'Content Management'),
        ('super', 'Super Admin') # Exclude super admin from regular registration
    ], validators=[DataRequired()])
    is_active = BooleanField('Active', default=True)
    submit = SubmitField('Create Admin')


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\forms\user.py ---
# forms/user.py
from flask_wtf import FlaskForm
from flask_wtf.file import FileField, FileAllowed, FileRequired
from wtforms import SubmitField
from wtforms.validators import ValidationError, NumberRange
from werkzeug.datastructures import FileStorage # Import for type hinting/checking
from models.booking import Booking # Import Booking model if needed for validation

class StartTripForm(FlaskForm):
    """
    WTForm for uploading pickup photos and starting a trip.
    """
    # Define the file field for pickup photos.
    # Using FileRequired might be too strict if you want custom messages
    # or if validation happens partly in the route/model.
    # We'll use FileAllowed for basic type checking.
    # The number of files (min/max) will be validated in the route/model.
    pickup_photos = FileField(
        'Pickup Photos',
        validators=[
            # FileRequired(message="Please select at least one photo."), # Optional: Enforce at least one file via WTForms
            FileAllowed(['jpg', 'jpeg', 'png', 'gif'], message="Only images (jpg, jpeg, png, gif) are allowed!")
        ],
        render_kw={"multiple": True, "accept": "image/*"} # HTML attributes for the input
    )
    submit = SubmitField('Confirm Start Trip')

    def __init__(self, booking_obj=None, *args, **kwargs):
        """Initialize the form, optionally passing the booking object for custom validation."""
        super(StartTripForm, self).__init__(*args, **kwargs)
        self.booking_obj = booking_obj # Store the booking object if passed

    # --- CRITICAL FIX: Add Custom Validation for Number of Files ---
    # This validation runs after basic WTForms validation (like FileAllowed)
    # but before the route logic.
    def validate_pickup_photos(self, field):
        """
        Custom validator to check the number of uploaded files.
        This requires accessing the raw request data, which is a bit tricky with FileField.
        It's often easier and more flexible to check this in the route after form.validate_on_submit().
        However, here's how you *could* attempt it within the form:
        """
        # Accessing files directly from request is generally preferred in the route.
        # The `field.data` for a multi-file input is often just the first file or a list,
        # and WTForms doesn't standardize this well for multi-file inputs.
        # A more reliable way is to check in the route after form validation.
        # For demonstration, we'll leave the core check in the route and maybe do a basic presence check here.

        # Example of a simple check (not exhaustive for min/max):
        # from flask import request
        # files = request.files.getlist('pickup_photos') # Get files by the input's name attribute
        # if not files or all(f.filename == '' for f in files):
        #     raise ValidationError("At least one photo is required.")

        # --- BEST PRACTICE: Leave complex multi-file validation to the route ---
        # The route can easily access request.files.getlist('pickup_photos')
        # and perform checks like len(files) > 10 or len(files) == 0.
        # This is cleaner and more standard.
        # We can still do simple checks here if needed.
        # --- END BEST PRACTICE ---
        pass # Validation for number of files will primarily happen in the route.
    # --- END CRITICAL FIX ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\forms\__init__.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\admin.py ---
# models/admin.py
from . import db
from datetime import datetime
import bcrypt
from flask_login import UserMixin

class Admin(UserMixin, db.Model):
    __tablename__ = 'admins'

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(128))
    # --- CRITICAL FIX 1: Add Access Level ---
    # Define access levels (e.g., 'super', 'support', 'finance', 'content')
    access_level = db.Column(db.String(20), default='support') # Default level
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    # --- END CRITICAL FIX 1 ---

    def set_password(self, password):
        """Hash and set the admin's password."""
        self.password_hash = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')

    def check_password(self, password):
        """Check if the provided password matches the stored hash."""
        return bcrypt.checkpw(password.encode('utf-8'), self.password_hash.encode('utf-8'))

    def __repr__(self):
        return f'<Admin {self.username} ({self.access_level})>'

    # --- CRITICAL FIX 2: Check Access Level ---
    def has_access(self, required_level):
        """
        Check if admin has the required access level.
        Super admins have access to everything.
        Other levels might have specific permissions.
        """
        if self.access_level == 'super':
            return True
        # Define access hierarchy or specific permissions per level
        # Example simple hierarchy: super > support > finance > content
        level_hierarchy = {
            'super': 4,
            'support': 3,
            'finance': 2,
            'content': 1
        }
        required_rank = level_hierarchy.get(required_level, 0)
        admin_rank = level_hierarchy.get(self.access_level, 0)
        return admin_rank >= required_rank

    def can_manage_admins(self):
        """Check if admin can manage other admins (typically super admins)."""
        return self.has_access('super')
    # --- END CRITICAL FIX 2 ---

# --- Helper Function to Create Default Admin ---
def create_default_admin():
    """Create a default admin user if one doesn't exist."""
    # Check if any admin exists
    existing_admin = Admin.query.first()
    if not existing_admin:
        # Create default admin
        default_admin = Admin(
            username='admin',
            email='admin@zoomcarclone.com',
            access_level='super' # Make default admin a super admin
        )
        default_admin.set_password('123') # Default password
        db.session.add(default_admin)
        try:
            db.session.commit()
            print("Default SUPER admin user 'admin' created with password '123'. Please change this immediately!")
        except Exception as e:
            db.session.rollback()
            print(f"Error creating default admin: {e}")
    else:
        print("Admin user already exists. Skipping default admin creation.")
# --- End Helper Function ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\api.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\booking.py ---
# models/booking.py
from sqlalchemy.orm import relationship
import pytz
from utils.timezone import get_current_ist_time, UTC_TZ, utc_to_ist
from . import db
from datetime import datetime, timedelta
# At the top, add:
from .photo import Photo # Import the Photo model

# --- CRITICAL FIX: Import timezone utilities ---
# Place these imports near the top of the file, after other imports
# Ensure the path 'utils.timezone' is correct for your project structure.
# This assumes 'utils' is a top-level package/directory in your project.
try:
    from utils.timezone import get_current_ist_time, db_utc_to_ist
    TIMEZONE_UTILS_AVAILABLE = True
    # print("DEBUG: Timezone utilities imported successfully.") # Optional debug print
except ImportError as e:
    # Handle the case where the utils module is missing or misconfigured
    print(f"Warning: Could not import timezone utilities: {e}")
    TIMEZONE_UTILS_AVAILABLE = False

    # --- CRITICAL FIX: Provide fallback implementations or signal error ---
    # Option 1: Define stub functions that raise an error if called
    # This forces the issue to be addressed.
    def get_current_ist_time():
        raise NotImplementedError("Timezone utilities (utils.timezone) are required but not available. Cannot get current IST time.")

    def db_utc_to_ist(dt):
        raise NotImplementedError("Timezone utilities (utils.timezone) are required but not available. Cannot convert DB UTC to IST.")

    # Option 2: Fallback to UTC logic (NOT recommended for consistency, but avoids crash)
    # Uncomment the block below if you prefer this temporary fallback.
    '''
    def get_current_ist_time():
        # Fallback: Just return UTC time (incorrect for IST logic)
        print("Warning: Timezone utilities not available, using UTC for 'current IST time'.")
        utc_now = datetime.utcnow()
        return pytz.utc.localize(utc_now) # Return UTC datetime

    def db_utc_to_ist(db_utc_dt):
        # Fallback: Treat DB time as UTC (incorrect if DB stores UTC, logic expects IST comparison)
        print("Warning: Timezone utilities not available, treating DB UTC time as UTC.")
        if db_utc_dt.tzinfo is None:
            return pytz.utc.localize(db_utc_dt) # Localize as UTC if naive
        return db_utc_dt # Return as-is if already timezone-aware
    '''
    # --- END CRITICAL FIX ---
# --- END CRITICAL FIX: Import timezone utilities ---


class Booking(db.Model):
    __tablename__ = 'bookings'

    id = db.Column(db.Integer, primary_key=True)

    # --- Core Booking Information ---
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    car_id = db.Column(db.Integer, db.ForeignKey('cars.id'), nullable=False)
    start_date = db.Column(db.DateTime, nullable=False)
    end_date = db.Column(db.DateTime, nullable=False)
    total_price = db.Column(db.Float, nullable=False)  # Price for original duration
    # --- End Core Info ---

    # --- Booking Flow Status Fields ---
    # General status of the booking process
    status = db.Column(db.String(20), default='pending') # pending, paid, active, completed, cancelled, extended
    # host_approval = db.Column(db.Boolean, default=False) # REMOVED: Not needed for initial booking
    payment_status = db.Column(db.String(20), default='pending') # pending, completed, failed
    payment_date = db.Column(db.DateTime)
    # --- End Status Fields ---

    # --- Cancellation Details ---
    cancelled_by = db.Column(db.String(10)) # 'user', 'host', 'admin'
    cancellation_reason = db.Column(db.String(255))
    cancellation_fee_deducted = db.Column(db.Float, default=0.0)
    refund_amount = db.Column(db.Float, default=0.0)
    cancelled_at = db.Column(db.DateTime)
    # --- End Cancellation Details ---
    ##trip_photos = relationship('TripPhoto', back_populates='booking', lazy=True)
    # --- Razorpay Integration Fields ---
    # Store Razorpay identifiers for verification and reference
    razorpay_order_id = db.Column(db.String(50)) # Store Razorpay Order ID
    razorpay_payment_id = db.Column(db.String(50)) # Store Razorpay Payment ID (after success)
    # --- End Razorpay Fields ---

    # --- CRITICAL: Trip Extension Fields ---
    # Flag to indicate if an extension request exists
    has_extension_request = db.Column(db.Boolean, default=False)
    # Details of the requested extension
    extension_new_end_date = db.Column(db.DateTime) # Proposed new end date
    extension_additional_days = db.Column(db.Integer) # Calculated additional days
    extension_additional_price = db.Column(db.Float) # Calculated additional price
    # Host approval for extension
    extension_host_approval = db.Column(db.Boolean, default=False)
    extension_host_approval_timestamp = db.Column(db.DateTime)
    # Status for the extension part of the booking
    extension_status = db.Column(db.String(20), default='none') # none, requested, approved, paid, completed, cancelled
    # Razorpay order/payment IDs for extension payment (if separate)
    extension_razorpay_order_id = db.Column(db.String(50))
    extension_razorpay_payment_id = db.Column(db.String(50))
    extension_payment_status = db.Column(db.String(20), default='none') # none, pending, completed, failed
    extension_payment_date = db.Column(db.DateTime)
    # --- END CRITICAL ---

    # --- Timestamps ---
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    # --- End Timestamps ---

    # --- REMOVED: Redundant Fields ---
    # is_active = db.Column(db.Boolean, default=False) # Trip is currently active - Use status instead
    # is_completed = db.Column(db.Boolean, default=False) # Trip is completed - Use status instead
    # pickup_photos_json = db.Column(db.Text)  # Store as JSON string - Use Photo model instead
    # dropoff_photos_json = db.Column(db.Text)  # Store as JSON string - Use Photo model instead
    # --- END REMOVED ---

    # --- Relationship Definitions ---
    # DO NOT DEFINE 'user' or 'car' relationships here if Car/Location/User models use backref.
    # The backref on Car.bookings creates a 'car' attribute on Booking instances.
    # The backref on User.bookings creates a 'user' attribute on Booking instances.
    # The relationship to Photo is defined via the Photo model's backref (e.g., booking.photos)
    # --- End Relationships ---

    def __repr__(self):
        return f'<Booking {self.id}>'

    # --- CRITICAL FIX: Define the duration_hours property ---
    @property
    def duration_hours(self):
        """Calculate booking duration in hours."""
        if self.start_date and self.end_date:
            duration = self.end_date - self.start_date
            return duration.total_seconds() / 3600  # Convert seconds to hours
        return 0.0  # Return 0 if dates are not set

    # --- Updated Price Calculation (Alternative: Query Car Directly) ---
    def calculate_total_price(self):
        """Calculate the total price based on duration in hours and car's price per hour."""
        duration_hours = self.duration_hours
        if duration_hours <= 0:
            return 0.0

        # --- CRITICAL FIX 3: Query Car's Price Directly ---
        # This avoids relying on the lazy-loaded relationship potentially being None
        # at the time of the hook execution.
        from .car import Car  # Import Car model inside the method
        car = Car.query.get(self.car_id)  # Fetch the car object using the foreign key
        if not car:
            # Log an error or raise an exception if the car doesn't exist
            print(f"ERROR: Car with ID {self.car_id} not found for booking {self.id}")
            return 0.0  # Or raise an exception

        price_per_hour = car.price_per_hour
        # --- END CRITICAL FIX 3 ---

        return round(duration_hours * price_per_hour, 2)  # Round to 2 decimal places

    def update_price_before_save(self):
        """Call this method before committing the booking to update the total_price."""
        self.total_price = self.calculate_total_price()

    # --- End Updated Price Calculation (Alternative) ---
    # --- End Updated Price Calculation ---
    # --- CRITICAL: Updated Booking State Logic ---
    # --- Initial Booking Logic ---
    def can_be_paid(self):
        """Check if booking can be paid by user (Initial booking payment)."""
        # Payment can be made if booking is pending and payment is also pending
        return self.status == 'pending' and self.payment_status == 'pending'

    def mark_as_paid(self, razorpay_payment_id=None):
        """Mark the booking as paid after successful initial payment."""
        if self.can_be_paid():
            self.payment_status = 'completed'
            self.payment_date = datetime.utcnow()
            self.status = 'paid'  # Status changes to 'paid' after payment
            if razorpay_payment_id:
                self.razorpay_payment_id = razorpay_payment_id
            db.session.add(self)
            return True
        return False

    def mark_payment_failed(self, razorpay_payment_id=None):
        """Mark the booking payment as failed."""
        self.payment_status = 'failed'
        self.status = 'pending'  # Or 'failed'? Depends on policy
        if razorpay_payment_id:
            self.razorpay_payment_id = razorpay_payment_id  # Store failed payment ID for debugging
        db.session.add(self)
        # Don't commit here, let caller handle it

    # --- End Initial Booking Logic ---

    # --- NEW: Trip Activation and Completion Logic (Using Status) ---
    # models/booking.py (Inside the Booking class)

    # --- CRITICAL FIX: Update Booking Activation Logic ---
    # models/booking.py (Inside the Booking class)

    # models/booking.py (Inside the Booking class)
    # Import the utility functions
    # Make sure the path is correct relative to your project structure
    # If utils is a top-level package, this should work:
    from utils.timezone import get_current_ist_time, db_utc_to_ist

    # --- CRITICAL FIX: Update Booking Activation Logic to use IST ---
    # --- CRITICAL FIX: Update Booking Activation Logic to use IST ---
    # --- CRITICAL FIX: Update Booking Activation Logic for DB stored as IST ---
    def can_be_activated_by_user(self):
        """
        Check if user can activate the trip (upload pickup photos and start).
        Assumes start_date and end_date in the database are stored as IST.
        Allows activation if:
        1. The booking status is 'paid'.
        2. The current time in IST is past the booking's start date.
        """
        # --- CRITICAL FIX: Get Current Time in IST ---
        # Use the utility function to get the current IST time
        # Ensure TIMEZONE_UTILS_AVAILABLE is correctly defined/imported as before
        if not TIMEZONE_UTILS_AVAILABLE:
            # Fallback or error handling (adjust as needed)
            print("Warning: Timezone utilities not available, falling back to potentially incorrect UTC comparison.")
            now_utc = datetime.utcnow()
            # INCORRECTLY assume self.start_date is UTC for fallback
            return (
                    self.status == 'paid' and
                    now_utc >= self.start_date
            )
        now_ist = get_current_ist_time()  # Returns timezone-aware IST datetime
        # --- END CRITICAL FIX ---

        # --- CRITICAL FIX: Correctly Interpret DB IST start_date ---
        # The database stores start_date as a naive datetime representing IST.
        # We need to inform Python that this datetime is in IST.
        if not TIMEZONE_UTILS_AVAILABLE:
            # Fallback: Treat DB time as naive IST (still better than UTC if DB is IST)
            # This is a simplification; pytz.localize is preferred for robustness.
            # For a quick fix, we compare naive datetimes.
            # Get current IST time as naive datetime for comparison
            naive_now_ist = datetime.now(pytz.timezone('Asia/Kolkata')).replace(tzinfo=None)
            naive_booking_start_ist = self.start_date  # Already naive, assumed IST
            status_ok = self.status == 'paid'
            time_ok = naive_now_ist >= naive_booking_start_ist
            print(f"DEBUG (Fallback - Naive IST) can_be_activated_by_user - Booking ID: {self.id}")
            print(f"  Status: {self.status}, Required: 'paid', Match: {status_ok}")
            print(
                f"  Now (Naive IST): {naive_now_ist}, Booking Start (Naive IST): {naive_booking_start_ist}, Time OK (Now >= Start): {time_ok}")
            print(f"  Final Result: {status_ok and time_ok}")
            return status_ok and time_ok
        else:
            # Use the robust timezone utility
            try:
                # Import pytz inside the method or at the top of the file
                import pytz
                ist_tz = pytz.timezone('Asia/Kolkata')

                # 1. Localize the naive DB datetime as IST
                # This tells Python that the datetime value represents IST.
                booking_start_ist = ist_tz.localize(self.start_date)
                # --- END CRITICAL FIX ---

                # --- CRITICAL FIX: Perform comparison in IST ---
                # Now compare the timezone-aware IST datetimes
                status_ok = self.status == 'paid'
                time_ok = now_ist >= booking_start_ist  # Compare IST times

                # Debugging output (optional, remove in production)
                print(f"DEBUG can_be_activated_by_user - Booking ID: {self.id}")
                print(f"  Status: {self.status}, Required: 'paid', Match: {status_ok}")
                print(f"  Now (Aware IST): {now_ist}, Booking Start (Localized Aware IST): {booking_start_ist}, Time OK (Now >= Start): {time_ok}")
                print(f"  Final Result: {status_ok and time_ok}")

                return status_ok and time_ok
            except Exception as e:
                # Handle potential errors in localization (e.g., ambiguous/non-existent times)
                print(f"Error in can_be_activated_by_user during localization: {e}")
                return False  # Or handle differently
        # --- END CRITICAL FIX ---

    # --- END CRITICAL FIX ---

    # --- END CRITICAL FIX ---

    # Ensure activate_trip uses the updated check (it should already if it calls can_be_activated_by_user)
    def activate_trip(self):
        """
        Activate the trip after user uploads pickup photos.
        This changes the booking status to 'active'.
        """
        # --- CRITICAL FIX: Use the updated can_be_activated_by_user check ---
        if self.can_be_activated_by_user():  # Use the corrected method that works in IST
            # --- END CRITICAL FIX ---
            self.status = 'active'  # Change status to active
            # is_active and is_completed flags are potentially redundant with status
            # but setting them for completeness based on your model definition
            self.is_active = True
            self.is_completed = False  # Ensure it's not marked completed prematurely
            db.session.add(self)  # Add the modified object to the session
            return True  # Indicate successful activation
        return False  # Indicate activation not allowed

    # --- END activate_trip ---

    # --- END activate_trip ---

    def can_be_completed_by_user(self):
        """Check if user can complete the trip."""
        # Trip can be completed if it's currently active
        return self.status == 'active'

    def complete_trip(self):
        """Complete the trip after user optionally uploads dropoff photos."""
        # This method should only be called from the route after photo upload validation (if any)
        # The route will check can_be_completed_by_user() first.
        if self.status == 'active': # Primary check
            self.status = 'completed' # Change status to completed
            # Transfer earnings to host's wallet (assuming logic exists in Host model)
            host = self.car.host
            if host:
                # Example: Add 90% of total price to host's wallet
                host_earning = self.total_price * 0.9
                # Add extension earnings if applicable
                if self.extension_additional_price:
                    host_earning += self.extension_additional_price * 0.9
                host.add_to_wallet(host_earning)
            db.session.add(self)
            return True
        return False # Should not happen if route checks properly

    def can_be_completed(self):
        """Check if booking trip can be marked as completed (e.g., drop-off time passed automatically - NOT USED HERE)."""
        # This old method is now redundant with the user-driven completion logic.
        # The trip completion should be driven by the user uploading dropoff photos.
        # The dashboard timer can still show "Until Dropoff" based on status == 'active'.
        # We can keep this for potential future auto-completion logic, but it's not the primary path.
        now = datetime.utcnow()
        # For extensions: Check against the *actual* end date (original or extended)
        effective_end_date = self.extension_new_end_date if self.extension_new_end_date else self.end_date
        return (self.status == 'active' and
                effective_end_date < now)
    # --- End NEW: Trip Activation and Completion Logic ---

    # --- Cancellation Logic ---
    def can_be_cancelled_by_user(self):
        """Check if user can cancel the booking."""
        now = datetime.utcnow()
        time_to_start = self.start_date - now
        # Allow cancellation if payment is pending, or if paid but trip hasn't started, and > 6 hours to start
        return ((self.status == 'pending' and self.payment_status == 'pending') or
                (self.payment_status == 'completed' and self.status in ['paid', 'approved'] and self.status != 'active' and time_to_start > timedelta(hours=6))) # Added check for status != 'active'

    def cancel_by_user(self, reason=""):
        """Cancel the booking by the user."""
        if self.can_be_cancelled_by_user():
            self.status = 'cancelled' # Update status
            self.cancelled_by = 'user'
            self.cancellation_reason = reason[:255]  # Truncate reason
            self.cancelled_at = datetime.utcnow()

            # Deduct cancellation fee if paid
            if self.payment_status == 'completed':
                # Example: 50% cancellation fee
                fee = self.total_price * 0.5
                self.cancellation_fee_deducted = round(fee, 2)
                self.refund_amount = round(self.total_price - fee, 2)

                # Update host wallet (deduct earnings, add back 50%)
                host = self.car.host
                if host:
                    # Deduct full amount first (as it was added on payment)
                    host.deduct_from_wallet(self.total_price)
                    # Add back 50% (host keeps 50% as cancellation fee)
                    host.add_to_wallet(self.total_price * 0.5)
            else:
                # If not paid, no fee/refund
                self.cancellation_fee_deducted = 0.0
                self.refund_amount = 0.0

            db.session.add(self)
            return True
        return False

    def can_be_cancelled_by_host(self):
        """Check if host can cancel the booking (before pickup)."""
        # Host can cancel before payment or within a window before trip start
        now = datetime.utcnow()
        time_to_start = self.start_date - now
        return ((self.status in ['pending'] and self.payment_status == 'pending') or
                (self.payment_status == 'completed' and self.status in ['paid', 'approved'] and self.status != 'active' and time_to_start > timedelta(hours=1))) # Added check for status != 'active'

    def cancel_by_host(self, reason=""):
        """Cancel the booking by the host."""
        if self.can_be_cancelled_by_host():
            self.status = 'cancelled' # Update status
            self.cancelled_by = 'host'
            self.cancellation_reason = reason[:255]  # Truncate reason
            self.cancelled_at = datetime.utcnow()

            # No cancellation fee for host
            self.cancellation_fee_deducted = 0.0
            self.refund_amount = self.total_price  # Full refund

            # Update host wallet (remove earnings if paid)
            host = self.car.host
            if host and self.payment_status == 'completed':
                host.deduct_from_wallet(self.total_price)

            # Notify Admin (placeholder - implement notification logic)
            self._notify_admin_of_host_cancellation(reason)

            db.session.add(self)
            return True
        return False

    def _notify_admin_of_host_cancellation(self, reason):
        """Placeholder for notifying admin of host cancellation."""
        print(f"[ADMIN NOTIFICATION] Host {self.car.host.user.username} cancelled booking {self.id} for {self.car.make} {self.car.model}. Reason: {reason}")

    # --- End Cancellation Logic ---

    # --- CRITICAL: Trip Extension Logic ---
    def can_request_extension(self):
        """Check if user can request an extension for this booking."""
        # Must be paid/active, not completed, not already have a request, and extension not paid/completed
        return (self.payment_status == 'completed' and
                self.status in ['paid', 'active', 'extended'] and
                self.status != 'completed' and # Explicitly check status
                not self.has_extension_request and
                self.extension_status in ['none', 'cancelled'] and
                self.extension_payment_status in ['none', 'cancelled'])

    def request_extension(self, new_end_date_str):
        """User requests to extend the booking."""
        if not self.can_request_extension():
            return False, "Extension cannot be requested at this time."

        try:
            new_end_date = datetime.strptime(new_end_date_str, '%Y-%m-%d')
        except ValueError:
            return False, "Invalid date format for extension."

        original_end_date = self.extension_new_end_date if self.extension_new_end_date else self.end_date

        # Check if new end date is after original end date
        if new_end_date <= original_end_date:
            return False, "Extension end date must be after the current trip end date."

        # Check if request is made at least 6 hours before original end
        now = datetime.utcnow()
        time_until_original_end = original_end_date - now
        if time_until_original_end < timedelta(hours=6):
            return False, "Extension request must be made at least 6 hours before the original trip end time."

        # Calculate additional days and price
        additional_days = (new_end_date - original_end_date).days
        if additional_days <= 0:
            return False, "Invalid extension duration."

        # Use price_per_hour for extension calculation
        additional_hours = additional_days * 24 # Approximate hours
        additional_price = additional_hours * self.car.price_per_hour # Use price_per_hour

        # Update booking fields for extension request
        self.has_extension_request = True
        self.extension_new_end_date = new_end_date
        self.extension_additional_days = additional_days
        self.extension_additional_price = round(additional_price, 2)
        self.extension_status = 'requested'
        self.extension_payment_status = 'pending'  # Reset payment status for extension
        self.extension_razorpay_order_id = None  # Clear previous order ID
        self.extension_razorpay_payment_id = None  # Clear previous payment ID

        db.session.add(self)
        # Don't commit here, let caller handle it
        return True, "Extension request submitted successfully. Waiting for host approval."

    def can_approve_extension(self, host):
        """Check if host can approve this extension request."""
        # Must be the owner, have a request, and request is in 'requested' status
        return (host.id == self.car.host_id and
                self.has_extension_request and
                self.extension_status == 'requested')

    def approve_extension(self, host):
        """Host approves the extension request."""
        if not self.can_approve_extension(host):
            return False, "Extension approval not allowed."

        # Update extension status
        self.extension_status = 'approved'
        self.extension_host_approval = True
        self.extension_host_approval_timestamp = datetime.utcnow()

        db.session.add(self)
        # Don't commit here, let caller handle it
        return True, "Extension approved. User can now proceed with payment."

    def can_reject_extension(self, host):
        """Check if host can reject this extension request."""
        return self.can_approve_extension(host)  # Same conditions as approval


    def reject_extension(self, host):
        """Host rejects the extension request."""
        if not self.can_reject_extension(host):
            return False, "Extension rejection not allowed."

        # Reset extension fields
        self.has_extension_request = False
        self.extension_new_end_date = None
        self.extension_additional_days = None
        self.extension_additional_price = None
        self.extension_status = 'cancelled'
        self.extension_payment_status = 'none'
        self.extension_razorpay_order_id = None
        self.extension_razorpay_payment_id = None

        db.session.add(self)
        # Don't commit here, let caller handle it
        return True, "Extension request rejected."


    def can_pay_for_extension(self):
        """Check if user can pay for the approved extension."""
        return (self.has_extension_request and
                self.extension_status == 'approved' and
                self.extension_payment_status == 'pending')


    def mark_extension_paid(self, razorpay_payment_id=None):
        """Mark the extension payment as completed."""
        if self.can_pay_for_extension():
            self.extension_payment_status = 'completed'
            self.extension_payment_date = datetime.utcnow()
            self.extension_razorpay_payment_id = razorpay_payment_id

            # Update main booking end date and total price
            if self.extension_new_end_date:
                self.end_date = self.extension_new_end_date
                self.total_price += self.extension_additional_price
                self.status = 'extended'  # Indicate it's been extended

            db.session.add(self)
            return True
        return False


    def can_complete_extension(self):
        """Check if the extended trip can be marked as completed."""
        # This is handled by the main complete_trip logic now
        # which checks the effective_end_date (could be extended)
        return self.extension_payment_status == 'completed' and self.status == 'active' and not self.status == 'completed' # Redundant check, kept for clarity


    # --- END CRITICAL: Trip Extension Logic ---

    def get_transaction_details(self):
        """Get formatted transaction details for display."""
        details = {
            'booking_id': self.id,
            'total_amount': self.total_price,
            'payment_status': self.payment_status,
            'payment_date': self.payment_date.strftime('%Y-%m-%d %H:%M') if self.payment_date else None,
            'razorpay_payment_id': self.razorpay_payment_id,
            'cancellation_fee': self.cancellation_fee_deducted,
            'refund_amount': self.refund_amount,
            'cancelled_by': self.cancelled_by,
            'cancellation_reason': self.cancellation_reason,
            'cancelled_at': self.cancelled_at.strftime('%Y-%m-%d %H:%M') if self.cancelled_at else None,
            'status': self.status,
            # Add extension details
            'has_extension': self.has_extension_request,
            'extension_status': self.extension_status,
            'extension_new_end_date': self.extension_new_end_date.strftime('%Y-%m-%d') if self.extension_new_end_date else None,
            'extension_additional_days': self.extension_additional_days,
            'extension_additional_price': self.extension_additional_price,
            'extension_payment_status': self.extension_payment_status,
            'extension_razorpay_payment_id': self.extension_razorpay_payment_id,
        }
        return details

    # Inside the Booking class, add these methods (e.g., before or after get_transaction_details):
    def get_pickup_photos(self):
        """Get all pickup photos associated with this booking."""
        # Use the relationship defined in the Photo model (backref='booking')
        return [photo for photo in self.photos if photo.photo_type == 'pickup'] # Assuming 'photos' is the backref name

    def get_dropoff_photos(self):
        """Get all dropoff photos associated with this booking."""
        # Use the relationship defined in the Photo model (backref='booking')
        return [photo for photo in self.photos if photo.photo_type == 'dropoff'] # Assuming 'photos' is the backref name

    def get_min_extension_date(self):
        """Returns the earliest possible date for an extension (1 day after current end date)."""
        return self.end_date + timedelta(days=1)

    # Optional: Also add helper to check if extension is allowed
    def can_be_extended(self):
        """Check if booking is eligible for extension."""
        return self.status in ['active', 'approved'] and self.payment_status == 'completed'

# --- Hook for SQLAlchemy to update price before insert/update ---
# This ensures total_price is always calculated based on current start/end dates and car price
@db.event.listens_for(Booking, 'before_insert')
@db.event.listens_for(Booking, 'before_update')
def update_booking_price(mapper, connection, target):
    target.update_price_before_save()
# --- End Hook ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\car.py ---
# models/car.py
from . import db
from datetime import datetime


class Car(db.Model):
    __tablename__ = 'cars'

    id = db.Column(db.Integer, primary_key=True)
    make = db.Column(db.String(100), nullable=False)
    model = db.Column(db.String(100), nullable=False)
    year = db.Column(db.Integer, nullable=False)
    price_per_hour = db.Column(db.Float, nullable=False) # Changed from price_per_day
    color = db.Column(db.String(50))
    mileage = db.Column(db.Integer)
    fuel_type = db.Column(db.String(20))  # Petrol, Diesel, Electric
    transmission = db.Column(db.String(20))  # Manual, Automatic
    seats = db.Column(db.Integer)

    # --- Structured Address Fields ---
    # These will store the address details directly on the car
    full_address = db.Column(db.Text)  # Store the complete address string
    street_address = db.Column(db.String(255))  # e.g., "123 Main Street"
    locality = db.Column(db.String(100))  # e.g., "Koramangala"
    city = db.Column(db.String(100))  # e.g., "Bangalore"
    state = db.Column(db.String(100))  # e.g., "Karnataka"
    pincode = db.Column(db.String(20))  # e.g., "560034"
    latitude = db.Column(db.Float)  # Store coordinates
    longitude = db.Column(db.Float)  # Store coordinates
    # --- End Structured Address Fields ---

    # --- Relationships and Foreign Keys ---
    # Link to the Host who owns this car
    host_id = db.Column(db.Integer, db.ForeignKey('hosts.id'), nullable=False)

    # --- CRITICAL: Ensure this foreign key and relationship are correct ---
    # If you are using a separate 'locations' table (OLD APPROACH):
    # location_id = db.Column(db.Integer, db.ForeignKey('locations.id'), nullable=False) # <-- UNCOMMENT if using locations table
    # location = db.relationship('Location', backref='cars') # <-- UNCOMMENT if using locations table

    # If you are storing location details directly in Car (NEW APPROACH - based on previous conversation):
    # Comment out or remove the location_id FK and relationship if you are NOT using a separate locations table.
    # location_id = db.Column(db.Integer, db.ForeignKey('locations.id')) # <-- COMMENT OUT or REMOVE
    # location = db.relationship('Location', backref='cars') # <-- COMMENT OUT or REMOVE
    # --- END CRITICAL ---

    # Availability status
    is_available = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    is_blocked = db.Column(db.Boolean, default=False)  # New: Host can block car
    blocked_reason = db.Column(db.String(255))  # New: Reason for blocking
    blocked_at = db.Column(db.DateTime)  # New: When blocked

    # --- Relationship Definitions ---
    # Relationship to Host: One Host can have many Cars.
    host = db.relationship('Host', backref='cars_managed')

    # Relationship to CarImage: One Car can have many Images.
    images = db.relationship('CarImage', backref='car', cascade='all, delete-orphan', lazy=True)

    # Relationship to Booking: One Car can have many Bookings.
    bookings = db.relationship('Booking', backref='car', lazy=True, cascade="all, delete-orphan")

    # --- End Relationships ---

    def __repr__(self):
        return f'<Car {self.make} {self.model}>'

    def to_dict(self):
        """Helper method to convert car object to dictionary, useful for APIs."""
        return {
            'id': self.id,
            'make': self.make,
            'model': self.model,
            'year': self.year,
            'price_per_day': self.price_per_day,
            'color': self.color,
            'mileage': self.mileage,
            'fuel_type': self.fuel_type,
            'transmission': self.transmission,
            'seats': self.seats,
            'full_address': self.full_address,
            'street_address': self.street_address,
            'locality': self.locality,
            'city': self.city,
            'state': self.state,
            'pincode': self.pincode,
            'latitude': self.latitude,
            'longitude': self.longitude,
            # Add other fields as needed for API responses
        }

    def can_be_booked(self):
        """Check if car is available for booking."""
        return self.is_available and not self.is_blocked
    # ... rest of model ...

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\car_image.py ---
# models/car_image.py
from . import db
from datetime import datetime

class CarImage(db.Model):
    __tablename__ = 'car_images'

    id = db.Column(db.Integer, primary_key=True)
    filename = db.Column(db.String(255), nullable=False)
    car_id = db.Column(db.Integer, db.ForeignKey('cars.id'), nullable=False)
    is_primary = db.Column(db.Boolean, default=False)
    uploaded_at = db.Column(db.DateTime, default=datetime.utcnow)

    # --- Relationship Definitions ---
    # DO NOT DEFINE 'car' relationship here.
    # It is provided automatically by the 'backref' defined in the Car model.
    # - Car.images backref='car' creates a 'car' attribute on CarImage.
    # --- End Relationships ---

    def __repr__(self):
        return f'<CarImage {self.filename} (Car ID: {self.car_id})>'


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\complaint.py ---
# models/complaint.py
from . import db
from datetime import datetime


class Complaint(db.Model):
    __tablename__ = 'complaints'
    id = db.Column(db.Integer, primary_key=True)
    booking_id = db.Column(db.Integer, db.ForeignKey('bookings.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    # Optional: complaint against host or car
    host_id = db.Column(db.Integer, db.ForeignKey('hosts.id'))
    car_id = db.Column(db.Integer, db.ForeignKey('cars.id'))
    subject = db.Column(db.String(100), nullable=False)
    description = db.Column(db.Text, nullable=False)
    status = db.Column(db.String(20), default='open')  # open, in_progress, resolved, closed
    priority = db.Column(db.String(20), default='medium')  # low, medium, high
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships via backref in Booking, User, Host, Car

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\document.py ---
# models/document.py
from . import db
from datetime import datetime


class Document(db.Model):
    __tablename__ = 'documents'

    id = db.Column(db.Integer, primary_key=True)
    filename = db.Column(db.String(255), nullable=False)
    # --- CRITICAL: Specify the type of document ---
    document_type = db.Column(db.String(50), nullable=False)  # e.g., 'rc', 'license', 'dl', 'insurance'
    # --- END CRITICAL ---
    is_verified = db.Column(db.Boolean, default=False)
    uploaded_at = db.Column(db.DateTime, default=datetime.utcnow)
    verified_at = db.Column(db.DateTime)

    # --- CRITICAL: The Foreign Key linking this document to its OWNER (User or Host) ---
    # This is the column used for the Document.user relationship
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    # --- END CRITICAL ---

    # --- Optional: Link to Car if document is car-specific ---
    # car_id = db.Column(db.Integer, db.ForeignKey('cars.id'))
    # car = db.relationship('Car', backref='documents')
    # --- End Optional ---

    # --- CRITICAL FIX: Explicitly define the relationship with foreign_keys ---
    # BEFORE (Ambiguous):
    # user = db.relationship('User', backref='documents')

    # AFTER (Explicit foreign_keys):
    # Tell SQLAlchemy: "Use the 'user_id' column to link Document to User"
    user = db.relationship('User', foreign_keys=[user_id], backref='documents_uploaded')

    # Note: Changed backref name to 'documents_uploaded' to avoid potential conflicts
    # with other User.document relationships (like rc_document, dl_document if they exist on User)
    # --- END CRITICAL FIX ---

    def __repr__(self):
        return f'<Document {self.filename} ({self.document_type}) for User {self.user_id}>'

    # --- Optional: Helper methods ---
    def verify(self):
        """Mark document as verified."""
        self.is_verified = True
        self.verified_at = datetime.utcnow()
        db.session.add(self)
        # Don't commit here, let caller handle it

    def belongs_to(self, user_obj):
        """Check if document belongs to a specific user."""
        return self.user_id == user_obj.id
    # --- End Optional ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\feedback.py ---
# models/feedback.py
from . import db
from datetime import datetime


class Feedback(db.Model):
    __tablename__ = 'feedbacks'
    id = db.Column(db.Integer, primary_key=True)
    booking_id = db.Column(db.Integer, db.ForeignKey('bookings.id'), nullable=False, unique=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    host_id = db.Column(db.Integer, db.ForeignKey('hosts.id'), nullable=False)
    subject = db.Column(db.String(100))
    message = db.Column(db.Text, nullable=False)
    is_resolved = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # Relationships via backref in Booking, User, Host

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\host.py ---
# models/host.py
from . import db
from datetime import datetime

# models/host.py
from . import db
from datetime import datetime

class Host(db.Model):
    __tablename__ = 'hosts'

    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    company_name = db.Column(db.String(100))
    phone = db.Column(db.String(20))
    address = db.Column(db.Text)

    # --- ADD THESE LOCATION COLUMNS ---
    latitude = db.Column(db.Float)
    longitude = db.Column(db.Float)
    full_address = db.Column(db.String(500))
    street_address = db.Column(db.String(255))
    locality = db.Column(db.String(100))
    city = db.Column(db.String(100))
    state = db.Column(db.String(100))
    pincode = db.Column(db.String(20))
    # --- END ADD ---

    is_verified = db.Column(db.Boolean, default=False)
    wallet_balance = db.Column(db.Float, default=0.0)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)



    # --- Relationship Definitions ---
    # DO NOT DEFINE 'user' relationship here if using backref.
    # The 'backref' on User.host_profile creates a 'user' attribute on Host instances.
    # Example expected setup in User model:
    # host_profile = db.relationship('Host', backref='user')
    #
    # If you were using back_populates instead, you would define them here like:
    # user = db.relationship('User', back_populates='host_profile')
    # AND in User model: back_populates='host_profile'
    # --- END RELATIONSHIPS ---

    def __repr__(self):
        user_info = f" (User ID: {self.user_id})" if self.user_id else ""
        name = self.company_name or (self.user.username if self.user else "No Name")
        return f'<Host {name}{user_info}>'

    def add_to_wallet(self, amount):
        """Add funds to the host's wallet."""
        self.wallet_balance += amount
        db.session.commit()

    def deduct_from_wallet(self, amount):
        """Deduct funds from the host's wallet."""
        if self.wallet_balance >= amount:
            self.wallet_balance -= amount
            db.session.commit()
            return True
        return False

    def add_to_wallet(self, amount):
        """Add funds to the host's wallet."""
        self.wallet_balance += amount
        db.session.commit()

    def deduct_from_wallet(self, amount):
        """Deduct funds from the host's wallet."""
        if self.wallet_balance >= amount:
            self.wallet_balance -= amount
            db.session.commit()
            return True
        return False

    def __repr__(self):
        user_info = f" (User ID: {self.user_id})" if self.user_id else ""
        name = self.company_name or (self.user.username if hasattr(self, 'user') and self.user else "No Name")
        return f'<Host {name}{user_info}>'

# --- Host Rating Model ---
class HostRating(db.Model):
    __tablename__ = 'host_ratings'

    id = db.Column(db.Integer, primary_key=True)
    host_id = db.Column(db.Integer, db.ForeignKey('hosts.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    rating = db.Column(db.Integer, nullable=False)  # 1-5 stars
    comment = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # --- Relationship Definitions ---
    # DO NOT DEFINE 'host' or 'user' relationships here.
    # They are provided automatically by the 'backref' defined in Host and User models.
    # - Host.ratings backref='host' creates a 'host' attribute on HostRating.
    # - User.host_ratings_given backref='user' creates a 'user' attribute on HostRating.
    # --- End Relationships ---

    def __repr__(self):
        return f'<HostRating {self.rating} stars for Host {self.host_id}>'

# --- Host Feedback Model ---
class HostFeedback(db.Model):
    __tablename__ = 'host_feedbacks'

    id = db.Column(db.Integer, primary_key=True)
    host_id = db.Column(db.Integer, db.ForeignKey('hosts.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    subject = db.Column(db.String(100))
    message = db.Column(db.Text, nullable=False)
    is_resolved = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # --- Relationship Definitions ---
    # DO NOT DEFINE 'host' or 'user' relationships here.
    # They are provided automatically by the 'backref' defined in Host and User models.
    # - Host.feedbacks backref='host' creates a 'host' attribute on HostFeedback.
    # - User.feedbacks_given backref='user' creates a 'user' attribute on HostFeedback.
    # --- End Relationships ---

    def __repr__(self):
        status = "Resolved" if self.is_resolved else "Pending"
        return f'<HostFeedback {self.subject} ({status}) for Host {self.host_id}>'


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\location.py ---
# models/location.py
# This file exists if you have a separate 'locations' table.
# However, based on your recent Car model, you are storing location directly in Car.
# If you are NOT using a separate locations table anymore, you can leave this file minimal
# or remove references to it. If you ARE using it, define it like this:

from . import db
from datetime import datetime

class Location(db.Model):
    """
    Model for predefined pickup/dropoff locations.
    Only use this if you are linking Cars to a central locations table.
    If Car stores address details directly, this model might not be actively used
    for car listings, but could be used for administrative purposes.
    """
    __tablename__ = 'locations'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False) # e.g., "Indiranagar Store"
    city = db.Column(db.String(50), nullable=False)  # e.g., "Bangalore"
    address = db.Column(db.Text)
    latitude = db.Column(db.Float)
    longitude = db.Column(db.Float)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # --- Relationship Definitions ---
    # If you were linking Cars to Location via location_id FK in Car:
    # cars = db.relationship('Car', backref='location', lazy=True)
    # --- End Relationships ---

    def __repr__(self):
        return f'<Location {self.name}, {self.city}>'


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\photo.py ---
# models/photo.py
from . import db
from datetime import datetime


class Photo(db.Model):
    __tablename__ = 'photos'

    id = db.Column(db.Integer, primary_key=True)  # <-- Photo HAS its own primary key
    filename = db.Column(db.String(255), nullable=False)
    # Link to booking for pickup/dropoff association
    booking_id = db.Column(db.Integer, db.ForeignKey('bookings.id'), nullable=False)  # <-- Links to Booking
    photo_type = db.Column(db.String(20), nullable=False)  # 'pickup', 'dropoff'
    uploaded_at = db.Column(db.DateTime, default=datetime.utcnow)

    # --- Relationships ---
    # Relationship to Booking (backref creates 'photos' on Booking)
    booking = db.relationship('Booking', backref='photos')  # Assumes Booking model exists correctly

    # --- End Relationships ---

    def __repr__(self):
        return f'<Photo {self.filename} ({self.photo_type}) for Booking {self.booking_id}>'



--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\rating.py ---
# models/rating.py
from . import db
from datetime import datetime


class Rating(db.Model):
    __tablename__ = 'ratings'
    id = db.Column(db.Integer, primary_key=True)
    booking_id = db.Column(db.Integer, db.ForeignKey('bookings.id'), nullable=False, unique=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    host_id = db.Column(db.Integer, db.ForeignKey('hosts.id'), nullable=False)
    stars = db.Column(db.Integer, nullable=False)  # 1-5
    comment = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # Relationships via backref in Booking, User, Host

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\trip_photo.py ---
# models/trip_photo.py
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from models import db
from datetime import datetime

class TripPhoto(db.Model):
    __tablename__ = 'trip_photos'

    id = Column(Integer, primary_key=True)
    booking_id = Column(Integer, db.ForeignKey('bookings.id'), nullable=False)
    photo_path = Column(String(255), nullable=False) # Store the path relative to upload folder
    upload_type = Column(String(20), nullable=False) # 'start' or 'end'
    uploaded_at = Column(DateTime, default=datetime.utcnow)

    booking = relationship('Booking', back_populates='trip_photos') # Assuming a backref exists in Booking

    def __repr__(self):
        return f'<TripPhoto {self.id} for Booking {self.booking_id} ({self.upload_type})>'

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\user.py ---
# models/user.py (Relevant part)
from . import db
from datetime import datetime
import bcrypt
from flask_login import UserMixin

from .wallet_transaction import WalletTransaction


class User(UserMixin, db.Model):
    __tablename__ = 'users'

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(128))
    phone = db.Column(db.String(20))
    is_admin = db.Column(db.Boolean, default=False)
    is_active = db.Column(db.Boolean, default=True)  # For Flask-Login
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    # Add wallet balance field
    wallet_balance = db.Column(db.Float, default=0.0)  # Add this if missing

    # --- CRITICAL: Ensure this relationship is defined correctly ---
    # This line creates a 'bookings' attribute on User instances
    # AND automatically creates a 'user' attribute on Booking instances via backref.
    bookings = db.relationship('Booking', backref='user', lazy=True)  # <-- MAKE SURE THIS LINE EXISTS
    # --- END CRITICAL ---

    # --- Host Profile Relationship (if applicable) ---
    # This creates a 'host_profile' attribute on User instances
    # AND automatically creates a 'user' attribute on Host instances via backref.
    host_profile = db.relationship('Host', backref='user', uselist=False, lazy=True)  # One user, one host profile

    # --- End Host Profile ---

    def set_password(self, password):
        """Hash and set the user's password."""
        self.password_hash = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')

    def check_password(self, password):
        """Check if the provided password matches the stored hash."""
        return bcrypt.checkpw(password.encode('utf-8'), self.password_hash.encode('utf-8'))

    def add_to_wallet(self, amount):
        """Add funds to the user's wallet."""
        self.wallet_balance += amount
        db.session.commit()

    def deduct_from_wallet(self, amount):
        """Deduct funds from the user's wallet."""
        if self.wallet_balance >= amount:
            self.wallet_balance -= amount
            db.session.commit()
            return True
        return False

    def __repr__(self):
        return f'<User {self.username}>'

    def get_wallet_transactions(self, limit=None):
        """
        Get the user's wallet transactions, sorted by timestamp descending.
        Args:
            limit (int, optional): Maximum number of transactions to return.
        Returns:
            list: List of WalletTransaction objects.
        """
        query = WalletTransaction.query.filter_by(user_id=self.id).order_by(
            WalletTransaction.timestamp.desc()
        )
        if limit:
            query = query.limit(limit)
        return query.all()

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\wallet_transaction.py ---
# models/wallet_transaction.py
from . import db
from datetime import datetime

class WalletTransaction(db.Model):
    __tablename__ = 'wallet_transactions'

    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)

    # --- Transaction Details ---
    transaction_type = db.Column(db.String(20), nullable=False) # deposit, withdrawal, earning, deduction, refund, bonus, penalty
    amount = db.Column(db.Float, nullable=False) # The amount of the transaction
    balance_after = db.Column(db.Float, nullable=False) # Running balance after transaction
    description = db.Column(db.String(255), nullable=False) # Human-readable description
    # --- End Transaction Details ---

    # --- Reference to Related Entity ---
    # Allows linking this transaction to, e.g., a Booking, Host Earning, Admin Action
    reference_id = db.Column(db.Integer) # Generic ID
    reference_type = db.Column(db.String(50)) # 'booking', 'host_earning', 'admin_action', 'cancellation_fee', 'refund', etc.
    # --- End Reference ---

    timestamp = db.Column(db.DateTime, default=datetime.utcnow)

    # --- Relationship Definitions ---
    # Relationship to User (backref creates 'wallet_transactions' on User)
    user = db.relationship('User', backref='wallet_transactions')
    # --- End Relationships ---

    def __repr__(self):
        return f'<WalletTransaction {self.id}: {self.transaction_type} ₹{self.amount} for User {self.user_id}>'

    @classmethod
    def record_transaction(cls, user, amount, transaction_type, description, reference_id=None, reference_type=None):
        """
        Record a wallet transaction for a user.
        Args:
            user (User): The User object.
            amount (float): The amount of the transaction.
            transaction_type (str): Type of transaction.
            description (str): Description of the transaction.
            reference_id (int, optional): ID of related entity.
            reference_type (str, optional): Type of related entity.
        Returns:
            WalletTransaction: The created transaction object.
        """
        # Calculate new balance based on transaction type
        if transaction_type in ['deposit', 'earning', 'refund', 'bonus']:
            new_balance = user.wallet_balance + amount
        elif transaction_type in ['withdrawal', 'deduction', 'penalty']:
            new_balance = user.wallet_balance - amount
        else:
            raise ValueError(f"Invalid transaction type: {transaction_type}")

        # Create transaction record
        transaction = cls(
            user_id=user.id,
            amount=amount,
            transaction_type=transaction_type,
            description=description[:255], # Truncate description
            balance_after=round(new_balance, 2),
            reference_id=reference_id,
            reference_type=reference_type,
            timestamp=datetime.utcnow()
        )

        # Update user's wallet balance in memory (actual DB update happens in calling function)
        # This assumes user.add_to_wallet/deduct_from_wallet handles DB persistence
        if transaction_type in ['deposit', 'earning', 'refund', 'bonus']:
            user.wallet_balance = new_balance # Update in memory
        elif transaction_type in ['withdrawal', 'deduction', 'penalty']:
            user.wallet_balance = new_balance # Update in memory

        db.session.add(transaction) # Add transaction to session
        # Note: Don't commit here, let the caller handle the transaction
        return transaction

# --- Helper Methods for Recording Specific Transaction Types ---
# These can be called from booking/host logic to record specific events

    @classmethod
    def record_booking_payment(cls, user, booking, amount_paid):
        """Record a user paying for a booking."""
        description = f"Payment for Booking #{booking.id}"
        return cls.record_transaction(
            user=user,
            amount=amount_paid,
            transaction_type='deduction', # User pays out
            description=description,
            reference_id=booking.id,
            reference_type='booking_payment'
        )

    @classmethod
    def record_booking_refund(cls, user, booking, refund_amount):
        """Record a refund issued to a user for a booking."""
        description = f"Refund for Booking #{booking.id}"
        return cls.record_transaction(
            user=user,
            amount=refund_amount,
            transaction_type='refund', # User receives money back
            description=description,
            reference_id=booking.id,
            reference_type='booking_refund'
        )

    @classmethod
    def record_host_earning(cls, host_user, booking, earning_amount): # Pass the User object associated with the host
        """Record earnings credited to a host's wallet for a completed booking."""
        description = f"Earnings from Booking #{booking.id}"
        return cls.record_transaction(
            user=host_user, # The User object linked to the Host
            amount=earning_amount,
            transaction_type='earning', # Host earns money
            description=description,
            reference_id=booking.id,
            reference_type='host_earning'
        )

    @classmethod
    def record_cancellation_fee(cls, user, booking, fee_amount):
        """Record a cancellation fee deducted from a user's wallet."""
        description = f"Cancellation Fee for Booking #{booking.id}"
        return cls.record_transaction(
            user=user,
            amount=fee_amount,
            transaction_type='deduction', # User pays fee
            description=description,
            reference_id=booking.id,
            reference_type='cancellation_fee'
        )

    @classmethod
    def record_manual_adjustment(cls, user, amount, admin_user, reason):
        """Record a manual adjustment made by an admin."""
        transaction_type = 'deposit' if amount >= 0 else 'deduction'
        description = f"Manual Adjustment by {admin_user.username}: {reason}"
        # Use absolute value for amount if deduction logic is handled by transaction_type
        abs_amount = abs(amount)
        return cls.record_transaction(
            user=user,
            amount=abs_amount,
            transaction_type=transaction_type,
            description=description,
            reference_id=admin_user.id, # Reference admin who made the adjustment
            reference_type='admin_adjustment'
        )

    @classmethod
    def record_deposit(cls, user, amount, payment_method_details=""):
        """Record a user depositing money into their wallet."""
        description = f"Deposit via {payment_method_details}" if payment_method_details else "Wallet Deposit"
        return cls.record_transaction(
            user=user,
            amount=amount,
            transaction_type='deposit',
            description=description,
            reference_type='deposit' # No specific reference ID needed unless tied to a payment gateway transaction
        )

    @classmethod
    def record_withdrawal(cls, user, amount, withdrawal_reference=""):
        """Record a user withdrawing money from their wallet."""
        description = f"Withdrawal Request {withdrawal_reference}" if withdrawal_reference else "Wallet Withdrawal"
        return cls.record_transaction(
            user=user,
            amount=amount,
            transaction_type='withdrawal',
            description=description,
            reference_id=user.id, # Or a specific withdrawal request ID
            reference_type='withdrawal'
        )
# --- End Helper Methods ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\models\__init__.py ---
from flask_sqlalchemy import SQLAlchemy

# Create db instance here - this will be imported by other modules
db = SQLAlchemy()

# Don't import models here to avoid circular imports
# Models will import db from this module

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\api.py ---
from flask import Blueprint, jsonify, request
from models import db
from models.car import Car
from models.location import Location
from models.booking import Booking
from utils.distance_calculator import calculate_distance
from datetime import datetime

api_bp = Blueprint('api', __name__)


@api_bp.route('/cars')
def api_cars():
    """Get all available cars with optional filters"""
    location_id = request.args.get('location_id', type=int)
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')

    # Base query for available cars
    query = Car.query.filter_by(is_available=True)

    # Apply location filter
    if location_id:
        query = query.filter_by(location_id=location_id)

    cars = query.all()

    # Convert to JSON
    cars_data = []
    for car in cars:
        car_dict = {
            'id': car.id,
            'make': car.make,
            'model': car.model,
            'year': car.year,
            'price_per_day': car.price_per_day,
            'color': car.color,
            'mileage': car.mileage,
            'fuel_type': car.fuel_type,
            'transmission': car.transmission,
            'seats': car.seats,
            'location': {
                'id': car.location.id,
                'name': car.location.name,
                'city': car.location.city,
                'latitude': car.location.latitude,
                'longitude': car.location.longitude
            },
            'images': [{'filename': img.filename, 'is_primary': img.is_primary} for img in car.images]
        }
        cars_data.append(car_dict)

    return jsonify(cars_data)


@api_bp.route('/locations')
def api_locations():
    """Get all locations"""
    locations = Location.query.all()
    locations_data = []

    for location in locations:
        locations_data.append({
            'id': location.id,
            'name': location.name,
            'city': location.city,
            'address': location.address,
            'latitude': location.latitude,
            'longitude': location.longitude
        })

    return jsonify(locations_data)


@api_bp.route('/search')
def api_search():
    """Search cars with location and date filters"""
    location_id = request.args.get('location_id', type=int)
    lat = request.args.get('lat', type=float)
    lng = request.args.get('lng', type=float)
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')

    # Base query
    query = Car.query.filter_by(is_available=True)

    # Apply filters
    if location_id:
        query = query.filter_by(location_id=location_id)

    cars = query.all()

    # Add distance calculation if coordinates provided
    if lat and lng:
        for car in cars:
            car.distance = calculate_distance(
                lat, lng,
                car.location.latitude, car.location.longitude
            )
        # Sort by distance
        cars.sort(key=lambda x: getattr(x, 'distance', float('inf')))

    # Convert to JSON with distance info
    cars_data = []
    for car in cars:
        car_dict = {
            'id': car.id,
            'make': car.make,
            'model': car.model,
            'year': car.year,
            'price_per_day': car.price_per_day,
            'distance': getattr(car, 'distance', None),
            'location': {
                'name': car.location.name,
                'city': car.location.city
            },
            'primary_image': car.images[0].filename if car.images else None
        }
        cars_data.append(car_dict)

    return jsonify(cars_data)


@api_bp.route('/car/<int:car_id>')
def api_car_detail(car_id):
    """Get detailed car information"""
    car = Car.query.get_or_404(car_id)

    car_data = {
        'id': car.id,
        'make': car.make,
        'model': car.model,
        'year': car.year,
        'price_per_day': car.price_per_day,
        'color': car.color,
        'mileage': car.mileage,
        'fuel_type': car.fuel_type,
        'transmission': car.transmission,
        'seats': car.seats,
        'is_available': car.is_available,
        'location': {
            'id': car.location.id,
            'name': car.location.name,
            'city': car.location.city,
            'address': car.location.address,
            'latitude': car.location.latitude,
            'longitude': car.location.longitude
        },
        'images': [{'filename': img.filename, 'is_primary': img.is_primary} for img in car.images],
        'specifications': {
            'engine': '1.5L',
            'ac': True,
            'music_system': True,
            'airbags': 2
        }
    }

    return jsonify(car_data)


@api_bp.route('/bookings', methods=['POST'])
def api_create_booking():
    """Create booking via API"""
    data = request.get_json()

    # Validate required fields
    required_fields = ['car_id', 'start_date', 'end_date', 'user_id']
    for field in required_fields:
        if field not in data:
            return jsonify({'error': f'Missing required field: {field}'}), 400

    car_id = data['car_id']
    user_id = data['user_id']
    start_date_str = data['start_date']
    end_date_str = data['end_date']

    # Convert dates
    try:
        start_date = datetime.strptime(start_date_str, '%Y-%m-%d')
        end_date = datetime.strptime(end_date_str, '%Y-%m-%d')
    except ValueError:
        return jsonify({'error': 'Invalid date format. Use YYYY-MM-DD'}), 400

    # Validate dates
    if end_date <= start_date:
        return jsonify({'error': 'End date must be after start date'}), 400

    # Check car availability
    car = Car.query.get(car_id)
    if not car or not car.is_available:
        return jsonify({'error': 'Car not available'}), 400

    # Check for existing bookings
    existing_booking = Booking.query.filter(
        Booking.car_id == car_id,
        Booking.status.in_(['pending', 'confirmed']),
        Booking.start_date < end_date,
        Booking.end_date > start_date
    ).first()

    if existing_booking:
        return jsonify({'error': 'Car is not available for the selected dates'}), 400

    # Calculate price
    total_days = (end_date - start_date).days
    total_price = total_days * car.price_per_day

    # Create booking
    booking = Booking(
        user_id=user_id,
        car_id=car_id,
        start_date=start_date,
        end_date=end_date,
        total_price=total_price,
        status='pending'
    )

    db.session.add(booking)
    db.session.commit()

    return jsonify({
        'message': 'Booking created successfully',
        'booking_id': booking.id,
        'total_price': total_price,
        'total_days': total_days
    }), 201


@api_bp.route('/user/<int:user_id>/bookings')
def api_user_bookings(user_id):
    """Get user's bookings"""
    bookings = Booking.query.filter_by(user_id=user_id).order_by(Booking.created_at.desc()).all()

    bookings_data = []
    for booking in bookings:
        bookings_data.append({
            'id': booking.id,
            'car': {
                'id': booking.car.id,
                'make': booking.car.make,
                'model': booking.car.model,
                'year': booking.car.year
            },
            'start_date': booking.start_date.isoformat(),
            'end_date': booking.end_date.isoformat(),
            'total_price': booking.total_price,
            'status': booking.status,
            'created_at': booking.created_at.isoformat()
        })

    return jsonify(bookings_data)

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\auth.py ---
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required
# routes/auth.py (Relevant part - register function)
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user
from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, SubmitField
from wtforms.fields.simple import BooleanField
from wtforms.validators import DataRequired, Email, Length
from models.user import User, db

auth_bp = Blueprint('auth', __name__)


class RegistrationForm(FlaskForm):
    """WTForm for user registration"""
    username = StringField('Username', validators=[DataRequired(), Length(min=3, max=80)])
    email = StringField('Email', validators=[DataRequired(), Email(), Length(max=120)])
    phone = StringField('Phone', validators=[DataRequired(), Length(min=10, max=20)])
    password = PasswordField('Password', validators=[DataRequired(), Length(min=6)])
    submit = SubmitField('Register')


# --- CRITICAL FIX 2: Define LoginForm using WTForms ---
class LoginForm(FlaskForm):
    """WTForm for user login"""
    email = StringField('Email', validators=[DataRequired(), Email()])
    password = PasswordField('Password', validators=[DataRequired()])
    remember_me = BooleanField('Remember Me')
    submit = SubmitField('Sign In')
# --- END CRITICAL FIX 2 ---

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    """
    User login page.
    This is the 'auth.login' endpoint.
    """
    # --- CRITICAL FIX 3: Instantiate the LoginForm ---
    form = LoginForm()  # Create an instance of the form
    # --- END CRITICAL FIX 3 ---

    if request.method == 'POST':
        # --- CRITICAL FIX 4: Use form validation ---
        # BEFORE (Manual validation)
        # email = request.form['email']
        # password = request.form['password']
        # remember = bool(request.form.get('remember_me'))
        # user = User.query.filter_by(email=email).first()
        # if user and user.check_password(password):
        #     login_user(user, remember=remember)
        #     return redirect(url_for('car.home'))
        # else:
        #     flash('Invalid email or password')

        # AFTER (WTForms validation)
        if form.validate_on_submit():  # This checks CSRF token and other validations
            email = form.email.data.strip().lower()
            password = form.password.data
            remember = form.remember_me.data

            user = User.query.filter_by(email=email).first()

            if user and user.check_password(password):
                login_user(user, remember=remember)
                flash('Login successful!', 'success')
                # Redirect to next page or car home
                next_page = request.args.get('next')
                return redirect(next_page) if next_page else redirect(url_for('car.home'))
            else:
                flash('Invalid email or password.', 'danger')
        else:
            # Form validation failed (CSRF, missing fields, etc.)
            flash('Please check your input and try again.', 'danger')
        # --- END CRITICAL FIX 4 ---

    # For GET request or failed validation, render the form
    # Pass the form instance to the template
    return render_template('login.html', form=form)  # <-- Pass the form instance





@auth_bp.route('/register', methods=['GET', 'POST'])
def register():
    """User registration page"""
    form = RegistrationForm()  # Instantiate the form

    if form.validate_on_submit():  # This checks CSRF token and other validations
        username = form.username.data.strip()
        email = form.email.data.strip().lower()
        phone = form.phone.data.strip()
        password = form.password.data

        # Check if user exists
        if User.query.filter_by(email=email).first():
            flash('Email already registered', 'danger')
            return render_template('register.html', form=form)  # Pass form back

        # Create new user
        user = User(username=username, email=email, phone=phone)
        user.set_password(password)
        db.session.add(user)

        try:
            db.session.commit()
            flash('Registration successful! Please login.', 'success')
            return redirect(url_for('auth.login'))
        except Exception as e:
            db.session.rollback()
            flash(f'Error during registration: {str(e)}', 'danger')
            return render_template('register.html', form=form)  # Pass form back

    # For GET request or failed validation, render the form
    # Pre-populate form with request data if available (for errors)
    return render_template('register.html', form=form)  # Pass the form instance


@auth_bp.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('car.home'))

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\booking.py ---
# routes/booking.py
import hashlib
import hmac
from datetime import datetime, timedelta
from flask_wtf.csrf import CSRFProtect  # ✅ Keep this if you need CSRF globally
from flask import Blueprint, render_template, request, redirect, url_for, flash, session, jsonify, current_app
from flask_login import login_required, current_user
from razorpay.errors import SignatureVerificationError

# Import the Booking model correctly from models
from models.booking import Booking # <-- Import from models, not defined here
from models.car import Car
from models import db # Import db for session operations
# Import Razorpay
import razorpay
import os
# AFTER (Correct - Import the csrf instance)
# --- END CRITICAL FIX 1 ---
# csrf = CSRFProtect()
booking_bp = Blueprint('booking', __name__, url_prefix='/booking')

# --- Razorpay Client Initialization ---
RAZORPAY_KEY_ID = os.getenv('RAZORPAY_KEY_ID')
RAZORPAY_KEY_SECRET = os.getenv('RAZORPAY_KEY_SECRET')

# Initialize Razorpay client
if RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET:
    try:
        razorpay_client = razorpay.Client(auth=(RAZORPAY_KEY_ID, RAZORPAY_KEY_SECRET))
        razorpay_client.set_app_details({"title": "ZoomCarClone", "version": "1.0"})
    except Exception as e:
        current_app.logger.error(f"Error initializing Razorpay client: {e}")
        razorpay_client = None
else:
    current_app.logger.warning("Razorpay keys not found in environment variables.")
    razorpay_client = None
# --- End Razorpay Client ---

# --- Route Definitions ---
# ... (Keep your existing route functions like list_bookings, booking_detail, initiate_booking, process_payment, handle_payment) ...
# Make sure they import Booking from models.booking, not define it.

@booking_bp.route('/')
@login_required
def list_bookings():
    """List user's bookings"""
    bookings = Booking.query.filter_by(user_id=current_user.id).order_by(Booking.created_at.desc()).all()
    return render_template('user/bookings/list.html', bookings=bookings)

from datetime import timedelta

@booking_bp.route('/<int:booking_id>')
@login_required
def booking_detail(booking_id):
    booking = Booking.query.get_or_404(booking_id)
    if booking.user_id != current_user.id:
        flash('Access denied')
        return redirect(url_for('car.home'))

    # ✅ CALCULATE min_extension_date HERE — in Python, not template
    min_extension_date = booking.end_date + timedelta(days=1)

    return render_template(
        'user/bookings/detail.html',
        booking=booking,
        min_extension_date=min_extension_date  # ✅ Pass it to template
    )


@booking_bp.route('/initiate/<int:car_id>', methods=['GET']) # <-- ADD GET method
@login_required
def show_booking_initiation(car_id):
    """Display the booking initiation page for a specific car.
    This handles GET requests to '/booking/initiate/<car_id>'.
    """
    car = Car.query.get_or_404(car_id)
    # Calculate default dates (e.g., tomorrow for 2 hours)
    default_start_datetime = datetime.now() + timedelta(hours=1)
    default_end_datetime = default_start_datetime + timedelta(hours=2)

    # Pass car details and default dates to template
    return render_template(
        'booking/initiate.html', # Ensure this template exists
        car=car,
        default_start_datetime=default_start_datetime,
        default_end_datetime=default_end_datetime
    )


# --- END NEW GET ROUTE ---

# --- EXISTING POST ROUTE: Process Booking Initiation ---
@booking_bp.route('/initiate/<int:car_id>', methods=['POST'])
@login_required
def initiate_booking(car_id):
    """Initiate a booking for a specific car."""
    car = Car.query.get_or_404(car_id)

    start_datetime_str = request.form.get('start_datetime')
    end_datetime_str = request.form.get('end_datetime')

    try:
        start_datetime = datetime.strptime(start_datetime_str, '%Y-%m-%dT%H:%M') # Format for datetime-local input
        end_datetime = datetime.strptime(end_datetime_str, '%Y-%m-%dT%H:%M')
    except ValueError:
        flash('Invalid date/time format.')
        return redirect(url_for('booking.show_booking_initiation', car_id=car_id))

    if end_datetime <= start_datetime:
        flash('End date/time must be after start date/time.')
        return redirect(url_for('booking.show_booking_initiation', car_id=car_id))

    # Calculate duration and price (simplified) - Now uses hours
    duration_hours = (end_datetime - start_datetime).total_seconds() / 3600
    if duration_hours <= 0:
        duration_hours = 1
    total_price = round(duration_hours * car.price_per_hour, 2) # Round to 2 decimal places

    # - Core Booking Creation Logic -
    # Check for existing conflicting bookings (simplified)
    existing_booking = Booking.query.filter(
        Booking.car_id == car_id,
        Booking.status.in_(['pending', 'approved', 'paid', 'active']), # Consider different statuses
        Booking.start_date < end_datetime,
        Booking.end_date > start_datetime
    ).first()

    if existing_booking:
        flash('Car is not available for the selected date/time range.')
        return redirect(url_for('booking.show_booking_initiation', car_id=car_id))

    # Create new booking record
    booking = Booking(
        user_id=current_user.id,
        car_id=car_id,
        start_date=start_datetime, # Store as datetime
        end_date=end_datetime,     # Store as datetime
        # total_price will be set by the SQLAlchemy hook before_insert/before_update
        # total_price=total_price, # Commented out, hook will set it
        status='pending', # Initial status might be pending host approval
        payment_status='pending' # Payment status before payment
        # Add other fields as needed
    )
    # Explicitly call the update method just before adding to session
    # This ensures the price is calculated based on the current values before the hook runs
    booking.update_price_before_save()
    db.session.add(booking)
    db.session.commit()

    flash('Booking initiated! Please complete the payment.')
    # Redirect to payment processing route
    return redirect(url_for('booking.process_payment', booking_id=booking.id))


# --- END EXISTING POST ROUTE ---

@booking_bp.route('/bookings/<int:booking_id>/complete-payment', methods=['POST']) # <-- New Route
@login_required
def complete_payment(booking_id):
    """
    Initiate Razorpay payment for a booking directly.
    This is the 'booking.complete_payment' endpoint.
    """
    booking = Booking.query.get_or_404(booking_id)

    # --- Authorization Check ---
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))
    # --- End Authorization ---

    # --- Check if Booking can be Paid ---
    if not booking.can_be_paid(): # Assuming you have this method in Booking model
        flash('This booking cannot be paid at this time.')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))
    # --- End Check ---

    # --- Razorpay Integration ---
    if not razorpay_client:
        flash('Payment gateway is currently unavailable. Please try again later.', 'danger')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))

    try:
        # Create a Razorpay Order
        order_data = {
            'amount': int(booking.total_price * 100), # Razorpay expects amount in paise
            'currency': 'INR',
            'receipt': f"booking_receipt_{booking.id}",
            'payment_capture': 1 # Auto-capture payment
        }
        razorpay_order = razorpay_client.order.create(order_data)
        razorpay_order_id = razorpay_order['id']

        # Store order ID in booking
        booking.razorpay_order_id = razorpay_order_id
        db.session.commit()

        # --- Prepare Context for Razorpay Checkout Template ---
        context = {
            'booking': booking,
            'razorpay_key_id': RAZORPAY_KEY_ID,
            'razorpay_order_id': razorpay_order_id,
            'total_amount_paise': int(booking.total_price * 100),
            'total_amount_rupees': booking.total_price
        }

        # --- Render Razorpay Checkout Template Directly ---
        # This template will contain the Razorpay Checkout.js script
        return render_template('booking/razorpay_checkout.html', **context)

    except razorpay.errors.RazorpayError as e:
        print(f"Razorpay API error: {e}")
        flash('Failed to initiate payment. Please try again.', 'danger')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))
    except Exception as e:
        db.session.rollback()
        print(f"Unexpected error in complete_payment: {e}")
        flash('An unexpected error occurred. Please try again.', 'danger')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))
    # --- End Razorpay Integration ---

# ... (rest of routes/booking.py - handle_payment, etc.) ...


# --- EXISTING PAYMENT ROUTES ---
# routes/booking.py (Relevant part - process_payment function)
# ... (imports and razorpay_client initialization remain the same) ...

@booking_bp.route('/<int:booking_id>/process_payment', methods=['GET'])
@login_required
def process_payment(booking_id):
    """Initiate Razorpay payment for a specific booking.
    This is the 'booking.process_payment' endpoint."""
    booking = Booking.query.get_or_404(booking_id)

    # - Authorization Check -
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))
    # - End Authorization -

    # - Check if Booking can be Paid -
    if not booking.can_be_paid(): # Assuming you have this method in Booking model
        flash('This booking cannot be paid at this time.')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))
    # - End Check -

    # - Razorpay Integration -
    if not razorpay_client:
        flash('Payment gateway is currently unavailable. Please try again later.', 'danger')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))

    try:
        # Create a Razorpay Order
        order_data = {
            "amount": int(booking.total_price * 100),  # Razorpay expects amount in paise
            "currency": "INR",
            "receipt": f"booking_receipt_{booking.id}",
            "payment_capture": 1 # Auto-capture payment
        }
        razorpay_order = razorpay_client.order.create(order_data)
        razorpay_order_id = razorpay_order['id']

        # --- CRITICAL FIX: Store order ID in booking and commit ---
        # This ensures the order ID is saved to the database before the payment popup opens
        booking.razorpay_order_id = razorpay_order_id
        db.session.commit() # This is crucial!
        # --- END CRITICAL FIX ---

        # Prepare context for Razorpay Checkout Template
        context = {
            'booking': booking,
            'razorpay_key_id': RAZORPAY_KEY_ID,
            'razorpay_order_id': razorpay_order_id,
            'total_amount_paise': int(booking.total_price * 100),
            'total_amount_rupees': booking.total_price
        }

        # Render Razorpay Checkout Template Directly
        # This template will contain the Razorpay Checkout.js script
        return render_template('booking/razorpay_checkout.html', **context)

    # - CRITICAL FIX: Catch the correct Razorpay exception -
    # AFTER (Correct - Catch specific known errors or general Exception)
    except razorpay.errors.BadRequestError as e: # Catch specific known Razorpay API errors
        print(f"Razorpay API error (BadRequest): {e}")
        flash(f'Failed to initiate payment: {str(e)}', 'danger')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))
    except Exception as e: # Catch any other unexpected errors from Razorpay SDK
        db.session.rollback()
        print(f"Unexpected error in process_payment: {e}")
        flash('An unexpected error occurred during payment processing. Please try again.', 'danger')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))
    # - END CRITICAL FIX -
    # - End Razorpay Integration -


# routes/booking.py (Updated handle_payment route)
# ... (imports and razorpay_client initialization remain the same) ...

# --- EXISTING PAYMENT ROUTES ---
# routes/booking.py (Updated handle_payment route)

@booking_bp.route('/payment-handler', methods=['POST'])
def handle_payment():
    """
    Handle Razorpay payment callback/verification via AJAX from frontend.
    This endpoint receives the payment details from the frontend JS after
    the Razorpay popup closes and verifies the signature before updating the booking.
    """
    current_app.logger.info("handle_payment route called.")

    # --- CRITICAL FIX 1: Ensure CSRF token is present (from frontend AJAX call) ---
    # The frontend JS (razorpaycheckout.html) sends the CSRF token in the headers.
    csrf_token = request.headers.get('X-CSRFToken')
    if not csrf_token:
        current_app.logger.warning("CSRF token missing from payment handler request (X-CSRFToken header).")
        return jsonify({'success': False, 'message': 'CSRF token is missing.'}), 400
    # --- END CRITICAL FIX 1 ---

    # --- CRITICAL FIX 1: Robust Razorpay Client Check ---
    if not razorpay_client:
        current_app.logger.error("Razorpay client is not initialized.")
        # Return JSON error for AJAX handler
        return jsonify(
            {'success': False, 'message': 'Payment gateway is currently unavailable. Please try again later.'}), 500
    # --- END CRITICAL FIX 1 ---

    try:
        # --- CRITICAL FIX 2: Get payment details from JSON request body ---
        data = request.get_json()  # <-- Use get_json() for application/json content-type
        current_app.logger.info(f"Received JSON data: {data}")
        # --- END CRITICAL FIX 2 ---

        # --- CRITICAL FIX 3: Validate required payment data from JSON ---
        if not data:
            current_app.logger.warning("handle_payment received no JSON data.")
            return jsonify({'success': False, 'message': 'Invalid payment data received (No JSON payload).'}), 400

        payment_id = data.get('razorpay_payment_id')
        order_id = data.get('razorpay_order_id')
        signature = data.get('razorpay_signature')

        if not all([payment_id, order_id, signature]):
            current_app.logger.warning(
                f"handle_payment received incomplete JSON data: payment_id={payment_id}, order_id={order_id}, signature={signature}")
            return jsonify(
                {'success': False, 'message': 'Invalid payment data received. Missing required fields.'}), 400
        # --- END CRITICAL FIX 3 ---

        # --- CRITICAL FIX 4: Verify the payment signature using HMAC SHA256 ---
        try:
            # Create the expected signature string
            signature_data = f"{order_id}|{payment_id}"
            # Generate the expected signature using HMAC-SHA256
            expected_signature = hmac.new(
                key=RAZORPAY_KEY_SECRET.encode(),
                msg=signature_data.encode(),
                digestmod=hashlib.sha256
            ).hexdigest()

            # Securely compare the signatures
            if not hmac.compare_digest(expected_signature, signature):
                current_app.logger.warning(f"Payment verification failed: Signature mismatch for order {order_id}.")
                return jsonify({'success': False, 'message': 'Payment verification failed. Signature mismatch.'}), 400

            result = True  # If no exception and signatures match
            current_app.logger.info(f"Payment signature verified successfully for order {order_id}.")
        except Exception as e:
            current_app.logger.error(f"Error during signature verification: {e}")
            return jsonify({'success': False, 'message': f'Payment verification error: {str(e)}'}), 400
        # --- END CRITICAL FIX 4 ---

        if result:
            # Payment signature verified successfully
            # --- CRITICAL FIX 5: Fetch booking by razorpay_order_id ---
            # Find the booking associated with this Razorpay order ID
            booking = Booking.query.filter_by(razorpay_order_id=order_id).first()
            if not booking:
                current_app.logger.warning(f"handle_payment: Booking not found for Razorpay order ID {order_id}")
                # Return 404 JSON for AJAX handler
                return jsonify({'success': False, 'message': 'Booking record not found for this payment.'}), 404
            # --- END CRITICAL FIX 5 ---

            # --- CRITICAL FIX 6: Authorization Check (Frontend JS Call) ---
            # This endpoint is called by the frontend JS *after* payment.
            # The frontend JS runs in the context of the logged-in user.
            # Therefore, `current_user` should be available here.
            # Verify that the booking belongs to the current user.
            if booking.user_id != current_user.id:
                 current_app.logger.warning(f"handle_payment: Access denied for user {current_user.id} on booking {booking.id}")
                 return jsonify({'success': False, 'message': 'Booking not found or access denied.'}), 403 # Use 403 Forbidden
            # --- END CRITICAL FIX 6 ---

            # --- CRITICAL FIX 7: Prevent Double Payment ---
            # Check if booking payment is already completed
            if booking.payment_status == 'completed':
                current_app.logger.info(f"handle_payment: Payment already processed for booking {booking.id}")
                # Already processed - Return success JSON for AJAX handler
                return jsonify({
                    'success': True,
                    'message': 'Payment already processed for this booking.',
                    'redirect_url': url_for('booking.booking_detail', booking_id=booking.id)
                })
            # --- END CRITICAL FIX 7 ---

            # --- CRITICAL FIX 8: Update booking status and host wallet ---
            # Use the model's method to mark payment as completed
            # This ensures consistency with the logic defined in the Booking model
            # The total_price used here is already calculated based on hours and price_per_hour
            if booking.mark_as_paid(razorpay_payment_id=payment_id):
                db.session.commit()
                current_app.logger.info(f"handle_payment: Payment successful and booking {booking.id} updated.")
                # Return success JSON for AJAX handler
                # Assuming called by frontend JS after Razorpay popup closes
                return jsonify({
                    'success': True,
                    'message': 'Payment successful! Your booking is confirmed.',
                    'redirect_url': url_for('booking.booking_detail', booking_id=booking.id)
                })
            else:
                db.session.rollback()
                current_app.logger.error(
                    f"handle_payment: Failed to mark booking {booking.id} as paid after verification.")
                return jsonify(
                    {'success': False, 'message': 'Failed to update booking status after payment verification.'}), 500
            # --- END CRITICAL FIX 8 ---

        else:
            # Payment signature verification failed
            current_app.logger.warning(f"handle_payment: Payment verification explicitly failed for order {order_id}")
            return jsonify({'success': False, 'message': 'Payment verification failed.'}), 400

    # --- CRITICAL FIX 9: Specific Razorpay signature error handling ---
    # AFTER (Corrected - Moved specific handling inside main try block)
    # The specific SignatureVerificationError is now caught by the inner try-except
    # Only catch general exceptions here for truly unexpected issues
    except Exception as e:
        # Handle other unexpected errors (network issues, JSON parsing, etc.)
        db.session.rollback()
        current_app.logger.exception(f"Unexpected error in handle_payment: {e}")
        return jsonify({'success': False,
                        'message': 'An unexpected error occurred during payment processing. Please try again or contact support.'}), 500

    # --- END CRITICAL FIX 9 ---


# --- End Payment Handler ---    # --- End Payment Handler ---
# --- End Route Definitions ---
@booking_bp.route('/my-bookings')  # This creates endpoint 'booking.my_bookings'
@login_required
def my_bookings():
    """
    Display the current user's bookings.
    This is the 'booking.my_bookings' endpoint.
    Could be an alias for list_bookings or have specific logic.
    """
    # This could simply delegate to list_bookings
    # return list_bookings() # If list_bookings is a callable function

    # Or implement specific logic here
    bookings = Booking.query.filter_by(user_id=current_user.id).order_by(Booking.created_at.desc()).all()
    return render_template('user/bookings/list.html', bookings=bookings)  # Use appropriate template


# routes/booking.py (Add this new route at the end)
# ... (existing imports and routes) ...


@booking_bp.route('/bookings/<int:booking_id>/cancel', methods=['POST'])
@login_required
def cancel_booking(booking_id):
    """
    Cancel a booking by the user.
    This is the 'booking.cancel_booking' endpoint.
    """
    booking = Booking.query.get_or_404(booking_id)

    # Check if user owns this booking
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    # Check if booking can be cancelled by user
    if not booking.can_be_cancelled_by_user():
        flash('This booking cannot be cancelled at this time.', 'warning')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))

    # Get reason from form
    reason = request.form.get('reason', '').strip()
    if reason == 'Other':
        reason = request.form.get('other_reason', '').strip()

    if not reason:
        flash('Please provide a reason for cancellation.', 'danger')
        return redirect(url_for('booking.booking_detail', booking_id=booking_id))

    # Attempt to cancel
    try:
        if booking.cancel_by_user(reason):
            db.session.commit()
            flash(
                f'Booking #{booking.id} cancelled successfully. A refund of ₹{booking.refund_amount:.2f} will be processed.',
                'success')
        else:
            flash('Failed to cancel booking.', 'danger')
    except Exception as e:
        db.session.rollback()
        print(f"Error cancelling booking: {e}")
        flash('An error occurred while cancelling the booking.', 'danger')

    return redirect(url_for('booking.booking_detail', booking_id=booking_id))

# ... (rest of routes/booking.py) ...

def get_min_extension_date(self):
    """Returns the earliest possible date for an extension (1 day after end)."""
    return self.end_date + timedelta(days=1)


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\car.py ---
# routes/car.py
from datetime import timedelta, datetime

from flask import Blueprint, render_template, request, jsonify, redirect, url_for, flash, session
from flask_login import current_user, login_required
from flask_wtf import FlaskForm
from wtforms.fields.datetime import DateField
from wtforms.fields.simple import SubmitField
from wtforms.validators import DataRequired

from models import db
from models.booking import Booking
from models.car import Car
# from models.location import Location # If you still use Location model for other purposes
# Import the distance calculator utility
from utils.distance_calculator import calculate_distance
# Import requests for the Nominatim API call
import requests

from .booking import booking_bp

# Import the filter manager function
# --- CORRECTED IMPORT ---
# Ensure this path matches your actual project structure.
# Based on the conversation, filters are in routes/user/filters/
# and the manager function is apply_filters_to_query in routes/user/filters/filters.py
try:
    # Attempt relative import if filters are within the routes package structure
    from .user.filters.filters import apply_filters_to_query
except ImportError:
    # Fallback if filters are in a different structure or need absolute import
    # Adjust 'your_app_package' to your actual package name if needed
    # from your_app_package.routes.user.filters.filters import apply_filters_to_query
    # Or if filters are directly importable (e.g., added to sys.path or __init__.py)
    # Make sure this path is correct for YOUR project structure
    from routes.user.filters.filters import apply_filters_to_query
# --- END CORRECTED IMPORT ---

# Create the 'car' blueprint. The name 'car' determines the prefix for endpoint names (e.g., 'car.home')
car_bp = Blueprint('car', __name__)

class BookingInitiationForm(FlaskForm):
    """Simple form for initiating a booking (dates + CSRF)"""
    start_date = DateField('Start Date', validators=[DataRequired()])
    end_date = DateField('End Date', validators=[DataRequired()])
    submit = SubmitField('Book Now')

# --- Route for Homepage ---
# Ensure this route is defined only ONCE
@car_bp.route('/')
def home():
    """
    Display the homepage.
    This is the 'car.home' endpoint.
    """
    # If you need to pass locations or other data to the homepage template, do it here.
    # For example, if you want to show popular cities or areas:
    # locations = Location.query.order_by(Location.city, Location.name).all()
    # return render_template('home.html', locations=locations)

    # For now, just render the homepage template.
    return render_template('home.html')


# --- End Homepage Route ---

# --- Route for Car Listing/Search ---
@car_bp.route('/cars')
def car_list():
    """
    Display a list of cars.
    1. Gets location and filter parameters from the request.
    2. Builds a query and applies filters.
    3. Calculates distance and sorts.
    4. Renders the consolidated car_list.html template.
    This is the 'car.car_list' endpoint.
    """
    # --- 1. Get Location Parameters ---
    user_lat_str = request.args.get('user_lat')
    user_lng_str = request.args.get('user_lng')
    # Optional: Get radius if passed from a form input (not the slider which is max_price)
    # radius_km_str = request.args.get('radius')

    # --- 2. Validate Location ---
    if not user_lat_str or not user_lng_str:
        flash("Unable to determine your location for searching. Please use 'Detect my location' or select a suggestion on the homepage.", "warning")
        return redirect(url_for('car.home'))

    try:
        user_lat = float(user_lat_str)
        user_lng = float(user_lng_str)
        # radius_km = float(radius_km_str) if radius_km_str else None
    except (ValueError, TypeError):
        flash("Invalid location coordinates provided.", "danger")
        return redirect(url_for('car.home'))
    # --- End Validation ---

    # --- 3. Get Filter Parameters from Request ---
    # Get filter values directly from request.args (MultiDict)
    car_type_filters = request.args.getlist('type') # e.g., ['SUV', 'Hatchback']
    transmission_filters = request.args.getlist('transmission') # e.g., ['Manual']
    fuel_type_filters = request.args.getlist('fuel') # e.g., ['Petrol', 'Diesel']
    brand_filters = request.args.getlist('brand') # e.g., ['Maruti', 'Hyundai']
    feature_filters = request.args.getlist('features') # e.g., ['ac', 'gps']
    min_seats_str = request.args.get('min_seats')
    max_seats_str = request.args.get('max_seats')
    min_price_str = request.args.get('min_price')
    max_price_str = request.args.get('max_price') # This is the one from the slider/form
    min_year_str = request.args.get('min_year')
    # --- End Get Filter Parameters ---

    # --- 4. Core Query Logic (Initial Filtering) ---
    # Start with all available cars that have coordinates
    query = Car.query.filter(
        Car.is_available == True,
        Car.latitude.isnot(None),
        Car.longitude.isnot(None)
    )
    # --- End Core Query Logic ---

    # --- 5. Apply Filters Directly to Query ---
    # --- Car Type Filter ---
    if car_type_filters:
        # Define valid types to prevent arbitrary filtering
        VALID_CAR_TYPES = {'SUV', 'Hatchback', 'Sedan', 'MUV', 'Luxury', 'EV'}
        valid_selected_types = [ct for ct in car_type_filters if ct in VALID_CAR_TYPES]
        if valid_selected_types:
            query = query.filter(Car.car_type.in_(valid_selected_types))
    # --- End Car Type Filter ---

    # --- Transmission Filter ---
    if transmission_filters:
        VALID_TRANSMISSIONS = {'Manual', 'Automatic'}
        valid_selected_trans = [t for t in transmission_filters if t in VALID_TRANSMISSIONS]
        if valid_selected_trans:
            query = query.filter(Car.transmission.in_(valid_selected_trans))
    # --- End Transmission Filter ---

    # --- Fuel Type Filter ---
    if fuel_type_filters:
        VALID_FUELS = {'Petrol', 'Diesel', 'CNG', 'EV', 'Electric', 'Hybrid'}
        # Normalize values (e.g., 'Electric' -> 'EV')
        normalized_fuels = []
        for f in fuel_type_filters:
            if f in VALID_FUELS:
                norm_f = 'EV' if f.lower() in ['electric', 'ev'] else f
                normalized_fuels.append(norm_f)
        if normalized_fuels:
            query = query.filter(Car.fuel_type.in_(normalized_fuels))
    # --- End Fuel Type Filter ---

    # --- Brand Filter ---
    if brand_filters:
        # Define valid brands or fetch from a predefined list/model
        VALID_BRANDS = {'Maruti', 'Hyundai', 'Tata', 'Mahindra', 'Toyota', 'Honda', 'Ford', 'Volkswagen'}
        valid_selected_brands = [b for b in brand_filters if b in VALID_BRANDS]
        if valid_selected_brands:
            query = query.filter(Car.make.in_(valid_selected_brands))
    # --- End Brand Filter ---

    # --- Seating Capacity Filter ---
    try:
        if min_seats_str:
            min_seats = int(min_seats_str)
            query = query.filter(Car.seats >= min_seats)
        if max_seats_str:
            max_seats = int(max_seats_str)
            query = query.filter(Car.seats <= max_seats)
    except (ValueError, TypeError):
        pass # Gracefully handle invalid seat numbers
    # --- End Seating Capacity Filter ---

    # --- Price Range Filter ---
    try:
        if min_price_str:
            min_price = float(min_price_str)
            query = query.filter(Car.price_per_day >= min_price)
        if max_price_str:
            max_price = float(max_price_str)
            query = query.filter(Car.price_per_day <= max_price)
    except (ValueError, TypeError):
        pass # Gracefully handle invalid prices
    # --- End Price Range Filter ---

    # --- Model Year Filter ---
    try:
        if min_year_str:
            min_year = int(min_year_str)
            # Add validation for reasonable year range if needed
            MIN_VALID_YEAR = 1950
            MAX_VALID_YEAR = 2030
            if MIN_VALID_YEAR <= min_year <= MAX_VALID_YEAR:
                query = query.filter(Car.year >= min_year)
    except (ValueError, TypeError):
        pass # Gracefully handle invalid years
    # --- End Model Year Filter ---

    # --- Features Filter ---
    if feature_filters:
        # Map feature names from URL param to Car model boolean field names
        FEATURE_MAP = {
            'ac': 'has_ac',
            'bluetooth': 'has_bluetooth',
            'sunroof': 'has_sunroof',
            'gps': 'has_gps',
            'usb_port': 'has_usb_port',
            'reverse_camera': 'has_reverse_camera'
            # Add more mappings as needed, ensure Car model has these boolean fields
        }
        from sqlalchemy import and_
        filter_conditions = []
        for feature_key in feature_filters:
            if feature_key in FEATURE_MAP:
                car_field_name = FEATURE_MAP[feature_key]
                if hasattr(Car, car_field_name):
                    # Add condition: Car.car_field_name == True
                    filter_conditions.append(getattr(Car, car_field_name) == True)

        # Apply filter for each selected feature (AND logic: car must have ALL selected features)
        if filter_conditions:
            # Use * to unpack the list of conditions
            query = query.filter(and_(*filter_conditions))
    # --- End Features Filter ---
    # --- End Applying Filters Directly ---

    # --- 6. Execute Query to get candidates ---
    # Get cars that pass the basic filters and have location data
    cars = query.all()
    # --- End Execute Query ---

    # --- 7. Distance Calculation & Sorting ---
    car_distances = []
    for car in cars:
        # Calculate distance for each car
        distance = calculate_distance(
            user_lat, user_lng,
            car.latitude, car.longitude
        )
        # Round distance for display/storage
        rounded_distance = round(distance, 2)

        # Store distance on car object for template access and sorting
        car.display_distance_km = rounded_distance # Use a clear attribute name

        # Add to list for sorting (radius filter can be applied here if needed)
        # For now, we sort all cars by distance.
        car_distances.append((car, rounded_distance))

    # Sort the list by distance (nearest first)
    car_distances.sort(key=lambda x: x[1])
    # Extract sorted cars
    cars_sorted_by_distance = [car for car, distance in car_distances]
    # --- End Distance Logic ---

    # --- 8. Prepare Context for Template ---
    selected_location_display = f"Cars near you (approx. Lat: {user_lat:.4f}, Lng: {user_lng:.4f})"
    # Add user location context for template (e.g., for map, re-search)
    user_location_context = {
        'lat': user_lat,
        'lng': user_lng,
        # 'radius': radius_km # Pass if radius is used
    }

    # --- Prepare Filter Context for Template ---
    # This helps the template know which filters are active to highlight them/reset them
    active_filters_context = {
        'types': car_type_filters,
        'transmissions': transmission_filters,
        'fuels': fuel_type_filters,
        'brands': brand_filters,
        'features': feature_filters,
        'min_seats': min_seats_str,
        'max_seats': max_seats_str,
        'min_price': min_price_str,
        'max_price': max_price_str, # Pass the max price for slider
        'min_year': min_year_str,
    }
    # --- End Prepare Filter Context ---

    # --- 9. Render Consolidated Template ---
    # Pass the sorted list, context messages, user location data, and active filters
    return render_template(
        'car_list.html', # Path to your single, consolidated template
        cars=cars_sorted_by_distance, # Pass the sorted list
        selected_location_display=selected_location_display,
        user_location=user_location_context,
        active_filters=active_filters_context, # Pass active filters for UI
        # You can pass other context like total_cars, current_page, total_pages for pagination if needed later
    )
# --- End Car Listing Route ---

# --- Route for Car Detail ---
@car_bp.route('/cars/<int:car_id>')
def car_detail(car_id):
    """
    Display detailed information for a specific car.
    This is the 'car.car_detail' endpoint.
    """
    # --- Get the car object or return 404 if not found ---
    # Assuming Car stores location details directly
    car = Car.query.filter(Car.id == car_id).first_or_404()
    # --- End Get Car ---

    # --- Calculate Default Dates ---
    # Calculate default start date (e.g., tomorrow)
    default_start_date = datetime.today().date() + timedelta(days=1)
    # Calculate default end date (e.g., day after tomorrow)
    default_end_date = default_start_date + timedelta(days=1)
    # --- End Calculate Dates ---

    # --- CRITICAL FIX: Instantiate and Pass Form ---
    # Create an instance of the booking form
    form = BookingInitiationForm()
    # Pre-populate form with default dates if needed (optional)
    # form.start_date.data = default_start_date
    # form.end_date.data = default_end_date
    # --- END CRITICAL FIX ---

    # --- Render Template with Context ---
    # Pass the car object and default dates
    return render_template(
        'car_detail.html',
        car=car,
        default_start_date=default_start_date, # <-- Pass default_start_date
        default_end_date=default_end_date,      # <-- Pass default_end_date (good to have)
        form = form  # <-- Pass the form instance
    )


# --- Route for Address Suggestions (API) ---
@car_bp.route('/suggest')
def suggest_address():
    """
    Provides address suggestions based on user input using Nominatim.
    This is the 'car.suggest_address' endpoint.
    """
    query = request.args.get('q', '').strip()
    if len(query) < 2:
        return jsonify([])

    # Use Nominatim API for suggestions
    # --- CRITICAL FIX 2: Corrected URL (no extra spaces) ---
    # BEFORE (Incorrect):
    # url = "https://nominatim.openstreetmap.org/search  "
    # AFTER (Correct):
    url = "https://nominatim.openstreetmap.org/search" # Use the corrected constant defined above
    # --- END CRITICAL FIX 2 ---
    params = {
        'q': query,
        'format': 'json',
        'countrycodes': 'IN', # Restrict to India
        'addressdetails': 1, # Get detailed address parts
        'limit': 10 # Limit results
    }
    # Nominatim requires a User-Agent header
    headers = {'User-Agent': 'ZoomCarClone/1.0 (contact@yourapp.com)'}

    try:
        response = requests.get(url, params=params, headers=headers, timeout=5)
        response.raise_for_status() # Raise an exception for bad status codes (4xx, 5xx)
        data = response.json()
        results = []
        for item in data:
            addr = item.get('address', {})
            # --- Improved field mapping ---
            # Nominatim keys can vary, try common ones for locality/sub-area
            locality_parts = [
                addr.get('suburb'),
                addr.get('neighbourhood'), # UK spelling
                addr.get('neighborhood'), # US spelling
                addr.get('hamlet'),
                addr.get('residential'),
                addr.get('quarter') # Sometimes used in cities
            ]
            # Get the first non-empty value from the list
            locality = next((part for part in locality_parts if part), None)

            # Get city/town/village
            city = addr.get('city') or addr.get('town') or addr.get('village')

            # Get state
            state = addr.get('state')

            # Get postcode
            postcode = addr.get('postcode')

            # Get road/street
            road = addr.get('road') or addr.get('pedestrian')

            # Get house number
            house_number = addr.get('house_number')
            # --- End Improved Mapping ---

            results.append({
                'display_name': item['display_name'],
                'lat': float(item['lat']),
                'lon': float(item['lon']),
                # Map Nominatim keys to potential fields you might use
                'road': road,
                'house_number': house_number,
                'postcode': postcode,
                'city': city,
                'state': state,
                'locality': locality, # Best guess for locality/area
                'county': addr.get('county') or addr.get('district') # District/County
                # Add more fields if needed from Nominatim response (e.g., country)
            })
        return jsonify(results)
    except requests.exceptions.RequestException as e:
        # Handle network errors, timeouts, HTTP errors
        print(f"Suggestion API error (Request): {e}")
        return jsonify({'error': 'Failed to fetch suggestions (Network Error)'}), 500
    except ValueError as e: # Includes JSONDecodeError
        # Handle errors parsing JSON response
        print(f"Suggestion API error (JSON): {e}")
        return jsonify({'error': 'Failed to process suggestions (Data Error)'}), 500
    except Exception as e:
        # Handle other unexpected errors
        print(f"Unexpected error in suggest_address: {e}")
        return jsonify({'error': 'An unexpected error occurred'}), 500
# --- End Address Suggestions Route ---





--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\New Text Document.bat ---
@echo off
REM Create the directory structure
mkdir user

REM Navigate into the directory
cd user

REM Create the Python files
echo.> __init__.py
echo.> dashboard.py
echo.> bookings.py
echo.> notifications.py

REM Done
echo Directory and files created successfully.


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\New Text Document.txt ---
@echo off
REM Create the directory structure
mkdir user

REM Navigate into the directory
cd user

REM Create the Python files
echo.> __init__.py
echo.> dashboard.py
echo.> bookings.py
echo.> notifications.py

REM Done
echo Directory and files created successfully.


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\payment.py ---
# routes/payment.py
import os  # <-- Import os at the top
from flask import Blueprint, render_template, request, redirect, url_for, flash, current_app
from flask_login import login_required, current_user
import razorpay
import hmac
import hashlib
from datetime import datetime
from models import db
from models.booking import Booking

# from models.car import Car # If needed

payment_bp = Blueprint('payment', __name__)

# --- CRITICAL FIX: Move Razorpay client initialization ---
# BEFORE (Incorrect - Module level access to current_app)
# RAZORPAY_KEY_ID = current_app.config.get('RAZORPAY_KEY_ID')
# RAZORPAY_KEY_SECRET = current_app.config.get('RAZORPAY_KEY_SECRET')
# AFTER (Correct - Use os.getenv or access within app context)
# Option 1: Use os.getenv (recommended for keys that don't change)
RAZORPAY_KEY_ID = os.getenv('RAZORPAY_KEY_ID')  # Get from environment variables
RAZORPAY_KEY_SECRET = os.getenv('RAZORPAY_KEY_SECRET')  # Get from environment variables

# Initialize client only if keys are present
if RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET:
    try:
        razorpay_client = razorpay.Client(auth=(RAZORPAY_KEY_ID, RAZORPAY_KEY_SECRET))
        razorpay_client.set_app_details({"title": "ZoomCarClone", "version": "1.0"})
    except Exception as e:
        print(f"Error initializing Razorpay client: {e}")
        razorpay_client = None
else:
    print("Razorpay keys not found in environment variables (.env file).")
    razorpay_client = None


# --- END CRITICAL FIX ---

@payment_bp.route('/initiate/<int:booking_id>')
@login_required
def initiate_payment(booking_id):
    """Initiate Razorpay payment for a booking."""
    booking = Booking.query.get_or_404(booking_id)

    # Authorization check
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    # Check if booking can be paid
    if not booking.can_be_paid():
        flash('This booking cannot be paid at this time.')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))  # Assuming user blueprint

    # --- Razorpay Integration ---
    if not razorpay_client:
        flash('Payment gateway is currently unavailable. Please try again later.', 'danger')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))  # Assuming user blueprint

    try:
        # Create a Razorpay Order
        order_data = {
            'amount': int(booking.total_price * 100),  # Razorpay expects amount in paise
            'currency': 'INR',
            'receipt': f"booking_receipt_{booking.id}",
            'payment_capture': 1  # Auto-capture payment
        }
        razorpay_order = razorpay_client.order.create(order_data)
        razorpay_order_id = razorpay_order['id']

        # Store order ID in booking
        booking.razorpay_order_id = razorpay_order_id
        db.session.commit()

        # Prepare context for template
        context = {
            'booking': booking,
            'razorpay_key_id': RAZORPAY_KEY_ID,
            'razorpay_order_id': razorpay_order_id,
            'total_amount_paise': int(booking.total_price * 100),
            'total_amount_rupees': booking.total_price
        }

        return render_template('payment/checkout.html', **context)

    except razorpay.errors.RazorpayError as e:
        print(f"Razorpay API error: {e}")
        flash('Failed to initiate payment. Please try again.', 'danger')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))  # Assuming user blueprint
    except Exception as e:
        print(f"Unexpected error in initiate_payment: {e}")
        flash('An unexpected error occurred. Please try again.', 'danger')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))  # Assuming user blueprint
    # --- End Razorpay Integration ---


@payment_bp.route('/handler', methods=['POST'])
@login_required
def handle_payment():
    """Handle Razorpay payment callback/verification."""
    if not razorpay_client:
        flash('Payment gateway is currently unavailable.', 'danger')
        # Redirect to appropriate place (user dashboard?)
        return redirect(url_for('car.home'))  # Or user dashboard

    try:
        # Get payment details from Razorpay callback
        payment_id = request.form.get('razorpay_payment_id')
        order_id = request.form.get('razorpay_order_id')
        signature = request.form.get('razorpay_signature')

        if not payment_id or not order_id or not signature:
            flash('Invalid payment data received.', 'danger')
            return redirect(url_for('car.home'))  # Or user dashboard

        # Verify the payment signature
        params_dict = {
            'razorpay_order_id': order_id,
            'razorpay_payment_id': payment_id,
            'razorpay_signature': signature
        }

        result = razorpay_client.utility.verify_payment_signature(params_dict)

        if result:
            # Payment signature verified successfully
            # Find the booking associated with this order
            booking = Booking.query.filter_by(razorpay_order_id=order_id).first()
            if not booking or booking.user_id != current_user.id:
                flash('Booking not found or access denied.', 'danger')
                return redirect(url_for('car.home'))  # Or user dashboard

            if booking.payment_status == 'completed':
                flash('Payment already processed for this booking.', 'info')
                # Redirect to booking detail or user dashboard
                return redirect(url_for('user.booking_detail', booking_id=booking.id))  # Assuming user blueprint

            # --- CRITICAL: Update booking status ---
            booking.payment_status = 'completed'
            booking.payment_date = datetime.utcnow()
            booking.razorpay_payment_id = payment_id  # Store payment ID
            # Update booking status to 'paid' or 'active' depending on your flow
            booking.status = 'paid'  # Or 'active' if trip starts immediately after payment

            # --- CRITICAL: Update Host Wallet ---
            # Assuming Host model has add_to_wallet method and a relationship to Car
            # This assumes Car has a 'host' relationship
            host = booking.car.host  # Access host via car relationship
            if host:
                # Example: Add 90% of total price to host's wallet
                host_earning = booking.total_price * 0.9
                host.add_to_wallet(host_earning)
                # You might want to record this in a WalletTransaction model
            # --- END CRITICAL ---

            db.session.commit()

            flash('Payment successful! Your booking is confirmed.', 'success')
            # Redirect to booking detail page
            return redirect(url_for('user.booking_detail', booking_id=booking.id))  # Assuming user blueprint
        else:
            # Payment signature verification failed
            flash('Payment verification failed. Please contact support.', 'danger')
            print(f"Razorpay signature verification failed for order {order_id}")
            return redirect(url_for('car.home'))  # Or user dashboard

    except razorpay.errors.SignatureVerificationError as e:
        # Specific Razorpay signature error
        flash(f"Payment verification failed: {str(e)}", "danger")
        print(f"SignatureVerificationError: {e}")
        return redirect(url_for('car.home'))  # Or user dashboard
    except Exception as e:
        # Handle other unexpected errors
        db.session.rollback()  # Rollback on error
        print(f"Unexpected error in handle_payment: {e}")
        flash("An error occurred during payment processing. Please contact support.", "danger")
        return redirect(url_for('car.home'))  # Or user dashboard

# Register blueprint in app.py
# app.register_blueprint(payment_bp, url_prefix='/payment')


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\some_bp.py ---
# routes/some_bp.py (Example - Fix the route logic)
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
# --- CRITICAL FIX 1: Import the correct model for authorization check ---
# If this route is for HOSTS, import Host
# If this route is for USERS, import User
# If this route is for ADMINS, import Admin
from models.host import Host  # <-- Assuming this route is for hosts
# --- END CRITICAL FIX 1 ---
from . import some_bp  # Replace 'some_bp' with your actual blueprint name


@some_bp.route('/some-route')
@login_required
def some_route():
    """
    Example route that requires host authorization.
    This is the 'some_bp.some_route' endpoint.
    """
    # --- CRITICAL FIX 2: Correct Authorization Check ---
    # BEFORE (Incorrect - Assumed current_user has host_profile)
    # if not current_user.host_profile: # <-- This will fail for regular users
    #     flash('Access denied.')
    #     return redirect(url_for('car.home'))

    # AFTER (Correct - Check user type and host profile)
    # Option A: Check if current_user is a Host object (if Host model inherits UserMixin)
    # if not isinstance(current_user, Host):
    #     flash('Access denied. This page is for hosts only.')
    #     return redirect(url_for('car.home'))

    # Option B: Check if current_user is a User and has a host_profile (via backref)
    # This is more common if Host is linked to User
    if not isinstance(current_user, User) or not getattr(current_user, 'host_profile', None):
        flash('Access denied. This page is for hosts only.')
        return redirect(url_for('car.home'))

    # Option C: Check if current_user is an Admin (if this route is for admins)
    # if not isinstance(current_user, Admin):
    #     flash('Access denied. This page is for admins only.')
    #     return redirect(url_for('car.home'))
    # --- END CRITICAL FIX 2 ---

    # ... rest of route logic ...
    # Assuming you need the host object for further processing
    host = current_user.host_profile  # This should now work safely

    return render_template('some_bp/some_route.html', host=host)  # Pass host context

# ... (rest of routes/some_bp.py) ...


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\admins.py ---
# routes/admin/admins.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.admin import Admin


@admin_bp.route('/admins')
@login_required
def list_admins():
    """List all admins (super admin only)"""
    # Authorization check (ensure user is a super admin)
    if not (hasattr(current_user, 'access_level') and current_user.can_manage_admins()):
        flash('Access denied. Only super admins can manage admins.')
        return redirect(url_for('admin.dashboard'))

    page = request.args.get('page', 1, type=int)
    per_page = 20

    # Base query
    query = Admin.query

    # Search functionality
    search_query = request.args.get('search', '').strip()
    if search_query:
        query = query.filter(
            db.or_(
                Admin.username.ilike(f"%{search_query}%"),
                Admin.email.ilike(f"%{search_query}%"),
                Admin.access_level.ilike(f"%{search_query}%")
            )
        )

    admins_pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    admins = admins_pagination.items

    return render_template('admin/admins/list.html',
                           admins=admins,
                           admins_pagination=admins_pagination,
                           search_query=search_query)


@admin_bp.route('/admins/<int:admin_id>/toggle-active', methods=['POST'])
@login_required
def toggle_admin_active(admin_id):
    """Toggle admin's active status (super admin only)"""
    # Authorization check
    if not (hasattr(current_user, 'access_level') and current_user.can_manage_admins()):
        flash('Access denied. Only super admins can manage admins.')
        return redirect(url_for('admin.dashboard'))

    # Prevent admin from toggling their own status
    if admin_id == current_user.id:
        flash('You cannot change your own status.', 'danger')
        return redirect(url_for('admin.list_admins'))

    admin = Admin.query.get_or_404(admin_id)
    admin.is_active = not admin.is_active
    db.session.commit()

    status_msg = "activated" if admin.is_active else "deactivated"
    flash(f'Admin {admin.username} has been {status_msg}.', 'success')
    return redirect(url_for('admin.list_admins'))


@admin_bp.route('/admins/<int:admin_id>/delete', methods=['POST'])
@login_required
def delete_admin(admin_id):
    """Delete an admin (super admin only)"""
    # Authorization check
    if not (hasattr(current_user, 'access_level') and current_user.can_manage_admins()):
        flash('Access denied. Only super admins can manage admins.')
        return redirect(url_for('admin.dashboard'))

    # Prevent admin from deleting themselves
    if admin_id == current_user.id:
        flash('You cannot delete yourself.', 'danger')
        return redirect(url_for('admin.list_admins'))

    admin = Admin.query.get_or_404(admin_id)
    # Prevent deletion of other super admins?
    # if admin.access_level == 'super' and admin.id != current_user.id:
    #     flash('Cannot delete other super admins.', 'danger')
    #     return redirect(url_for('admin.list_admins'))

    try:
        username = admin.username
        db.session.delete(admin)
        db.session.commit()
        flash(f'Admin {username} deleted successfully.', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'Error deleting admin: {str(e)}', 'danger')

    return redirect(url_for('admin.list_admins'))


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\auth.py ---
# routes/admin/auth.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required, current_user
from . import admin_bp
from models import db
from models.admin import Admin
# --- CRITICAL FIX 1: Import WTForms ---
from forms.admin import AdminLoginForm, AdminRegistrationForm  # <-- Import forms


# --- END CRITICAL FIX 1 ---

@admin_bp.route('/login', methods=['GET', 'POST'])
def login():
    """
    Admin login page.
    This is the 'admin.login' endpoint.
    """
    # Redirect if already logged in as admin
    if current_user.is_authenticated and hasattr(current_user, 'access_level'):
        return redirect(url_for('admin.dashboard'))

    # --- CRITICAL FIX 2: Instantiate the AdminLoginForm ---
    form = AdminLoginForm()  # Create an instance of the form
    # --- END CRITICAL FIX 2 ---

    if request.method == 'POST':
        # --- CRITICAL FIX 3: Use form validation ---
        if form.validate_on_submit():  # This checks CSRF token and other validations
            username = form.username.data.strip()
            password = form.password.data
            # --- CRITICAL FIX 4: Get remember_me value from form ---
            # BEFORE (Incorrect - Used request.form.get directly)
            # remember = bool(request.form.get('remember_me'))

            # AFTER (Correct - Use form data)
            remember = form.remember_me.data  # <-- Get value from form object
            # --- END CRITICAL FIX 4 ---

            admin = Admin.query.filter_by(username=username).first()

            # Check if admin exists, password is correct, and admin is active
            if admin and admin.check_password(password) and admin.is_active:
                login_user(admin, remember=remember)  # <-- Pass remember value to login_user
                flash('Logged in successfully as admin.', 'success')
                # Redirect to next page or admin dashboard
                next_page = request.args.get('next')
                return redirect(next_page) if next_page else redirect(url_for('admin.dashboard'))
            else:
                flash('Login failed. Please check your username and password, and ensure your account is active.',
                      'danger')
        else:
            # Form validation failed (CSRF, missing fields, etc.)
            flash('Please check your input and try again.', 'danger')
        # --- END CRITICAL FIX 3 ---

    # For GET request or failed validation, render the form
    # --- CRITICAL FIX 5: Pass the form instance to the template ---
    return render_template('admin/login.html', form=form)  # <-- Pass the form instance


@admin_bp.route('/logout')
@login_required
def logout():
    """Admin logout"""
    # Optional: Add authorization check to ensure only admins can logout via this route
    # if not isinstance(current_user, Admin):
    #     flash('Access denied.')
    #     return redirect(url_for('car.home'))

    logout_user()
    flash('You have been logged out.')
    return redirect(url_for('admin.login'))  # Redirect to admin login page

# --- CRITICAL FIX 3: Add Admin Registration Route (for super admins) ---
@admin_bp.route('/register', methods=['GET', 'POST'])
@login_required
def register():
    """Admin registration page (accessible only by super admins)"""
    # Authorization check (ensure user is a super admin)
    if not (hasattr(current_user, 'access_level') and current_user.can_manage_admins()):
        flash('Access denied. Only super admins can create new admins.')
        return redirect(url_for('admin.dashboard'))

    form = AdminRegistrationForm()  # <-- Instantiate the registration form

    if form.validate_on_submit():  # <-- This checks CSRF token and other validations
        username = form.username.data.strip()
        email = form.email.data.strip().lower()
        password = form.password.data
        confirm_password = form.confirm_password.data
        access_level = form.access_level.data
        is_active = form.is_active.data

        # Validate password confirmation
        if password != confirm_password:
            flash('Passwords do not match.', 'danger')
            return render_template('admin/register.html', form=form)

        # Check if admin already exists
        if Admin.query.filter_by(username=username).first() or Admin.query.filter_by(email=email).first():
            flash('Username or email already taken by another admin.', 'danger')
            return render_template('admin/register.html', form=form)

        # Create new admin
        new_admin = Admin(
            username=username,
            email=email,
            access_level=access_level,
            is_active=is_active
        )
        new_admin.set_password(password)
        db.session.add(new_admin)

        try:
            db.session.commit()
            flash(f'Admin {username} created successfully!', 'success')
            return redirect(url_for('admin.list_admins'))  # Redirect to admin list
        except Exception as e:
            db.session.rollback()
            flash(f'Error creating admin: {str(e)}', 'danger')
            return render_template('admin/register.html', form=form)

    # For GET request or failed validation, render the form
    return render_template('admin/register.html', form=form)
# --- END CRITICAL FIX 3 ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\bookings.py ---
# routes/admin/bookings.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.booking import Booking
from models.car import Car
from models.user import User
from models.host import Host


@admin_bp.route('/bookings')
@login_required
def list_bookings():
    """
    List all bookings with search and pagination.
    This is the 'admin.list_bookings' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    page = request.args.get('page', 1, type=int)
    per_page = 20

    # Base query - Join for comprehensive data
    query = Booking.query.join(Booking.car).join(Booking.user).join(Car.host).join(Car.host.user)

    # Search functionality
    search_query = request.args.get('search', '').strip()
    if search_query:
        query = query.filter(
            db.or_(
                db.cast(Booking.id, db.String).ilike(f"%{search_query}%"),
                Car.make.ilike(f"%{search_query}%"),
                Car.model.ilike(f"%{search_query}%"),
                User.username.ilike(f"%{search_query}%"),
                User.email.ilike(f"%{search_query}%"),
                Car.host.user.username.ilike(f"%{search_query}%"),
                Car.host.company_name.ilike(f"%{search_query}%")
                # Add more searchable fields as needed (dates, status)
            )
        )

    # Paginate results
    bookings_pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    bookings = bookings_pagination.items

    return render_template('admin/bookings/list.html',
                           bookings=bookings,
                           bookings_pagination=bookings_pagination,
                           search_query=search_query)


@admin_bp.route('/bookings/<int:booking_id>')
@login_required
def booking_detail(booking_id):
    """
    View detailed information for a specific booking.
    This is the 'admin.booking_detail' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    booking = Booking.query.get_or_404(booking_id)
    # The relationships should load car, user, and host details

    return render_template('admin/bookings/detail.html', booking=booking)


@admin_bp.route('/bookings/<int:booking_id>/cancel', methods=['POST'])
@login_required
def cancel_booking(booking_id):
    """
    Cancel a booking by admin.
    This is the 'admin.cancel_booking' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    booking = Booking.query.get_or_404(booking_id)

    reason = request.form.get('reason', '').strip()
    if not reason:
        flash('Please provide a reason for cancellation.', 'danger')
        return redirect(url_for('admin.booking_detail', booking_id=booking_id))

    # Attempt to cancel
    if booking.cancel_by_admin(reason=reason):
        db.session.commit()
        flash(f'Booking #{booking.id} cancelled successfully by admin.', 'success')
    else:
        flash('Failed to cancel booking.', 'danger')

    return redirect(url_for('admin.booking_detail', booking_id=booking_id))

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\cars.py ---
# routes/admin/cars.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.car import Car
from models.host import Host


@admin_bp.route('/cars')
@login_required
def list_cars():
    """
    List all cars with search and pagination.
    This is the 'admin.list_cars' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    page = request.args.get('page', 1, type=int)
    per_page = 20

    # Base query - Join with Host and User for host info
    query = Car.query.join(Car.host).join(Host.user)

    # Search functionality
    search_query = request.args.get('search', '').strip()
    if search_query:
        query = query.filter(
            db.or_(
                Car.make.ilike(f"%{search_query}%"),
                Car.model.ilike(f"%{search_query}%"),
                Car.city.ilike(f"%{search_query}%"),
                Car.locality.ilike(f"%{search_query}%"),
                Car.full_address.ilike(f"%{search_query}%"),
                Host.company_name.ilike(f"%{search_query}%"),
                Host.user.username.ilike(f"%{search_query}%")
            )
        )

    # Paginate results
    cars_pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    cars = cars_pagination.items

    return render_template('admin/cars/list.html',
                           cars=cars,
                           cars_pagination=cars_pagination,
                           search_query=search_query)


@admin_bp.route('/cars/<int:car_id>/toggle-block', methods=['POST'])
@login_required
def toggle_car_block(car_id):
    """
    Block/Unblock a car.
    This is the 'admin.toggle_car_block' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    car = Car.query.get_or_404(car_id)

    car.is_blocked = not car.is_blocked
    # Optionally set a timestamp and reason
    from datetime import datetime
    car.blocked_at = datetime.utcnow() if car.is_blocked else None
    car.blocked_reason = request.form.get('reason', 'Blocked by admin') if car.is_blocked else None

    db.session.commit()

    status_msg = "blocked" if car.is_blocked else "unblocked"
    flash(f'Car {car.make} {car.model} has been {status_msg}.', 'success')
    return redirect(url_for('admin.list_cars'))


@admin_bp.route('/cars/<int:car_id>/delete', methods=['POST'])
@login_required
def delete_car(car_id):
    """
    Delete a car.
    This is the 'admin.delete_car' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    car = Car.query.get_or_404(car_id)

    try:
        car_name = f"{car.make} {car.model}"

        # Delete associated images first (filesystem cleanup)
        for image in car.images:
            filepath = os.path.join('static', 'uploads', image.filename)
            if os.path.exists(filepath):
                os.remove(filepath)
            db.session.delete(image)

        # Delete the car
        db.session.delete(car)
        db.session.commit()

        flash(f'Car {car_name} deleted successfully.', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'Error deleting car: {str(e)}', 'danger')

    return redirect(url_for('admin.list_cars'))

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\dashboard.py ---
# routes/admin/dashboard.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.user import User
from models.host import Host
from models.car import Car
from models.booking import Booking
from models.admin import Admin  # <-- Import Admin model


@admin_bp.route('/')  # <-- This creates the 'admin.dashboard' endpoint
@login_required
def dashboard():
    """
    Admin dashboard overview.
    This is the 'admin.dashboard' endpoint.
    """
    # --- CRITICAL FIX 1: Authorization check (ensure user is an admin) ---
    # BEFORE (Incorrect - Might have checked for host_profile or user attributes)
    # if not hasattr(current_user, 'host_profile') or not current_user.host_profile:
    #     flash('Access denied.')
    #     return redirect(url_for('car.home'))

    # AFTER (Correct - Check if current_user is an Admin instance)
    if not isinstance(current_user, Admin):  # <-- Check user type
        flash('Access denied.')
        return redirect(url_for('car.home'))
    # --- END CRITICAL FIX 1 ---

    # --- Get statistics ---
    total_users = User.query.count()
    total_hosts = Host.query.count()
    total_cars = Car.query.count()
    total_bookings = Booking.query.count()
    total_admins = Admin.query.count()

    # Get recent entities
    recent_users = User.query.order_by(User.created_at.desc()).limit(5).all()
    recent_hosts = Host.query.order_by(Host.created_at.desc()).limit(5).all()
    recent_bookings = Booking.query.order_by(Booking.created_at.desc()).limit(5).all()
    recent_cars = Car.query.order_by(Car.created_at.desc()).limit(5).all()
    recent_admins = Admin.query.order_by(Admin.created_at.desc()).limit(5).all()
    # --- End Get Statistics ---

    return render_template('admin/dashboard.html',
                           total_users=total_users,
                           total_hosts=total_hosts,
                           total_cars=total_cars,
                           total_bookings=total_bookings,
                           total_admins=total_admins,
                           recent_users=recent_users,
                           recent_hosts=recent_hosts,
                           recent_bookings=recent_bookings,
                           recent_cars=recent_cars,
                           recent_admins=recent_admins)


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\documents.py ---
# routes/admin/documents.py
from flask import render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.document import Document  # Assuming Document model exists


@admin_bp.route('/documents')
@login_required
def list_documents():
    """List all user documents"""
    if not current_user.is_admin:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    page = request.args.get('page', 1, type=int)
    per_page = 20

    query = Document.query.join(Document.user)

    search_query = request.args.get('search', '').strip()
    if search_query:
        query = query.filter(
            db.or_(
                Document.document_type.ilike(f"%{search_query}%"),
                Document.user.username.ilike(f"%{search_query}%"),
                Document.user.email.ilike(f"%{search_query}%")
                # Add more searchable fields as needed
            )
        )

    documents_pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    documents = documents_pagination.items

    return render_template('admin/documents/list.html',
                           documents=documents,
                           documents_pagination=documents_pagination,
                           search_query=search_query)


@admin_bp.route('/documents/<int:doc_id>/verify', methods=['POST'])
@login_required
def verify_document(doc_id):
    """Verify a user document"""
    if not current_user.is_admin:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    doc = Document.query.get_or_404(doc_id)
    doc.is_verified = True
    from datetime import datetime
    doc.verified_at = datetime.utcnow()
    db.session.commit()

    flash(f'Document for user {doc.user.username} verified successfully.', 'success')
    return redirect(url_for('admin.list_documents'))


@admin_bp.route('/documents/<int:doc_id>/reject', methods=['POST'])
@login_required
def reject_document(doc_id):
    """Reject a user document"""
    if not current_user.is_admin:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    doc = Document.query.get_or_404(doc_id)
    doc.is_verified = False
    doc.verified_at = None  # Clear verification timestamp
    # Optionally add a rejection reason
    # doc.rejection_reason = request.form.get('reason', '')
    db.session.commit()

    flash(f'Document for user {doc.user.username} rejected.', 'success')
    return redirect(url_for('admin.list_documents'))

# Add routes for viewing document details, downloading, etc.

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\hosts.py ---
# routes/admin/hosts.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.host import Host
from models.user import User


@admin_bp.route('/hosts')
@login_required
def list_hosts():
    """
    List all hosts with search and pagination.
    This is the 'admin.list_hosts' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    page = request.args.get('page', 1, type=int)
    per_page = 20

    # Base query - Join with User for username/email
    query = Host.query.join(Host.user)

    # Search functionality
    search_query = request.args.get('search', '').strip()
    if search_query:
        query = query.filter(
            db.or_(
                Host.company_name.ilike(f"%{search_query}%"),
                User.username.ilike(f"%{search_query}%"),
                User.email.ilike(f"%{search_query}%"),
                User.phone.ilike(f"%{search_query}%"),
                Host.phone.ilike(f"%{search_query}%")
            )
        )

    # Paginate results
    hosts_pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    hosts = hosts_pagination.items

    return render_template('admin/hosts/list.html',
                           hosts=hosts,
                           hosts_pagination=hosts_pagination,
                           search_query=search_query)


@admin_bp.route('/hosts/<int:host_id>/verify', methods=['POST'])
@login_required
def verify_host(host_id):
    """
    Verify a host.
    This is the 'admin.verify_host' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    host = Host.query.get_or_404(host_id)
    host.is_verified = True
    db.session.commit()

    flash(f'Host {host.company_name or host.user.username} verified successfully.', 'success')
    return redirect(url_for('admin.list_hosts'))


@admin_bp.route('/hosts/<int:host_id>/unverify', methods=['POST'])
@login_required
def unverify_host(host_id):
    """
    Unverify a host.
    This is the 'admin.unverify_host' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    host = Host.query.get_or_404(host_id)
    host.is_verified = False
    db.session.commit()

    flash(f'Host {host.company_name or host.user.username} unverified.', 'success')
    return redirect(url_for('admin.list_hosts'))


@admin_bp.route('/hosts/<int:host_id>/toggle-active', methods=['POST'])
@login_required
def toggle_host_active(host_id):
    """
    Toggle host's active status (block/unblock).
    This is the 'admin.toggle_host_active' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    host = Host.query.get_or_404(host_id)

    # Toggle the user's is_active status (assuming Host is linked to User)
    if host.user:
        host.user.is_active = not host.user.is_active
        db.session.commit()

        status_msg = "activated" if host.user.is_active else "deactivated"
        flash(f'Host {host.company_name or host.user.username} has been {status_msg}.', 'success')
    else:
        flash('Host user not found.', 'danger')

    return redirect(url_for('admin.list_hosts'))


@admin_bp.route('/hosts/<int:host_id>/delete', methods=['POST'])
@login_required
def delete_host(host_id):
    """
    Delete a host (and associated user if desired).
    This is the 'admin.delete_host' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    host = Host.query.get_or_404(host_id)

    try:
        host_name = host.company_name or host.user.username
        user_id = host.user_id  # Store user ID before deleting host

        # Delete the host profile
        db.session.delete(host)
        db.session.commit()

        # Optionally, delete the associated user account
        # user = User.query.get(user_id)
        # if user:
        #     db.session.delete(user)
        #     db.session.commit()

        flash(f'Host {host_name} deleted successfully.', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'Error deleting host: {str(e)}', 'danger')

    return redirect(url_for('admin.list_hosts'))

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\transactions.py ---
# routes/admin/transactions.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.booking import Booking
from models.car import Car
from models.user import User
from models.host import Host


@admin_bp.route('/transactions')
@login_required
def list_transactions():
    """
    List all transactions (payments, refunds, etc.) with search and pagination.
    This is the 'admin.list_transactions' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    page = request.args.get('page', 1, type=int)
    per_page = 20

    # Base query for transactions - Filter for completed/paid bookings
    # For now, we'll use Booking records as the source of transaction data
    # In a full implementation, you'd query a dedicated Transaction/WalletTransaction model
    query = Booking.query.join(Booking.car).join(Booking.user).join(Car.host).join(Car.host.user)
    query = query.filter(Booking.payment_status.in_(['completed', 'refunded', 'failed']))

    # Add search functionality
    search_query = request.args.get('search', '').strip()
    if search_query:
        query = query.filter(
            db.or_(
                db.cast(Booking.id, db.String).ilike(f"%{search_query}%"),
                Booking.razorpay_payment_id.ilike(f"%{search_query}%"),
                User.username.ilike(f"%{search_query}%"),
                User.email.ilike(f"%{search_query}%"),
                Car.make.ilike(f"%{search_query}%"),
                Car.model.ilike(f"%{search_query}%"),
                Car.host.user.username.ilike(f"%{search_query}%"),
                Car.host.company_name.ilike(f"%{search_query}%")
                # Add more searchable fields as needed
            )
        )

    # Add sorting
    sort_by = request.args.get('sort', 'date_desc')  # Default sort
    if sort_by == 'date_asc':
        query = query.order_by(Booking.payment_date.asc())
    elif sort_by == 'date_desc':
        query = query.order_by(Booking.payment_date.desc())
    elif sort_by == 'amount_asc':
        query = query.order_by(Booking.total_price.asc())
    elif sort_by == 'amount_desc':
        query = query.order_by(Booking.total_price.desc())
    else:
        query = query.order_by(Booking.payment_date.desc())  # Default

    transactions_pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    transactions = transactions_pagination.items

    return render_template('admin/transactions/list.html',
                           transactions=transactions,
                           transactions_pagination=transactions_pagination,
                           search_query=search_query,
                           current_sort=sort_by)

# ... (Add more transaction-related routes as needed, like viewing transaction details) ...

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\users.py ---
# routes/admin/user.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import admin_bp
from models import db
from models.user import User


@admin_bp.route('/users')
@login_required
def list_users():
    """
    List all users with search and pagination.
    This is the 'admin.list_users' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    page = request.args.get('page', 1, type=int)
    per_page = 20

    # Base query
    query = User.query

    # Search functionality
    search_query = request.args.get('search', '').strip()
    if search_query:
        query = query.filter(
            db.or_(
                User.username.ilike(f"%{search_query}%"),
                User.email.ilike(f"%{search_query}%"),
                User.phone.ilike(f"%{search_query}%")
            )
        )

    # Paginate results
    users_pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    users = users_pagination.items

    return render_template('admin/users/list.html',
                           users=users,
                           users_pagination=users_pagination,
                           search_query=search_query)


@admin_bp.route('/users/<int:user_id>/toggle-active', methods=['POST'])
@login_required
def toggle_user_active(user_id):
    """
    Toggle user's active status (block/unblock).
    This is the 'admin.toggle_user_active' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    user = User.query.get_or_404(user_id)
    # Prevent admin from toggling their own status
    if user.id == current_user.id:
        flash('You cannot change your own status.', 'danger')
        return redirect(url_for('admin.list_users'))

    user.is_active = not user.is_active
    db.session.commit()

    status_msg = "activated" if user.is_active else "deactivated"
    flash(f'User {user.username} has been {status_msg}.', 'success')
    return redirect(url_for('admin.list_users'))


@admin_bp.route('/users/<int:user_id>/delete', methods=['POST'])
@login_required
def delete_user(user_id):
    """
    Delete a user.
    This is the 'admin.delete_user' endpoint.
    """
    # Authorization check
    if not hasattr(current_user, 'is_super_admin'):
        flash('Access denied.')
        return redirect(url_for('car.home'))

    user = User.query.get_or_404(user_id)
    # Prevent admin from deleting themselves or other admins (optional)
    if user.id == current_user.id:
        flash('You cannot delete yourself.', 'danger')
        return redirect(url_for('admin.list_users'))
    if user.is_admin:  # Assuming you have an is_admin flag on User
        flash('Cannot delete admin user.', 'danger')
        return redirect(url_for('admin.list_users'))

    try:
        username = user.username
        db.session.delete(user)
        db.session.commit()
        flash(f'User {username} deleted successfully.', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'Error deleting user: {str(e)}', 'danger')

    return redirect(url_for('admin.list_users'))

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\admin\__init__.py ---
# routes/admin/__init__.py
from flask import Blueprint

# Create the admin blueprint
admin_bp = Blueprint('admin', __name__, url_prefix='/admin')

# Import route modules to register them with the blueprint
from . import auth, dashboard, users, hosts, cars, bookings, transactions, admins

__all__ = ['admin_bp', 'auth', 'dashboard', 'users', 'hosts', 'cars', 'bookings', 'transactions', 'admins']

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\analytics.py ---
# routes/host/analytics.py
from flask import render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import host_bp
from models import db
from models.host import Host, HostRating, HostFeedback


@host_bp.route('/ratings')
@login_required
def ratings():
    """Display host's ratings and reviews"""
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()

    # Get ratings for this host
    ratings_query = HostRating.query.filter_by(host_id=host.id).order_by(HostRating.created_at.desc())

    # Simple pagination
    page = request.args.get('page', 1, type=int)
    per_page = 5
    ratings_pagination = ratings_query.paginate(page=page, per_page=per_page, error_out=False)
    ratings = ratings_pagination.items

    # Calculate average rating
    if ratings:
        average_rating = sum(r.rating for r in ratings) / len(ratings)
        # Calculate rating distribution (1 to 5 stars)
        rating_distribution = {i: 0 for i in range(1, 6)}
        for r in ratings:
            rating_distribution[r.rating] += 1
    else:
        average_rating = 0
        rating_distribution = {i: 0 for i in range(1, 6)}

    return render_template(
        'host/analytics/ratings.html',
        host=host,
        ratings=ratings,
        ratings_pagination=ratings_pagination,
        average_rating=average_rating,
        rating_distribution=rating_distribution,
        total_ratings=len(ratings)
    )


@host_bp.route('/feedbacks')
@login_required
def feedbacks():
    """Display host's feedback"""
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()

    # Get feedback for this host
    feedbacks_query = HostFeedback.query.filter_by(host_id=host.id).order_by(HostFeedback.created_at.desc())

    # Simple pagination
    page = request.args.get('page', 1, type=int)
    per_page = 5
    feedbacks_pagination = feedbacks_query.paginate(page=page, per_page=per_page, error_out=False)
    feedbacks = feedbacks_pagination.items

    # Count unresolved feedback
    unresolved_count = HostFeedback.query.filter_by(host_id=host.id, is_resolved=False).count()

    return render_template(
        'host/analytics/feedbacks.html',
        host=host,
        feedbacks=feedbacks,
        feedbacks_pagination=feedbacks_pagination,
        unresolved_count=unresolved_count
    )


# Optional route to mark feedback as resolved
@host_bp.route('/feedbacks/<int:feedback_id>/resolve', methods=['POST'])
@login_required
def resolve_feedback(feedback_id):
    """Mark a feedback as resolved"""
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()

    # Get the feedback item, ensuring it belongs to this host
    feedback = HostFeedback.query.join(HostFeedback.host).filter(
        HostFeedback.id == feedback_id,
        Host.id == host.id
    ).first_or_404()

    if not feedback.is_resolved:
        feedback.is_resolved = True
        db.session.commit()
        flash('Feedback marked as resolved.', 'success')
    else:
        flash('Feedback was already resolved.', 'info')

    return redirect(url_for('host.feedbacks'))


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\auth.py ---


# routes/host/auth.py (Relevant part - register function)
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required, current_user
# --- CRITICAL FIX 1: Import WTForms ---
from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, TextAreaField, TelField, SubmitField, HiddenField
from wtforms.fields.simple import BooleanField
from wtforms.validators import DataRequired, Email, Length, Optional
# --- END CRITICAL FIX 1 ---
from . import host_bp
from models import db
from models.user import User
from models.host import Host


# --- CRITICAL FIX 2: Define Host Registration Form using WTForms ---
class HostRegistrationForm(FlaskForm):
    """WTForm for Host registration"""
    email = StringField('Email', validators=[DataRequired(), Email(), Length(max=120)])
    password = PasswordField('Password', validators=[DataRequired(), Length(min=6)])
    confirm_password = PasswordField('Confirm Password', validators=[DataRequired()])
    company_name = StringField('Company Name / Your Name', validators=[DataRequired(), Length(max=100)])
    phone = TelField('Phone Number', validators=[DataRequired(), Length(min=10, max=20)])
    address = TextAreaField('Address', validators=[Optional(), Length(max=500)])
    # Hidden fields for location coordinates (if needed from previous step)
    latitude = HiddenField('Latitude')
    longitude = HiddenField('Longitude')
    full_address = HiddenField('Full Address')
    street_address = HiddenField('Street Address')
    locality = HiddenField('Locality')
    city = HiddenField('City')
    state = HiddenField('State')
    pincode = HiddenField('Pincode')
    submit = SubmitField('Register as Host')

# --- CRITICAL FIX 2: Define HostLoginForm using WTForms ---
class HostLoginForm(FlaskForm):
    """WTForm for host login"""
    email = StringField('Email', validators=[DataRequired(), Email()])
    password = PasswordField('Password', validators=[DataRequired()])
    remember_me = BooleanField('Remember Me')
    submit = SubmitField('Login as Host')
# --- END CRITICAL FIX 2 ---

@host_bp.route('/register', methods=['GET', 'POST'])
def register():
    """
    Host registration page.
    This is the 'host.register' endpoint.
    """
    # --- CRITICAL FIX 3: Instantiate the form ---
    form = HostRegistrationForm()  # Create an instance of the form
    # --- END CRITICAL FIX 3 ---

    # Pre-fill email if provided in query string (e.g., from user login)
    prefill_email = request.args.get('email', '')

    if request.method == 'POST':
        # --- CRITICAL FIX 4: Use form validation ---
        # BEFORE (Manual validation)
        # email = request.form.get('email')
        # password = request.form.get('password')
        # confirm_password = request.form.get('confirm_password')
        # company_name = request.form.get('company_name')
        # phone = request.form.get('phone')
        # address = request.form.get('address')

        # AFTER (WTForms validation)
        if form.validate_on_submit():  # This checks CSRF token and other validations
            email = form.email.data.strip().lower()
            password = form.password.data
            confirm_password = form.confirm_password.data
            company_name = form.company_name.data.strip()
            phone = form.phone.data.strip()
            address = form.address.data.strip() if form.address.data else ''

            # --- Get Location Data from Form (if collected in previous step) ---
            latitude_str = form.latitude.data
            longitude_str = form.longitude.data
            full_address = form.full_address.data
            street_address = form.street_address.data
            locality = form.locality.data
            city = form.city.data
            state = form.state.data
            pincode = form.pincode.data
            # --- End Get Location Data ---

            # --- Validate Password Confirmation ---
            if password != confirm_password:
                flash('Passwords do not match.', 'danger')
                return render_template('host/register.html', form=form, prefill_email=prefill_email)
            # --- End Password Validation ---

            # --- Check for Existing User/Host ---
            user = User.query.filter_by(email=email).first()
            if user and user.host_profile:
                flash('An account with this email is already registered as a host.', 'danger')
                return render_template('host/register.html', form=form, prefill_email=prefill_email)

            # If user exists but doesn't have a host profile, we can use that user
            # Otherwise, create a new user
            if not user:
                user = User(email=email, username=email.split('@')[0])  # Create username from email prefix
                user.set_password(password)
                db.session.add(user)
                db.session.flush()  # Get user ID without committing

            # Check if a host profile already exists for this user (shouldn't happen, but double-check)
            if not user.host_profile:
                # --- Create Host Profile with Location ---
                try:
                    latitude = float(latitude_str) if latitude_str else None
                    longitude = float(longitude_str) if longitude_str else None
                except (ValueError, TypeError):
                    latitude = None
                    longitude = None

                host = Host(
                    user_id=user.id,
                    company_name=company_name,
                    phone=phone,
                    address=address,
                    # --- Assign Location Data ---
                    latitude=latitude,
                    longitude=longitude,
                    full_address=full_address[:500] if full_address else None,
                    street_address=street_address[:255] if street_address else None,
                    locality=locality[:100] if locality else None,
                    city=city[:100] if city else None,
                    state=state[:100] if state else None,
                    pincode=pincode[:20] if pincode else None,
                    # --- End Assign Location Data ---
                    is_verified=False  # Default to not verified
                )
                db.session.add(host)
                # --- End Create Host Profile ---

                try:
                    db.session.commit()
                    flash('Host registration successful! Please log in.', 'success')
                    return redirect(url_for('host.login'))
                except Exception as e:
                    db.session.rollback()
                    print(f"Error adding host: {e}")  # Log the specific error
                    flash('Registration failed. Please try again.', 'danger')
                    return render_template('host/register.html', form=form,
                                           prefill_email=prefill_email)  # Pass form back with errors
            else:
                flash('You already have a host profile.', 'info')
                # Log them in automatically?
                login_user(user)
                return redirect(url_for('host.dashboard'))
        else:
            # Form validation failed (CSRF, missing fields, etc.)
            flash('Please correct the errors in the form.', 'danger')
        # --- END WTForms Validation ---

    # For GET request or failed validation, render the form
    # Pre-populate form with request data if available (for errors or prefill)
    if prefill_email and not form.email.data:
        form.email.data = prefill_email
    return render_template('host/register.html', form=form, prefill_email=prefill_email)  # <-- Pass the form instance

# --- END CRITICAL FIX 2 ---

@host_bp.route('/login', methods=['GET', 'POST'])
def login():
    """
    Host login page.
    This is the 'host.login' endpoint.
    """
    # --- CRITICAL FIX 3: Redirect if already logged in as host ---
    # Check if user is already authenticated and has a host profile
    if current_user.is_authenticated:
        host_profile = getattr(current_user, 'host_profile', None)
        if host_profile:
            flash("You are already logged in as a host.", "info")
            return redirect(url_for('host.dashboard'))
        else:
            # Logged in as regular user, not host
            flash("You are logged in as a customer. Please logout first.", "warning")
            return redirect(url_for('car.home'))  # Or redirect to user dashboard if you have one
    # --- END CRITICAL FIX 3 ---

    # --- CRITICAL FIX 4: Instantiate the HostLoginForm ---
    form = HostLoginForm()  # Create an instance of the form
    # --- END CRITICAL FIX 4 ---

    if request.method == 'POST':
        # --- CRITICAL FIX 5: Use form validation ---
        # BEFORE (Manual validation)
        # email = request.form['email']
        # password = request.form['password']
        # remember = bool(request.form.get('remember_me'))
        #
        # user = User.query.filter_by(email=email).first()
        #
        # # Check if user exists, password is correct, and user HAS a host profile
        # if user and user.check_password(password):
        #     # Check if this user has a host profile created
        #     host_profile = getattr(user, 'host_profile', None)
        #     if host_profile:
        #         login_user(user, remember=remember)
        #         flash('Logged in successfully as host.', 'success')
        #         # Redirect to next page or host dashboard
        #         next_page = request.args.get('next')
        #         return redirect(next_page) if next_page else redirect(url_for('host.dashboard'))
        #     else:
        #         flash('This account is not registered as a host. Please register as a host first or login as a customer.')
        # else:
        #     flash('Login failed. Please check your email and password.')

        # AFTER (WTForms validation)
        if form.validate_on_submit():  # This checks CSRF token and other validations
            email = form.email.data.strip().lower()
            password = form.password.data
            remember = form.remember_me.data

            user = User.query.filter_by(email=email).first()

            # Check if user exists, password is correct, and user HAS a host profile
            if user and user.check_password(password):
                # Check if this user has a host profile created
                host_profile = getattr(user, 'host_profile', None)
                if host_profile:
                    login_user(user, remember=remember)
                    flash('Logged in successfully as host.', 'success')
                    # Redirect to next page or host dashboard
                    next_page = request.args.get('next')
                    return redirect(next_page) if next_page else redirect(url_for('host.dashboard'))
                else:
                    flash(
                        'This account is not registered as a host. Please register as a host first or login as a customer.',
                        'warning')
            else:
                flash('Login failed. Please check your email and password.', 'danger')
        else:
            # Form validation failed (CSRF, missing fields, etc.)
            flash('Please check your input and try again.', 'danger')
        # --- END CRITICAL FIX 5 ---

    # For GET request or failed validation, render the form
    # Pass the form instance to the template
    return render_template('host/login.html', form=form)  # <-- Pass the form instance


@host_bp.route('/logout')
@login_required
def logout():
    """Host logout"""
    logout_user()
    flash('You have been logged out.')
    return redirect(url_for('car.home')) # Redirect to main home page after logout

# Optional: If you want a host registration route
# @host_bp.route('/register', methods=['GET', 'POST'])
# def register():
#     # Implementation for host registration
#     # This would involve creating a User (if new) and then a Host profile linked to that user
#     pass

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\bookings.py ---
# routes/host/bookings.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import host_bp
from models import db
from models.host import Host
from models.booking import Booking


# ... (existing imports and routes like dashboard, list_bookings, booking_detail) ...

@host_bp.route('/bookings/<int:booking_id>/extension/approve', methods=['POST'])
@login_required
def approve_extension(booking_id):
    """
    Approve a user's extension request for a booking.
    This is the 'host.approve_extension' endpoint.
    """
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()
    booking = Booking.query.get_or_404(booking_id)

    # Check if host owns the car for this booking
    if booking.car.host_id != host.id:
        flash('Access denied.')
        return redirect(url_for('host.dashboard'))

    # Check if extension can be approved
    if not booking.can_approve_extension(host):
        flash('This extension request cannot be approved.', 'warning')
        return redirect(url_for('host.booking_detail', booking_id=booking_id))

    # Attempt to approve
    success, message = booking.approve_extension(host)
    if success:
        db.session.commit()
        flash(message, 'success')
    else:
        flash(message, 'danger')

    return redirect(url_for('host.booking_detail', booking_id=booking_id))


@host_bp.route('/bookings/<int:booking_id>/extension/reject', methods=['POST'])
@login_required
def reject_extension(booking_id):
    """
    Reject a user's extension request for a booking.
    This is the 'host.reject_extension' endpoint.
    """
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()
    booking = Booking.query.get_or_404(booking_id)

    # Check if host owns the car for this booking
    if booking.car.host_id != host.id:
        flash('Access denied.')
        return redirect(url_for('host.dashboard'))

    # Check if extension can be rejected
    if not booking.can_reject_extension(host):
        flash('This extension request cannot be rejected.', 'warning')
        return redirect(url_for('host.booking_detail', booking_id=booking_id))

    # Attempt to reject
    success, message = booking.reject_extension(host)
    if success:
        db.session.commit()
        flash(message, 'info')
    else:
        flash(message, 'danger')

    return redirect(url_for('host.booking_detail', booking_id=booking_id))

# ... (rest of routes/host/bookings.py) ...




--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\cars.py ---
from flask import render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from flask_wtf import FlaskForm
from wtforms.fields.choices import SelectField
from wtforms.fields.numeric import IntegerField, FloatField
from wtforms.fields.simple import StringField, TextAreaField, BooleanField, SubmitField, FileField
from wtforms.validators import DataRequired, NumberRange, Optional

from . import host_bp
from models import db
from models.host import Host
from models.car import Car
from models.car_image import CarImage
from models.location import Location
from werkzeug.utils import secure_filename
import os
from models.location import Location # <-- Add this import
import requests # For Nominatim API call


@host_bp.route('/cars')
@login_required
def list_cars():
    """List all cars owned by host"""
    host = Host.query.filter_by(user_id=current_user.id).first()
    if not host:
        flash('Please complete your host profile first')
        return redirect(url_for('host.setup_profile'))

    cars = Car.query.filter_by(host_id=host.id).all()
    return render_template('host/cars/list.html', cars=cars, host=host)


# --- CRITICAL FIX: Define Car Form using WTForms ---
class CarForm(FlaskForm):
    """WTForm for Car (Add/Edit)"""
    make = StringField('Make', validators=[DataRequired()])
    model = StringField('Model', validators=[DataRequired()])
    year = IntegerField('Year', validators=[DataRequired(), NumberRange(min=1900, max=2030)])
    price_per_hour = FloatField('Price per Hour (₹)', validators=[DataRequired(), NumberRange(min=0)])
    color = StringField('Color', validators=[Optional()])
    mileage = IntegerField('Mileage (km)', validators=[Optional(), NumberRange(min=0)])
    fuel_type = SelectField('Fuel Type', choices=[('', 'Select Fuel Type'), ('Petrol', 'Petrol'), ('Diesel', 'Diesel'), ('CNG', 'CNG'), ('EV', 'EV'), ('Electric', 'Electric'), ('Hybrid', 'Hybrid')], validators=[DataRequired()])
    transmission = SelectField('Transmission', choices=[('', 'Select Transmission'), ('Manual', 'Manual'), ('Automatic', 'Automatic')], validators=[DataRequired()])
    seats = IntegerField('Seats', validators=[DataRequired(), NumberRange(min=1, max=20)])
    # Location fields (will be handled by JavaScript/hidden inputs)
    latitude = FloatField('Latitude', validators=[Optional()]) # Hidden input
    longitude = FloatField('Longitude', validators=[Optional()]) # Hidden input
    full_address = TextAreaField('Full Address', validators=[Optional()]) # Hidden/Readonly input
    street_address = StringField('Street Address', validators=[Optional()]) # Hidden/Readonly input
    locality = StringField('Locality/Area', validators=[Optional()]) # Hidden/Readonly input
    city = StringField('City', validators=[DataRequired()]) # Required
    state = StringField('State', validators=[DataRequired()]) # Required
    pincode = StringField('Pincode', validators=[Optional()]) # Hidden/Readonly input
    is_available = BooleanField('Available for booking')
    images = FileField('Car Images', validators=[Optional()])
    submit = SubmitField('Add Car') # Or 'Update Car' based on context

# --- END CRITICAL FIX ---

@host_bp.route('/cars/add', methods=['GET', 'POST'])
@login_required
def add_car():
    """Add new car"""
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()

    # --- CRITICAL FIX: Instantiate the form ---
    form = CarForm() # Create an instance of the form
    # --- END CRITICAL FIX ---

    if form.validate_on_submit(): # This checks CSRF token and other validations
        # --- Get Location Data from Form (processed by JavaScript) ---
        latitude = form.latitude.data
        longitude = form.longitude.data
        full_address = form.full_address.data.strip()[:500] if form.full_address.data else None
        street_address = form.street_address.data.strip()[:255] if form.street_address.data else None
        locality = form.locality.data.strip()[:100] if form.locality.data else None
        city = form.city.data.strip()[:100] if form.city.data else None
        state = form.state.data.strip()[:100] if form.state.data else None
        pincode = form.pincode.data.strip()[:20] if form.pincode.data else None
        # --- End Get Location Data ---

        # --- Validate Location Data ---
        if not latitude or not longitude or not city or not state:
            flash('Location details (coordinates, city, state) are required.', 'danger')
            return render_template('host/cars/add.html', form=form) # Pass form back with errors
        # --- End Validation ---

        # --- Create Car Object ---
        try:
            car = Car(
                make=form.make.data.strip(),
                model=form.model.data.strip(),
                year=form.year.data,
                price_per_hour=form.price_per_hour.data,
                color=form.color.data.strip() if form.color.data else None,
                mileage=form.mileage.data or 0,
                fuel_type=form.fuel_type.data,
                transmission=form.transmission.data,
                seats=form.seats.data,
                # --- Assign Location Data ---
                latitude=latitude,
                longitude=longitude,
                full_address=full_address,
                street_address=street_address,
                locality=locality,
                city=city,
                state=state,
                pincode=pincode,
                # --- End Assign Location Data ---
                host_id=host.id,
                is_available=form.is_available.data
            )

            db.session.add(car)
            db.session.flush() # Get car ID for image filenames

            # Handle image uploads
            if 'images' in request.files:
                files = request.files.getlist('images')
                for i, file in enumerate(files):
                    if file and file.filename != '':
                        filename = secure_filename(file.filename)
                        name, ext = os.path.splitext(filename)
                        # Include car ID in filename
                        filename = f"{name}_{car.id}_{i}{ext}"
                        filepath = os.path.join('static', 'uploads', filename)
                        # Ensure the uploads directory exists
                        os.makedirs(os.path.dirname(filepath), exist_ok=True)
                        file.save(filepath)

                        car_image = CarImage(
                            filename=filename,
                            car_id=car.id,
                            is_primary=(i == 0)
                        )
                        db.session.add(car_image)

            db.session.commit()
            flash('Car added successfully!', 'success')
            return redirect(url_for('host.list_cars'))

        except Exception as e:
            db.session.rollback()
            print(f"Error adding car: {e}") # Log the error
            flash(f'Error adding car: {str(e)}', 'danger')
            return render_template('host/cars/add.html', form=form) # Pass form back with errors

    # For GET request or failed validation, render the form
    # Pre-populate form with request data if available (for errors)
    # locations = Location.query.order_by(Location.city, Location.name).all() # If needed for other dropdowns
    return render_template('host/cars/add.html', form=form) # Pass the form instance

@host_bp.route('/cars/<int:car_id>/edit', methods=['GET', 'POST'])
@login_required
def edit_car(car_id):
    """Edit existing car"""
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()
    car = Car.query.get_or_404(car_id)

    # Check if host owns this car
    if car.host_id != host.id:
        flash('Access denied.')
        return redirect(url_for('host.list_cars'))

    # --- CRITICAL FIX: Instantiate the form and populate with car data ---
    form = CarForm(obj=car) # Populate form with existing car data
    # --- END CRITICAL FIX ---

    if form.validate_on_submit(): # This checks CSRF token and other validations
        # --- Get Updated Location Data from Form (processed by JavaScript) ---
        latitude = form.latitude.data
        longitude = form.longitude.data
        full_address = form.full_address.data.strip()[:500] if form.full_address.data else None
        street_address = form.street_address.data.strip()[:255] if form.street_address.data else None
        locality = form.locality.data.strip()[:100] if form.locality.data else None
        city = form.city.data.strip()[:100] if form.city.data else None
        state = form.state.data.strip()[:100] if form.state.data else None
        pincode = form.pincode.data.strip()[:20] if form.pincode.data else None
        # --- End Get Updated Location Data ---

        # --- Validate Location Data ---
        if not latitude or not longitude or not city or not state:
            flash('Location details (coordinates, city, state) are required.', 'danger')
            return render_template('host/cars/edit.html', form=form, car=car) # Pass form and car back
        # --- End Validation ---

        # --- Update Car Object ---
        try:
            car.make = form.make.data.strip()
            car.model = form.model.data.strip()
            car.year = form.year.data
            car.price_per_hour = form.price_per_hour.data
            car.color = form.color.data.strip() if form.color.data else None
            car.mileage = form.mileage.data or 0
            car.fuel_type = form.fuel_type.data
            car.transmission = form.transmission.data
            car.seats = form.seats.data
            # --- Update Location Data ---
            car.latitude = latitude
            car.longitude = longitude
            car.full_address = full_address
            car.street_address = street_address
            car.locality = locality
            car.city = city
            car.state = state
            car.pincode = pincode
            # --- End Update Location Data ---
            car.is_available = form.is_available.data

            # Handle new image uploads (if any)
            if 'images' in request.files:
                files = request.files.getlist('images')
                for i, file in enumerate(files):
                    if file and file.filename != '':
                        filename = secure_filename(file.filename)
                        name, ext = os.path.splitext(filename)
                        # Include car ID in filename
                        filename = f"{name}_{car.id}_{len(car.images) + i}{ext}" # Append to existing count
                        filepath = os.path.join('static', 'uploads', filename)
                        os.makedirs(os.path.dirname(filepath), exist_ok=True)
                        file.save(filepath)

                        car_image = CarImage(
                            filename=filename,
                            car_id=car.id
                            # is_primary not set here, user can set it later or logic can assign
                        )
                        db.session.add(car_image)

            db.session.commit()
            flash('Car updated successfully!', 'success')
            return redirect(url_for('host.list_cars'))

        except Exception as e:
            db.session.rollback()
            print(f"Error updating car: {e}")
            flash(f'Error updating car: {str(e)}', 'danger')
            return render_template('host/cars/edit.html', form=form, car=car) # Pass form and car back

    # For GET request, render the form with pre-populated data
    return render_template('host/cars/edit.html', form=form, car=car) # Pass the form and car instance

# ... (rest of routes/host/cars.py - delete_car, delete_car_image, etc.) ...

@host_bp.route('/cars/<int:car_id>/delete')
@login_required
def delete_car(car_id):
    """Delete car"""
    host = Host.query.filter_by(user_id=current_user.id).first()
    car = Car.query.get_or_404(car_id)

    # Check if host owns this car
    if car.host_id != host.id:
        flash('Access denied')
        return redirect(url_for('host.list_cars'))

    # Delete associated images
    for image in car.images:
        filepath = os.path.join('static', 'uploads', image.filename)
        if os.path.exists(filepath):
            os.remove(filepath)
        db.session.delete(image)

    db.session.delete(car)
    db.session.commit()
    flash('Car deleted successfully!')
    return redirect(url_for('host.list_cars'))


@host_bp.route('/cars/image/<int:image_id>/delete')
@login_required
def delete_car_image(image_id):
    """Delete specific car image"""
    from models.car_image import CarImage

    host = Host.query.filter_by(user_id=current_user.id).first()
    image = CarImage.query.get_or_404(image_id)
    car = image.car

    # Check if host owns this car
    if car.host_id != host.id:
        flash('Access denied')
        return redirect(url_for('host.list_cars'))

    # Delete file
    filepath = os.path.join('static', 'uploads', image.filename)
    if os.path.exists(filepath):
        os.remove(filepath)

    db.session.delete(image)
    db.session.commit()
    flash('Image deleted successfully!')
    return redirect(url_for('host.edit_car', car_id=car.id))

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\dashboard.py ---
from flask import render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import host_bp
from models import db
from models.host import Host
from models.car import Car
from models.booking import Booking


@host_bp.route('/')
@login_required
def dashboard():
    """Host dashboard overview"""
    # --- CRITICAL FIX 1: Correct Host Lookup and Authorization ---
    # Fetch the host profile associated with the current user
    host = Host.query.filter_by(user_id=current_user.id).first()

    # Check if the host profile exists
    if not host:
        flash('Please complete your host profile first.', 'warning') # Use 'warning' category
        # Redirect to the host profile setup page
        # Make sure 'host.setup_profile' is the correct endpoint name for your profile setup route
        return redirect(url_for('host.setup_profile')) # Adjust endpoint name if needed
    # --- END CRITICAL FIX 1 ---

    # --- Fetch Host Statistics ---
    # 1. Total Cars Listed
    total_cars = Car.query.filter_by(host_id=host.id).count()

    # 2. Pending Booking Approvals
    # Join Booking with Car to link bookings to the host's cars
    # Filter for bookings with status 'pending' for the host's cars
    pending_approvals = Booking.query.join(Car).filter(
        Car.host_id == host.id,
        Booking.status == 'pending' # Use status field
    ).count()

    # 3. Active Bookings
    # Filter for bookings with status 'active' for the host's cars
    # --- CRITICAL FIX 2: Use 'status' field instead of non-existent 'is_active' ---
    active_bookings = Booking.query.join(Car).filter(
        Car.host_id == host.id,
        Booking.status == 'active' # Use status field to find active bookings
    ).count()
    # --- END CRITICAL FIX 2 ---

    # 4. Total Earnings (from host's wallet balance)
    total_earnings = host.wallet_balance # Assumes wallet_balance is updated correctly on the Host model

    # 5. Recent Pending Bookings (last 5)
    pending_bookings = Booking.query.join(Car).filter(
        Car.host_id == host.id,
        Booking.status == 'pending' # Filter for pending status
    ).order_by(Booking.created_at.desc()).limit(5).all()
    # --- End Fetch Statistics ---

    # --- Prepare Context for Template ---
    context = {
        'host': host,
        'total_cars': total_cars,
        'pending_approvals': pending_approvals,
        'active_bookings': active_bookings,
        'total_earnings': total_earnings,
        'pending_bookings': pending_bookings
    }
    # --- End Context ---

    # --- Render Template ---
    return render_template('host/dashboard.html', **context)
    # --- End Render ---
# --- End Dashboard Route ---


@host_bp.route('/bookings/<int:booking_id>/approve', methods=['POST'])
@login_required
def approve_booking(booking_id):
    """Approve a booking"""
    host = Host.query.filter_by(user_id=current_user.id).first()
    booking = Booking.query.get_or_404(booking_id)

    # Check if host owns this car
    if booking.car.host_id != host.id:
        flash('Access denied')
        return redirect(url_for('host.dashboard'))

    # Check if booking can be approved
    if not booking.can_be_approved():
        flash('This booking cannot be approved')
        return redirect(url_for('host.dashboard'))

    # Approve booking
    booking.host_approval = True
    booking.status = 'approved'
    db.session.commit()

    flash('Booking approved successfully!')
    return redirect(url_for('host.dashboard'))

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\payments.py ---
# routes/host/payment.py
from flask import render_template, request, redirect, url_for, flash, jsonify
from flask_login import login_required, current_user
from . import host_bp
from models import db
from models.host import Host
from models.booking import Booking


# If you create a dedicated Payment model later, import it here
# from models.payment import Payment

@host_bp.route('/payments')
@login_required
def list_payments():
    """Display host's payment history"""
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()

    # Query bookings related to this host's cars
    # For a more complex system, you'd have a dedicated Payment/Transaction model
    # linked to bookings or host wallet changes.
    # This example assumes earnings are tied directly to bookings.

    # Get all bookings for cars owned by this host
    bookings_query = Booking.query.join(Booking.car).filter(
        Booking.car.has(host_id=host.id)
    ).order_by(Booking.created_at.desc())

    # Simple pagination (optional, but good practice)
    page = request.args.get('page', 1, type=int)
    per_page = 10
    bookings_pagination = bookings_query.paginate(page=page, per_page=per_page, error_out=False)
    bookings = bookings_pagination.items

    # Calculate summary statistics
    total_earnings = sum(b.total_price for b in bookings if b.status == 'completed')  # Simplified
    pending_earnings = sum(b.total_price for b in bookings if b.status in ['pending', 'confirmed'])

    return render_template(
        'host/payments/list.html',
        host=host,
        bookings=bookings,
        bookings_pagination=bookings_pagination,
        total_earnings=total_earnings,
        pending_earnings=pending_earnings
    )

# Optional: Route for payment details (if you add a Payment model)
# @host_bp.route('/payments/<int:payment_id>')
# @login_required
# def payment_detail(payment_id):
#     host = Host.query.filter_by(user_id=current_user.id).first_or_404()
#     # Logic to fetch specific payment details
#     # payment = Payment.query.get_or_404(payment_id)
#     # ... check ownership ...
#     # return render_template('host/payments/detail.html', payment=payment)
#     pass

# Optional: Route for withdrawal requests (requires more logic and models)
# @host_bp.route('/payments/withdraw', methods=['GET', 'POST'])
# @login_required
# def withdraw_funds():
#     host = Host.query.filter_by(user_id=current_user.id).first_or_404()
#     # Logic for withdrawal form and processing
#     # if request.method == 'POST':
#     #     amount = float(request.form.get('amount', 0))
#     #     bank_account_id = int(request.form.get('bank_account'))
#     #     # ... validation and processing ...
#     # return render_template('host/payments/withdraw.html', host=host)
#     pass

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\profile.py ---
# routes/host/profile.py
from flask import render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import host_bp
from models import db
from models.host import Host


# If you create a WalletTransaction model later, import it here
# from models.wallet import WalletTransaction

@host_bp.route('/profile/wallet')  # <-- This creates the 'host.wallet' endpoint
@login_required
def wallet():
    """Display host's wallet information and transaction history"""
    host = Host.query.filter_by(user_id=current_user.id).first_or_404()

    # For now, just pass the host object which contains wallet_balance
    # In a full implementation, you'd query a Transaction/WalletHistory model

    # Example placeholder data (replace with real queries)
    # transactions = WalletTransaction.query.filter_by(host_id=host.id).order_by(WalletTransaction.created_at.desc()).limit(10).all()
    transactions = []  # Placeholder

    return render_template('host/profile/wallet.html', host=host, transactions=transactions)

# Optional: Route for withdrawal requests (requires more logic)
# @host_bp.route('/profile/wallet/withdraw', methods=['GET', 'POST'])
# @login_required
# def withdraw_funds():
#     host = Host.query.filter_by(user_id=current_user.id).first_or_404()
#     # Logic for withdrawal form and processing
#     # if request.method == 'POST':
#     #     amount = float(request.form.get('amount', 0))
#     #     bank_account_id = int(request.form.get('bank_account'))
#     #     # ... validation and processing ...
#     # return render_template('host/profile/withdraw.html', host=host)
#     pass


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\host\__init__.py ---
# routes/host/__init__.py
from flask import Blueprint

host_bp = Blueprint('host', __name__, url_prefix='/host')

# Import routes - THIS IS CRUCIAL TO REGISTER THEM
from . import dashboard, cars, auth, payments, analytics, profile, bookings  # Make sure 'auth' is imported

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\bookings.py ---
# routes/user/bookings.py
import razorpay
from flask import Blueprint, render_template, request, redirect, url_for, flash, current_app
from flask_login import login_required, current_user

from forms.user import StartTripForm
from models import db
from models.booking import Booking
from models.photo import Photo # Import the Photo model
from werkzeug.utils import secure_filename
import os
import json

# Import user_bp from the package's __init__.py
from routes.user import user_bp

RAZORPAY_KEY_ID = os.getenv('RAZORPAY_KEY_ID')
RAZORPAY_KEY_SECRET = os.getenv('RAZORPAY_KEY_SECRET')
if RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET:
    try:
        razorpay_client = razorpay.Client(auth=(RAZORPAY_KEY_ID, RAZORPAY_KEY_SECRET))
        razorpay_client.set_app_details({"title": "ZoomCarClone", "version": "1.0"})
    except Exception as e:
        current_app.logger.error(f"Error initializing Razorpay client in user/bookings: {e}")
        razorpay_client = None
else:
    current_app.logger.warning("Razorpay keys not found in environment variables (user/bookings).")
    razorpay_client = None
# - End Razorpay Client Initialization -


# --- List Bookings ---
@user_bp.route('/bookings') # This creates endpoint 'user.list_bookings'
@login_required
def list_bookings():
    """List the current user's bookings."""
    bookings = Booking.query.filter_by(user_id=current_user.id).order_by(Booking.created_at.desc()).all()
    return render_template('user/bookings/list.html', bookings=bookings)

# --- Booking Detail ---
@user_bp.route('/bookings/<int:booking_id>') # This creates endpoint 'user.booking_detail'
@login_required
def booking_detail(booking_id):
    """View detailed information for a specific booking."""
    booking = Booking.query.get_or_404(booking_id)

    # Authorization check
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    # Calculate min_extension_date (if needed for extensions, which are separate logic now)
    # min_extension_date = booking.get_min_extension_date() # Not used in new flow, but kept if extensions are still a feature elsewhere

    return render_template(
        'user/bookings/detail.html',
        booking=booking,
        # min_extension_date=min_extension_date # Pass if extensions are still used here
    )

# --- NEW: Trip Activation (Pickup Photos) ---
# --- NEW: Trip Activation (Pickup Photos) ---
# --- CRITICAL FIX: Ensure start_trip route uses the model method ---
@user_bp.route('/bookings/<int:booking_id>/start_trip', methods=['GET', 'POST'])
@login_required
def start_trip(booking_id):
    """
    Handle pickup photo upload and trip activation using WTForms.
    This is the 'user.start_trip' endpoint.
    """
    # --- Fetch Booking ---
    booking = Booking.query.get_or_404(booking_id)
    # --- End Fetch Booking ---

    # --- Authorization Check ---
    if booking.user_id != current_user.id:
        flash('Access denied.', 'danger')
        return redirect(url_for('car.home')) # Or redirect to a more appropriate page
    # --- End Authorization ---

    # --- Check if booking can be activated ---
    # Use the model method to ensure consistency
    if not booking.can_be_activated_by_user():
        flash('Trip cannot be started at this time.', 'warning')
        # Redirect back to the booking detail page for context
        return redirect(url_for('user.booking_detail', booking_id=booking.id))
    # --- End Check ---

    # --- CRITICAL FIX 2: Instantiate the StartTripForm ---
    # Pass the booking object to the form if needed for future custom validation
    form = StartTripForm(booking_obj=booking) # Create an instance of the form
    # --- END CRITICAL FIX 2 ---

    if request.method == 'POST':
        # --- CRITICAL FIX 3: Use WTForms Validation ---
        # First, check if the form (including CSRF) is valid
        if form.validate_on_submit(): # This checks CSRF token and FileAllowed validator
            # --- Handle POST: Process Uploaded Photos ---
            # Get the list of files directly from the request object
            # This is the standard and reliable way to get multiple files
            files = request.files.getlist('pickup_photos') # 'pickup_photos' is the name attribute of the input

            # --- CRITICAL FIX 4: Validate Number of Files (Server-Side) ---
            # Perform validation on the number of files selected
            # This is where the route-based validation (mentioned in the form class) happens.
            if len(files) > 10 or len(files) == 0: # Assuming max 10 photos, at least 1 required
                flash('Please select between 1 and 10 photos.', 'danger')
                # Re-render the template with the form (now defined) and booking
                # Pass any error context if needed
                return render_template('user/bookings/start_trip.html', booking=booking, form=form)
            # --- END CRITICAL FIX 4 ---

            uploaded_photo_records = [] # List to hold Photo model instances

            # Save files and create Photo records
            for file in files:
                # Check if a file was actually selected (browsers might send empty entries)
                if file and file.filename != '':
                    try:
                        filename = secure_filename(file.filename)
                        # Add booking ID to filename for uniqueness
                        name, ext = os.path.splitext(filename)
                        # Format: pickup_<booking_id>_<original_name><extension>
                        filename = f"pickup_{booking.id}_{name}{ext}"
                        filepath = os.path.join(current_app.config['UPLOAD_FOLDER'], filename)
                        file.save(filepath)

                        # Create Photo record in the database
                        photo = Photo(
                            booking_id=booking.id,
                            filename=filename,
                            photo_type='pickup' # Specify the type
                        )
                        db.session.add(photo)
                        uploaded_photo_records.append(photo) # Store for potential use

                    except Exception as e:
                        current_app.logger.error(f"Error saving pickup photo: {e}")
                        flash('An error occurred while saving photos. Please try again.', 'danger')
                        db.session.rollback() # Rollback on error
                        # Optionally, delete any files saved so far if partial save is undesirable
                        return render_template('user/bookings/start_trip.html', booking=booking, form=form) # Re-render with form

            # --- Activate the Trip ---
            # Call the model method to handle status changes
            if booking.activate_trip(): # This should now work with the updated logic
                try:
                    db.session.commit() # Commit both photo saves and booking activation
                    flash('Trip started successfully! Photos uploaded.', 'success')
                    # Redirect to booking detail page
                    return redirect(url_for('user.booking_detail', booking_id=booking.id))
                except Exception as e:
                    db.session.rollback()
                    current_app.logger.error(f"Error activating booking {booking.id}: {e}")
                    flash('Failed to start trip after uploading photos. Please try again.', 'danger')
                    # Optionally, delete saved files if DB commit fails
                    return render_template('user/bookings/start_trip.html', booking=booking, form=form) # Re-render with form
            else:
                db.session.rollback()
                flash('Failed to start trip. Please ensure the trip is eligible to start.', 'danger')
                return render_template('user/bookings/start_trip.html', booking=booking, form=form) # Re-render with form
            # --- End Activate Trip ---
        else:
            # If WTForms validation fails (e.g., CSRF error, file type error)
            # form.validate_on_submit() will automatically populate form.errors
            # The template will display these errors.
            # Log specific errors if needed
            # for fieldName, errorMessages in form.errors.items():
            #     current_app.logger.debug(f"Form field '{fieldName}' has errors: {errorMessages}")
            flash('Please correct the errors below and try again.', 'danger')
            # Re-render the template with the form (containing errors) and booking
            return render_template('user/bookings/start_trip.html', booking=booking, form=form)
        # --- END CRITICAL FIX 3 ---

    # GET request: Show the upload form
    # --- CRITICAL FIX 5: Pass the form instance to the template ---
    return render_template('user/bookings/start_trip.html', booking=booking, form=form)
    # --- END CRITICAL FIX 5 ---


# --- NEW: Trip Completion (Dropoff Photos) ---
@user_bp.route('/bookings/<int:booking_id>/complete_trip', methods=['GET', 'POST'])
@login_required
def complete_trip(booking_id):
    """Handle optional dropoff photo upload and trip completion."""
    booking = Booking.query.get_or_404(booking_id)

    # Authorization check
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    # Check if booking can be completed
    if not booking.can_be_completed_by_user():
        flash('Trip cannot be completed at this time.')
        return redirect(url_for('user.booking_detail', booking_id=booking.id))

    if request.method == 'POST':
        files = request.files.getlist('dropoff_photos')
        uploaded_photo_filenames = []

        # Validate and save photos (optional)
        if len(files) > 10:
            flash('Maximum of 10 photos allowed for dropoff.')
            return render_template('user/bookings/complete_trip.html', booking=booking)

        for file in files:
            if file and file.filename != '':
                try:
                    filename = secure_filename(file.filename)
                    # Add booking ID to filename for uniqueness
                    name, ext = os.path.splitext(filename)
                    filename = f"dropoff_{booking.id}_{name}{ext}"
                    filepath = os.path.join(current_app.config['UPLOAD_FOLDER'], filename)
                    file.save(filepath)

                    # Create Photo record
                    photo = Photo(
                        booking_id=booking.id,
                        filename=filename,
                        photo_type='dropoff' # Set type to 'dropoff'
                    )
                    db.session.add(photo)
                    uploaded_photo_filenames.append(filename) # Store for potential use
                except Exception as e:
                    current_app.logger.error(f"Error saving dropoff photo: {e}")
                    flash('An error occurred while saving photos. Please try again.')
                    db.session.rollback() # Rollback on error
                    return render_template('user/bookings/complete_trip.html', booking=booking)

        # Complete the trip using the Booking model method
        if booking.complete_trip(): # This changes status to 'completed' and handles earnings
            db.session.commit()
            flash('Trip completed successfully!', 'success')
            return redirect(url_for('user.booking_detail', booking_id=booking.id))
        else:
            db.session.rollback()
            flash('Failed to complete trip. Please try again.')
            return render_template('user/bookings/complete_trip.html', booking=booking)

    # GET request: Show the upload form (optional photos)
    return render_template('user/bookings/complete_trip.html', booking=booking)

# --- NEW: Cancel Booking (User Initiated) ---
@user_bp.route('/bookings/<int:booking_id>/cancel', methods=['POST'])
@login_required
def cancel_booking(booking_id):
    """Cancel a booking initiated by the user."""
    booking = Booking.query.get_or_404(booking_id)

    # Authorization check: Ensure the current user owns the booking
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))

    # Check if booking can be cancelled by user (using the model method)
    # This method should check status, time before start, etc.
    if not booking.can_be_cancelled_by_user():
        flash('This booking cannot be cancelled at this time.', 'warning')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))

    try:
        # Call the model method to handle cancellation logic
        booking.cancel_by_user() # Implement this method in the Booking model if not already done
        db.session.commit()
        flash('Booking cancelled successfully.')
    except Exception as e:
        print(f"Error cancelling booking: {e}") # Consider using logging
        flash('An error occurred while cancelling the booking.', 'danger')
        db.session.rollback() # Rollback on error

    return redirect(url_for('user.list_bookings')) # Redirect to list after cancellation

# --- NEW: Pay for Booking (User Initiated) ---
@user_bp.route('/bookings/<int:booking_id>/pay', methods=['GET'])
@login_required
def pay_booking(booking_id):
    """
    Initiate Razorpay payment for a specific booking.
    This is the 'user.pay_booking' endpoint.
    """
    booking = Booking.query.get_or_404(booking_id)

    # - Authorization Check -
    if booking.user_id != current_user.id:
        flash('Access denied.')
        return redirect(url_for('car.home'))
    # - End Authorization -

    # - Check if Booking can be Paid -
    if not booking.can_be_paid(): # Assuming you have this method in Booking model
        flash('This booking cannot be paid at this time.')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))
    # - End Check -

    # - Razorpay Integration -
    if not razorpay_client:
        flash('Payment gateway is currently unavailable. Please try again later.', 'danger')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))

    try:
        # Create a Razorpay Order
        order_data = {
            "amount": int(booking.total_price * 100),  # Razorpay expects amount in paise
            "currency": "INR",
            "receipt": f"booking_receipt_{booking.id}",
            "payment_capture": 1 # Auto-capture payment
        }
        razorpay_order = razorpay_client.order.create(order_data)
        razorpay_order_id = razorpay_order['id']

        # Store order ID in booking and commit
        booking.razorpay_order_id = razorpay_order_id
        db.session.commit() # Crucial: Save the order ID before rendering checkout

        # Prepare context for Razorpay Checkout Template
        context = {
            'booking': booking,
            'razorpay_key_id': RAZORPAY_KEY_ID,
            'razorpay_order_id': razorpay_order_id,
            'total_amount_paise': int(booking.total_price * 100),
            'total_amount_rupees': booking.total_price
        }

        # Render Razorpay Checkout Template Directly
        # This template will contain the Razorpay Checkout.js script
        return render_template('user/bookings/razorpay_checkout.html', **context)

    # - CRITICAL FIX: Catch the correct Razorpay exception -
    except razorpay.errors.BadRequestError as e: # Catch specific known errors or general Exception
        print(f"Razorpay API error (BadRequest): {e}")
        flash(f'Failed to initiate payment: {str(e)}', 'danger')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))
    except Exception as e: # Catch any other unexpected errors from Razorpay SDK
        db.session.rollback()
        print(f"Unexpected error in user.pay_booking: {e}")
        flash('An unexpected error occurred during payment processing. Please try again.', 'danger')
        return redirect(url_for('user.booking_detail', booking_id=booking_id))
    # - END CRITICAL FIX -
    # - End Razorpay Integration -

# --- END NEW: Pay for Booking ---



--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\dashboard.py ---
# routes/user/dashboard.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import user_bp
from models import db
from models.booking import Booking
from datetime import datetime
import pytz # Import pytz for timezone handling

@user_bp.route('/dashboard') # This route combined with url_prefix='/user' makes the full URL /user/dashboard
@login_required
def dashboard():
    """
    Display the user dashboard with upcoming trips.
    This is the 'user.dashboard' endpoint.
    """
    # --- Fetch Upcoming Bookings ---
    # Filter bookings where:
    # 1. The booking belongs to the current user
    # 2. The status indicates it's pending, approved, or paid (not cancelled/completed)
    # 3. The start date is in the future OR the trip is currently active
    now_utc = datetime.utcnow() # Get current time in UTC
    upcoming_bookings = Booking.query.filter(
        Booking.user_id == current_user.id,
        Booking.status.in_(['pending', 'approved', 'paid', 'active']), # Adjust statuses as needed
        Booking.start_date >= now_utc # Trip starts now or in the future, OR is active
    ).order_by(Booking.start_date.asc()).all() # Order by start date ascending (soonest first)
    # --- End Fetch Upcoming Bookings ---

    # --- Process Bookings for Template ---
    # Prepare a list of tuples (or dictionaries) containing booking and related data for the template
    processed_bookings = []
    for booking in upcoming_bookings:
        time_to_start = booking.start_date - now_utc
        # Check if within 1 hour to enable button (and status allows starting)
        enable_start_button = (
            time_to_start.total_seconds() <= (1 * 60 * 60) and # 1 hour in seconds
            time_to_start.total_seconds() > 0 and # Not already started
            booking.status in ['paid', 'approved'] # Check status
        )
        processed_bookings.append({
            'booking': booking,
            'time_to_start': time_to_start,
            'enable_start_button': enable_start_button
        })
    # --- End Process Bookings for Template ---

    # --- Fetch Wallet Data (Keep existing logic or adapt as needed) ---
    # Wallet balance is directly on the User object
    wallet_balance = current_user.wallet_balance

    # Fetch recent wallet transactions (Keep existing logic or adapt as needed)
    # For simplicity, using the direct query approach again
    from models.wallet_transaction import WalletTransaction
    recent_transactions = WalletTransaction.query.filter_by(
        user_id=current_user.id
    ).order_by(
        WalletTransaction.timestamp.desc()
    ).limit(5).all()
    # --- End Fetch Wallet Data ---

    # --- CRITICAL FIX: Get Server Time in IST ---
    # Get the current UTC time
    utc_now = datetime.utcnow()
    # Define UTC and IST timezones
    utc_tz = pytz.utc
    ist_tz = pytz.timezone('Asia/Kolkata') # Indian Standard Time
    # Localize the UTC datetime to UTC timezone (attach timezone info)
    utc_now_with_tz = utc_tz.localize(utc_now)
    # Convert the localized UTC time to IST
    ist_now = utc_now_with_tz.astimezone(ist_tz)
    # --- END CRITICAL FIX ---

    # --- Prepare Context for Template ---
    context = {
        'user': current_user,
        'upcoming_bookings': processed_bookings, # Pass the processed list
        'wallet_balance': wallet_balance,
        'recent_transactions': recent_transactions,
        # --- CRITICAL FIX: Pass IST time to template ---
        'server_time': ist_now # Pass the IST datetime object
        # --- END CRITICAL FIX ---
    }
    # --- End Context ---

    # --- Render Template ---
    return render_template('user/dashboard.html', **context)
    # --- End Render ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\notifications.py ---
# routes/user/notifications.py (example)
from flask import Blueprint, render_template # , login_required etc.

user_notifications_bp = Blueprint('user_notifications', __name__, url_prefix='/user')

@user_notifications_bp.route('/notifications') # This creates endpoint 'user_notifications.notifications'
def list_notifications(): # Function name contributes to endpoint if no 'endpoint' kwarg
    # ... logic to fetch notifications ...
    return render_template('user/notifications/list.html', notifications=notifications)

# Remember to register this blueprint in app.py
# app.register_blueprint(user_notifications_bp)


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\profile.py ---
# routes/user/profile.py
from flask import Blueprint, render_template, redirect, url_for, flash, request
from flask_login import login_required, current_user
from flask_wtf import FlaskForm # Import FlaskForm
# Remove: from wtforms.csrf.core import CSRFTokenField # No longer needed
from wtforms.fields.simple import StringField, TelField # Use TelField for phone
from wtforms.validators import ValidationError, DataRequired, \
    Email  # Import validators
from models import db # Import db if you need to commit changes

# Use the existing user blueprint from routes/user/__init__.py
# Make sure this import matches your project structure
from routes.user import user_bp

# --- CORRECTED: Define a Form with Fields and rely on FlaskForm's CSRF ---
class ProfileEditForm(FlaskForm): # INHERIT FROM FlaskForm (handles CSRF automatically)
    """A form class for editing user profile, including CSRF token."""
    # Add fields you want WTForms to handle (including validation if desired)
    username = StringField('Username', validators=[DataRequired()])
    email = StringField('Email', validators=[DataRequired(), Email()])
    phone = TelField('Phone') # TelField is more appropriate for phone numbers
    # Note: FlaskForm automatically adds and validates a CSRF token
    # No need to explicitly define csrf_token field
# --- END CORRECTED ---

@user_bp.route('/profile') # This decorator defines the route /user/profile
@login_required # Ensure the user is logged in to access this page
def profile():
    """
    Display the logged-in user's profile information.
    This creates the 'user.profile' endpoint.
    """
    # The 'current_user' object is provided by Flask-Login
    # It contains the details of the currently logged-in user

    # Render the profile template, passing the user object
    # This will look for templates/user/profile/view.html
    return render_template('user/profile/view.html', user=current_user)

# --- UPDATED: Route for editing profile with FlaskForm for CSRF and Validation ---
@user_bp.route('/profile/edit', methods=['GET', 'POST'])
@login_required
def edit_profile():
    """
    Allow the user to edit their profile information.
    This creates the 'user.edit_profile' endpoint.
    """
    form = ProfileEditForm() # Instantiate the form object

    # Pre-populate form fields with current user data on GET request
    if request.method == 'GET':
        form.username.data = current_user.username
        form.email.data = current_user.email
        form.phone.data = current_user.phone

    if form.validate_on_submit(): # This validates CSRF token AND form fields
        # Get validated data directly from the form object
        new_username = form.username.data
        new_email = form.email.data
        new_phone = form.phone.data # Can be None if not provided

        # Basic validation (add more as needed)
        # WTForms validators on username/email handle basic checks like required/valid email
        # We can add custom logic here if needed, e.g., checking uniqueness in DB
        # For now, just update assuming validation passed
        current_user.username = new_username
        current_user.email = new_email
        current_user.phone = new_phone # Can be None, which is fine

        try:
            db.session.commit() # Commit the changes to the database
            flash('Profile updated successfully!', 'success')
            return redirect(url_for('user.profile')) # Redirect back to the profile view
        except Exception as e:
            db.session.rollback() # Rollback on error
            flash(f'Error updating profile: {str(e)}', 'danger')
            # Re-render the form with errors (handled by WTForms)
            return render_template('user/profile/edit.html', user=current_user, form=form)

    # If form validation fails (including CSRF or field validation),
    # render the template again, passing the form which now contains errors
    return render_template('user/profile/edit.html', user=current_user, form=form)
# --- END UPDATED ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\wallet.py ---
# routes/user/wallet.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from . import user_bp
from models import db
# Import WalletTransaction
from models.wallet_transaction import WalletTransaction

@user_bp.route('/wallet')
@user_bp.route('/wallet/history') # Alias route for clarity
@login_required
def wallet():
    """
    Display the user's wallet balance and full transaction history.
    This is the 'user.wallet' endpoint.
    """
    # --- Fetch Wallet Data ---
    wallet_balance = current_user.wallet_balance
    # --- End Fetch Wallet Data ---

    # --- Fetch All Transactions with Pagination ---
    page = request.args.get('page', 1, type=int)
    per_page = 10 # Number of transactions per page

    transactions_query = WalletTransaction.query.filter_by(
        user_id=current_user.id
    ).order_by(
        WalletTransaction.timestamp.desc()
    )

    transactions_pagination = transactions_query.paginate(
        page=page, per_page=per_page, error_out=False
    )
    transactions = transactions_pagination.items
    # --- End Fetch Transactions ---

    # --- Prepare Context for Template ---
    context = {
        'wallet_balance': wallet_balance,
        'transactions': transactions,
        'transactions_pagination': transactions_pagination
    }
    # --- End Context ---

    # --- Render Template ---
    return render_template('user/wallet/list.html', **context)
    # --- End Render ---

# --- NEW: Transaction Detail Route ---
@user_bp.route('/wallet/transactions/<int:transaction_id>')
@login_required
def wallet_transaction_detail(transaction_id):
    """
    Display detailed information for a specific wallet transaction.
    This is the 'user.wallet_transaction_detail' endpoint.
    """
    # Fetch the transaction
    transaction = WalletTransaction.query.get_or_404(transaction_id)

    # Authorization: Ensure the transaction belongs to the current user
    if transaction.user_id != current_user.id:
        flash('Access denied.', 'danger')
        return redirect(url_for('user.wallet'))

    # --- Prepare Context for Template ---
    # You might want to fetch related objects based on reference_type/reference_id
    # For example, if reference_type is 'booking', fetch the Booking object
    related_object = None
    if transaction.reference_type == 'booking' and transaction.reference_id:
        from models.booking import Booking
        related_object = Booking.query.get(transaction.reference_id)
    elif transaction.reference_type == 'host_earning' and transaction.reference_id:
         # Example: if reference_id points to a Booking, fetch it
         from models.booking import Booking
         related_object = Booking.query.get(transaction.reference_id)
    # Add more elif blocks for other reference_types as needed

    context = {
        'transaction': transaction,
        'related_object': related_object # Pass the related object to the template
    }
    # --- End Context ---

    # --- Render Template ---
    return render_template('user/wallet/detail.html', **context)
    # --- End Render ---
# --- END NEW: Transaction Detail Route ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\__init__.py ---
from flask import Blueprint

user_bp = Blueprint('user', __name__, url_prefix='/user')

from . import dashboard, bookings, notifications, profile, wallet

__all__ = ['user_bp', 'dashboard', 'bookings', 'profile', 'wallet']

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\base.py ---
# routes/user/filters/base.py
from abc import ABC, abstractmethod
# from flask import request # Don't import request here

class BaseFilter(ABC):
    """Abstract base class for car listing filters."""
    param_name = None  # Must be set by subclasses

    @abstractmethod
    def apply(self, query, value):
        """Apply the filter to the SQLAlchemy query."""
        pass

    # --- CRITICAL: Ensure this method is defined correctly ---
    @classmethod
    def get_value_from_request(cls, request):
        """
        Get the filter value from the Flask request.
        This is the standard method for single-value filters.
        Override for multi-value (e.g., checkboxes) or range filters.
        """
        if cls.param_name:
            return request.args.get(cls.param_name)
        return None

    @classmethod
    def get_values_from_request(cls, request):
        """
        Get multiple filter values (e.g., for checkboxes) from the Flask request.
        Useful for filters like 'type' where multiple types can be selected.
        """
        if cls.param_name:
            return request.args.getlist(cls.param_name)
        return []
    # --- END CRITICAL ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\brand.py ---
# routes/user/filters/brand.py
from .base import BaseFilter
# from models.car import Car

class BrandFilter(BaseFilter):
    """Filter cars by brand/make (Maruti, Hyundai, etc.)."""
    param_name = 'brand'
    # Consider defining this list dynamically from your Car data if brands vary
    VALID_BRANDS = ['Maruti', 'Hyundai', 'Tata', 'Mahindra', 'Toyota', 'Honda', 'Ford', 'Volkswagen']

    def apply(self, query, value):
        """Apply the brand filter."""
        if value and value in self.VALID_BRANDS:
            from models.car import Car
            query = query.filter(Car.make == value) # Assumes 'make' field holds brand
        return query

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\car_type.py ---
# routes/user/filters/car_type.py
from .base import BaseFilter
# from models.car import Car

class CarTypeFilter(BaseFilter):
    """Filter cars by type (SUV, Hatchback, Sedan, etc.)."""
    param_name = 'type'
    VALID_TYPES = ['SUV', 'Hatchback', 'Sedan', 'MUV', 'Luxury', 'EV']

    def apply(self, query, value):
        """Apply the car type filter."""
        # Example: Filter by a 'car_type' field on Car model
        # Adjust 'car_type' to your actual field name
        if value and value in self.VALID_TYPES:
             from models.car import Car
             query = query.filter(Car.car_type == value)
        return query

    # --- CRITICAL: Ensure this method is defined correctly ---
    # Inherit the default get_value_from_request from BaseFilter
    # Or override if needed, but ALWAYS use @classmethod
    # @classmethod
    # def get_value_from_request(cls, request):
    #     # Use getlist if multiple values are expected (e.g., checkboxes)
    #     # return request.args.getlist(cls.param_name)
    #     # Or use get for single value
    #     return super().get_value_from_request(request) # Uses BaseFilter's logic
    # --- END CRITICAL ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\delivery_type.py ---
# routes/user/filters/delivery_type.py
from .base import BaseFilter
# from models.car import Car # Import when needed inside apply method

class DeliveryTypeFilter(BaseFilter):
    """
    Filter cars by delivery type (Self Pickup, Home Delivery, Airport Delivery).
    Expects URL parameter like `delivery=Self Pickup`.
    Note: This assumes your Car model has a way to indicate delivery options.
    This could be boolean flags (e.g., has_home_delivery), a string field (delivery_type),
    or derived from location/host details.
    For now, let's assume a simple string field `delivery_type` exists on Car.
    """
    param_name = 'delivery'
    VALID_DELIVERY_TYPES = {'Self Pickup', 'Home Delivery', 'Airport Delivery'}

    def apply(self, query, value):
        """
        Apply the delivery type filter to the query.
        """
        # Example implementation - adjust based on your actual Car model fields/logic
        if value and value in self.VALID_DELIVERY_TYPES:
            # This is a placeholder. You need to implement logic based on how
            # delivery type is represented/stored in your Car model.
            # Option 1: If Car has a 'delivery_type' field:
            # from models.car import Car
            # query = query.filter(Car.delivery_type == value)

            # Option 2: If delivery type is derived (e.g., based on location or host setting)
            # You would need more complex logic here, possibly involving joins or subqueries.
            # For example, if 'Self Pickup' means car.location is used:
            # if value == 'Self Pickup':
            #     # Logic already handled by location search? Or flag cars as self-pickup?

            # For demonstration, let's assume Option 1 with a 'delivery_option' field
            from models.car import Car
            # Normalize value if needed (e.g., handle case variations)
            normalized_value = value.strip().title() # Capitalize words
            query = query.filter(Car.delivery_option == normalized_value) # Adjust field name

        return query


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\distance.py ---
# routes/user/filters/distance.py
from .base import BaseFilter
# from models.car import Car

class DistanceFilter(BaseFilter):
    """
    Filter cars by maximum distance from the user's location.
    This filter works differently: it operates on a list of cars
    AFTER the main database query and distance calculation/sorting.
    Expects URL parameter like `max_distance=50`.
    """
    param_name = 'max_distance'

    def apply(self, query, value):
        """
        This filter's main logic is applied AFTER the initial query
        and distance calculation in the route (routes/car.py).
        This method on the query itself is a placeholder.
        The actual filtering happens in the route or via the static method below.
        """
        # Distance filtering is handled in routes/car.py after sorting.
        # Returning the query unchanged signals it's processed elsewhere.
        # This class mainly defines the parameter name.
        return query

    @staticmethod
    def filter_car_list(cars, max_distance_km):
        """
        Static method to filter a list of Car objects by a maximum distance.
        Assumes each car in the list has a 'display_distance_km' attribute
        calculated beforehand (e.g., in routes/car.py).

        Args:
            cars (list): List of Car objects, potentially with 'display_distance_km'.
            max_distance_km (str or float): Maximum allowed distance in kilometers.

        Returns:
            list: Filtered list of Car objects within the max distance.
        """
        if max_distance_km in [None, '', '']:
            return cars # No distance filter applied

        try:
            max_dist = float(max_distance_km)
        except (ValueError, TypeError):
            return cars # Invalid max distance, return all

        # Filter the list based on the pre-calculated distance attribute
        return [car for car in cars if hasattr(car, 'display_distance_km') and car.display_distance_km <= max_dist]

    # Override class method to get the distance value
    @classmethod
    def get_value_from_request(cls, request):
        return request.args.get(cls.param_name)

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\features.py ---
# routes/user/filters/features.py
from .base import BaseFilter
# from models.car import Car

class FeaturesFilter(BaseFilter):
    """
    Filter cars by specific features (e.g., AC, Bluetooth, Sunroof, GPS).
    Expects URL parameters like `features=AC&features=GPS`.
    Assumes Car model has boolean fields like has_ac, has_bluetooth, etc.
    """
    param_name = 'features' # Use get_values_from_request for multiple values
    VALID_FEATURES = {'ac', 'bluetooth', 'sunroof', 'gps', 'usb_port', 'reverse_camera'}

    def apply(self, query, values): # 'values' is a list from get_values_from_request
        """
        Apply the features filter to the query.
        Filters cars that have ALL the selected features enabled.
        """
        # values comes from get_values_from_request (list)
        if not values:
            return query

        # Sanitize and normalize feature names
        selected_features = [f.lower().strip() for f in values if f.lower().strip() in self.VALID_FEATURES]

        if not selected_features:
            return query

        from models.car import Car

        # Apply filter for each selected feature (AND logic)
        filter_conditions = []
        for feature in selected_features:
            # Map feature name to Car model field (assumes naming convention)
            field_name = f"has_{feature}"
            if hasattr(Car, field_name):
                filter_conditions.append(getattr(Car, field_name) == True)

        if filter_conditions:
            # Use * to unpack the list of conditions
            query = query.filter(*filter_conditions)

        return query

    # Override to get multiple values correctly
    @classmethod
    def get_value_from_request(cls, request):
        """
        Override to get a LIST of values for multi-select filters.
        """
        # Use getlist to get all values for the 'features' parameter
        return request.args.getlist(cls.param_name) # Returns a list, even if empty or one item

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\filters.py ---
# routes/user/filters/filters.py
# Central place to manage active filters
# from flask import request # Import inside functions if needed directly
# from . import FILTER_CLASSES # Import the list
from routes.user.filters import FeaturesFilter


def apply_filters_to_query(query, flask_request):
    """
    Iterates through active filters and applies them to the SQLAlchemy query.
    Handles standard single-value, multi-value (like checkboxes), and range filters.
    """
    # Import here to avoid potential circular import issues at init time
    from . import FILTER_CLASSES

    for FilterClass in FILTER_CLASSES:
        # --- CRITICAL: This is the line that was failing ---
        # Ensure FilterClass.get_value_from_request is correctly defined with @classmethod
        # --- END CRITICAL ---

        # Determine how to get the value based on filter type or convention
        # Option 1: Check for specific method names indicating multi-value
        # if hasattr(FilterClass, 'get_values_from_request'):
        #     values = FilterClass.get_values_from_request(flask_request)
        #     if values: # Apply if list is not empty
        #         filter_instance = FilterClass()
        #         query = filter_instance.apply(query, values)
        # else:
        #     # Standard single value
        #     value = FilterClass.get_value_from_request(flask_request)
        #     if value:
        #         filter_instance = FilterClass()
        #         query = filter_instance.apply(query, value)

        # Option 2: Let the filter class decide internally (often better)
        # The filter's apply method can call request.args.get or getlist as needed
        # But we still need to get the value(s) to decide if we should instantiate and apply

        # --- BEST PRACTICE: Let the filter handle its value retrieval internally ---
        # Instantiate the filter
        filter_instance = FilterClass()

        # Let the filter's apply method get its own values from the request if needed
        # This requires modifying the apply methods slightly or passing the request.
        # However, the standard pattern is to get the value here and pass it in.
        # Let's stick to the pattern: get value, check if exists, apply.

        # --- HANDLE DIFFERENT FILTER TYPES ---
        # Check if it's a range filter (has min/max params)
        if hasattr(FilterClass, 'param_min') or hasattr(FilterClass, 'param_max'):
            # For range filters, the apply method handles getting its own values from request
            # Pass None or a dummy value, or just call apply directly
            # The filter's apply method signature should match: apply(self, query, value=None)
            query = filter_instance.apply(query)
        # Check if it's a multi-value filter (like FeaturesFilter)
        elif FilterClass == FeaturesFilter: # Specific handling for known multi-value filter
             values = FilterClass.get_value_from_request(flask_request) # Gets list
             if values: # Apply if list is not empty
                 query = filter_instance.apply(query, values)
        else:
            # Standard single value filter
            value = FilterClass.get_value_from_request(flask_request)
            if value: # Apply if value exists (handles empty strings, None)
                # Pass the value to the instance's apply method
                query = filter_instance.apply(query, value)
        # --- END HANDLING ---

    return query

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\fuel_type.py ---
# routes/user/filters/fuel_type.py
from .base import BaseFilter
# from models.car import Car

class FuelTypeFilter(BaseFilter):
    """Filter cars by fuel type (Petrol, Diesel, CNG, EV)."""
    param_name = 'fuel'
    VALID_FUELS = ['Petrol', 'Diesel', 'CNG', 'EV', 'Electric']

    def apply(self, query, value):
        """Apply the fuel type filter."""
        if value and value in self.VALID_FUELS:
            from models.car import Car
            normalized_value = 'EV' if value == 'Electric' else value
            query = query.filter(Car.fuel_type == normalized_value)
        return query

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\model_year.py ---
# routes/user/filters/model_year.py
from .base import BaseFilter
# from models.car import Car

class ModelYearFilter(BaseFilter):
    """
    Filter cars by minimum model year.
    Expects URL parameter like `min_year=2020`.
    """
    param_name = 'min_year'
    MIN_VALID_YEAR = 1950
    MAX_VALID_YEAR = 2030

    def apply(self, query, value):
        """Apply the model year filter to the query."""
        # value comes from get_value_from_request (single value)
        if not value:
            return query

        try:
            min_year = int(value)
            if min_year < self.MIN_VALID_YEAR or min_year > self.MAX_VALID_YEAR:
                 return query

            from models.car import Car
            query = query.filter(Car.year >= min_year)

        except (ValueError, TypeError):
            pass
        return query

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\price_range.py ---
# routes/user/filters/price_range.py
from .base import BaseFilter
# from models.car import Car

class PriceRangeFilter(BaseFilter):
    """Filter cars by price per day range."""
    # Note: This filter uses TWO parameters, so we override the base methods slightly
    param_min = 'min_price'
    param_max = 'max_price'

    def apply(self, query, value=None): # Value not used directly here
        """
        Apply the price range filter to the query.
        Gets min/max values directly from the request.
        """
        # Import request locally or pass it if needed, but here we get it from args
        from flask import request
        from models.car import Car

        min_price_str = request.args.get(self.param_min)
        max_price_str = request.args.get(self.param_max)

        try:
            if min_price_str:
                min_price = float(min_price_str)
                query = query.filter(Car.price_per_day >= min_price)
            if max_price_str:
                max_price = float(max_price_str)
                query = query.filter(Car.price_per_day <= max_price)
        except (ValueError, TypeError):
             pass # Gracefully handle invalid inputs

        return query

    # Override class methods since we use two params
    # These are not typically called by the filter manager for range filters,
    # but good to define for consistency or if needed elsewhere.
    @classmethod
    def get_value_from_request(cls, request):
        # Not directly usable for a range, but could return a tuple
        min_val = request.args.get(cls.param_min)
        max_val = request.args.get(cls.param_max)
        return (min_val, max_val) # Or just return None

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\seating_capacity.py ---
# routes/user/filters/seating_capacity.py
from .base import BaseFilter
# from models.car import Car

class SeatingCapacityFilter(BaseFilter):
    """Filter cars by seating capacity range."""
    param_min = 'min_seats'
    param_max = 'max_seats'

    def apply(self, query, value=None): # Value not used directly here
        """Apply the seating capacity range filter."""
        from flask import request
        from models.car import Car

        min_seats_str = request.args.get(self.param_min)
        max_seats_str = request.args.get(self.param_max)

        try:
            if min_seats_str:
                min_seats = int(min_seats_str)
                query = query.filter(Car.seats >= min_seats)
            if max_seats_str:
                max_seats = int(max_seats_str)
                query = query.filter(Car.seats <= max_seats)
        except (ValueError, TypeError):
            pass # Gracefully handle invalid inputs
        return query

    # Override class methods if needed (similar to price range)
    @classmethod
    def get_value_from_request(cls, request):
        min_val = request.args.get(cls.param_min)
        max_val = request.args.get(cls.param_max)
        return (min_val, max_val)

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\some_filter.py ---
# routes/user/filters/some_filter.py
from routes.user.filters import BaseFilter


class SomeFilter(BaseFilter):
    param_name = 'something'

    # --- WRONG: Incorrect signature for a classmethod ---
    @classmethod
    def get_value_from_request(self, request): # <-- Should be 'cls', not 'self'
        if self.param_name: # <-- Should be 'cls.param_name'
            return request.args.get(self.param_name) # <-- Should be 'cls.param_name'
        return None
    # --- END WRONG ---

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\transmission.py ---
# routes/user/filters/transmission.py
from .base import BaseFilter
# from models.car import Car

class TransmissionFilter(BaseFilter):
    """Filter cars by transmission type (Manual, Automatic)."""
    param_name = 'transmission'
    VALID_TRANSMISSIONS = ['Manual', 'Automatic']

    def apply(self, query, value):
        """Apply the transmission filter."""
        if value and value in self.VALID_TRANSMISSIONS:
            from models.car import Car
            query = query.filter(Car.transmission == value)
        return query

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\routes\user\filters\__init__.py ---
# routes/user/filters/__init__.py
# This file makes the 'filters' directory a Python package.
# It also imports and exposes filter classes for easier access.

# --- Import filter classes ---
from .base import BaseFilter
from .car_type import CarTypeFilter
from .distance import DistanceFilter
from .transmission import TransmissionFilter
from .fuel_type import FuelTypeFilter
from .seating_capacity import SeatingCapacityFilter
# from .delivery_type import DeliveryTypeFilter # Uncomment if implemented and fixed
from .price_range import PriceRangeFilter
# from .brand import BrandFilter # Uncomment if implemented
from .model_year import ModelYearFilter
from .features import FeaturesFilter
# --- End Imports ---

# --- List of active filter classes for easy iteration ---
# Make sure this list only includes filters whose classes are correctly defined
FILTER_CLASSES = [
    CarTypeFilter,
    TransmissionFilter,
    FuelTypeFilter,
    SeatingCapacityFilter,
    # DeliveryTypeFilter, # Add only if working
    PriceRangeFilter,
    # BrandFilter, # Add only if working
    ModelYearFilter,
    FeaturesFilter,
    # DistanceFilter, # Add if you want it managed by the standard loop (though logic is special)
]
# --- End List ---

__all__ = [
    'BaseFilter',
    'CarTypeFilter',
    'TransmissionFilter',
    'FuelTypeFilter',
    'SeatingCapacityFilter',
    # 'DeliveryTypeFilter',
    'PriceRangeFilter',
    # 'BrandFilter',
    'ModelYearFilter',
    'FeaturesFilter',
    'DistanceFilter',
    'FILTER_CLASSES'
]

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\static\style.css ---
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --success-color: #27ae60;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #34495e;
    --border-radius: 8px;
    --box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    --transition: all 0.3s ease;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    line-height: 1.6;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 15px;
}

header {
    text-align: center;
    margin-bottom: 30px;
    padding: 25px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    backdrop-filter: blur(10px);
}

header h1 {
    color: var(--secondary-color);
    font-size: 2.5rem;
    margin-bottom: 10px;
}

header p {
    color: var(--dark-color);
    font-size: 1.1rem;
}

.alert {
    background: var(--danger-color);
    color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Add Car Form - Responsive */
.add-car-form {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 40px;
    backdrop-filter: blur(10px);
}

.add-car-form h2 {
    color: var(--secondary-color);
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.8rem;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark-color);
}

.form-group input,
.form-group select {
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.file-upload {
    border: 2px dashed #ddd;
    border-radius: var(--border-radius);
    padding: 20px;
    text-align: center;
    transition: var(--transition);
    cursor: pointer;
    background: #f8f9fa;
}

.file-upload:hover {
    border-color: var(--primary-color);
    background: #e3f2fd;
}

.file-upload i {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: 10px;
    display: block;
}

#image-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.preview-image-container {
    position: relative;
    display: inline-block;
}

.preview-image {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: var(--border-radius);
    border: 2px solid #ddd;
    transition: var(--transition);
}

.preview-image:hover {
    transform: scale(1.05);
    border-color: var(--primary-color);
}

.remove-preview {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    border: 2px solid white;
}

.form-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 20px;
}

.btn {
    padding: 12px 25px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: var(--transition);
    min-width: 120px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
}

.btn-secondary {
    background: var(--dark-color);
    color: white;
}

.btn-secondary:hover {
    background: #2c3e50;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 73, 94, 0.3);
}

/* Car List - Responsive Grid */
.car-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.car-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
    transition: var(--transition);
    backdrop-filter: blur(10px);
}

.car-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.car-images {
    position: relative;
    height: 200px;
    overflow: hidden;
}

.car-image-main {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: var(--transition);
}

.image-counter {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.no-image-placeholder {
    width: 100%;
    height: 200px;
    background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 14px;
}

.car-info {
    padding: 20px;
}

.car-info h3 {
    color: var(--secondary-color);
    margin-bottom: 10px;
    font-size: 1.4rem;
}

.car-details {
    margin: 15px 0;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
}

.detail-label {
    font-weight: 600;
    color: var(--dark-color);
}

.detail-value {
    color: var(--secondary-color);
    font-weight: 500;
}

.price-tag {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--success-color);
    margin: 10px 0;
}

.actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.actions .btn {
    flex: 1;
    min-width: 100px;
    padding: 10px 15px;
    font-size: 14px;
}

/* Edit Car Page */
.edit-car-form {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 30px;
    backdrop-filter: blur(10px);
}

.edit-car-form h2 {
    color: var(--secondary-color);
    margin-bottom: 25px;
    text-align: center;
    font-size: 2rem;
}

.current-images-section {
    margin: 25px 0;
}

.current-images-section h3 {
    color: var(--dark-color);
    margin-bottom: 15px;
    font-size: 1.3rem;
}

.current-images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
}

.image-item {
    position: relative;
    display: inline-block;
}

.current-image {
    width: 100%;
    height: 90px;
    object-fit: cover;
    border-radius: var(--border-radius);
    border: 2px solid #ddd;
    transition: var(--transition);
}

.current-image:hover {
    border-color: var(--primary-color);
    transform: scale(1.05);
}

.delete-image-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    border: 2px solid white;
    transition: var(--transition);
}

.delete-image-btn:hover {
    background: #c0392b;
    transform: scale(1.1);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    backdrop-filter: blur(10px);
}

.empty-state i {
    font-size: 4rem;
    color: #ddd;
    margin-bottom: 20px;
    display: block;
}

.empty-state h3 {
    color: var(--dark-color);
    margin-bottom: 15px;
    font-size: 1.8rem;
}

.empty-state p {
    color: #777;
    font-size: 1.1rem;
    margin-bottom: 20px;
}

/* Responsive Breakpoints */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    header h1 {
        font-size: 2rem;
    }

    .add-car-form {
        padding: 20px;
    }

    .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .car-list {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .car-card {
        margin: 0 5px;
    }

    .car-images {
        height: 180px;
    }

    .car-info {
        padding: 15px;
    }

    .actions {
        flex-direction: column;
    }

    .actions .btn {
        width: 100%;
    }

    .form-buttons {
        flex-direction: column;
    }

    .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    header {
        padding: 15px;
    }

    header h1 {
        font-size: 1.5rem;
    }

    .add-car-form {
        padding: 15px;
    }

    .car-images {
        height: 150px;
    }

    .car-info h3 {
        font-size: 1.2rem;
    }

    .price-tag {
        font-size: 1.3rem;
    }

    #image-preview {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
    }

    .preview-image,
    .current-image {
        height: 70px;
    }
}

@media (min-width: 1200px) {
    .car-list {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }
}

/* Loading Animation */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Smooth transitions */
* {
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\static\css\dashboard.css ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\static\css\host.css ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\static\css\style.css ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\static\css\user.css ---
/* static/css/user.css */
/* Import Google Fonts if needed (ensure it matches base.html) */
/* @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'); */

:root {
    --user-primary: #00b4d8;
    --user-secondary: #0077b6;
    --user-accent: #ff9e00;
    --user-dark: #1d3557;
    --user-light: #f8f9fa;
    --user-success: #28a745;
    --user-danger: #dc3545;
    --user-warning: #ffc107;
    --user-info: #17a2b8;
}

/* --- Base Styles (Mirroring/Extending base.html styles) --- */
body {
    font-family: 'Inter', sans-serif;
    background-color: #f8fafc;
}

/* --- Filter Chips --- */
.filter-chip {
    transition: all 0.2s ease;
    cursor: pointer;
}

.filter-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.filter-chip.active {
    background-color: var(--user-primary);
    color: white;
    border-color: var(--user-primary);
}
/* --- End Filter Chips --- */

/* --- Car Cards --- */
.car-card {
    transition: all 0.3s ease;
    border-radius: 16px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.car-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.car-image {
    transition: transform 0.5s ease;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.car-card:hover .car-image {
    transform: scale(1.05);
}
/* --- End Car Cards --- */

/* --- Map Container --- */
.map-container {
    background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    height: 100%; /* Adjust as needed */
}

.map-overlay {
    position: absolute;
    bottom: 12px;
    left: 12px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    z-index: 10; /* Ensure it's above map tiles */
}
/* --- End Map Container --- */

/* --- Filter Drawer --- */
.filter-drawer {
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
    z-index: 1050; /* Higher than navbar */
}

.suggestions-list {
    z-index: 1000; /* Ensure it's above other content */
    max-height: 200px;
    overflow-y: auto;
}
/* --- End Filter Drawer --- */

/* --- Price Slider --- */
.price-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--user-primary);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.price-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--user-primary);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
/* --- End Price Slider --- */

/* --- Badges --- */
.badge-primary {
    background: var(--user-primary);
    color: white;
}

.badge-secondary {
    background: var(--user-secondary);
    color: white;
}

.badge-accent {
    background: var(--user-accent);
    color: white;
}

.badge-success {
    background: var(--user-success);
    color: white;
}

.badge-danger {
    background: var(--user-danger);
    color: white;
}

.badge-warning {
    background: var(--user-warning);
    color: black; /* Warning text is usually black */
}

.badge-info {
    background: var(--user-info);
    color: white;
}
/* --- End Badges --- */

/* --- Booking Buttons --- */
.booking-btn {
    background: linear-gradient(135deg, var(--user-primary) 0%, var(--user-secondary) 100%);
    transition: all 0.3s ease;
    color: white;
    border: none;
}

.booking-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3);
    color: white; /* Ensure text color stays white on hover */
}

.apply-filters-btn {
    background: var(--user-primary);
    color: white;
    transition: all 0.3s ease;
    border: none;
}

.apply-filters-btn:hover {
    background: #009bc5; /* Slightly darker shade for hover */
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3);
}
/* --- End Booking Buttons --- */

/* --- Search Bar --- */
.search-bar {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}
/* --- End Search Bar --- */

/* --- Header Sticky --- */
.header-sticky {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}
/* --- End Header Sticky --- */

/* --- Stat Cards --- */
.stat-card {
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}
/* --- End Stat Cards --- */

/* --- Entity Cards --- */
.entity-card {
    transition: all 0.3s ease;
}

.entity-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
/* --- End Entity Cards --- */

/* --- Sort Dropdown --- */
.sort-dropdown {
    position: relative;
}

.sort-dropdown-content {
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    width: 200px;
    z-index: 10;
    display: none;
}

.sort-dropdown:hover .sort-dropdown-content {
    display: block;
}

.sort-option {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    text-decoration: none;
    display: block;
    color: inherit;
}

.sort-option:hover {
    background-color: #f1f5f9;
}

.sort-option.active {
    font-weight: 600;
    color: var(--user-primary);
}
/* --- End Sort Dropdown --- */

/* --- Filter Count --- */
.filter-count {
    background-color: var(--user-primary);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    margin-left: 4px;
}
/* --- End Filter Count --- */

/* --- Filter Tag --- */
.filter-tag {
    background-color: #e0f7fa;
    border: 1px solid #b3e5fc;
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 12px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.filter-tag .remove {
    cursor: pointer;
    color: #0077b6;
    text-decoration: none;
}
/* --- End Filter Tag --- */

/* --- Car Grid --- */
.car-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}
/* --- End Car Grid --- */

/* --- Pagination --- */
.pagination {
    display: flex;
    justify-content: center;
    margin-top: 30px;
    gap: 8px;
}

.pagination a, .pagination span { /* Style both links and current page span */
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: white;
    cursor: pointer;
    text-decoration: none; /* Remove underline */
    color: inherit; /* Inherit text color */
}

.pagination .active { /* Specific style for active page */
    background: var(--user-primary);
    color: white;
    border-color: var(--user-primary);
}

.pagination a:hover:not(.active) {
    background: #f1f5f9;
}
/* --- End Pagination --- */

/* --- Car Skeleton (Loading Placeholder) --- */
.car-skeleton {
    border-radius: 16px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.skeleton-img {
    height: 160px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

.skeleton-line {
    height: 16px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    margin: 8px 0;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
/* --- End Car Skeleton --- */


/* --- Additional User-Specific Styles --- */

/* Profile Section */
.profile-section {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.profile-section h3 {
    color: var(--user-dark);
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.profile-detail {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.profile-label {
    font-weight: 600;
    color: var(--user-secondary);
}

.profile-value {
    color: var(--user-dark);
    font-weight: 500;
}

/* Booking Detail Page */
.booking-detail-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 20px;
}

.booking-detail-header {
    background: linear-gradient(135deg, var(--user-dark), var(--user-secondary));
    color: white;
    padding: 20px;
}

.booking-detail-body {
    padding: 20px;
}

.booking-status-badge {
    font-size: 0.9rem;
    padding: 5px 10px;
    border-radius: 20px;
}

/* Wallet Section */
.wallet-summary {
    background: linear-gradient(135deg, #4cc9f0, #4361ee);
    color: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.wallet-summary h3 {
    margin-bottom: 10px;
    font-size: 1.5rem;
}

.wallet-summary p {
    margin-bottom: 5px;
    font-size: 1rem;
}

.wallet-transactions {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 20px;
}

.wallet-transactions h3 {
    color: var(--user-dark);
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.transaction-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.transaction-description {
    font-weight: 500;
}

.transaction-amount {
    font-weight: 600;
}

.transaction-positive {
    color: var(--user-success);
}

.transaction-negative {
    color: var(--user-danger);
}

.transaction-date {
    font-size: 0.8rem;
    color: #777;
}

/* Notifications */
.notification-item {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.notification-item.unread {
    border-left: 4px solid var(--user-primary);
}

.notification-title {
    font-weight: 600;
    color: var(--user-dark);
    margin-bottom: 5px;
}

.notification-message {
    color: #555;
    margin-bottom: 10px;
}

.notification-date {
    font-size: 0.8rem;
    color: #999;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .car-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .filter-drawer {
        width: 100%;
        max-width: none;
    }

    .sort-dropdown-content {
        width: 150px;
    }

    .profile-section, .booking-detail-card, .wallet-summary, .wallet-transactions {
        padding: 15px;
    }
}

/* --- End Additional User-Specific Styles --- */


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\static\js\host.js ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\static\js\main.js ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\base.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ZoomCar Clone{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff6b35;
            --secondary: #2a9d8f;
            --dark: #264653;
            --light: #f8f9fa;
        }

        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--dark), var(--secondary));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .hero-section {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 60px 0;
            text-align: center;
            margin-bottom: 30px;
        }

        .search-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            margin: -50px auto 30px;
            max-width: 800px;
            position: relative;
            z-index: 10;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .btn-primary {
            background: var(--primary);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #e55a2b;
        }

        .car-card {
            transition: transform 0.3s ease;
            height: 100%;
        }

        .car-card:hover {
            transform: translateY(-5px);
        }

        .feature-card {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .feature-card i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('car.home') }}">
                <i class="fas fa-car"></i> ZoomCar Clone
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('car.home') }}">Home</a>
                    </li>
                    {% if current_user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('booking.my_bookings') }}">My Bookings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.login') }}">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.register') }}">Register</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% block scripts %}{% endblock %}
</body>
</html>

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\booking.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
</html>

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\booking_confirmation.html ---
{% extends "base.html" %}

{% block title %}Booking Confirmation - ZoomCar Clone{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0"><i class="fas fa-check-circle"></i> Booking Confirmed!</h3>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-calendar-check fa-4x text-success mb-3"></i>
                <h4>Thank you for your booking!</h4>
                <p class="text-muted">Booking ID: #{{ booking.id }}</p>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="border rounded p-3">
                            <h5>{{ booking.car.make }} {{ booking.car.model }}</h5>
                            <p class="text-muted">{{ booking.car.year }}</p>
                            <p>₹{{ "%.2f"|format(booking.car.price_per_day) }} per day</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3">
                            <h5>Dates</h5>
                            <p><i class="fas fa-calendar-start"></i> {{ booking.start_date.strftime('%Y-%m-%d') }}</p>
                            <p><i class="fas fa-calendar-end"></i> {{ booking.end_date.strftime('%Y-%m-%d') }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3 class="text-primary">Total Amount: ₹{{ "%.2f"|format(booking.total_price) }}</h3>
                </div>
                
                <div class="mt-4">
                    <p class="text-muted">
                        Your booking is confirmed. You will receive a confirmation email shortly.
                    </p>
                </div>
                
                <div class="mt-4">
                    <a href="{{ url_for('booking.my_bookings') }}" class="btn btn-primary">
                        <i class="fas fa-calendar"></i> View All Bookings
                    </a>
                    <a href="{{ url_for('car.home') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-home"></i> Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\car_detail.html ---
<!-- templates/car_detail.html -->
{% extends "base.html" %} <!-- Or your main base template -->

{% block title %}{{ car.make }} {{ car.model }} - ZoomCar Clone{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="bg-white border rounded-2xl overflow-hidden shadow-sm">
        <!-- Car Images Carousel -->
        <div class="relative h-64 md:h-80 w-full overflow-hidden">
            {% if car.images %}
                <div id="carImageCarousel" class="carousel slide relative h-full w-full" data-bs-ride="carousel">
                    <div class="carousel-inner h-full w-full">
                        {% for image in car.images %}
                        <div class="carousel-item h-full w-full {% if loop.first %}active{% endif %}">
                            <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                 class="d-block w-full h-full object-cover car-image transition-transform duration-500"
                                 alt="{{ car.make }} {{ car.model }} Image {{ loop.index }}">
                        </div>
                        {% endfor %}
                    </div>
                    {% if car.images|length > 1 %}
                    <button class="carousel-control-prev absolute top-1/2 left-0 transform -translate-y-1/2 z-10 p-2 text-white bg-black/30 rounded-e-lg" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon inline-block" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next absolute top-1/2 right-0 transform -translate-y-1/2 z-10 p-2 text-white bg-black/30 rounded-s-lg" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon inline-block" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
            {% else %}
                <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center">
                    <i class="fas fa-car text-gray-400 text-4xl"></i>
                </div>
            {% endif %}
            {% if car.badge %}
            <div class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">
                {{ car.badge }}
            </div>
            {% endif %}
        </div>

        <div class="p-6">
            <!-- Car Title & Details -->
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 leading-tight">{{ car.make }} {{ car.model }} ({{ car.year }})</h1>
                    <p class="text-sm text-gray-600 mt-1">{{ car.transmission }} • {{ car.fuel_type }} • {{ car.seats }} seats</p>
                </div>
                <div class="flex flex-col items-end">
                    <!-- --- UPDATED: Pricing Display (Hour-based) --- -->
                    <div class="text-2xl md:text-3xl font-bold text-gray-900">₹{{ "%.2f"|format(car.price_per_hour) }}</div>
                    <div class="text-sm text-gray-500">/ hour</div>
                    <!-- --- END UPDATED: Pricing Display (Hour-based) --- -->
                    {% if car.display_distance_km is defined %}
                    <div class="text-xs text-gray-500 mt-1">{{ car.display_distance_km }} km away</div>
                    {% endif %}
                </div>
            </div>

            <!-- Location & Host Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-primary"></i> Pickup Location
                    </h3>
                    <p class="text-sm">
                        <!-- FIXED: Access location details directly from car object -->
                        {% if car.full_address %}
                            {{ car.full_address }}
                        {% else %}
                            {% if car.street_address %}{{ car.street_address }}, {% endif %}
                            {% if car.locality %}{{ car.locality }}, {% endif %}
                            {% if car.city %}{{ car.city }}{% endif %}
                            {% if car.pincode %} - {{ car.pincode }}{% endif %}
                        {% endif %}
                    </p>
                    {% if car.latitude and car.longitude %}
                    <div class="mt-2 text-xs text-gray-500">
                        Coordinates: {{ "%.6f"|format(car.latitude) }}, {{ "%.6f"|format(car.longitude) }}
                    </div>
                    {% endif %}
                </div>
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-user-tie text-primary"></i> Hosted By
                    </h3>
                    <p class="text-sm font-medium">{{ car.host.company_name or car.host.user.username }}</p>
                    <p class="text-xs text-gray-500 mt-1">Verified Host</p>
                    <!-- Placeholder for Host Rating -->
                    <div class="flex items-center gap-1 text-sm mt-2">
                        <i class="fas fa-star text-yellow-400"></i>
                        <span class="font-semibold">4.7</span>
                        <span class="text-gray-500">(89 reviews)</span>
                    </div>
                </div>
            </div>

            <!-- Car Specifications -->
            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-info-circle text-primary"></i> Specifications
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div>
                        <span class="font-medium">Make:</span> {{ car.make }}
                    </div>
                    <div>
                        <span class="font-medium">Model:</span> {{ car.model }}
                    </div>
                    <div>
                        <span class="font-medium">Year:</span> {{ car.year }}
                    </div>
                    <div>
                        <span class="font-medium">Color:</span> {{ car.color or 'N/A' }}
                    </div>
                    <div>
                        <span class="font-medium">Mileage:</span> {{ car.mileage or 'N/A' }} km
                    </div>
                    <div>
                        <span class="font-medium">Fuel Type:</span> {{ car.fuel_type }}
                    </div>
                    <div>
                        <span class="font-medium">Transmission:</span> {{ car.transmission }}
                    </div>
                    <div>
                        <span class="font-medium">Seating:</span> {{ car.seats }} seats
                    </div>
                </div>
            </div>

            <!-- Features -->
            {% if car.has_ac or car.has_bluetooth or car.has_sunroof or car.has_gps or car.has_usb_port or car.has_reverse_camera %}
            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-star text-primary"></i> Features
                </h3>
                <div class="flex flex-wrap gap-2">
                    {% if car.has_ac %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">AC</span>{% endif %}
                    {% if car.has_bluetooth %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">Bluetooth</span>{% endif %}
                    {% if car.has_sunroof %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">Sunroof</span>{% endif %}
                    {% if car.has_gps %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">GPS</span>{% endif %}
                    {% if car.has_usb_port %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">USB Port</span>{% endif %}
                    {% if car.has_reverse_camera %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">Reverse Camera</span>{% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Booking Form -->
            <div class="border rounded-xl p-4 bg-blue-50">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-primary"></i> Book This Car
                </h3>

                {% if current_user.is_authenticated %}
                <!-- CRITICAL FIX 2: Corrected the form action URL -->
                <form id="bookingForm" method="POST" action="{{ url_for('booking.initiate_booking', car_id=car.id) }}">
                     <!-- CRITICAL FIX: Manually Add CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- END CRITICAL FIX -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- --- UPDATED: Input Type to datetime-local (Hour-based) --- -->
                        <div>
                            <label for="start_datetime" class="block text-sm font-medium text-gray-700 mb-1">Start Date & Time</label>
                            <input type="datetime-local" id="start_datetime" name="start_datetime"
                                   class="w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                   min="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}"
                                   value="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}" required>
                        </div>
                        <div>
                            <label for="end_datetime" class="block text-sm font-medium text-gray-700 mb-1">End Date & Time</label>
                            <input type="datetime-local" id="end_datetime" name="end_datetime"
                                   class="w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                   min="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}"
                                   value="{{ default_end_datetime.strftime('%Y-%m-%dT%H:%M') if default_end_datetime else '' }}" required>
                        </div>
                        <!-- --- END UPDATED: Input Type to datetime-local (Hour-based) --- -->
                    </div>

                    <div class="mb-4">
                        <!-- --- UPDATED: Labels and Calculation Logic (Hour-based) --- -->
                        <div class="flex justify-between items-center text-sm">
                            <span>Duration (Hours):</span>
                            <span id="numHours">0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-1">
                            <span>Price per Hour:</span>
                            <span>₹{{ "%.2f"|format(car.price_per_hour) }}</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between items-center font-semibold text-base">
                            <span>Total Cost:</span>
                            <span id="totalCost">₹0.00</span>
                        </div>
                        <!-- --- END UPDATED: Labels and Calculation Logic (Hour-based) --- -->
                    </div>

                    <button type="submit" class="w-full bg-primary text-white rounded-xl px-4 py-3 font-medium hover:bg-blue-600 transition-colors">
                        <i class="fas fa-credit-card mr-2"></i> Proceed to Payment
                    </button>
                    <a href="{{ url_for('booking.show_booking_initiation', car_id=car.id) }}" class="btn btn-primary">
                        <i class="fas fa-calendar-plus"></i> Book Now
                    </a>
                </form>
                {% else %}
                <div class="text-center py-4">
                    <p class="text-gray-600 mb-3">Please login to book this car.</p>
                    <a href="{{ url_for('auth.login') }}" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i> Login to Book
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- UPDATED: Variable Names and Input IDs (Hour-based) ---
    const startDateTimeInput = document.getElementById('start_datetime');
    const endDateTimeInput = document.getElementById('end_datetime');
    const numHoursSpan = document.getElementById('numHours'); // Changed ID
    const totalCostSpan = document.getElementById('totalCost');
    const pricePerHour = {{ car.price_per_hour }}; // Use price_per_hour
    // --- END UPDATED: Variable Names and Input IDs (Hour-based) ---

    function updateBookingDetails() {
        // --- UPDATED: Get datetime values (Hour-based) ---
        const startDateTimeStr = startDateTimeInput.value;
        const endDateTimeStr = endDateTimeInput.value;

        if (startDateTimeStr && endDateTimeStr) {
            const startDateTime = new Date(startDateTimeStr);
            const endDateTime = new Date(endDateTimeStr);

            if (endDateTime >= startDateTime) {
                const timeDiff = endDateTime.getTime() - startDateTime.getTime();
                const hoursDiff = timeDiff / (1000 * 3600); // Convert milliseconds to hours
                const numHours = hoursDiff > 0 ? hoursDiff : 0.01; // Minimum e.g., 0.01 hours (36 seconds)

                numHoursSpan.textContent = numHours.toFixed(2); // Display with 2 decimal places
                const totalCost = numHours * pricePerHour;
                totalCostSpan.textContent = `₹${totalCost.toFixed(2)}`; // Display with 2 decimal places
            } else {
                numHoursSpan.textContent = 'Invalid';
                totalCostSpan.textContent = 'Invalid';
            }
        } else {
             numHoursSpan.textContent = '0.00'; // Reset if inputs are empty
             totalCostSpan.textContent = '₹0.00';
        }
    }

    if (startDateTimeInput && endDateTimeInput) {
        startDateTimeInput.addEventListener('change', updateBookingDetails);
        endDateTimeInput.addEventListener('change', updateBookingDetails);
        // Initialize on load
        updateBookingDetails();
    }

    // Set minimum datetime for end datetime based on start datetime
    if (startDateTimeInput) {
        startDateTimeInput.addEventListener('change', function() {
            if (endDateTimeInput) {
                endDateTimeInput.min = this.value; // Set minimum to start datetime
                // If end datetime is before new start datetime, reset it
                if (new Date(endDateTimeInput.value) < new Date(this.value)) {
                    endDateTimeInput.value = this.value;
                }
                updateBookingDetails();
            }
        });
    }
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\car_list.html ---
<!-- templates/car_list.html -->
{% extends "base.html" %}
{% block title %}Available Cars - ZoomCar Clone{% endblock %}
{% block styles %}
{{ super() }}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f5f7fa;
    }

    .filter-chip:checked+div,
    .filter-chip:checked+div {
        background-color: #1A73E8;
        /* Blue for active */
        color: white;
        border-color: #1A73E8;
    }

    .price-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1A73E8;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .price-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1A73E8;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .car-card {
        transition: all 0.3s ease;
        transform: translateY(0);
    }

    .car-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .car-image {
        transition: transform 0.5s ease;
    }

    .car-card:hover .car-image {
        transform: scale(1.05);
    }

    .filter-section {
        transition: all 0.3s ease;
    }

    .filter-section:hover {
        background-color: #f8f9fa;
    }

    .mobile-filter-drawer {
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .mobile-filter-drawer.open {
        transform: translateX(0);
    }

    .sort-dropdown-content {
        transform: translateY(-10px);
        opacity: 0;
        transition: all 0.3s ease;
    }

    .sort-dropdown-content.show {
        transform: translateY(0);
        opacity: 1;
    }

    .filter-tag {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Specific adjustments for active filter tags */
    .filter-tag .remove:hover {
        color: #dc2626; /* Red on hover for remove icon */
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-4 px-4 sm:px-6 lg:px-8 py-4">
    <!-- Filters Sidebar -->
    <aside class="hidden lg:block lg:col-span-3">
        <div class="bg-white border rounded-2xl p-4 shadow-sm sticky top-24">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-lg">Filters</h2>
                <button id="clearAllFilters"
                    class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">
                    Clear All
                </button>
            </div>
            <!-- Filter Form -->
            <form id="carFiltersForm" method="GET" action="{{ url_for('car.car_list') }}">
                <!-- Pass through existing NON-FILTER search/location parameters -->
                {% for key, value in request.args.items() %}
                {% if key not in ['type', 'transmission', 'fuel', 'min_seats', 'max_seats', 'min_price', 'max_price',
                'brand', 'min_year', 'features'] %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
                {% endfor %}
                <!-- Ensure user_lat and user_lng are always passed -->
                <input type="hidden" name="user_lat" value="{{ user_location.lat }}">
                <input type="hidden" name="user_lng" value="{{ user_location.lng }}">

                <!-- Quick Picks -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-sliders-h text-primary"></i> Quick Picks
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <a href="#"
                            class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300">Top
                            Rated</a>
                        <a href="#"
                            class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300">Price:
                            Low to High</a>
                        <a href="#"
                            class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300">Price:
                            High to Low</a>
                        <a href="{{ url_for('car.car_list', user_lat=user_location.lat, user_lng=user_location.lng) }}"
                            class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-primary text-white border-primary">Recommended</a>
                    </div>
                </div>

                <!-- Car Type Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-car text-primary"></i> Car Type
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set car_types = ['SUV', 'Hatchback', 'Sedan', 'MUV', 'Luxury', 'EV'] %}
                        {% for type in car_types %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="type" value="{{ type }}" class="hidden peer filter-chip"
                                {% if type in active_filters.types %}checked{% endif %}>
                            <div
                                class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                {{ type }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Transmission Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-cog text-primary"></i> Transmission
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set transmissions = ['Manual', 'Automatic'] %}
                        {% for trans in transmissions %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="transmission" value="{{ trans }}" class="hidden peer filter-chip"
                                {% if trans in active_filters.transmissions %}checked{% endif %}>
                            <div
                                class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                {{ trans }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Fuel Type Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-gas-pump text-primary"></i> Fuel Type
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set fuels = ['Petrol', 'Diesel', 'CNG', 'EV', 'Electric'] %}
                        {% for fuel in fuels %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="fuel" value="{{ fuel }}" class="hidden peer filter-chip"
                                {% if fuel in active_filters.fuels %}checked{% endif %}>
                            <div
                                class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                {{ fuel }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Seating Capacity Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-users text-primary"></i> Seating Capacity
                    </h3>
                    <div class="flex items-center gap-3">
                        <input type="number" id="minSeats" name="min_seats" min="2" max="20"
                            value="{{ active_filters.min_seats or '' }}" placeholder="Min"
                            class="w-20 rounded-lg border px-2 py-1 text-sm filter-input">
                        <span class="text-sm text-gray-500">to</span>
                        <input type="number" id="maxSeats" name="max_seats" min="2" max="20"
                            value="{{ active_filters.max_seats or '' }}" placeholder="Max"
                            class="w-20 rounded-lg border px-2 py-1 text-sm filter-input">
                    </div>
                </div>

                <!-- Price Range Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-rupee-sign text-primary"></i> Max Price (₹/day)
                    </h3>
                    <div class="space-y-2">
                        <input type="range" id="priceSlider" name="max_price_slider" min="500" max="10000" step="100"
                            value="{{ active_filters.max_price or '10000' }}"
                            class="w-full price-slider h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>₹500</span>
                            <span id="priceValue">Up to ₹{{ active_filters.max_price or '10000' }}</span>
                            <span>₹10000</span>
                        </div>
                        <input type="hidden" name="max_price" id="maxPriceInput"
                            value="{{ active_filters.max_price or '10000' }}">
                        <input type="hidden" name="min_price" id="minPriceInput"
                            value="{{ active_filters.min_price or '0' }}">
                    </div>
                </div>

                <!-- Brand Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-building text-primary"></i> Brand
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set brands = ['Maruti', 'Hyundai', 'Tata', 'Mahindra', 'Toyota', 'Honda', 'Ford',
                        'Volkswagen'] %}
                        {% for brand in brands %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="brand" value="{{ brand }}" class="hidden peer filter-chip"
                                {% if brand in active_filters.brands %}checked{% endif %}>
                            <div
                                class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                {{ brand }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Model Year Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary"></i> Model Year
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set years = ['2020', '2021', '2022', '2023', '2024'] %}
                        {% for year in years %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="min_year" value="{{ year }}" class="hidden peer filter-chip"
                                {% if active_filters.min_year == year %}checked{% endif %}>
                            <div
                                class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                {{ year }}+
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Features Filter -->
                <div class="filter-section mb-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-star text-primary"></i> Features
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set features = ['ac', 'bluetooth', 'sunroof', 'gps'] %}
                        {% set feature_labels = {'ac': 'AC', 'bluetooth': 'Bluetooth', 'sunroof': 'Sunroof', 'gps':
                        'GPS'} %}
                        {% for feature in features %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="features" value="{{ feature }}"
                                class="hidden peer filter-chip" {% if feature in active_filters.features
                                %}checked{% endif %}>
                            <div
                                class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                {{ feature_labels[feature] }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Apply Filters Button -->
                <div class="pt-4">
                    <button type="submit"
                        class="w-full apply-filters-btn bg-primary text-white rounded-xl px-4 py-2 font-medium hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </aside>

    <!-- Results Section -->
    <section class="lg:col-span-9 space-y-4">
        <!-- Toolbar -->
        <div class="bg-white border rounded-2xl p-3 shadow-sm flex flex-wrap items-center gap-2 justify-between">
            <div class="flex items-center gap-2">
                <button id="mobileFilterToggle"
                    class="md:hidden inline-flex items-center gap-2 px-3 py-2 border rounded-xl">
                    <i class="fas fa-filter"></i> Filters
                </button>
                <div class="text-sm text-gray-600"><span id="carCount">{{ cars|length }}</span> cars found</div>
            </div>
            <div class="flex items-center gap-2">
                <div class="sort-dropdown relative">
                    <button id="sortButton"
                        class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 text-sm">
                        <i class="fas fa-sort-amount-down"></i> Sort
                        <i class="fas fa-chevron-down ml-1"></i>
                    </button>
                    <div id="sortDropdown"
                        class="sort-dropdown-content absolute right-0 top-full mt-1 w-48 bg-white border rounded-xl shadow-lg py-1 hidden z-10">
                        <a href="?{{ request.args|urlencode }}&sort=recommended"
                            class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 sort-option">Recommended</a>
                        <a href="?{{ request.args|urlencode }}&sort=price_low_high"
                            class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 sort-option">Price: Low to
                            High</a>
                        <a href="?{{ request.args|urlencode }}&sort=price_high_low"
                            class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 sort-option">Price: High to
                            Low</a>
                        <a href="?{{ request.args|urlencode }}&sort=distance"
                            class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 sort-option">Distance</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applied Filters Tags -->
        <div class="bg-white border rounded-2xl p-3 shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-700">Applied Filters</h3>
                <button id="resetFilters" class="text-xs text-primary font-medium">Reset</button>
            </div>
            <div class="flex flex-wrap gap-2" id="activeFilters">
                <!-- Filter tags will be populated by JavaScript or Jinja2 -->
                {% if active_filters.types or active_filters.transmissions or active_filters.fuels or
                active_filters.brands or active_filters.features or active_filters.min_seats or
                active_filters.max_seats or active_filters.min_price or active_filters.max_price or
                active_filters.min_year %}
                {% for type in active_filters.types %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ type }}</span>
                    <button class="remove cursor-pointer" data-type="type" data-value="{{ type }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endfor %}
                {% for trans in active_filters.transmissions %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ trans }}</span>
                    <button class="remove cursor-pointer" data-type="transmission" data-value="{{ trans }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endfor %}
                {% for fuel in active_filters.fuels %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ fuel }}</span>
                    <button class="remove cursor-pointer" data-type="fuel" data-value="{{ fuel }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endfor %}
                {% for brand in active_filters.brands %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ brand }}</span>
                    <button class="remove cursor-pointer" data-type="brand" data-value="{{ brand }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endfor %}
                {% for feature in active_filters.features %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ feature_labels.get(feature, feature) }}</span>
                    <button class="remove cursor-pointer" data-type="feature" data-value="{{ feature }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endfor %}
                {% if active_filters.min_seats %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Min Seats: {{ active_filters.min_seats }}</span>
                    <button class="remove cursor-pointer" data-type="min_seats" data-value="{{ active_filters.min_seats }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endif %}
                {% if active_filters.max_seats %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Max Seats: {{ active_filters.max_seats }}</span>
                    <button class="remove cursor-pointer" data-type="max_seats" data-value="{{ active_filters.max_seats }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endif %}
                {% if active_filters.min_price %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Min Price: ₹{{ active_filters.min_price }}</span>
                    <button class="remove cursor-pointer" data-type="min_price" data-value="{{ active_filters.min_price }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endif %}
                {% if active_filters.max_price %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Max Price: ₹{{ active_filters.max_price }}</span>
                    <button class="remove cursor-pointer" data-type="max_price" data-value="{{ active_filters.max_price }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endif %}
                {% if active_filters.min_year %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Min Year: {{ active_filters.min_year }}+</span>
                    <button class="remove cursor-pointer" data-type="year" data-value="{{ active_filters.min_year }}"><i
                            class="fas fa-times"></i></button>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
        <!-- End Applied Filters Tags -->

        <!-- Car Listings Grid -->
        <div id="carGrid" class="car-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% if cars %}
            {% for car in cars %}
            <div class="car-card bg-white border rounded-2xl overflow-hidden shadow-sm">
                <div class="relative h-48 w-full overflow-hidden">
                    {% if car.images and car.images[0] %}
                    <img src="{{ url_for('static', filename='uploads/' + car.images[0].filename) }}"
                        alt="{{ car.make }} {{ car.model }}"
                        class="w-full h-full object-cover car-image transition-transform duration-500">
                    {% else %}
                    <div
                        class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center">
                        <i class="fas fa-car text-gray-400 text-4xl"></i>
                    </div>
                    {% endif %}
                    {% if loop.index == 1 %}
                    <div
                        class="absolute top-2 left-2 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">
                        Top Pick
                    </div>
                    {% endif %}
                </div>
                <div class="p-4">
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <div>
                            <h3 class="font-bold text-gray-800 leading-tight">{{ car.make }} {{ car.model }} ({{
                                car.year }})</h3>
                            <p class="text-xs text-gray-500 mt-1">{{ car.transmission }} • {{ car.fuel_type }} • {{
                                car.seats }} seats</p>
                        </div>
                        <div class="flex items-center gap-1 text-sm">
                            <i class="fas fa-star text-yellow-400"></i>
                            <span class="font-semibold">4.5</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm mb-3">
                        <div class="text-gray-600">
                            <i class="fas fa-map-marker-alt text-primary mr-1"></i>
                            {% if car.locality %}{{ car.locality }}, {% endif %}
                            {{ car.city }}
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-gray-900">₹{{ "%.0f"|format(car.price_per_hour) }}</div>
                            <div class="text-xs text-gray-500">/ day</div>
                            {% if car.display_distance_km is defined %}
                            <div class="text-xs text-gray-500">{{ car.display_distance_km }} km away</div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Inside the car card loop in templates/car_list.html -->
<!-- ... existing car card HTML ... -->
<div class="mt-3 flex items-center gap-2">
    <!-- Update this button/link -->
                    <a href="{{ url_for('car.car_detail', car_id=car.id) }}"
                       class="flex-1 text-center text-sm font-medium bg-primary text-white rounded-xl px-3 py-2 transition-all hover:bg-blue-600">
                        <i class="fas fa-info-circle mr-1"></i> View Details
                    </a>
                    <button class="text-sm px-3 py-2 rounded-xl border text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
<!-- ... end existing car card HTML ... -->
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="col-span-full text-center py-10">
                <i class="fas fa-car fa-3x text-gray-300 mb-3"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No cars found</h3>
                <p class="text-gray-500 mb-4">Try adjusting your filters or search criteria.</p>
                <a href="{{ url_for('car.home') }}"
                    class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-search mr-2"></i> Search Again
                </a>
            </div>
            {% endif %}
        </div>
        <!-- End Car Listings Grid -->

        <!-- Pagination (Placeholder) -->
        <!--
        <div class="pagination flex justify-center mt-6 gap-2">
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">1</button>
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">2</button>
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">3</button>
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
        </div>
        -->
    </section>
</div>

<!-- Mobile Filters Drawer -->
<div id="mobileFilterDrawer" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" id="drawerBackdrop"></div>
    <div class="mobile-filter-drawer absolute right-0 top-0 h-full w-full max-w-md bg-white p-4 overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Filters</h3>
            <button id="closeFilterDrawer" class="p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="mobileFiltersContent">
            <!-- Mobile filters content - simplified version of sidebar -->
            <form id="mobileCarFiltersForm">
                 <!-- Pass through existing NON-FILTER search/location parameters -->
                 {% for key, value in request.args.items() %}
                 {% if key not in ['type', 'transmission', 'fuel', 'min_seats', 'max_seats', 'min_price', 'max_price',
                 'brand', 'min_year', 'features'] %}
                 <input type="hidden" name="{{ key }}" value="{{ value }}">
                 {% endif %}
                 {% endfor %}
                 <!-- Ensure user_lat and user_lng are always passed -->
                 <input type="hidden" name="user_lat" value="{{ user_location.lat }}">
                 <input type="hidden" name="user_lng" value="{{ user_location.lng }}">
                <div class="space-y-6">
                    <!-- Car Type -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Car Type</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for type in car_types %}
                            <label class="cursor-pointer">
                                <input type="checkbox" name="type" value="{{ type }}" class="hidden peer filter-chip"
                                    {% if type in active_filters.types %}checked{% endif %}>
                                <div
                                    class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                    {{ type }}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Transmission -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Transmission</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for trans in transmissions %}
                            <label class="cursor-pointer">
                                <input type="checkbox" name="transmission" value="{{ trans }}"
                                    class="hidden peer filter-chip" {% if trans in active_filters.transmissions
                                    %}checked{% endif %}>
                                <div
                                    class="px-3 py-1.5 rounded-full border text-sm bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-colors">
                                    {{ trans }}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Max Price (₹/day)</h4>
                        <div class="space-y-2">
                            <input type="range" id="mobilePriceSlider" name="max_price_slider_mobile" min="500" max="10000" step="100"
                                value="{{ active_filters.max_price or '10000' }}"
                                class="w-full price-slider h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>₹500</span>
                                <span id="mobilePriceValue">Up to ₹{{ active_filters.max_price or '10000' }}</span>
                                <span>₹10000</span>
                            </div>
                            <input type="hidden" name="max_price" id="mobileMaxPriceInput"
                                value="{{ active_filters.max_price or '10000' }}">
                        </div>
                    </div>

                    <!-- Seating Capacity -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Seating Capacity</h4>
                        <div class="flex items-center gap-3">
                            <input type="number" id="mobileMinSeats" name="min_seats" min="2" max="20"
                                value="{{ active_filters.min_seats or '' }}" placeholder="Min"
                                class="w-20 rounded-lg border px-2 py-1 text-sm">
                            <span class="text-sm text-gray-500">to</span>
                            <input type="number" id="mobileMaxSeats" name="max_seats" min="2" max="20"
                                value="{{ active_filters.max_seats or '' }}" placeholder="Max"
                                class="w-20 rounded-lg border px-2 py-1 text-sm">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="pt-4 flex items-center gap-2 border-t border-gray-200 mt-4">
            <button id="applyMobileFilters"
                class="flex-1 bg-primary text-white rounded-xl px-4 py-2 font-medium">
                Apply Filters
            </button>
            <button id="resetMobileFilters"
                class="px-4 py-2 rounded-xl border text-gray-700 hover:bg-gray-100">
                Reset
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // --- Dummy Car Data (for client-side filtering demo - replace with real data if needed) ---
    // Note: In a real app, this would likely come from the server or be used for initial rendering.
    // Since the Flask backend handles filtering, this is primarily for UI interaction feedback.
    const cars = [
        { id: 1, make: 'Maruti', model: 'Swift', year: 2022, transmission: 'Manual', fuel_type: 'Petrol', seats: 5, price_per_day: 2500, features: ['ac', 'bluetooth'], city: 'Bangalore', locality: 'Koramangala', images: [] },
        { id: 2, make: 'Hyundai', model: 'Creta', year: 2021, transmission: 'Automatic', fuel_type: 'Diesel', seats: 5, price_per_day: 3500, features: ['ac', 'sunroof'], city: 'Bangalore', locality: 'Indiranagar', images: [] },
        { id: 3, make: 'Tata', model: 'Nexon', year: 2023, transmission: 'Manual', fuel_type: 'Petrol', seats: 5, price_per_day: 2800, features: ['ac', 'bluetooth', 'gps'], city: 'Bangalore', locality: 'Whitefield', images: [] },
        { id: 4, make: 'Mahindra', model: 'XUV300', year: 2020, transmission: 'Manual', fuel_type: 'Diesel', seats: 5, price_per_day: 3200, features: ['ac'], city: 'Bangalore', locality: 'HSR Layout', images: [] },
        { id: 5, make: 'Toyota', model: 'Innova', year: 2019, transmission: 'Manual', fuel_type: 'Diesel', seats: 7, price_per_day: 4500, features: ['ac', 'bluetooth'], city: 'Bangalore', locality: 'Jayanagar', images: [] },
        { id: 6, make: 'Honda', model: 'City', year: 2022, transmission: 'Automatic', fuel_type: 'Petrol', seats: 5, price_per_day: 3000, features: ['ac', 'bluetooth', 'sunroof'], city: 'Bangalore', locality: 'Marathahalli', images: [] }
    ];

    // --- DOM Elements ---
    const carGrid = document.getElementById('carGrid');
    const carCountElement = document.getElementById('carCount');
    const activeFilters = document.getElementById('activeFilters');
    const priceSlider = document.getElementById('priceSlider');
    const priceValue = document.getElementById('priceValue');
    const maxPriceInput = document.getElementById('maxPriceInput');
    const minPriceInput = document.getElementById('minPriceInput'); // Might be used later
    const minSeats = document.getElementById('minSeats');
    const maxSeats = document.getElementById('maxSeats');
    const sortButton = document.getElementById('sortButton');
    const sortDropdown = document.getElementById('sortDropdown');
    const mobileFilterToggle = document.getElementById('mobileFilterToggle');
    const mobileFilterDrawer = document.getElementById('mobileFilterDrawer');
    const closeFilterDrawer = document.getElementById('closeFilterDrawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    const clearAllFilters = document.getElementById('clearAllFilters');
    const resetFilters = document.getElementById('resetFilters');
    const applyMobileFiltersBtn = document.getElementById('applyMobileFilters');
    const resetMobileFiltersBtn = document.getElementById('resetMobileFilters');
    const filterChips = document.querySelectorAll('.filter-chip');
    const filterInputs = document.querySelectorAll('.filter-input');

    // --- Initialize the page ---
    document.addEventListener('DOMContentLoaded', function () {
        // Initial render and event listeners are handled by Flask/Jinja2 for server-side filtering
        // But we can still set up client-side interactions for immediate feedback
        setupEventListeners();
        // updateActiveFilters(); // Already populated by Jinja2
    });

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        // Price slider
        if (priceSlider) {
            priceSlider.addEventListener('input', function () {
                priceValue.textContent = `Up to ₹${this.value}`;
                maxPriceInput.value = this.value;
                // applyFilters(); // Client-side filtering - commented out as server handles it
            });
        }

        // Seating capacity inputs
        if (minSeats) minSeats.addEventListener('input', /* applyFilters */ function () { /* UI feedback */ });
        if (maxSeats) maxSeats.addEventListener('input', /* applyFilters */ function () { /* UI feedback */ });

        // Filter chips (checkboxes)
        filterChips.forEach(chip => {
            chip.addEventListener('change', function () {
                // applyFilters(); // Client-side filtering - commented out
                // updateActiveFilters(); // Client-side update - commented out
                // Instead, we can trigger form submit for server-side filtering
                document.getElementById('carFiltersForm').submit(); // Submit the main form
            });
        });

        // Filter inputs (number fields)
        filterInputs.forEach(input => {
             input.addEventListener('change', function() {
                 document.getElementById('carFiltersForm').submit(); // Submit the main form
             });
        });

        // Sort dropdown toggle
        if (sortButton && sortDropdown) {
            sortButton.addEventListener('click', function (e) {
                e.stopPropagation();
                sortDropdown.classList.toggle('hidden');
                sortDropdown.classList.toggle('show');
            });

            document.addEventListener('click', function (e) {
                if (!sortButton.contains(e.target) && !sortDropdown.contains(e.target)) {
                    sortDropdown.classList.add('hidden');
                    sortDropdown.classList.remove('show');
                }
            });

            // Sort options (links) - These links already have href, so they work. JS just closes dropdown.
            document.querySelectorAll('.sort-option').forEach(option => {
                option.addEventListener('click', function () {
                    sortDropdown.classList.add('hidden');
                    sortDropdown.classList.remove('show');
                    // sortButton.innerHTML = `<i class="fas fa-sort-amount-down"></i> ${this.textContent} <i class="fas fa-chevron-down ml-1"></i>`;
                    // Actual sorting is handled by the link's href (server-side)
                });
            });
        }

        // Mobile filter drawer
        if (mobileFilterToggle) mobileFilterToggle.addEventListener('click', openMobileDrawer);
        if (closeFilterDrawer) closeFilterDrawer.addEventListener('click', closeMobileDrawer);
        if (drawerBackdrop) drawerBackdrop.addEventListener('click', closeMobileDrawer);

        // Clear/Reset filters
        if (clearAllFilters) clearAllFilters.addEventListener('click', resetAllFilters);
        if (resetFilters) resetFilters.addEventListener('click', resetAllFilters);

        // Mobile Apply/Reset
        if (applyMobileFiltersBtn) applyMobileFiltersBtn.addEventListener('click', applyMobileFilters);
        if (resetMobileFiltersBtn) resetMobileFiltersBtn.addEventListener('click', resetMobileFilters);

        // Remove filter tag buttons (added by Jinja2 or JS)
        document.querySelectorAll('#activeFilters .remove').forEach(button => {
            button.addEventListener('click', function () {
                const type = this.getAttribute('data-type');
                const value = this.getAttribute('data-value');
                removeFilter(type, value);
            });
        });
    }

    // --- Mobile Filter Drawer Logic ---
    function openMobileDrawer() {
        mobileFilterDrawer.classList.remove('hidden');
        setTimeout(() => {
            document.querySelector('.mobile-filter-drawer').classList.add('open');
        }, 10);
    }

    function closeMobileDrawer() {
        document.querySelector('.mobile-filter-drawer').classList.remove('open');
        setTimeout(() => {
            mobileFilterDrawer.classList.add('hidden');
        }, 300);
    }

    // Apply mobile filters (sync to desktop form and submit)
    function applyMobileFilters() {
        // Sync mobile inputs to main form
        const mobileMinSeatsValue = document.getElementById('mobileMinSeats').value || '';
        const mobileMaxSeatsValue = document.getElementById('mobileMaxSeats').value || '';
        const mobileMaxPriceValue = document.getElementById('mobileMaxPriceInput').value || '10000';
        const mobilePriceSliderValue = document.getElementById('mobilePriceSlider').value || '10000';

        // Update main form inputs
        if (document.querySelector('input[name="min_seats"]')) {
            document.querySelector('input[name="min_seats"]').value = mobileMinSeatsValue;
        }
        if (document.querySelector('input[name="max_seats"]')) {
            document.querySelector('input[name="max_seats"]').value = mobileMaxSeatsValue;
        }
        if (maxPriceInput) {
            maxPriceInput.value = mobileMaxPriceValue;
            // Also update the desktop slider if it exists and differs
            if (priceSlider && priceSlider.value != mobilePriceSliderValue) {
                 priceSlider.value = mobilePriceSliderValue;
                 priceValue.textContent = `Up to ₹${mobilePriceSliderValue}`;
            }
        }

        // Sync checkboxes/radios if needed (they are separate forms but share names)
        // A more robust way is to collect mobile form data and set main form data
        // For simplicity, we'll assume they are synced by name/value on submit.
        // Alternatively, collect mobile data and set main form elements.

        // Collect mobile filter states
        const mobileSelectedTypes = Array.from(document.querySelectorAll('#mobileFiltersContent input[name="type"]:checked')).map(cb => cb.value);
        const mobileSelectedTransmissions = Array.from(document.querySelectorAll('#mobileFiltersContent input[name="transmission"]:checked')).map(cb => cb.value);
        // ... other mobile filters

        // Set main form filter states to match mobile
        // Uncheck all main form chips first
        document.querySelectorAll('#carFiltersForm input[name="type"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('#carFiltersForm input[name="transmission"]').forEach(cb => cb.checked = false);
        // ... uncheck others

        // Check the ones selected in mobile
        mobileSelectedTypes.forEach(type => {
            const mainCheckbox = document.querySelector(`#carFiltersForm input[name="type"][value="${type}"]`);
            if (mainCheckbox) mainCheckbox.checked = true;
        });
        mobileSelectedTransmissions.forEach(trans => {
            const mainCheckbox = document.querySelector(`#carFiltersForm input[name="transmission"][value="${trans}"]`);
            if (mainCheckbox) mainCheckbox.checked = true;
        });
        // ... sync others

        // Now submit the main desktop form
        document.getElementById('carFiltersForm').submit();
        closeMobileDrawer();
    }

    // Reset mobile filters
    function resetMobileFilters() {
        // Reset mobile inputs
        const mobilePriceSlider = document.getElementById('mobilePriceSlider');
        if (mobilePriceSlider) {
            const defaultValue = mobilePriceSlider.max;
            mobilePriceSlider.value = defaultValue;
            document.getElementById('mobilePriceValue').textContent = `Up to ₹${defaultValue}`;
            document.getElementById('mobileMaxPriceInput').value = defaultValue;
        }
        document.getElementById('mobileMinSeats').value = '';
        document.getElementById('mobileMaxSeats').value = '';

        // Also reset the main form's corresponding inputs
        if (document.querySelector('input[name="min_seats"]')) {
            document.querySelector('input[name="min_seats"]').value = '';
        }
        if (document.querySelector('input[name="max_seats"]')) {
            document.querySelector('input[name="max_seats"]').value = '';
        }
        if (maxPriceInput) {
            const defaultValue = '10000'; // Match the slider max
            maxPriceInput.value = defaultValue;
            if(priceSlider) {
                 priceSlider.value = defaultValue;
                 priceValue.textContent = `Up to ₹${defaultValue}`;
            }
        }
        // Uncheck mobile checkboxes
        document.querySelectorAll('#mobileFiltersContent input[type="checkbox"]').forEach(cb => cb.checked = false);
        // Uncheck main form checkboxes
        document.querySelectorAll('#carFiltersForm input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    // --- Filter Logic (Client-side simulation - not used for actual filtering due to Flask) ---
    /*
    function applyFilters() {
        // This is a placeholder/simulation. Actual filtering is done by Flask.
        // It's kept for potential client-side preview or if JS filtering is desired.
        const selectedTypes = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => cb.value);
        const selectedTransmissions = Array.from(document.querySelectorAll('input[name="transmission"]:checked')).map(cb => cb.value);
        const selectedFuels = Array.from(document.querySelectorAll('input[name="fuel"]:checked')).map(cb => cb.value);
        const selectedBrands = Array.from(document.querySelectorAll('input[name="brand"]:checked')).map(cb => cb.value);
        const selectedYears = Array.from(document.querySelectorAll('input[name="min_year"]:checked')).map(cb => cb.value);
        const selectedFeatures = Array.from(document.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value);

        const minPrice = parseFloat(minPriceInput.value) || 0;
        const maxPrice = parseFloat(maxPriceInput.value) || Infinity;
        const minSeatValue = parseInt(minSeats.value) || 0;
        const maxSeatValue = parseInt(maxSeats.value) || Infinity;

        const filteredCars = cars.filter(car => {
            // Type filter
            if (selectedTypes.length > 0 && !selectedTypes.includes(getCarType(car.model))) {
                return false;
            }
            // Transmission filter
            if (selectedTransmissions.length > 0 && !selectedTransmissions.includes(car.transmission)) {
                return false;
            }
            // Fuel filter
            if (selectedFuels.length > 0 && !selectedFuels.includes(car.fuel_type)) {
                return false;
            }
            // Brand filter
            if (selectedBrands.length > 0 && !selectedBrands.includes(car.make)) {
                return false;
            }
            // Year filter (simplified)
            if (selectedYears.length > 0) {
                const carYear = car.year.toString();
                if (!selectedYears.some(year => carYear >= year)) {
                    return false;
                }
            }
            // Feature filter (all selected features must be present)
            if (selectedFeatures.length > 0 && !selectedFeatures.every(feature => car.features.includes(feature))) {
                return false;
            }
            // Price filter
            if (car.price_per_day < minPrice || car.price_per_day > maxPrice) {
                return false;
            }
            // Seats filter
            if (car.seats < minSeatValue || car.seats > maxSeatValue) {
                return false;
            }
            return true;
        });

        renderCars(filteredCars);
        updateActiveFilters();
        updateCarCount(filteredCars.length);
    }
    */

    // Helper function to determine car type (simulation)
    /*
    function getCarType(model) {
        const suvs = ['Creta', 'XUV300', 'Nexon'];
        const hatchbacks = ['Swift', 'Alto'];
        const sedans = ['City', 'Verna'];
        const muvs = ['Innova', 'Ertiga'];

        if (suvs.includes(model)) return 'SUV';
        if (hatchbacks.includes(model)) return 'Hatchback';
        if (sedans.includes(model)) return 'Sedan';
        if (muvs.includes(model)) return 'MUV';
        return 'Sedan'; // default
    }
    */

    // --- Update UI based on filters (Client-side simulation) ---
    /*
    function updateActiveFilters() {
        activeFilters.innerHTML = '';

        // Get all selected filters
        const selectedTypes = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => cb.value);
        const selectedTransmissions = Array.from(document.querySelectorAll('input[name="transmission"]:checked')).map(cb => cb.value);
        const selectedFuels = Array.from(document.querySelectorAll('input[name="fuel"]:checked')).map(cb => cb.value);
        const selectedBrands = Array.from(document.querySelectorAll('input[name="brand"]:checked')).map(cb => cb.value);
        const selectedYears = Array.from(document.querySelectorAll('input[name="min_year"]:checked')).map(cb => cb.value);
        const selectedFeatures = Array.from(document.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value);

        // Create filter tags
        selectedTypes.forEach(type => {
            addFilterTag(type, 'type');
        });
        selectedTransmissions.forEach(trans => {
            addFilterTag(trans, 'transmission');
        });
        selectedFuels.forEach(fuel => {
            addFilterTag(fuel, 'fuel');
        });
        selectedBrands.forEach(brand => {
            addFilterTag(brand, 'brand');
        });
        selectedYears.forEach(year => {
            addFilterTag(`${year}+`, 'year');
        });
        selectedFeatures.forEach(feature => {
            // Use label if available
            const label = feature_labels[feature] || feature;
            addFilterTag(label, 'feature');
        });
        if (minSeats.value) {
            addFilterTag(`Min Seats: ${minSeats.value}`, 'min_seats');
        }
        if (maxSeats.value) {
            addFilterTag(`Max Seats: ${maxSeats.value}`, 'max_seats');
        }
        if (maxPriceInput.value !== '10000') { // Assuming 10000 is default max
            addFilterTag(`Max Price: ₹${maxPriceInput.value}`, 'max_price');
        }
    }
    */

    // Add a filter tag to the display (Client-side simulation)
    /*
    function addFilterTag(text, type) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2';
        tag.innerHTML = `<span>${text}</span><button class="remove cursor-pointer" data-type="${type}" data-value="${text}"><i class="fas fa-times"></i></button>`;
        activeFilters.appendChild(tag);

        // Add event listener to remove button
        tag.querySelector('.remove').addEventListener('click', function () {
            removeFilter(type, text);
        });
    }
    */

    // --- Remove a filter (Triggers server-side update) ---
    function removeFilter(type, value) {
        switch (type) {
            case 'type':
                document.querySelector(`input[name="type"][value="${value}"]`).checked = false;
                break;
            case 'transmission':
                document.querySelector(`input[name="transmission"][value="${value}"]`).checked = false;
                break;
            case 'fuel':
                document.querySelector(`input[name="fuel"][value="${value}"]`).checked = false;
                break;
            case 'brand':
                document.querySelector(`input[name="brand"][value="${value}"]`).checked = false;
                break;
            case 'year': // Special case for min_year
                document.querySelector(`input[name="min_year"][value="${value.replace('+', '')}"]`).checked = false;
                break;
            case 'feature':
                document.querySelector(`input[name="features"][value="${value}"]`).checked = false;
                break;
            case 'min_seats':
                if (minSeats) minSeats.value = '';
                if (document.getElementById('mobileMinSeats')) document.getElementById('mobileMinSeats').value = '';
                break;
            case 'max_seats':
                if (maxSeats) maxSeats.value = '';
                if (document.getElementById('mobileMaxSeats')) document.getElementById('mobileMaxSeats').value = '';
                break;
            case 'max_price':
                const defaultPrice = '10000';
                if (priceSlider) {
                    priceSlider.value = defaultPrice;
                    priceValue.textContent = `Up to ₹${defaultPrice}`;
                }
                if (maxPriceInput) maxPriceInput.value = defaultPrice;
                if (document.getElementById('mobilePriceSlider')) {
                     document.getElementById('mobilePriceSlider').value = defaultPrice;
                     document.getElementById('mobilePriceValue').textContent = `Up to ₹${defaultPrice}`;
                }
                if (document.getElementById('mobileMaxPriceInput')) document.getElementById('mobileMaxPriceInput').value = defaultPrice;
                break;
            default:
                console.warn(`Unknown filter type to remove: ${type}`);
        }
        // Trigger form submit to update server-side
        document.getElementById('carFiltersForm').submit();
    }


    // Reset all filters (Triggers server-side update)
    function resetAllFilters() {
        // Uncheck all checkboxes (main form)
        document.querySelectorAll('#carFiltersForm input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        // Reset inputs (main form)
        if (minSeats) minSeats.value = '';
        if (maxSeats) maxSeats.value = '';
        const defaultPrice = '10000';
        if (priceSlider) {
            priceSlider.value = defaultPrice;
            priceValue.textContent = `Up to ₹${defaultPrice}`;
        }
        if (maxPriceInput) maxPriceInput.value = defaultPrice;

        // Reset mobile inputs
        resetMobileFilters();

        // Reset sort button (optional, UI only)
        // sortButton.innerHTML = `<i class="fas fa-sort-amount-down"></i> Sort <i class="fas fa-chevron-down ml-1"></i>`;

        // Submit form to refresh with no filters
        // window.location.href = "{{ url_for('car.car_list', user_lat=user_location.lat, user_lng=user_location.lng) }}";
        // Or, submit the form which should now have all filters cleared
         document.getElementById('carFiltersForm').submit();
    }

    // --- Render cars to the grid (Client-side simulation) ---
    /*
    function renderCars(carsToRender) {
        carGrid.innerHTML = '';
        if (carsToRender.length === 0) {
            carGrid.innerHTML = `<div class="col-span-full text-center py-10"><i class="fas fa-car fa-3x text-gray-300 mb-3"></i><h3 class="text-xl font-semibold text-gray-700 mb-2">No cars found</h3><p class="text-gray-500 mb-4">Try adjusting your filters.</p></div>`;
            return;
        }

        carsToRender.forEach(car => {
            const carCard = document.createElement('div');
            carCard.className = 'car-card bg-white border rounded-2xl overflow-hidden shadow-sm';
            // Simplified card content for demo
            carCard.innerHTML = `
                <div class="relative h-48 w-full overflow-hidden">
                    <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center">
                        <i class="fas fa-car text-gray-400 text-4xl"></i>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <div>
                            <h3 class="font-bold text-gray-800 leading-tight">${car.make} ${car.model} (${car.year})</h3>
                            <p class="text-xs text-gray-500 mt-1">${car.transmission} • ${car.fuel_type} • ${car.seats} seats</p>
                        </div>
                        <div class="flex items-center gap-1 text-sm">
                            <i class="fas fa-star text-yellow-400"></i>
                            <span class="font-semibold">4.5</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm mb-3">
                        <div class="text-gray-600">
                            <i class="fas fa-map-marker-alt text-primary mr-1"></i>
                            ${car.locality ? car.locality + ', ' : ''}${car.city}
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-gray-900">₹${car.price_per_day.toFixed(0)}</div>
                            <div class="text-xs text-gray-500">/ day</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="/car/${car.id}" class="flex-1 text-center text-sm font-medium bg-primary text-white rounded-xl px-3 py-2 transition-all hover:bg-blue-600">
                            <i class="fas fa-info-circle"></i> View Details
                        </a>
                        <button class="text-sm px-3 py-2 rounded-xl border text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            `;
            carGrid.appendChild(carCard);
        });
    }
    */

    // --- Update car count display (Client-side simulation) ---
    /*
    function updateCarCount(count) {
        if (carCountElement) {
            carCountElement.textContent = count;
        }
    }
    */

    // --- Feature Labels (for display) ---
    const feature_labels = {
        'ac': 'AC',
        'bluetooth': 'Bluetooth',
        'sunroof': 'Sunroof',
        'gps': 'GPS'
    };
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\dashboard.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
</html>

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\directory structre but not same as it.tct ---
zoomcar_clone/
│
├── app.py                          # Main Flask application factory
├── config.py                       # Configuration settings
├── requirements.txt                # Python dependencies
├── .env                            # Environment variables
├── init_data.py                    # Script to initialize sample data
│
├── models/                         # Database models
│   ├── __init__.py                 # Initialize db, import all models
│   ├── user.py                     # User model (customer)
│   ├── host.py                     # Host model (owner)
│   ├── car.py                      # Car model
│   ├── location.py                 # Location model
│   ├── booking.py                  # Booking model
│   ├── car_image.py                # Car images model
│   └── payment.py                  # Payment model (if separate from Booking)
│
├── routes/                         # Route handlers (Blueprints)
│   ├── __init__.py
│   ├── auth.py                     # General authentication routes (login, register for users/customers)
│   ├── car.py                      # Main car listing/search routes (`car_bp`)
│   ├── booking.py                  # General booking routes (user/customer booking flow)
│   ├── api.py                      # General API endpoints
│   │
│   ├── host/                       # Host-specific routes (`host_bp`)
│   │   ├── __init__.py             # Initialize host blueprint
│   │   ├── auth.py                 # Host authentication routes (login, register for hosts)
│   │   ├── dashboard.py            # Host dashboard overview
│   │   ├── cars.py                 # Host car management (add, edit, delete, list own cars)
│   │   ├── bookings.py             # Host booking management (approve, manage bookings for own cars)
│   │   ├── payments.py             # Host payment tracking/history
│   │   ├── analytics.py            # Host ratings, feedbacks, performance
│   │   └── profile.py              # Host profile management, wallet
│   │
│   └── user/                       # User-specific routes (`user_bp`) - Optional, can use main auth/booking
│       ├── __init__.py             # Initialize user blueprint (if separate)
│       ├── dashboard.py            # User dashboard overview (bookings, profile link)
│       ├── bookings.py             # User booking management (view, cancel own bookings)
│       └── profile.py              # User profile management
│
├── controllers/                    # Business logic (optional, can be in routes)
│   ├── __init__.py
│   ├── auth_controller.py          # Auth logic
│   ├── car_controller.py           # Car search/filter logic
│   ├── booking_controller.py       # Booking flow logic
│   │
│   ├── host/                       # Host-specific controllers
│   │   ├── __init__.py
│   │   ├── car_manager.py         # Logic for host adding/editing cars
│   │   ├── booking_manager.py     # Logic for host managing bookings
│   │   └── analytics.py           # Logic for host ratings/feedbacks
│   │
│   └── user/                       # User-specific controllers
│       ├── __init__.py
│       ├── booking_manager.py      # Logic for user creating/viewing bookings
│       └── profile_manager.py     # Logic for user profile updates
│
├── utils/                          # Utility functions
│   ├── __init__.py
│   ├── distance_calculator.py     # Haversine distance calculation
│   ├── geocoder.py                # Wrapper for Nominatim/OpenCage/etc. geocoding (future)
│   └── validators.py              # Input validation helpers
│
├── templates/                      # HTML templates
│   ├── base.html                  # Main base template
│   ├── home.html                  # Homepage
│   ├── car_list.html              # Main car listing/search results page
│   ├── car_detail.html            # Car detail page
│   ├── login.html                 # General user/customer login page
│   ├── register.html              # General user/customer register page
│   ├── booking/                   # Booking flow templates
│   │   ├── confirm.html
│   │   ├── payment.html
│   │   └── success.html
│   │
│   ├── host/                      # Host templates
│   │   ├── base.html              # Host base template
│   │   ├── login.html             # Host login page
│   │   ├── register.html          # Host register page
│   │   ├── dashboard.html         # Host dashboard
│   │   ├── cars/                  # Host car management templates
│   │   │   ├── list.html
│   │   │   ├── add.html           # Add car form (includes location details section)
│   │   │   ├── edit.html
│   │   │   └── detail.html
│   │   ├── bookings/              # Host booking management templates
│   │   │   ├── list.html
│   │   │   └── detail.html
│   │   ├── payments/              # Host payment templates
│   │   │   └── list.html
│   │   ├── analytics/             # Host analytics templates
│   │   │   ├── ratings.html
│   │   │   └── feedbacks.html
│   │   └── profile/               # Host profile templates
│   │       ├── view.html
│   │       ├── edit.html
│   │       └── wallet.html
│   │
│   └── user/                      # User templates (if separate from main)
│       ├── base.html              # User base template
│       ├── dashboard.html         # User dashboard
│       ├── filter/                # User car search/filter templates
│       │   ├── list.html          # Main user car listing page (results)
│       │   └── filters_sidebar.html # Filter sidebar content (the updated one)
│       ├── bookings/              # User booking templates
│       │   ├── list.html
│       │   ├── detail.html
│       │   └── payment.html
│       └── profile/               # User profile templates
│           ├── view.html
│           └── edit.html
│
├── static/                         # Static assets
│   ├── css/
│   │   ├── style.css              # Main stylesheet
│   │   ├── host.css               # Host-specific styles
│   │   └── user.css               # User-specific styles
│   ├── js/
│   │   ├── main.js                # Main JavaScript
│   │   ├── host.js                # Host-specific JavaScript
│   │   └── user.js                # User-specific JavaScript (includes filter logic)
│   ├── images/                    # General images
│   └── uploads/                   # Uploaded car images (created by app)
│
└── uploads/                        # Actual uploaded files directory (created by app)

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\edit_car.html ---
{% extends "base.html" %}

{% block content %}
<div class="edit-car-form">
    <h2>✏️ Edit Car</h2>
    <form method="POST" action="{{ url_for('update_car', id=car.id) }}" enctype="multipart/form-data">
        <div class="form-grid">
            <div class="form-group">
                <label for="make">Make *</label>
                <input type="text" id="make" name="make" value="{{ car.make }}" required>
            </div>

            <div class="form-group">
                <label for="model">Model *</label>
                <input type="text" id="model" name="model" value="{{ car.model }}" required>
            </div>

            <div class="form-group">
                <label for="year">Year *</label>
                <input type="number" id="year" name="year" value="{{ car.year }}" min="1900" max="2030" required>
            </div>

            <div class="form-group">
                <label for="price">Price ($) *</label>
                <input type="number" id="price" name="price" value="{{ car.price }}" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label for="color">Color</label>
                <input type="text" id="color" name="color" value="{{ car.color or '' }}">
            </div>

            <div class="form-group">
                <label for="mileage">Mileage</label>
                <input type="number" id="mileage" name="mileage" value="{{ car.mileage or '' }}" min="0">
            </div>
        </div>

        {% if car.images %}
        <div class="current-images-section">
            <h3>📸 Current Images</h3>
            <div class="current-images-grid">
                {% for image in car.images %}
                    <div class="image-item">
                        <img src="{{ url_for('uploaded_file', filename=image.filename) }}"
                             alt="Car Image" class="current-image">
                        <a href="{{ url_for('delete_image', image_id=image.id) }}"
                           class="delete-image-btn"
                           onclick="return confirm('Delete this image?')">×</a>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="file-upload" id="fileUploadArea">
            <i>📁</i>
            <p>Click to upload new images or drag & drop</p>
            <p style="font-size: 0.9rem; color: #666;">Supports JPG, PNG, GIF (Multiple files allowed)</p>
            <input type="file" name="images" accept="image/*" multiple style="display: none;" id="fileInput">
        </div>

        <div id="image-preview"></div>

        <div class="form-buttons">
            <button type="submit" class="btn btn-primary">
                <span>💾</span> Update Car
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <span>↩️</span> Cancel
            </a>
        </div>
    </form>
</div>

<script>
// Enhanced image upload with drag & drop for edit page
document.addEventListener('DOMContentLoaded', function() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('image-preview');

    // Click to upload
    fileUploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        fileUploadArea.style.borderColor = '#3498db';
        fileUploadArea.style.backgroundColor = '#e3f2fd';
    }

    function unhighlight() {
        fileUploadArea.style.borderColor = '#ddd';
        fileUploadArea.style.backgroundColor = '#f8f9fa';
    }

    // Handle dropped files
    fileUploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    // Handle selected files
    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function handleFiles(files) {
        if (files.length > 0) {
            if (preview.innerHTML.includes('Selected Images:')) {
                // Append to existing preview
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const container = document.createElement('div');
                            container.className = 'preview-image-container';
                            container.innerHTML = `
                                <img src="${e.target.result}" class="preview-image">
                                <span class="remove-preview" onclick="this.parentElement.remove()">×</span>
                            `;
                            preview.appendChild(container);
                        }
                        reader.readAsDataURL(file);
                    }
                }
            } else {
                // Create new preview section
                preview.innerHTML = '<h4>Selected Images:</h4>';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const container = document.createElement('div');
                            container.className = 'preview-image-container';
                            container.innerHTML = `
                                <img src="${e.target.result}" class="preview-image">
                                <span class="remove-preview" onclick="this.parentElement.remove()">×</span>
                            `;
                            preview.appendChild(container);
                        }
                        reader.readAsDataURL(file);
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\home.html ---
<!-- templates/home.html -->
{% extends "base.html" %}

{% block title %}Home - ZoomCar Clone{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section bg-primary text-white py-5">
    <div class="container py-5">
        <div class="row align-items-center">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <h1 class="display-4 fw-bold">🚗 Drive Your Freedom</h1>
                <p class="lead mb-4">Rent the perfect car for your journey or list your car and earn money.</p>
                <div class="d-flex flex-wrap gap-2">
                    <a href="#search-section" class="btn btn-light btn-lg">
                        <i class="fas fa-search me-2"></i>Rent a Car
                    </a>
                    <a href="{{ url_for('host.login') }}" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-car me-2"></i>List Your Car
                    </a>
                </div>
            </div>
            <div class="col-lg-6 text-center">
                <i class="fas fa-car-side fa-10x"></i>
            </div>
        </div>
    </div>
</div>

<!-- How It Works Section -->
<div class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5">How It Works</h2>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>For Customers</h5>
                    </div>
                    <div class="card-body">
                        <ol class="list-group list-group-numbered">
                            <li class="list-group-item">Search for cars in your city and select dates</li>
                            <li class="list-group-item">Choose the perfect car from our listings</li>
                            <li class="list-group-item">Book online and get instant confirmation</li>
                            <li class="list-group-item">Pick up, drive, and return hassle-free</li>
                            <li class="list-group-item">Leave a review and help others!</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100 border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>For Hosts</h5>
                    </div>
                    <div class="card-body">
                        <ol class="list-group list-group-numbered">
                            <li class="list-group-item">Sign up as a host and verify your profile</li>
                            <li class="list-group-item">List your car with photos and details</li>
                            <li class="list-group-item">Set your price and availability</li>
                            <li class="list-group-item">Get bookings and earn money</li>
                            <li class="list-group-item">Manage your cars and track earnings</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Section -->
<div id="search-section" class="py-5">
    <div class="container">
        <h2 class="text-center mb-4">Find Your Perfect Ride</h2>
        <div class="card shadow">
            <div class="card-body">
                <form action="{{ url_for('car.car_list') }}" method="GET" id="searchForm">
                    <div class="row g-3">
                        <!-- Location Input with Suggestions -->
                        <div class="col-md-5">
                            <label for="location_input" class="form-label"><i class="fas fa-map-marker-alt me-1"></i> Location</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="location_input" name="q" placeholder="Enter city, area, or pincode" autocomplete="off" required>
                                <button class="btn btn-outline-secondary" type="button" id="detectLocationBtn" title="Detect my location">
                                    <i class="fas fa-location-arrow"></i>
                                </button>
                            </div>
                            <input type="hidden" id="selected_lat" name="user_lat">
                            <input type="hidden" id="selected_lng" name="user_lng">
                            <input type="hidden" id="selected_city" name="city">
                            <input type="hidden" id="selected_locality" name="locality">
                            <input type="hidden" id="selected_pincode" name="pincode">
                            <!-- Suggestions Dropdown -->
                            <ul id="suggestionsList" class="list-group position-absolute z-1000 w-100" style="display:none; max-height: 200px; overflow-y: auto;"></ul>
                            <div id="locationStatus" class="form-text"></div>
                        </div>

                        <!-- Date Pickers -->
                        <div class="col-md-3">
                            <label for="start_date" class="form-label"><i class="fas fa-calendar-start me-1"></i> Start Date</label>
                            <input type="date" name="starts" id="start_date" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label"><i class="fas fa-calendar-end me-1"></i> End Date</label>
                            <input type="date" name="ends" id="end_date" class="form-control" required>
                        </div>

                        <!-- Search Button -->
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100" id="searchButton">
                                <i class="fas fa-search"></i> <span class="d-none d-md-inline">Search</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Features/Benefits Section -->
<div class="py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="text-center">
                    <div class="feature-icon bg-primary text-white rounded-circle mx-auto mb-3" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-car fa-2x"></i>
                    </div>
                    <h5>Wide Selection</h5>
                    <p class="text-muted">Hundreds of cars from trusted hosts.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <div class="feature-icon bg-success text-white rounded-circle mx-auto mb-3" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-tags fa-2x"></i>
                    </div>
                    <h5>Best Prices</h5>
                    <p class="text-muted">Competitive pricing with no hidden fees.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <div class="feature-icon bg-info text-white rounded-circle mx-auto mb-3" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-headset fa-2x"></i>
                    </div>
                    <h5>24/7 Support</h5>
                    <p class="text-muted">Round-the-clock customer support.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Call to Action Section -->
<div class="py-5 bg-dark text-white">
    <div class="container text-center">
        <h2 class="mb-3">Got a Car? Start Earning Today!</h2>
        <p class="lead mb-4">Join our community of hosts and monetize your vehicle when it's not in use.</p>
        <a href="{{ url_for('host.login') }}" class="btn btn-success btn-lg">
            <i class="fas fa-car me-2"></i>Become a Host
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Date Logic ---
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start_date').min = today;
    document.getElementById('end_date').min = today;

    // Set default dates: start = today, end = tomorrow
    const startDate = new Date();
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 1);

    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    // --- End Date Logic ---

    // --- Location Suggestion Logic ---
    const locationInput = document.getElementById('location_input');
    const suggestionsList = document.getElementById('suggestionsList');
    const locationStatus = document.getElementById('locationStatus');
    const selectedLat = document.getElementById('selected_lat');
    const selectedLng = document.getElementById('selected_lng');
    const selectedCity = document.getElementById('selected_city');
    const selectedLocality = document.getElementById('selected_locality');
    const selectedPincode = document.getElementById('selected_pincode');
    const detectLocationBtn = document.getElementById('detectLocationBtn');
    const searchForm = document.getElementById('searchForm');

    let debounceTimer;

    locationInput.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(debounceTimer);
        suggestionsList.style.display = 'none';

        if (query.length < 2) {
            locationStatus.textContent = '';
            return;
        }

        locationStatus.innerHTML = '<span class="text-primary"><i class="fas fa-spinner fa-spin"></i> Searching...</span>';
        debounceTimer = setTimeout(() => {
            fetch(`/suggest?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsList.innerHTML = '';
                    if (data.error) {
                         locationStatus.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${data.error}</span>`;
                         return;
                    }
                    if (data.length === 0) {
                        locationStatus.innerHTML = '<span class="text-muted">No suggestions found.</span>';
                        return;
                    }
                    locationStatus.textContent = '';
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item list-group-item-action';
                        li.textContent = item.display_name;
                        li.dataset.lat = item.lat;
                        li.dataset.lon = item.lon;
                        li.dataset.city = item.city || '';
                        li.dataset.locality = item.locality || item.suburb || item.neighbourhood || item.hamlet || '';
                        li.dataset.pincode = item.postcode || '';
                        li.addEventListener('click', function() {
                            selectLocation(this);
                        });
                        suggestionsList.appendChild(li);
                    });
                    suggestionsList.style.display = 'block';
                })
                .catch(error => {
                    console.error('Suggestion error:', error);
                    locationStatus.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Failed to fetch suggestions.</span>';
                });
        }, 300); // Debounce for 300ms
    });

    function selectLocation(listItem) {
        const displayName = listItem.textContent;
        const lat = listItem.dataset.lat;
        const lon = listItem.dataset.lon;
        const city = listItem.dataset.city;
        const locality = listItem.dataset.locality;
        const pincode = listItem.dataset.pincode;

        locationInput.value = displayName;
        selectedLat.value = lat;
        selectedLng.value = lon;
        selectedCity.value = city;
        selectedLocality.value = locality;
        selectedPincode.value = pincode;
        suggestionsList.style.display = 'none';
        locationStatus.innerHTML = `<span class="text-success"><i class="fas fa-check"></i> Location selected.</span>`;
    }

    // Close suggestions if clicked outside
    document.addEventListener('click', function(e) {
        if (!locationInput.contains(e.target) && !suggestionsList.contains(e.target)) {
            suggestionsList.style.display = 'none';
        }
    });

    // --- Detect User Location ---
    detectLocationBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
            locationStatus.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Geolocation is not supported by your browser.</span>';
            return;
        }

        detectLocationBtn.disabled = true;
        locationStatus.innerHTML = '<span class="text-primary"><i class="fas fa-spinner fa-spin"></i> Detecting your location...</span>';

        navigator.geolocation.getCurrentPosition(
            // Success
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                selectedLat.value = lat.toFixed(6);
                selectedLng.value = lon.toFixed(6);
                locationStatus.innerHTML = `<span class="text-success"><i class="fas fa-check"></i> Location detected (Lat: ${selectedLat.value}, Lng: ${selectedLng.value}). Searching nearby...</span>`;

                // Use Reverse Geocoding to get a display name (optional, for user feedback)
                // You could also directly submit the form with lat/lng
                // For now, we'll just show the coordinates were detected.
                // The backend can use these for proximity search.

                detectLocationBtn.disabled = false;
            },
            // Error
            function(error) {
                let errorMsg = 'Unable to retrieve your location.';
                if (error.code === error.PERMISSION_DENIED) {
                    errorMsg = 'Location access denied by user.';
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    errorMsg = 'Location information is unavailable.';
                } else if (error.code === error.TIMEOUT) {
                    errorMsg = 'The request to get user location timed out.';
                }
                locationStatus.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${errorMsg}</span>`;
                console.error("Geolocation error:", error);
                detectLocationBtn.disabled = false;
            },
            // Options
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
            }
        );
    });
    // --- End Detect User Location ---
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\index.html ---
{% extends "base.html" %}

{% block content %}
<div class="add-car-form">
    <h2>🚗 Add New Car</h2>
    <form method="POST" action="{{ url_for('add_car') }}" enctype="multipart/form-data" id="carForm">
        <div class="form-grid">
            <div class="form-group">
                <label for="make">Make *</label>
                <input type="text" id="make" name="make" placeholder="Toyota, Honda, etc." required>
            </div>

            <div class="form-group">
                <label for="model">Model *</label>
                <input type="text" id="model" name="model" placeholder="Camry, Civic, etc." required>
            </div>

            <div class="form-group">
                <label for="year">Year *</label>
                <input type="number" id="year" name="year" placeholder="2023" min="1900" max="2030" required>
            </div>

            <div class="form-group">
                <label for="price">Price ($) *</label>
                <input type="number" id="price" name="price" placeholder="25000" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label for="color">Color</label>
                <input type="text" id="color" name="color" placeholder="Red, Blue, etc.">
            </div>

            <div class="form-group">
                <label for="mileage">Mileage</label>
                <input type="number" id="mileage" name="mileage" placeholder="15000" min="0">
            </div>
        </div>

        <div class="file-upload" id="fileUploadArea">
            <i>📁</i>
            <p>Click to upload images or drag & drop</p>
            <p style="font-size: 0.9rem; color: #666;">Supports JPG, PNG, GIF (Multiple files allowed)</p>
            <input type="file" name="images" accept="image/*" multiple style="display: none;" id="fileInput">
        </div>

        <div id="image-preview"></div>

        <div class="form-buttons">
            <button type="submit" class="btn btn-primary">
                <span>➕</span> Add Car
            </button>
            <button type="reset" class="btn btn-secondary">
                <span>🔄</span> Reset
            </button>
        </div>
    </form>
</div>

{% if cars %}
<div class="car-list">
    {% for car in cars %}
    <div class="car-card">
        <div class="car-images">
            {% if car.images %}
                <img src="{{ url_for('uploaded_file', filename=car.images[0].filename) }}"
                     alt="{{ car.make }} {{ car.model }}" class="car-image-main">
                {% if car.images|length > 1 %}
                    <div class="image-counter">{{ car.images|length }} images</div>
                {% endif %}
            {% else %}
                <div class="no-image-placeholder">
                    <div>📷 No Image</div>
                </div>
            {% endif %}
        </div>

        <div class="car-info">
            <h3>{{ car.make }} {{ car.model }}</h3>
            <div class="price-tag">${{ "%.2f"|format(car.price) }}</div>

            <div class="car-details">
                <div class="detail-item">
                    <span class="detail-label">Year:</span>
                    <span class="detail-value">{{ car.year }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Color:</span>
                    <span class="detail-value">{{ car.color or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Mileage:</span>
                    <span class="detail-value">{{ car.mileage or 'N/A' }} miles</span>
                </div>
            </div>

            <div class="actions">
                <a href="{{ url_for('edit_car_form', id=car.id) }}" class="btn btn-warning">
                    <span>✏️</span> Edit
                </a>
                <a href="{{ url_for('delete_car', id=car.id) }}" class="btn btn-danger"
                   onclick="return confirm('Are you sure you want to delete this car and all its images?')">
                    <span>🗑️</span> Delete
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <i>🚗</i>
    <h3>No Cars in Inventory</h3>
    <p>Start by adding your first car to the inventory!</p>
</div>
{% endif %}

<script>
// Enhanced image upload with drag & drop
document.addEventListener('DOMContentLoaded', function() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('image-preview');

    // Click to upload
    fileUploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        fileUploadArea.style.borderColor = '#3498db';
        fileUploadArea.style.backgroundColor = '#e3f2fd';
    }

    function unhighlight() {
        fileUploadArea.style.borderColor = '#ddd';
        fileUploadArea.style.backgroundColor = '#f8f9fa';
    }

    // Handle dropped files
    fileUploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    // Handle selected files
    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function handleFiles(files) {
        if (files.length > 0) {
            preview.innerHTML = '<h4>Selected Images:</h4>';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const container = document.createElement('div');
                        container.className = 'preview-image-container';
                        container.innerHTML = `
                            <img src="${e.target.result}" class="preview-image">
                            <span class="remove-preview" onclick="this.parentElement.remove()">×</span>
                        `;
                        preview.appendChild(container);
                    }
                    reader.readAsDataURL(file);
                }
            }
        }
    }
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\login.html ---
{% extends "base.html" %}

{% block title %}Login - ZoomCar Clone{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="text-center"><i class="fas fa-sign-in-alt"></i> Login</h3>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.csrf_token }} <!-- This renders the hidden input for CSRF -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                <div class="text-center mt-3">
                    <p>Don't have an account? <a href="{{ url_for('auth.register') }}">Register here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\my_bookings.html ---
{% extends "base.html" %}

{% block title %}My Bookings - ZoomCar Clone{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-check"></i> My Bookings</h2>
    <a href="{{ url_for('car.home') }}" class="btn btn-outline-primary">
        <i class="fas fa-car"></i> Book New Car
    </a>
</div>

{% if bookings %}
    <div class="row">
        {% for booking in bookings %}
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title">{{ booking.car.make }} {{ booking.car.model }}</h5>
                            <p class="text-muted">{{ booking.car.year }}</p>
                        </div>
                        <span class="badge bg-{% if booking.status == 'confirmed' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                            {{ booking.status|title }}
                        </span>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Start Date</small>
                            <p>{{ booking.start_date.strftime('%Y-%m-%d') }}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">End Date</small>
                            <p>{{ booking.end_date.strftime('%Y-%m-%d') }}</p>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-primary">₹{{ "%.2f"|format(booking.total_price) }}</h4>
                            <small class="text-muted">Total Amount</small>
                        </div>
                        {% if booking.status == 'pending' %}
                            <a href="{{ url_for('booking.cancel_booking', booking_id=booking.id) }}" 
                               class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('Are you sure you want to cancel this booking?')">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-calendar fa-4x text-muted mb-3"></i>
        <h4>No bookings yet</h4>
        <p class="text-muted">Start by booking your first car</p>
        <a href="{{ url_for('car.home') }}" class="btn btn-primary">
            <i class="fas fa-car"></i> Book a Car
        </a>
    </div>
{% endif %}
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\New Text Document.txt ---
@echo off
REM Create the base user templates directory
mkdir user

REM Create the HTML files in the main user template folder
cd user
echo.> base.html
echo.> dashboard.html

REM Create the bookings subdirectory and files
mkdir bookings
cd bookings
echo.> list.html
echo.> detail.html
echo.> payment.html

REM Go back to user directory
cd ..

REM Create the notifications subdirectory and files
mkdir notifications
cd notifications
echo.> list.html

REM Go back to root
cd ..

echo User template directory structure created successfully.


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\register.html ---
{% extends "base.html" %}

{% block title %}Register - ZoomCar Clone{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="text-center"><i class="fas fa-user-plus"></i> Register</h3>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.csrf_token }} <!-- This renders the hidden input for CSRF -->
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="phone" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </form>
                <div class="text-center mt-3">
                    <p>Already have an account? <a href="{{ url_for('auth.login') }}">Login here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\base.html ---

---

### 1. `templates/admin/base.html`

The main base template for all admin pages.

**File: `templates/admin/base.html`**
```html
<!-- templates/admin/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Admin Dashboard{% endblock %} - ZoomCar Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --admin-primary: #6f42c1; /* Purple */
            --admin-secondary: #0077b6; /* Blue */
            --admin-accent: #ff9e00; /* Orange */
            --admin-dark: #1d3557; /* Dark Blue */
            --admin-light: #f8f9fa; /* Light Gray */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--admin-dark), #343a40);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            margin: 5px 0;
            border-radius: 5px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        @media (max-width: 767.98px) {
            .main-content {
                margin-left: 0;
            }
        }

        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .entity-card {
            transition: all 0.3s ease;
        }

        .entity-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .sort-dropdown {
            position: relative;
        }

        .sort-dropdown-content {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 200px;
            z-index: 10;
            display: none;
        }

        .sort-dropdown:hover .sort-dropdown-content {
            display: block;
        }

        .sort-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            display: block;
            color: inherit;
        }

        .sort-option:hover {
            background-color: #f1f5f9;
        }

        .sort-option.active {
            font-weight: 600;
            color: var(--admin-primary);
        }

        .filter-count {
            background-color: var(--admin-primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 4px;
        }

        .filter-tag {
            background-color: #e0f7fa;
            border: 1px solid #b3e5fc;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .filter-tag .remove {
            cursor: pointer;
            color: #0077b6;
            text-decoration: none;
        }

        .car-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 8px;
        }

        .pagination a, .pagination span { /* Style both links and current page span */
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            text-decoration: none; /* Remove underline */
            color: inherit; /* Inherit text color */
        }

        .pagination .active { /* Specific style for active page */
            background: var(--admin-primary);
            color: white;
            border-color: var(--admin-primary);
        }

        .pagination a:hover:not(.active) {
            background: #f1f5f9;
        }

        .car-skeleton {
            border-radius: 16px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .skeleton-img {
            height: 160px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .skeleton-line {
            height: 16px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin: 8px 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4><i class="fas fa-crown"></i> Admin Panel</h4>
                        <small class="text-muted">{{ current_user.username }}</small>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}"
                               href="{{ url_for('admin.dashboard') }}">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'admin.list_users' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('admin.list_users') }}">
                                <i class="fas fa-users"></i> Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'admin.list_hosts' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('admin.list_hosts') }}">
                                <i class="fas fa-user-tie"></i> Hosts
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'admin.list_cars' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('admin.list_cars') }}">
                                <i class="fas fa-car"></i> Cars
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'admin.list_bookings' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('admin.list_bookings') }}">
                                <i class="fas fa-receipt"></i> Bookings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin.list_transactions' %}active{% endif %}"
                               href="{{ url_for('admin.list_transactions') }}">
                                <i class="fas fa-money-bill-wave"></i> Transactions
                            </a>
                        </li>
                    </ul>

                    <hr class="my-3">

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('car.home') }}">
                                <i class="fas fa-home"></i> Back to Site
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin.logout') }}">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">{% block page_title %}Dashboard{% endblock %}</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        {% block header_buttons %}{% endblock %}
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-info alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Page Content -->
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% block scripts %}{% endblock %}
</body>
</html>


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\dashboard.html ---
<!-- templates/admin/dashboard.html -->
{% extends "admin/base.html" %}

{% block title %}Admin Dashboard{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}

<!-- templates/admin/dashboard.html (Updated Sidebar Links) -->
<!-- ... (existing HTML) ... -->

<!-- In templates/admin/base.html or templates/admin/dashboard.html sidebar -->
<ul class="nav flex-column">
    <li class="nav-item">
        <a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}"
           href="{{ url_for('admin.dashboard') }}">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.endpoint and 'admin.list_users' in request.endpoint %}active{% endif %}"
           href="{{ url_for('admin.list_users') }}">
            <i class="fas fa-users"></i> Users
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.endpoint and 'admin.list_hosts' in request.endpoint %}active{% endif %}"
           href="{{ url_for('admin.list_hosts') }}">
            <i class="fas fa-user-tie"></i> Hosts
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.endpoint and 'admin.list_cars' in request.endpoint %}active{% endif %}"
           href="{{ url_for('admin.list_cars') }}">
            <i class="fas fa-car"></i> Cars
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.endpoint and 'admin.list_bookings' in request.endpoint %}active{% endif %}"
           href="{{ url_for('admin.list_bookings') }}">
            <i class="fas fa-receipt"></i> Bookings
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.endpoint == 'admin.list_transactions' %}active{% endif %}"
           href="{{ url_for('admin.list_transactions') }}">
            <i class="fas fa-money-bill-wave"></i> Transactions
        </a>
    </li>
    <!-- --- CRITICAL FIX: Add Admin Management Links --- -->
    {% if current_user.can_manage_admins() %} <!-- Check if super admin -->
    <li class="nav-item">
        <a class="nav-link {% if request.endpoint == 'admin.list_admins' %}active{% endif %}"
           href="{{ url_for('admin.list_admins') }}"> <!-- You'll need to create this route -->
            <i class="fas fa-users-cog"></i> Manage Admins
        </a>
    </li>
    {% endif %}
    <!-- --- END CRITICAL FIX --- -->
</ul>

<!-- ... (rest of template) ... -->

<div class="row">
    <!-- Stats Cards -->
    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-users"></i> Total Users</h5>
                <h2>{{ total_users }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-user-tie"></i> Total Hosts</h5>
                <h2>{{ total_hosts }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-car"></i> Total Cars</h5>
                <h2>{{ total_cars }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-receipt"></i> Total Bookings</h5>
                <h2>{{ total_bookings }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Users</h5>
            </div>
            <div class="card-body">
                {% if recent_users %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in recent_users %}
                                <tr>
                                    <td>#{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No recent users.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Bookings</h5>
            </div>
            <div class="card-body">
                {% if recent_bookings %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Car</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in recent_bookings %}
                                <tr>
                                    <td>#{{ booking.id }}</td>
                                    <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                                    <td>{{ booking.user.username }}</td>
                                    <td>
                                        <span class="badge bg-{% if booking.status == 'completed' %}success{% elif booking.status == 'active' %}info{% elif booking.status == 'paid' %}primary{% elif booking.status == 'approved' %}secondary{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}light{% endif %}">
                                            {{ booking.status|title }}
                                        </span>
                                    </td>
                                    <td>{{ booking.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No recent bookings.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\login.html ---
<!-- templates/admin/login.html -->
{% extends "base.html" %} <!-- Or a minimal base if preferred -->

{% block title %}Admin Login{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card shadow">
            <div class="card-header text-center bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-crown"></i> Admin Login</h4>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if 'success' in message %}success{% elif 'danger' in message or 'error' in message %}danger{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- --- CRITICAL FIX: Use WTForm for Login ---
                BEFORE (Incorrect - Manual form, no CSRF protection)
                <form method="POST">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" value="{{ request.form.username or '' }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt"></i> Login as Admin
                    </button>
                </form>
                -->

                <!-- AFTER (Corrected - Use WTForm with CSRF protection) -->
                <form method="POST">
                    <!-- Render the CSRF token field provided by Flask-WTF -->
                    {{ form.csrf_token }} <!-- This renders the hidden input for CSRF -->

                    <div class="mb-3">
                        <label for="{{ form.username.id }}" class="form-label">{{ form.username.label.text }} *</label>
                        {{ form.username(class="form-control", value=request.form.username or '') }}
                        {% if form.username.errors %}
                            <div class="text-danger">
                                {% for error in form.username.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.password.id }}" class="form-label">{{ form.password.label.text }} *</label>
                        {{ form.password(class="form-control") }}
                        {% if form.password.errors %}
                            <div class="text-danger">
                                {% for error in form.password.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3 form-check">
                        {{ form.remember_me(class="form-check-input") }}
                        <label class="form-check-label" for="{{ form.remember_me.id }}">
                            {{ form.remember_me.label.text }}
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt"></i> {{ form.submit.label.text }}
                    </button>
                </form>
                <!-- --- END CRITICAL FIX ---

                <hr>

                <div class="text-center">
                    <p><a href="{{ url_for('car.home') }}">← Back to Main Site</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\register.html ---
<!-- templates/admin/register.html -->
{% extends "admin/base.html" %}

{% block title %}Register New Admin{% endblock %}
{% block page_title %}Register New Admin{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header text-center bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-user-plus"></i> Create New Admin</h4>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if 'success' in message %}success{% elif 'danger' in message or 'error' in message %}danger{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- --- Use WTForm for Registration --- -->
                <form method="POST">
                    <!-- Render the CSRF token field provided by Flask-WTF -->
                    {{ form.csrf_token }}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.username.id }}" class="form-label">{{ form.username.label.text }} *</label>
                            {{ form.username(class="form-control") }}
                            {% if form.username.errors %}
                                <div class="text-danger">
                                    {% for error in form.username.errors %}
                                        <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email.id }}" class="form-label">{{ form.email.label.text }} *</label>
                            {{ form.email(class="form-control") }}
                            {% if form.email.errors %}
                                <div class="text-danger">
                                    {% for error in form.email.errors %}
                                        <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.password.id }}" class="form-label">{{ form.password.label.text }} *</label>
                            {{ form.password(class="form-control") }}
                            {% if form.password.errors %}
                                <div class="text-danger">
                                    {% for error in form.password.errors %}
                                        <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.confirm_password.id }}" class="form-label">{{ form.confirm_password.label.text }} *</label>
                            {{ form.confirm_password(class="form-control") }}
                            {% if form.confirm_password.errors %}
                                <div class="text-danger">
                                    {% for error in form.confirm_password.errors %}
                                        <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.access_level.id }}" class="form-label">{{ form.access_level.label.text }} *</label>
                            {{ form.access_level(class="form-select") }}
                            {% if form.access_level.errors %}
                                <div class="text-danger">
                                    {% for error in form.access_level.errors %}
                                        <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.is_active.id }}" class="form-label">{{ form.is_active.label.text }}</label>
                            <div class="form-check mt-2">
                                {{ form.is_active(class="form-check-input") }}
                                <label class="form-check-label" for="{{ form.is_active.id }}">
                                    {{ form.is_active.label.text }}
                                </label>
                            </div>
                            {% if form.is_active.errors %}
                                <div class="text-danger">
                                    {% for error in form.is_active.errors %}
                                        <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('admin.list_admins') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> {{ form.submit.label.text }}
                        </button>
                    </div>
                </form>
                <!-- --- End Use WTForm --- -->

            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\admins\list.html ---
<!-- templates/admin/admins/list.html -->
{% extends "admin/base.html" %}

{% block title %}Manage Admins{% endblock %}
{% block page_title %}Manage Admins{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users-cog"></i> All Admins</h5>
            <form method="GET" action="{{ url_for('admin.list_admins') }}" class="d-flex">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search admins..." value="{{ search_query }}">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if admins %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Access Level</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for admin in admins %}
                        <tr>
                            <td>#{{ admin.id }}</td>
                            <td>{{ admin.username }}</td>
                            <td>{{ admin.email }}</td>
                            <td>
                                <span class="badge bg-{% if admin.access_level == 'super' %}danger
                                                    {% elif admin.access_level == 'support' %}primary
                                                    {% elif admin.access_level == 'finance' %}success
                                                    {% elif admin.access_level == 'content' %}info
                                                    {% else %}secondary{% endif %}">
                                    {{ admin.access_level|title }}
                                </span>
                            </td>
                            <td>
                                {% if admin.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ admin.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if admin.id != current_user.id %}
                                    {% if admin.is_active %}
                                        <form method="POST" action="{{ url_for('admin.toggle_admin_active', admin_id=admin.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-warning" onclick="return confirm('Deactivate admin {{ admin.username }}?')">
                                                <i class="fas fa-ban"></i> Deactivate
                                            </button>
                                        </form>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('admin.toggle_admin_active', admin_id=admin.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Activate admin {{ admin.username }}?')">
                                                <i class="fas fa-check"></i> Activate
                                            </button>
                                        </form>
                                    {% endif %}
                                    <form method="POST" action="{{ url_for('admin.delete_admin', admin_id=admin.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete admin {{ admin.username }}? This cannot be undone.')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="text-muted">(You)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if admins_pagination.pages > 1 %}
            <nav aria-label="Admins pagination">
                <ul class="pagination justify-content-center">
                    {% if admins_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_admins', page=admins_pagination.prev_num, search=search_query) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in admins_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != admins_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.list_admins', page=page_num, search=search_query) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if admins_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_admins', page=admins_pagination.next_num, search=search_query) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users-cog fa-3x text-muted mb-3"></i>
                <h4>No admins found</h4>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="mt-4 text-center">
    <a href="{{ url_for('admin.register') }}" class="btn btn-success">
        <i class="fas fa-user-plus"></i> Create New Admin
    </a>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\bookings\detail.html ---
<!-- templates/admin/bookings/detail.html -->
{% extends "admin/base.html" %}

{% block title %}Booking #{{ booking.id }} Details{% endblock %}
{% block page_title %}Booking Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-receipt"></i> Booking #{{ booking.id }}</h5>
            </div>
            <div class="card-body">
                <!-- Booking Status -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Status</h6>
                        <span class="badge bg-{% if booking.status == 'completed' %}success
                                            {% elif booking.status == 'active' %}info
                                            {% elif booking.status == 'paid' %}primary
                                            {% elif booking.status == 'approved' %}secondary
                                            {% elif booking.status == 'pending' %}warning
                                            {% elif booking.status == 'cancelled' %}danger
                                            {% else %}light{% endif %}">
                            {{ booking.status|title }}
                        </span>
                    </div>
                    {% if booking.cancelled_by %}
                    <div class="mt-2">
                        <small class="text-muted">
                            Cancelled by: <strong>{{ booking.cancelled_by|title }}</strong>
                            {% if booking.cancelled_at %}on {{ booking.cancelled_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
                        </small>
                        {% if booking.cancellation_reason %}
                        <br><small class="text-muted">Reason: {{ booking.cancellation_reason }}</small>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Car & User Details -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Car Details</h6>
                        <p><strong>{{ booking.car.make }} {{ booking.car.model }}</strong> ({{ booking.car.year }})</p>
                        <p>{{ booking.car.transmission }} • {{ booking.car.fuel_type }} • {{ booking.car.seats }} seats</p>
                        <p>Color: {{ booking.car.color or 'N/A' }}</p>
                        <p>Mileage: {{ booking.car.mileage or 'N/A' }} km</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Customer Details</h6>
                        <p><strong>{{ booking.user.username }}</strong></p>
                        <p>Email: {{ booking.user.email }}</p>
                        <p>Phone: {{ booking.user.phone or 'N/A' }}</p>
                    </div>
                </div>

                <!-- Rental Period -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Rental Period</h6>
                        <p><i class="fas fa-calendar-start"></i> Start: {{ booking.start_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><i class="fas fa-calendar-end"></i> End: {{ booking.end_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><i class="fas fa-clock"></i> Duration: {{ booking.duration_days }} days</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Location</h6>
                        <p><i class="fas fa-map-marker-alt"></i>
                            {% if booking.car.full_address %}
                                {{ booking.car.full_address }}
                            {% else %}
                                {% if booking.car.street_address %}{{ booking.car.street_address }}, {% endif %}
                                {% if booking.car.locality %}{{ booking.car.locality }}, {% endif %}
                                {% if booking.car.city %}{{ booking.car.city }}{% endif %}
                                {% if booking.car.state %}, {{ booking.car.state }}{% endif %}
                                {% if booking.car.pincode %} - {{ booking.car.pincode }}{% endif %}
                            {% endif %}
                        </p>
                        {% if booking.car.latitude and booking.car.longitude %}
                        <div class="mt-2 text-xs text-gray-500">
                            Coordinates: {{ "%.6f"|format(booking.car.latitude) }}, {{ "%.6f"|format(booking.car.longitude) }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Financial Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Financial Summary</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td><strong>Total Amount:</strong></td>
                                        <td class="text-end">₹{{ "%.2f"|format(booking.total_price) }}</td>
                                    </tr>
                                    {% if booking.cancellation_fee_deducted > 0 %}
                                    <tr>
                                        <td><strong>Cancellation Fee (50%):</strong></td>
                                        <td class="text-end text-danger">-₹{{ "%.2f"|format(booking.cancellation_fee_deducted) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.refund_amount > 0 %}
                                    <tr>
                                        <td><strong>Refund Amount:</strong></td>
                                        <td class="text-end text-success">₹{{ "%.2f"|format(booking.refund_amount) }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr class="table-light">
                                        <td><strong>Net Amount:</strong></td>
                                        <td class="text-end">
                                            <strong>
                                                ₹{{ "%.2f"|format(booking.total_price - booking.cancellation_fee_deducted + booking.refund_amount) }}
                                            </strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Transaction Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Transaction Details</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>Payment Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.payment_status == 'completed' %}success
                                                                {% elif booking.payment_status == 'pending' %}warning
                                                                {% elif booking.payment_status == 'failed' %}danger
                                                                {% elif booking.payment_status == 'refunded' %}secondary
                                                                {% else %}light{% endif %}">
                                                {{ booking.payment_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% if booking.payment_date %}
                                    <tr>
                                        <td>Payment Date:</td>
                                        <td class="text-end">{{ booking.payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.razorpay_payment_id %}
                                    <tr>
                                        <td>Razorpay Payment ID:</td>
                                        <td class="text-end">{{ booking.razorpay_payment_id }}</td>
                                    </tr>
                                    {% endif %}
                                    <!-- Add more transaction details as needed -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Extension Details (if applicable) -->
                {% if booking.has_extension_request %}
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Extension Request</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>New End Date:</td>
                                        <td class="text-end">{{ booking.extension_new_end_date.strftime('%Y-%m-%d') }}</td>
                                    </tr>
                                    <tr>
                                        <td>Additional Days:</td>
                                        <td class="text-end">{{ booking.extension_additional_days }}</td>
                                    </tr>
                                    <tr>
                                        <td>Additional Price:</td>
                                        <td class="text-end">₹{{ "%.2f"|format(booking.extension_additional_price) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Extension Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.extension_status == 'approved' %}success
                                                                {% elif booking.extension_status == 'requested' %}warning
                                                                {% elif booking.extension_status == 'cancelled' %}danger
                                                                {% else %}light{% endif %}">
                                                {{ booking.extension_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Extension Payment Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.extension_payment_status == 'completed' %}success
                                                                {% elif booking.extension_payment_status == 'pending' %}warning
                                                                {% elif booking.extension_payment_status == 'failed' %}danger
                                                                {% elif booking.extension_payment_status == 'refunded' %}secondary
                                                                {% else %}light{% endif %}">
                                                {{ booking.extension_payment_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% if booking.extension_payment_date %}
                                    <tr>
                                        <td>Extension Payment Date:</td>
                                        <td class="text-end">{{ booking.extension_payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.extension_razorpay_payment_id %}
                                    <tr>
                                        <td>Extension Razorpay Payment ID:</td>
                                        <td class="text-end">{{ booking.extension_razorpay_payment_id }}</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Extension Actions -->
                        {% if booking.extension_status == 'requested' %}
                        <div class="mt-2">
                            <form method="POST" action="{{ url_for('admin.approve_extension', booking_id=booking.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Approve this extension request?')">
                                    <i class="fas fa-check"></i> Approve Extension
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('admin.reject_extension', booking_id=booking.id) }}" class="d-inline ms-2">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Reject this extension request?')">
                                    <i class="fas fa-times"></i> Reject Extension
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        <!-- End Extension Actions -->
                    </div>
                </div>
                {% endif %}
                <!-- End Extension Details -->

            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Admin Actions</h5>
            </div>
            <div class="card-body">
                {% if booking.can_be_approved() %}
                <form method="POST" action="{{ url_for('admin.approve_booking', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-success w-100" onclick="return confirm('Approve this booking request?')">
                        <i class="fas fa-check-circle"></i> Approve Booking
                    </button>
                </form>
                {% elif booking.status == 'approved' and booking.payment_status == 'pending' %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Waiting for customer to complete payment.
                </div>
                {% elif booking.payment_status == 'completed' and not booking.is_active %}
                <form method="POST" action="{{ url_for('admin.mark_booking_paid', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-hand-holding-usd"></i> Mark as Paid (Confirm Receipt)
                    </button>
                </form>
                {% elif booking.is_active and not booking.is_completed %}
                <form method="POST" action="{{ url_for('admin.complete_booking_trip', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-info w-100" onclick="return confirm('Mark this trip as completed?')">
                        <i class="fas fa-flag-checkered"></i> Complete Trip
                    </button>
                </form>
                {% elif booking.is_completed %}
                <button class="btn btn-secondary w-100" disabled>
                    <i class="fas fa-check-double"></i> Trip Completed
                </button>
                {% elif booking.status == 'cancelled' %}
                <button class="btn btn-danger w-100" disabled>
                    <i class="fas fa-ban"></i> Booking Cancelled
                </button>
                {% else %}
                <div class="alert alert-secondary">
                    <i class="fas fa-info-circle"></i> No actions available at this time.
                </div>
                {% endif %}

                {% if booking.status not in ['completed', 'cancelled'] %}
                <hr class="my-3">
                <form method="POST" action="{{ url_for('admin.cancel_booking', booking_id=booking.id) }}" class="d-grid gap-2">
                    <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Cancel this booking? This action cannot be undone.')">
                        <i class="fas fa-times-circle"></i> Cancel Booking
                    </button>
                </form>
                {% endif %}

                <hr class="my-3">
                <a href="{{ url_for('admin.list_bookings') }}" class="btn btn-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Back to Bookings
                </a>
            </div>
        </div>

        <!-- Car Images -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images"></i> Car Images</h5>
            </div>
            <div class="card-body">
                {% if booking.car.images %}
                    <div id="carImageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for image in booking.car.images %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                     class="d-block w-100" alt="{{ booking.car.make }} {{ booking.car.model }} Image {{ loop.index }}"
                                     style="height: 200px; object-fit: cover;">
                            </div>
                            {% endfor %}
                        </div>
                        {% if booking.car.images|length > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-image fa-3x"></i>
                        <p>No images available for this car.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\bookings\list.html ---
<!-- templates/admin/bookings/list.html -->
{% extends "admin/base.html" %}

{% block title %}Manage Bookings{% endblock %}
{% block page_title %}Manage Bookings{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-receipt"></i> All Bookings</h5>
            <form method="GET" action="{{ url_for('admin.list_bookings') }}" class="d-flex">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search by ID, Car, User..." value="{{ search_query }}">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if bookings %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Car</th>
                            <th>Host</th>
                            <th>User</th>
                            <th>Dates</th>
                            <th>Total Price</th>
                            <th>Payment Status</th>
                            <th>Booking Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>#{{ booking.id }}</td>
                            <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                            <td>{{ booking.car.host.company_name or booking.car.host.user.username }}</td>
                            <td>{{ booking.user.username }}</td>
                            <td>
                                {{ booking.start_date.strftime('%Y-%m-%d') }}<br>
                                to {{ booking.end_date.strftime('%Y-%m-%d') }}
                            </td>
                            <td>₹{{ "%.2f"|format(booking.total_price) }}</td>
                            <td>
                                <span class="badge bg-{% if booking.payment_status == 'completed' %}success{% elif booking.payment_status == 'pending' %}warning{% elif booking.payment_status == 'failed' %}danger{% else %}secondary{% endif %}">
                                    {{ booking.payment_status|title }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{% if booking.status == 'completed' %}success{% elif booking.status == 'active' %}info{% elif booking.status == 'paid' %}primary{% elif booking.status == 'approved' %}secondary{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}light{% endif %}">
                                    {{ booking.status|title }}
                                </span>
                                {% if booking.is_active %}<span class="badge bg-info">Active</span>{% endif %}
                                {% if booking.is_completed %}<span class="badge bg-success">Completed</span>{% endif %}
                            </td>
                            <td>{{ booking.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <a href="{{ url_for('admin.booking_detail', booking_id=booking.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if bookings_pagination.pages > 1 %}
            <nav aria-label="Bookings pagination">
                <ul class="pagination justify-content-center">
                    {% if bookings_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_bookings', page=bookings_pagination.prev_num, search=search_query) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in bookings_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != bookings_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.list_bookings', page=page_num, search=search_query) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if bookings_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_bookings', page=bookings_pagination.next_num, search=search_query) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                <h4>No bookings found</h4>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\cars\detail.html ---
<!-- templates/admin/cars/detail.html -->
{% extends "admin/base.html" %}

{% block title %}Car Details - {{ car.make }} {{ car.model }}{% endblock %}
{% block page_title %}Car Details: {{ car.make }} {{ car.model }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-car"></i> {{ car.make }} {{ car.model }} ({{ car.year }})</h5>
            </div>
            <div class="card-body">
                <!-- Car Images -->
                {% if car.images %}
                    <div id="carImageCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for image in car.images %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                     class="d-block w-100" alt="{{ car.make }} {{ car.model }} Image {{ loop.index }}"
                                     style="height: 300px; object-fit: cover;">
                            </div>
                            {% endfor %}
                        </div>
                        {% if car.images|length > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-64 flex items-center justify-center mb-4">
                        <i class="fas fa-car text-gray-400 text-4xl"></i>
                    </div>
                {% endif %}

                <!-- Car Specifications -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Make:</strong> {{ car.make }}
                    </div>
                    <div class="col-md-4">
                        <strong>Model:</strong> {{ car.model }}
                    </div>
                    <div class="col-md-4">
                        <strong>Year:</strong> {{ car.year }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Price/Day:</strong> ₹{{ "%.2f"|format(car.price_per_day) }}
                    </div>
                    <div class="col-md-4">
                        <strong>Color:</strong> {{ car.color or 'N/A' }}
                    </div>
                    <div class="col-md-4">
                        <strong>Mileage:</strong> {{ car.mileage or 'N/A' }} km
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Fuel Type:</strong> {{ car.fuel_type }}
                    </div>
                    <div class="col-md-4">
                        <strong>Transmission:</strong> {{ car.transmission }}
                    </div>
                    <div class="col-md-4">
                        <strong>Seats:</strong> {{ car.seats }}
                    </div>
                </div>

                <!-- Features -->
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Features:</strong>
                        <div class="mt-1">
                            {% if car.has_ac %}<span class="badge bg-success me-1">AC</span>{% endif %}
                            {% if car.has_bluetooth %}<span class="badge bg-success me-1">Bluetooth</span>{% endif %}
                            {% if car.has_sunroof %}<span class="badge bg-success me-1">Sunroof</span>{% endif %}
                            {% if car.has_gps %}<span class="badge bg-success me-1">GPS</span>{% endif %}
                            {% if car.has_usb_port %}<span class="badge bg-success me-1">USB Port</span>{% endif %}
                            {% if car.has_reverse_camera %}<span class="badge bg-success me-1">Reverse Camera</span>{% endif %}
                            {% if not (car.has_ac or car.has_bluetooth or car.has_sunroof or car.has_gps or car.has_usb_port or car.has_reverse_camera) %}
                                <span class="text-muted">No features listed</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Location Details -->
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Location:</strong>
                        <div class="mt-1">
                            <p class="mb-1">
                                {% if car.full_address %}
                                    {{ car.full_address }}
                                {% else %}
                                    {% if car.street_address %}{{ car.street_address }}, {% endif %}
                                    {% if car.locality %}{{ car.locality }}, {% endif %}
                                    {% if car.city %}{{ car.city }}{% endif %}
                                    {% if car.state %}, {{ car.state }}{% endif %}
                                    {% if car.pincode %} - {{ car.pincode }}{% endif %}
                                {% endif %}
                            </p>
                            {% if car.latitude and car.longitude %}
                                <small class="text-muted">Coordinates: {{ "%.6f"|format(car.latitude) }}, {{ "%.6f"|format(car.longitude) }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Host Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Host:</strong> {{ car.host.company_name or car.host.user.username }}
                    </div>
                    <div class="col-md-6">
                        <strong>Host Status:</strong>
                        {% if car.host.is_verified %}
                            <span class="badge bg-success">Verified</span>
                        {% else %}
                            <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Status -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Availability:</strong>
                        {% if car.is_available %}
                            <span class="badge bg-success">Available</span>
                        {% else %}
                            <span class="badge bg-secondary">Unavailable</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Blocking Status:</strong>
                        {% if car.is_blocked %}
                            <span class="badge bg-danger">Blocked</span>
                            {% if car.blocked_reason %}
                                <small class="text-muted d-block">Reason: {{ car.blocked_reason }}</small>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-success">Not Blocked</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Admin Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if car.is_blocked %}
                        <form method="POST" action="{{ url_for('admin.toggle_car_block', car_id=car.id) }}">
                            <input type="hidden" name="reason" value="Unblocked by admin">
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Unblock car {{ car.make }} {{ car.model }}?')">
                                <i class="fas fa-unlock"></i> Unblock Car
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{{ url_for('admin.toggle_car_block', car_id=car.id) }}">
                            <input type="hidden" name="reason" value="Blocked by admin">
                            <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Block car {{ car.make }} {{ car.model }}?')">
                                <i class="fas fa-lock"></i> Block Car
                            </button>
                        </form>
                    {% endif %}

                    <a href="{{ url_for('admin.list_cars') }}" class="btn btn-secondary w-100">
                        <i class="fas fa-arrow-left"></i> Back to Cars
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Booking History</h5>
            </div>
            <div class="card-body">
                {% if car.bookings %}
                    <ul class="list-group list-group-flush">
                        {% for booking in car.bookings[:5] %} <!-- Show last 5 -->
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <span>Booking #{{ booking.id }}</span>
                                <span class="badge bg-{% if booking.status == 'completed' %}success{% elif booking.status == 'active' %}info{% elif booking.status == 'paid' %}primary{% elif booking.status == 'approved' %}secondary{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}light{% endif %}">
                                    {{ booking.status|title }}
                                </span>
                            </div>
                            <small class="text-muted">{{ booking.user.username }} • {{ booking.start_date.strftime('%Y-%m-%d') }} to {{ booking.end_date.strftime('%Y-%m-%d') }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% if car.bookings|length > 5 %}
                        <a href="{{ url_for('admin.list_bookings', car_id=car.id) }}" class="btn btn-sm btn-outline-primary mt-2">View All Bookings</a>
                    {% endif %}
                {% else %}
                    <p class="text-muted">No bookings for this car yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\cars\list.html ---
<!-- templates/admin/cars/list.html -->
{% extends "admin/base.html" %}

{% block title %}Manage Cars{% endblock %}
{% block page_title %}Manage Cars{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-car"></i> All Cars</h5>
            <form method="GET" action="{{ url_for('admin.list_cars') }}" class="d-flex">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search cars..." value="{{ search_query }}">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if cars %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Car ID</th>
                            <th>Make & Model</th>
                            <th>Year</th>
                            <th>Host</th>
                            <th>Location</th>
                            <th>Price/Day</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for car in cars %}
                        <tr>
                            <td>#{{ car.id }}</td>
                            <td>{{ car.make }} {{ car.model }}</td>
                            <td>{{ car.year }}</td>
                            <td>{{ car.host.company_name or car.host.user.username }}</td>
                            <td>
                                {% if car.city %}{{ car.city }}{% endif %}
                                {% if car.locality %}, {{ car.locality }}{% endif %}
                            </td>
                            <td>₹{{ "%.2f"|format(car.price_per_day) }}</td>
                            <td>
                                {% if car.is_available %}
                                    <span class="badge bg-success">Available</span>
                                {% else %}
                                    <span class="badge bg-secondary">Unavailable</span>
                                {% endif %}
                                {% if car.is_blocked %}
                                    <span class="badge bg-danger">Blocked</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin.car_detail', car_id=car.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% if car.is_blocked %}
                                    <form method="POST" action="{{ url_for('admin.toggle_car_block', car_id=car.id) }}" class="d-inline">
                                        <input type="hidden" name="reason" value="Unblocked by admin">
                                        <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Unblock car {{ car.make }} {{ car.model }}?')">
                                            <i class="fas fa-unlock"></i> Unblock
                                        </button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('admin.toggle_car_block', car_id=car.id) }}" class="d-inline">
                                        <input type="hidden" name="reason" value="Blocked by admin">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Block car {{ car.make }} {{ car.model }}?')">
                                            <i class="fas fa-lock"></i> Block
                                        </button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if cars_pagination.pages > 1 %}
            <nav aria-label="Cars pagination">
                <ul class="pagination justify-content-center">
                    {% if cars_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_cars', page=cars_pagination.prev_num, search=search_query) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in cars_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != cars_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.list_cars', page=page_num, search=search_query) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if cars_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_cars', page=cars_pagination.next_num, search=search_query) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-car fa-3x text-muted mb-3"></i>
                <h4>No cars found</h4>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\documents\detail.html ---
<!-- templates/admin/documents/detail.html -->
{% extends "admin/base.html" %}

{% block title %}Document Details - #{{ document.id }}{% endblock %}
{% block page_title %}Document Details: #{{ document.id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt"></i> {{ document.document_type|title }} Document #{{ document.id }}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>User:</strong> {{ document.user.username }} ({{ document.user.email }})
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        {% if document.is_verified %}
                            <span class="badge bg-success">Verified</span>
                        {% else %}
                            <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Uploaded:</strong> {{ document.uploaded_at.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                    <div class="col-md-6">
                        {% if document.verified_at %}
                            <strong>Verified:</strong> {{ document.verified_at.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                    </div>
                </div>

                {% if document.verified_at %}
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Verified By:</strong> Admin (System)
                    </div>
                </div>
                {% endif %}

                <hr>

                <div class="mb-3">
                    <h6>Document Image</h6>
                    {% if document.filename %}
                        <div class="text-center">
                            <img src="{{ url_for('static', filename='uploads/' + document.filename) }}"
                                 class="img-fluid border rounded" alt="{{ document.document_type }} Document"
                                 style="max-height: 500px;">
                        </div>
                    {% else %}
                        <p class="text-muted">No document image available.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Admin Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if not document.is_verified %}
                        <form method="POST" action="{{ url_for('admin.verify_document', doc_id=document.id) }}">
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Verify this {{ document.document_type }} document for {{ document.user.username }}?')">
                                <i class="fas fa-check-circle"></i> Verify Document
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{{ url_for('admin.reject_document', doc_id=document.id) }}">
                            <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Reject this {{ document.document_type }} document for {{ document.user.username }}?')">
                                <i class="fas fa-times-circle"></i> Reject Document
                            </button>
                        </form>
                    {% endif %}

                    <a href="{{ url_for('admin.list_documents') }}" class="btn btn-secondary w-100">
                        <i class="fas fa-arrow-left"></i> Back to Documents
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user"></i> User Profile</h5>
            </div>
            <div class="card-body">
                <p><strong>{{ document.user.username }}</strong></p>
                <p>Email: {{ document.user.email }}</p>
                <p>Phone: {{ document.user.phone or 'N/A' }}</p>
                <a href="{{ url_for('admin.user_detail', user_id=document.user.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i> View User Profile
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\documents\list.html ---
<!-- templates/admin/documents/list.html -->
{% extends "admin/base.html" %}

{% block title %}Manage Documents{% endblock %}
{% block page_title %}Manage Documents{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-file-alt"></i> User Documents</h5>
            <form method="GET" action="{{ url_for('admin.list_documents') }}" class="d-flex">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search documents..." value="{{ search_query }}">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if documents %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Doc ID</th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Uploaded</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for document in documents %}
                        <tr>
                            <td>#{{ document.id }}</td>
                            <td>{{ document.user.username }} ({{ document.user.email }})</td>
                            <td>{{ document.document_type|title }}</td>
                            <td>{{ document.uploaded_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if document.is_verified %}
                                    <span class="badge bg-success">Verified</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin.document_detail', doc_id=document.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% if not document.is_verified %}
                                    <form method="POST" action="{{ url_for('admin.verify_document', doc_id=document.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Verify this {{ document.document_type }} document for {{ document.user.username }}?')">
                                            <i class="fas fa-check-circle"></i> Verify
                                        </button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('admin.reject_document', doc_id=document.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Reject this {{ document.document_type }} document for {{ document.user.username }}?')">
                                            <i class="fas fa-times-circle"></i> Reject
                                        </button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if documents_pagination.pages > 1 %}
            <nav aria-label="Documents pagination">
                <ul class="pagination justify-content-center">
                    {% if documents_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_documents', page=documents_pagination.prev_num, search=search_query) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in documents_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != documents_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.list_documents', page=page_num, search=search_query) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if documents_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_documents', page=documents_pagination.next_num, search=search_query) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                <h4>No documents found</h4>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\hosts\detail.html ---
<!-- templates/admin/hosts/detail.html -->
{% extends "admin/base.html" %}

{% block title %}Host Details - {{ host.company_name or host.user.username }}{% endblock %}
{% block page_title %}Host Details: {{ host.company_name or host.user.username }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-tie"></i> Host Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Host ID:</strong> #{{ host.id }}
                    </div>
                    <div class="col-md-6">
                        <strong>Associated User:</strong> {{ host.user.username }} ({{ host.user.email }})
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Company Name:</strong> {{ host.company_name or 'N/A' }}
                    </div>
                    <div class="col-md-6">
                        <strong>Phone:</strong> {{ host.phone or host.user.phone or 'N/A' }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Address:</strong> {{ host.address or 'N/A' }}
                    </div>
                    <div class="col-md-6">
                        <strong>Verification Status:</strong>
                        {% if host.is_verified %}
                            <span class="badge bg-success">Verified</span>
                        {% else %}
                            <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Wallet Balance:</strong> ₹{{ "%.2f"|format(host.wallet_balance) }}
                    </div>
                    <div class="col-md-6">
                        <strong>User Status:</strong>
                        {% if host.user.is_active %}
                            <span class="badge bg-info">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Joined:</strong> {{ host.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                    <div class="col-md-6">
                        <strong>Cars Listed:</strong> {{ host.cars_managed|length }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-car"></i> Host's Cars</h5>
            </div>
            <div class="card-body">
                {% if host.cars_managed %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Car ID</th>
                                    <th>Make & Model</th>
                                    <th>Year</th>
                                    <th>Price/Day</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for car in host.cars_managed %}
                                <tr>
                                    <td>#{{ car.id }}</td>
                                    <td>{{ car.make }} {{ car.model }}</td>
                                    <td>{{ car.year }}</td>
                                    <td>₹{{ "%.2f"|format(car.price_per_day) }}</td>
                                    <td>
                                        {% if car.is_available %}
                                            <span class="badge bg-success">Available</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Unavailable</span>
                                        {% endif %}
                                        {% if car.is_blocked %}
                                            <span class="badge bg-danger">Blocked</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('admin.car_detail', car_id=car.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        {% if car.is_blocked %}
                                            <form method="POST" action="{{ url_for('admin.toggle_car_block', car_id=car.id) }}" class="d-inline">
                                                <input type="hidden" name="reason" value="Unblocked by admin">
                                                <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Unblock car {{ car.make }} {{ car.model }}?')">
                                                    <i class="fas fa-unlock"></i> Unblock
                                                </button>
                                            </form>
                                        {% else %}
                                            <form method="POST" action="{{ url_for('admin.toggle_car_block', car_id=car.id) }}" class="d-inline">
                                                <input type="hidden" name="reason" value="Blocked by admin">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Block car {{ car.make }} {{ car.model }}?')">
                                                    <i class="fas fa-lock"></i> Block
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">This host has not listed any cars yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Admin Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if host.is_verified %}
                        <form method="POST" action="{{ url_for('admin.unverify_host', host_id=host.id) }}">
                            <button type="submit" class="btn btn-warning w-100" onclick="return confirm('Unverify host {{ host.company_name or host.user.username }}?')">
                                <i class="fas fa-times-circle"></i> Unverify Host
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{{ url_for('admin.verify_host', host_id=host.id) }}">
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Verify host {{ host.company_name or host.user.username }}?')">
                                <i class="fas fa-check-circle"></i> Verify Host
                            </button>
                        </form>
                    {% endif %}

                    {% if host.user.is_active %}
                        <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=host.user.id) }}"> <!-- Reuse existing user toggle -->
                            <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Deactivate user account for {{ host.user.username }}?')">
                                <i class="fas fa-user-slash"></i> Deactivate User
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=host.user.id) }}"> <!-- Reuse existing user toggle -->
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Activate user account for {{ host.user.username }}?')">
                                <i class="fas fa-user-check"></i> Activate User
                            </button>
                        </form>
                    {% endif %}

                    <a href="{{ url_for('admin.list_hosts') }}" class="btn btn-secondary w-100">
                        <i class="fas fa-arrow-left"></i> Back to Hosts
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wallet"></i> Wallet</h5>
            </div>
            <div class="card-body">
                <p><strong>Balance:</strong> ₹{{ "%.2f"|format(host.wallet_balance) }}</p>
                <a href="#" class="btn btn-sm btn-outline-primary disabled">View Transactions</a>
                <a href="#" class="btn btn-sm btn-outline-success disabled">Add Funds</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\hosts\list.html ---
<!-- templates/admin/hosts/list.html -->
{% extends "admin/base.html" %}

{% block title %}Manage Hosts{% endblock %}
{% block page_title %}Manage Hosts{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-user-tie"></i> All Hosts</h5>
            <form method="GET" action="{{ url_for('admin.list_hosts') }}" class="d-flex">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search hosts..." value="{{ search_query }}">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if hosts %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Host ID</th>
                            <th>Company/Name</th>
                            <th>Contact</th>
                            <th>Phone</th>
                            <th>Cars Listed</th>
                            <th>Status</th>
                            <th>Wallet Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for host in hosts %}
                        <tr>
                            <td>#{{ host.id }}</td>
                            <td>{{ host.company_name or host.user.username }}</td>
                            <td>{{ host.user.email }}</td>
                            <td>{{ host.phone or host.user.phone or 'N/A' }}</td>
                            <td>{{ host.cars_managed|length }}</td>
                            <td>
                                {% if host.is_verified %}
                                    <span class="badge bg-success">Verified</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                                {% if host.user.is_active %}
                                    <span class="badge bg-info">User Active</span>
                                {% else %}
                                    <span class="badge bg-danger">User Inactive</span>
                                {% endif %}
                            </td>
                            <td>₹{{ "%.2f"|format(host.wallet_balance) }}</td>
                            <td>
                                <a href="{{ url_for('admin.host_detail', host_id=host.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% if host.is_verified %}
                                    <form method="POST" action="{{ url_for('admin.unverify_host', host_id=host.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-warning" onclick="return confirm('Unverify host {{ host.company_name or host.user.username }}?')">
                                            <i class="fas fa-times-circle"></i> Unverify
                                        </button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('admin.verify_host', host_id=host.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Verify host {{ host.company_name or host.user.username }}?')">
                                            <i class="fas fa-check-circle"></i> Verify
                                        </button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if hosts_pagination.pages > 1 %}
            <nav aria-label="Hosts pagination">
                <ul class="pagination justify-content-center">
                    {% if hosts_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_hosts', page=hosts_pagination.prev_num, search=search_query) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in hosts_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != hosts_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.list_hosts', page=page_num, search=search_query) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if hosts_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_hosts', page=hosts_pagination.next_num, search=search_query) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                <h4>No hosts found</h4>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\transactions\list.html ---
<!-- templates/admin/transactions/list.html -->
{% extends "admin/base.html" %}

{% block title %}Transaction History{% endblock %}
{% block page_title %}Transaction History{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-receipt"></i> All Transactions</h5>
            <form method="GET" action="{{ url_for('admin.list_transactions') }}" class="d-flex">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search transactions..." value="{{ search_query }}">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if transactions %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Booking ID</th>
                            <th>User</th>
                            <th>Car</th>
                            <th>Amount (₹)</th>
                            <th>Status</th>
                            <th>Payment Date</th>
                            <th>Razorpay ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in transactions %} <!-- Using Booking as transaction source -->
                        <tr>
                            <td>#TXN-{{ booking.id }}</td>
                            <td><a href="{{ url_for('admin.booking_detail', booking_id=booking.id) }}">#{{ booking.id }}</a></td>
                            <td>{{ booking.user.username }} ({{ booking.user.email }})</td>
                            <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                            <td>₹{{ "%.2f"|format(booking.total_price) }}</td>
                            <td>
                                <span class="badge bg-{% if booking.payment_status == 'completed' %}success
                                                    {% elif booking.payment_status == 'pending' %}warning
                                                    {% elif booking.payment_status == 'failed' %}danger
                                                    {% elif booking.payment_status == 'refunded' %}secondary
                                                    {% else %}light{% endif %}">
                                    {{ booking.payment_status|title }}
                                </span>
                            </td>
                            <td>{{ booking.payment_date.strftime('%Y-%m-%d %H:%M') if booking.payment_date else 'N/A' }}</td>
                            <td>{{ booking.razorpay_payment_id or 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if transactions_pagination.pages > 1 %}
            <nav aria-label="Transactions pagination">
                <ul class="pagination justify-content-center">
                    {% if transactions_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_transactions', page=transactions_pagination.prev_num, search=search_query, sort=current_sort) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in transactions_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != transactions_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.list_transactions', page=page_num, search=search_query, sort=current_sort) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if transactions_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_transactions', page=transactions_pagination.next_num, search=search_query, sort=current_sort) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                <h4>No transactions found</h4>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\users\detail.html ---
<!-- templates/admin/users/detail.html -->
{% extends "admin/base.html" %}

{% block title %}User Details - {{ user.username }}{% endblock %}
{% block page_title %}User Details: {{ user.username }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user"></i> User Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>ID:</strong> {{ user.id }}
                    </div>
                    <div class="col-md-6">
                        <strong>Username:</strong> {{ user.username }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Email:</strong> {{ user.email }}
                    </div>
                    <div class="col-md-6">
                        <strong>Phone:</strong> {{ user.phone or 'N/A' }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        {% if user.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                        {% if user.is_admin %}
                            <span class="badge bg-purple">Admin</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Joined:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>RC Document:</strong>
                        {% if user.rc_document %}
                            <a href="{{ url_for('static', filename='uploads/' + user.rc_document.filename) }}" target="_blank">View RC</a>
                            {% if user.rc_document.is_verified %}
                                <span class="badge bg-success">Verified</span>
                            {% else %}
                                <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not uploaded</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>DL Document:</strong>
                        {% if user.dl_document %}
                            <a href="{{ url_for('static', filename='uploads/' + user.dl_document.filename) }}" target="_blank">View DL</a>
                            {% if user.dl_document.is_verified %}
                                <span class="badge bg-success">Verified</span>
                            {% else %}
                                <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not uploaded</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-receipt"></i> User Bookings</h5>
            </div>
            <div class="card-body">
                {% if user.bookings %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Car</th>
                                    <th>Dates</th>
                                    <th>Total Price</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in user.bookings %}
                                <tr>
                                    <td><a href="{{ url_for('admin.booking_detail', booking_id=booking.id) }}">#{{ booking.id }}</a></td>
                                    <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                                    <td>{{ booking.start_date.strftime('%Y-%m-%d') }} to {{ booking.end_date.strftime('%Y-%m-%d') }}</td>
                                    <td>₹{{ "%.2f"|format(booking.total_price) }}</td>
                                    <td>
                                        <span class="badge bg-{% if booking.status == 'completed' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                            {{ booking.status|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No bookings found for this user.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if user.is_active %}
                        <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}">
                            <button type="submit" class="btn btn-warning w-100" onclick="return confirm('Deactivate user {{ user.username }}?')">
                                <i class="fas fa-ban"></i> Deactivate User
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}">
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Activate user {{ user.username }}?')">
                                <i class="fas fa-check"></i> Activate User
                            </button>
                        </form>
                    {% endif %}

                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}">
                        <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Delete user {{ user.username }}? This cannot be undone.')">
                            <i class="fas fa-trash"></i> Delete User
                        </button>
                    </form>

                    {% if user.rc_document and not user.rc_document.is_verified %}
                    <form method="POST" action="{{ url_for('admin.verify_document', document_id=user.rc_document.id) }}">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-check-circle"></i> Verify RC
                        </button>
                    </form>
                    {% endif %}

                    {% if user.dl_document and not user.dl_document.is_verified %}
                    <form method="POST" action="{{ url_for('admin.verify_document', document_id=user.dl_document.id) }}">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-check-circle"></i> Verify DL
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\admin\users\list.html ---
<!-- templates/admin/users/list.html -->
{% extends "admin/base.html" %}

{% block title %}Manage Users{% endblock %}
{% block page_title %}Manage Users{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users"></i> All Users</h5>
            <form method="GET" action="{{ url_for('admin.list_users') }}" class="d-flex">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search users..." value="{{ search_query }}">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if users %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>#{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.phone or 'N/A' }}</td>
                            <td>
                                {% if user.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                                {% if user.is_admin %}
                                    <span class="badge bg-purple">Admin</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% if user.is_active %}
                                    <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-warning" onclick="return confirm('Deactivate user {{ user.username }}?')">
                                            <i class="fas fa-ban"></i> Deactivate
                                        </button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Activate user {{ user.username }}?')">
                                            <i class="fas fa-check"></i> Activate
                                        </button>
                                    </form>
                                {% endif %}
                                <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete user {{ user.username }}? This cannot be undone.')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if users_pagination.pages > 1 %}
            <nav aria-label="Users pagination">
                <ul class="pagination justify-content-center">
                    {% if users_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_users', page=users_pagination.prev_num, search=search_query) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in users_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != users_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.list_users', page=page_num, search=search_query) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if users_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.list_users', page=users_pagination.next_num, search=search_query) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h4>No users found</h4>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\booking\initiate.html ---
<!-- templates/booking/initiate.html -->
{% extends "base.html" %} <!-- Or your main base template -->

{% block title %}Book {{ car.make }} {{ car.model }} - ZoomCar Clone{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="bg-white border rounded-2xl overflow-hidden shadow-sm p-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Book {{ car.make }} {{ car.model }} ({{ car.year }})</h1>

        <!-- Car Info Summary (Optional) -->
        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-700"><strong>Transmission:</strong> {{ car.transmission }}</p>
                    <p class="text-gray-700"><strong>Fuel Type:</strong> {{ car.fuel_type }}</p>
                    <p class="text-gray-700"><strong>Seats:</strong> {{ car.seats }}</p>
                </div>
                <div class="text-right">
                    <p class="text-xl font-bold text-gray-900">₹{{ "%.2f"|format(car.price_per_hour) }}/hour</p>
                </div>
            </div>
        </div>
        <!-- End Car Info Summary -->

        <!-- Booking Form -->
        <div class="border rounded-xl p-4 bg-blue-50">
            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <i class="fas fa-calendar-alt text-primary"></i> Enter Booking Details
            </h3>

            <!-- CRITICAL FIX 2: Corrected the form action URL -->
            <form id="bookingForm" method="POST" action="{{ url_for('booking.initiate_booking', car_id=car.id) }}">
                 <!-- CRITICAL FIX: Manually Add CSRF Token -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <!-- END CRITICAL FIX -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start_datetime" class="block text-sm font-medium text-gray-700 mb-1">Start Date & Time</label>
                        <input type="datetime-local" id="start_datetime" name="start_datetime"
                               class="w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               min="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}"
                               value="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}" required>
                    </div>
                    <div>
                        <label for="end_datetime" class="block text-sm font-medium text-gray-700 mb-1">End Date & Time</label>
                        <input type="datetime-local" id="end_datetime" name="end_datetime"
                               class="w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               min="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}"
                               value="{{ default_end_datetime.strftime('%Y-%m-%dT%H:%M') if default_end_datetime else '' }}" required>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center text-sm">
                        <span>Duration (Hours):</span>
                        <span id="numHours">0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-sm mt-1">
                        <span>Price per Hour:</span>
                        <span>₹{{ "%.2f"|format(car.price_per_hour) }}</span>
                    </div>
                    <hr class="my-2">
                    <div class="flex justify-between items-center font-semibold text-base">
                        <span>Total Cost:</span>
                        <span id="totalCost">₹0.00</span>
                    </div>
                </div>

                <button type="submit" class="w-full bg-primary text-white rounded-xl px-4 py-3 font-medium hover:bg-blue-600 transition-colors">
                    <i class="fas fa-credit-card mr-2"></i> Proceed to Payment
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startDateTimeInput = document.getElementById('start_datetime');
    const endDateTimeInput = document.getElementById('end_datetime');
    const numHoursSpan = document.getElementById('numHours');
    const totalCostSpan = document.getElementById('totalCost');
    const pricePerHour = {{ car.price_per_hour }}; // Use price_per_hour

    function updateBookingDetails() {
        const startDateTimeStr = startDateTimeInput.value;
        const endDateTimeStr = endDateTimeInput.value;

        if (startDateTimeStr && endDateTimeStr) {
            const startDateTime = new Date(startDateTimeStr);
            const endDateTime = new Date(endDateTimeStr);

            if (endDateTime >= startDateTime) {
                const timeDiff = endDateTime.getTime() - startDateTime.getTime();
                const hoursDiff = timeDiff / (1000 * 3600); // Convert milliseconds to hours
                const numHours = hoursDiff > 0 ? hoursDiff : 0.01; // Minimum e.g., 0.01 hours (36 seconds)

                numHoursSpan.textContent = numHours.toFixed(2); // Display with 2 decimal places
                const totalCost = numHours * pricePerHour;
                totalCostSpan.textContent = `₹${totalCost.toFixed(2)}`; // Display with 2 decimal places
            } else {
                numHoursSpan.textContent = 'Invalid';
                totalCostSpan.textContent = 'Invalid';
            }
        } else {
             numHoursSpan.textContent = '0.00'; // Reset if inputs are empty
             totalCostSpan.textContent = '₹0.00';
        }
    }

    if (startDateTimeInput && endDateTimeInput) {
        startDateTimeInput.addEventListener('change', updateBookingDetails);
        endDateTimeInput.addEventListener('change', updateBookingDetails);
        // Initialize on load
        updateBookingDetails();
    }

    // Set minimum datetime for end datetime based on start datetime
    if (startDateTimeInput) {
        startDateTimeInput.addEventListener('change', function() {
            if (endDateTimeInput) {
                endDateTimeInput.min = this.value; // Set minimum to start datetime
                // If end datetime is before new start datetime, reset it
                if (new Date(endDateTimeInput.value) < new Date(this.value)) {
                    endDateTimeInput.value = this.value;
                }
                updateBookingDetails();
            }
        });
    }
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\booking\payment.html ---
<!-- templates/booking/payment.html -->
{% extends "base.html" %}

{% block title %}Payment for Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
        <div class="bg-primary text-white p-5">
            <h1 class="text-2xl font-bold"><i class="fas fa-credit-card mr-2"></i>Secure Payment</h1>
            <p class="text-blue-100">Complete your booking for {{ booking.car.make }} {{ booking.car.model }}</p>
        </div>

        <div class="p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-car text-primary"></i> Car Details
                    </h3>
                    <p class="font-medium">{{ booking.car.make }} {{ booking.car.model }} ({{ booking.car.year }})</p>
                    <p class="text-sm text-gray-600">{{ booking.car.transmission }} • {{ booking.car.fuel_type }}</p>
                </div>
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary"></i> Rental Period
                    </h3>
                    <p class="text-sm"><strong>{{ booking.start_date.strftime('%Y-%m-%d') }}</strong> to <strong>{{ booking.end_date.strftime('%Y-%m-%d') }}</strong></p>
                    <p class="text-sm text-gray-600">{{ booking.duration_days }} days</p>
                </div>
            </div>

            <div class="border rounded-xl p-4 mb-6 bg-blue-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">Total Amount:</span>
                    <span class="text-xl font-bold text-primary">₹{{ "%.2f"|format(total_amount_rupees) }}</span>
                </div>
                <p class="text-xs text-gray-600">This amount will be charged to your payment method.</p>
            </div>

            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-primary"></i> Payment Method
                </h3>
                <div class="text-center py-4">
                    <i class="fas fa-lock text-2xl text-green-500 mb-2"></i>
                    <p class="text-sm text-gray-600 mb-3">Powered by <strong>Razorpay</strong>. Your payment is secured with 128-bit SSL encryption.</p>
                    <button id="rzp-button1" class="bg-primary text-white rounded-xl px-6 py-3 font-medium hover:bg-blue-600 transition-colors">
                        <i class="fas fa-rupee-sign mr-1"></i> Pay ₹{{ "%.2f"|format(total_amount_rupees) }}
                    </button>
                </div>
            </div>

            <div class="text-center text-xs text-gray-500">
                <p>By proceeding, you agree to our <a href="#" class="text-primary hover:underline">Terms of Service</a> and <a href="#" class="text-primary hover:underline">Privacy Policy</a>.</p>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if Razorpay key and order ID are available
    const razorpayKeyId = "{{ razorpay_key_id }}";
    const razorpayOrderId = "{{ razorpay_order_id }}";
    const totalAmountPaise = {{ total_amount_paise }};
    const totalAmountRupees = {{ total_amount_rupees }};
    const bookingId = {{ booking.id }};
    const carMakeModel = "{{ booking.car.make }} {{ booking.car.model }}";

    if (!razorpayKeyId || !razorpayOrderId || !totalAmountPaise) {
        console.error("Razorpay configuration missing.");
        alert("Payment configuration error. Please try again.");
        // window.location.href = "{{ url_for('car.home') }}"; // Redirect on error
        return;
    }

    const options = {
        "key": razorpayKeyId, // Enter the Key ID generated from the Dashboard
        "amount": totalAmountPaise, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "ZoomCar Clone",
        "description": `Booking for ${carMakeModel}`,
        "image": "https://example.com/your_logo.png", // Add your logo URL
        "order_id": razorpayOrderId, // This is a sample Order ID. Pass the `id` obtained in the previous step
        "handler": function (response){
            // This function executes after payment is successful
            // Send payment details to your server for verification
            const paymentData = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
            };

            // Submit payment data to your backend for verification
            // We'll create a simple form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("booking.handle_payment") }}'; // Your backend verification endpoint

            for (const key in paymentData) {
                if (paymentData.hasOwnProperty(key)) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = key;
                    hiddenField.value = paymentData[key];
                    form.appendChild(hiddenField);
                }
            }

            document.body.appendChild(form);
            form.submit();
        },
        "prefill": {
            "name": "{{ current_user.username }}", // Prefill user's name
            "email": "{{ current_user.email }}", // Prefill user's email
            // "contact": "" // Prefill user's contact number if available
        },
        "notes": {
            "booking_id": bookingId,
            "car": carMakeModel
        },
        "theme": {
            "color": "#00b4d8" // Primary color
        }
    };

    const rzp1 = new Razorpay(options);

    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    };

    // Handle payment failure or closure
    rzp1.on('payment.failed', function (response){
        alert(`Payment failed: ${response.error.description}`);
        console.log(response.error);
        // You can redirect to a failure page or show an error message
        // window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
    });
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\booking\razorpay_checkout.html ---
<!-- templates/booking/razorpay_checkout.html -->
{% extends "base.html" %}
{% block title %}Complete Payment for Booking #{{ booking.id }}{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
        <div class="bg-primary text-white p-5">
            <h1 class="text-2xl font-bold"><i class="fas fa-credit-card mr-2"></i>Secure Payment</h1>
            <p class="text-blue-100">Complete your booking for {{ booking.car.make }} {{ booking.car.model }}</p>
        </div>
        <div class="p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-car text-primary"></i> Car Details
                    </h3>
                    <p class="font-medium">{{ booking.car.make }} {{ booking.car.model }} ({{ booking.car.year }})</p>
                    <p class="text-sm text-gray-600">{{ booking.car.transmission }} â€¢ {{ booking.car.fuel_type }}</p>
                </div>
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary"></i> Rental Period
                    </h3>
                    <p class="text-sm"><strong>{{ booking.start_date.strftime('%Y-%m-%d') }}</strong> to <strong>{{ booking.end_date.strftime('%Y-%m-%d') }}</strong></p>
                    <p class="text-sm text-gray-600">{{ booking.duration_days }} days</p>
                </div>
            </div>
            <div class="border rounded-xl p-4 mb-6 bg-blue-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">Total Amount:</span>
                    <span class="text-xl font-bold text-primary">â‚¹{{ "%.2f"|format(total_amount_rupees) }}</span>
                </div>
                <p class="text-xs text-gray-600">This amount will be charged to your payment method.</p>
            </div>
            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-primary"></i> Payment Method
                </h3>
                <div class="text-center py-4">
                    <i class="fas fa-lock text-2xl text-green-500 mb-2"></i>
                    <p class="text-sm text-gray-600 mb-3">Powered by <strong>Razorpay</strong>. Your payment is secured with 128-bit SSL encryption.</p>
                    <button id="rzp-button1" class="bg-primary text-white rounded-xl px-6 py-3 font-medium hover:bg-blue-600 transition-colors">
                        <i class="fas fa-rupee-sign mr-1"></i> Pay â‚¹{{ "%.2f"|format(total_amount_rupees) }}
                    </button>
                </div>
            </div>
            <div class="text-center text-xs text-gray-500">
                <p>By proceeding, you agree to our <a href="#" class="text-primary hover:underline">Terms of Service</a> and <a href="#" class="text-primary hover:underline">Privacy Policy</a>.</p>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<!-- templates/booking/razorpay_checkout.html (Relevant part - Razorpay handler script) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Razorpay Configuration ---
    const razorpayKeyId = "{{ razorpay_key_id }}";
    const razorpayOrderId = "{{ razorpay_order_id }}";
    const totalAmountPaise = {{ total_amount_paise }};
    const totalAmountRupees = {{ total_amount_rupees }};
    const bookingId = {{ booking.id }};
    const carMakeModel = "{{ booking.car.make }} {{ booking.car.model }}";

    if (!razorpayKeyId || !razorpayOrderId || !totalAmountPaise) {
        console.error("Razorpay configuration missing.");
        alert("Payment configuration error. Please try again.");
        window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
        return;
    }
    // --- End Configuration ---

    // --- Razorpay Options ---
    const options = {
        "key": razorpayKeyId,
        "amount": totalAmountPaise,
        "currency": "INR",
        "name": "ZoomCar Clone",
        "description": `Booking for ${carMakeModel} (#${bookingId})`,
        // "image": "https://example.com/your_logo.png", // Add your logo URL if available
        "order_id": razorpayOrderId,
        "handler": function (response){
            // This function executes after payment is successful in the Razorpay popup
            console.log("Razorpay Payment Response:", response);

            // --- CRITICAL FIX: Prepare payment data for backend verification ---
            // BEFORE (Incorrect - Sent raw response object)
            // const paymentData = response;

            // AFTER (Corrected - Extract specific fields and include CSRF token)
            const paymentData = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature
                // csrf_token: '{{ csrf_token() }}' // <-- DO NOT include CSRF token in JSON body
            };
            // --- END CRITICAL FIX ---

            // --- CRITICAL FIX 2: Submit payment data with CSRF token in headers ---
            // BEFORE (Incorrect - No CSRF token sent)
            // fetch('{{ url_for("booking.handle_payment") }}', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         // Missing 'X-CSRFToken': ...
            //     },
            //     body: JSON.stringify(paymentData)
            // })

            // AFTER (Corrected - Include CSRF token in headers)
            fetch('{{ url_for("booking.handle_payment") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // --- Include CSRF token in the header ---
                    // Flask-WTF looks for 'X-CSRFToken' by default
                    'X-CSRFToken': '{{ csrf_token() }}'
                    // --- End Include CSRF token ---
                },
                body: JSON.stringify(paymentData) // Send only payment details in body
            })
            // --- END CRITICAL FIX 2 ---
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Redirect to booking detail page on successful verification
                    // Use URL from backend response
                    window.location.href = data.redirect_url;
                } else {
                    // Handle verification failure
                    alert(data.message || "Payment verification failed. Please contact support.");
                    window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
                }
            })
            .catch(error => {
                console.error('Payment verification error:', error);
                alert("An error occurred during payment verification. Please check your booking status.");
                window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
            });
        },
        "prefill": {
            "name": "{{ current_user.username }}",
            "email": "{{ current_user.email }}",
            // "contact": "{{ current_user.phone }}" // Prefill user's contact number if available
        },
        "notes": {
            "booking_id": bookingId,
            "car": carMakeModel
        },
        "theme": {
            "color": "#00b4d8" // Primary color from your theme
        },
        "modal": {
            "ondismiss": function(){
                // Handle case where user closes the Razorpay popup without paying
                console.log("Razorpay Popup closed by user.");
                alert("Payment was not completed. You can resume payment from the booking details page.");
                window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
            }
        }
    };
    // --- End Options ---

    // --- Initialize and Open Razorpay Checkout ---
    const rzp1 = new Razorpay(options);
    rzp1.open();
    // --- End Initialization ---
});
</script>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\base.html ---
<!-- templates/host/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Host Dashboard{% endblock %} - ZoomCar Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/host.css') }}">
    <style>
        :root {
            --host-primary: #28a745;
            --host-secondary: #17a2b8;
            --host-dark: #343a40;
        }

        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--host-dark), #212529);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            margin: 5px 0;
            border-radius: 5px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            margin-left: 16.666667%; /* Roughly equivalent to col-lg-2 */
            padding: 20px;
        }

        @media (min-width: 768px) {
            .main-content {
                margin-left: 250px;
            }
        }

        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .car-card {
            transition: all 0.3s ease;
        }

        .car-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4><i class="fas fa-car"></i> Host Panel</h4>
                        <small class="text-muted">{{ current_user.username }}</small>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'host.dashboard' %}active{% endif %}"
                               href="{{ url_for('host.dashboard') }}">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'host.list_cars' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('host.list_cars') }}">
                                <i class="fas fa-car"></i> My Cars
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('host.list_payments') }}">
                                <i class="fas fa-money-bill-wave"></i> Payments
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('host.ratings') }}">
                                <i class="fas fa-star"></i> Ratings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('host.feedbacks') }}">
                                <i class="fas fa-comment"></i> Feedbacks
                            </a>
                        </li>
                        <!-- Commented out Wallet link as the route doesn't exist yet -->
                        <li class="nav-item">
                            <a class="nav-link disabled" href="#" title="Feature Coming Soon">
                                <i class="fas fa-wallet"></i> Wallet
                            </a>
                        </li>
                    </ul>

                    <hr class="my-3">

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('car.home') }}">
                                <i class="fas fa-home"></i> Back to Site
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.logout') }}">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">{% block page_title %}Dashboard{% endblock %}</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        {% block header_buttons %}{% endblock %}
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            {% set msg_type = 'info' %}
                            {% if 'success' in message.lower() %}{% set msg_type = 'success' %}
                            {% elif 'danger' in message.lower() or 'error' in message.lower() or 'failed' in message.lower() %}{% set msg_type = 'danger' %}
                            {% elif 'warning' in message.lower() %}{% set msg_type = 'warning' %}{% endif %}
                            <div class="alert alert-{{ msg_type }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Page Content -->
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- This is the new, empty scripts block that child templates can extend -->
    {% block scripts %}{% endblock %}

</body>
</html>

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\dashboard.html ---
{% extends "host/base.html" %}

{% block title %}Host Dashboard{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="row">
    <!-- Stats Cards -->
    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-car"></i> Total Cars</h5>
                <h2>{{ total_cars }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-calendar-check"></i> Active Bookings</h5>
                <h2>{{ active_bookings }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-rupee-sign"></i> Total Earnings</h5>
                <h2>₹{{ "%.2f"|format(total_earnings) }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-star"></i> Average Rating</h5>
                <h2>
                    {% if host.ratings %}
                        {{ "%.1f"|format(host.ratings|sum(attribute='rating') / host.ratings|length) }}
                    {% else %}
                        0.0
                    {% endif %}
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- Recent Bookings -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Bookings</h5>
            </div>
            <div class="card-body">
                {% if recent_bookings %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Car</th>
                                    <th>User</th>
                                    <th>Dates</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in recent_bookings %}
                                <tr>
                                    <td>#{{ booking.id }}</td>
                                    <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                                    <td>{{ booking.user.username }}</td>
                                    <td>{{ booking.start_date.strftime('%Y-%m-%d') }} to {{ booking.end_date.strftime('%Y-%m-%d') }}</td>
                                    <td>₹{{ "%.2f"|format(booking.total_price) }}</td>
                                    <td>
                                        <span class="badge bg-{% if booking.status == 'confirmed' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                            {{ booking.status|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No bookings yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('host.add_car') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Car
                    </a>
                    <a href="{{ url_for('host.list_cars') }}" class="btn btn-outline-primary">
                        <i class="fas fa-car"></i> Manage Cars
                    </a>
                    <a href="{{ url_for('host.list_payments') }}" class="btn btn-outline-success">
                        <i class="fas fa-money-bill-wave"></i> View Payments
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Performance</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Your hosting performance metrics will appear here.</p>
                <div class="progress">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 85%">85%</div>
                </div>
                <small class="text-muted">Profile completion</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\login.html ---
<!-- templates/host/login.html -->
{% extends "base.html" %} <!-- Or your main base template -->

{% block title %}Host Login{% endblock %}
{% block page_title %}Host Login{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card shadow">
            <div class="card-header text-center bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-user-tie"></i> Host Login</h4>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if 'success' in message %}success
                                                {% elif 'danger' in message or 'error' in message %}danger
                                                {% elif 'warning' in message %}warning
                                                {% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- CRITICAL FIX 6: Use WTForm in Template -->
                <form method="POST">
                    <!-- Render the CSRF token field provided by WTForms -->
                    {{ form.csrf_token }} <!-- This renders the hidden input -->

                    <div class="mb-3">
                        <label for="{{ form.email.id }}" class="form-label">{{ form.email.label.text }}</label>
                        {{ form.email(class="form-control", value=request.form.email or '') }}
                        {% if form.email.errors %}
                            <div class="text-danger">
                                {% for error in form.email.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.password.id }}" class="form-label">{{ form.password.label.text }}</label>
                        {{ form.password(class="form-control") }}
                        {% if form.password.errors %}
                            <div class="text-danger">
                                {% for error in form.password.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3 form-check">
                        {{ form.remember_me(class="form-check-input") }}
                        <label class="form-check-label" for="{{ form.remember_me.id }}">
                            {{ form.remember_me.label.text }}
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt"></i> {{ form.submit.label.text }}
                    </button>
                </form>
                <!-- END CRITICAL FIX 6 -->

                <hr>

                <div class="text-center">
                    <p>Not a host yet? <a href="{{ url_for('host.register') }}">Register as Host</a></p>
                    <p><a href="{{ url_for('car.home') }}">← Back to Main Site</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\register.html ---
<!-- templates/host/register.html -->
{% extends "base.html" %} <!-- Or your main base template -->

{% block title %}Host Registration{% endblock %}
{% block page_title %}Register as Host{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header text-center bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-user-tie"></i> Register as Host</h4>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if 'success' in message %}success{% elif 'danger' in message or 'error' in message %}danger{% elif 'warning' in message %}warning{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- CRITICAL FIX 5: Use WTForm in Template -->
                <form method="POST">
                    <!-- Render the CSRF token field provided by WTForms -->
                    {{ form.csrf_token }} <!-- This renders the hidden input -->

                    <!-- Email -->
                    <div class="mb-3">
                        <label for="{{ form.email.id }}" class="form-label">{{ form.email.label.text }} *</label>
                        {{ form.email(class="form-control", value=prefill_email) }}
                        {% if form.email.errors %}
                            <div class="text-danger">
                                {% for error in form.email.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Password -->
                    <div class="mb-3">
                        <label for="{{ form.password.id }}" class="form-label">{{ form.password.label.text }} *</label>
                        {{ form.password(class="form-control") }}
                        {% if form.password.errors %}
                            <div class="text-danger">
                                {% for error in form.password.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-3">
                        <label for="{{ form.confirm_password.id }}" class="form-label">{{ form.confirm_password.label.text }} *</label>
                        {{ form.confirm_password(class="form-control") }}
                        {% if form.confirm_password.errors %}
                            <div class="text-danger">
                                {% for error in form.confirm_password.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Company Name -->
                    <div class="mb-3">
                        <label for="{{ form.company_name.id }}" class="form-label">{{ form.company_name.label.text }} *</label>
                        {{ form.company_name(class="form-control") }}
                        <div class="form-text">This will be shown to customers.</div>
                        {% if form.company_name.errors %}
                            <div class="text-danger">
                                {% for error in form.company_name.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Phone -->
                    <div class="mb-3">
                        <label for="{{ form.phone.id }}" class="form-label">{{ form.phone.label.text }} *</label>
                        {{ form.phone(class="form-control") }}
                        {% if form.phone.errors %}
                            <div class="text-danger">
                                {% for error in form.phone.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Address -->
                    <div class="mb-3">
                        <label for="{{ form.address.id }}" class="form-label">{{ form.address.label.text }}</label>
                        {{ form.address(class="form-control", rows="3") }}
                        {% if form.address.errors %}
                            <div class="text-danger">
                                {% for error in form.address.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Hidden Location Fields (Populated by previous step or JS) -->
                    {{ form.latitude() }}
                    {{ form.longitude() }}
                    {{ form.full_address() }}
                    {{ form.street_address() }}
                    {{ form.locality() }}
                    {{ form.city() }}
                    {{ form.state() }}
                    {{ form.pincode() }}

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        {{ form.submit(class="btn btn-success w-100") }}
                    </div>
                </form>
                <!-- END CRITICAL FIX 5 -->

                <hr>

                <div class="text-center">
                    <p>Already registered as a host? <a href="{{ url_for('host.login') }}">Login here</a></p>
                    {% if not current_user.is_authenticated %}
                        <p>Are you a customer? <a href="{{ url_for('auth.register') }}">Register as Customer</a> | <a href="{{ url_for('auth.login') }}">Login as Customer</a></p>
                    {% endif %}
                    <p><a href="{{ url_for('car.home') }}">← Back to Main Site</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Optional: Add any specific JavaScript for this page if needed -->
<!-- For example, to handle location detection/population from a previous step -->
<script>
// Example: If location data was passed from a previous step (e.g., via query params or session)
// You would retrieve it here and populate the hidden fields
// This is just a placeholder/example
/*
document.addEventListener('DOMContentLoaded', function() {
    // Get location data from query params or session storage
    const urlParams = new URLSearchParams(window.location.search);
    const lat = urlParams.get('lat');
    const lng = urlParams.get('lng');
    // ... other location params ...

    if (lat && lng) {
        document.getElementById('{{ form.latitude.id }}').value = lat;
        document.getElementById('{{ form.longitude.id }}').value = lng;
        // ... populate other fields ...
    }
});
*/
</script>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\analytics\feedbacks.html ---
<!-- templates/host/analytics/feedbacks.html -->
{% extends "host/base.html" %}

{% block title %}Feedback Management{% endblock %}
{% block page_title %}Feedback Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-comment-dots"></i> Customer Feedback</h5>
            <span class="badge bg-{% if unresolved_count > 0 %}warning{% else %}success{% endif %}">
                {{ unresolved_count }} Unresolved
            </span>
        </div>
    </div>
    <div class="card-body">
        {% if feedbacks %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>From</th>
                            <th>Subject</th>
                            <th>Message</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for feedback in feedbacks %}
                        <tr class="{% if not feedback.is_resolved %}table-warning{% endif %}">
                            <td>{{ feedback.user.username }}</td>
                            <td>{{ feedback.subject or 'No Subject' }}</td>
                            <td>
                                {% if feedback.message|length > 50 %}
                                    {{ feedback.message[:50] }}...
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#feedback-{{ feedback.id }}">
                                        View
                                    </button>
                                    <div class="collapse mt-2" id="feedback-{{ feedback.id }}">
                                        {{ feedback.message }}
                                    </div>
                                {% else %}
                                    {{ feedback.message }}
                                {% endif %}
                            </td>
                            <td>{{ feedback.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if feedback.is_resolved %}
                                    <span class="badge bg-success">Resolved</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not feedback.is_resolved %}
                                    <form method="POST" action="{{ url_for('host.resolve_feedback', feedback_id=feedback.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Mark this feedback as resolved?')">
                                            <i class="fas fa-check"></i> Resolve
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

             <!-- Simple Pagination for Feedbacks -->
             {% if feedbacks_pagination.pages > 1 %}
             <nav aria-label="Feedbacks pagination">
                 <ul class="pagination justify-content-center">
                     {% if feedbacks_pagination.has_prev %}
                         <li class="page-item">
                             <a class="page-link" href="{{ url_for('host.feedbacks', page=feedbacks_pagination.prev_num) }}">Previous</a>
                         </li>
                     {% else %}
                         <li class="page-item disabled">
                             <span class="page-link">Previous</span>
                         </li>
                     {% endif %}

                     {% for page_num in feedbacks_pagination.iter_pages() %}
                         {% if page_num %}
                             {% if page_num != feedbacks_pagination.page %}
                                 <li class="page-item">
                                     <a class="page-link" href="{{ url_for('host.feedbacks', page=page_num) }}">{{ page_num }}</a>
                                 </li>
                             {% else %}
                                 <li class="page-item active">
                                     <span class="page-link">{{ page_num }}</span>
                                 </li>
                             {% endif %}
                         {% else %}
                             <li class="page-item disabled">
                                 <span class="page-link">&hellip;</span>
                             </li>
                         {% endif %}
                     {% endfor %}

                     {% if feedbacks_pagination.has_next %}
                         <li class="page-item">
                             <a class="page-link" href="{{ url_for('host.feedbacks', page=feedbacks_pagination.next_num) }}">Next</a>
                         </li>
                     {% else %}
                         <li class="page-item disabled">
                             <span class="page-link">Next</span>
                         </li>
                     {% endif %}
                 </ul>
             </nav>
             {% endif %}


        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                <h5>No feedback received yet</h5>
                <p class="text-muted">Customer feedback will appear here.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\analytics\ratings.html ---
<!-- templates/host/analytics/ratings.html -->
{% extends "host/base.html" %}

{% block title %}Ratings & Reviews{% endblock %}
{% block page_title %}Ratings & Reviews{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-4">
        <div class="card text-center">
            <div class="card-body">
                <h1 class="display-4 text-primary">{{ "%.1f"|format(average_rating) }}</h1>
                <p class="card-text">Average Rating</p>
                <div class="mb-2">
                    {% for i in range(1, 6) %}
                        {% if i <= average_rating|round(0, 'floor')|int %}
                            <i class="fas fa-star text-warning"></i>
                        {% elif i - 0.5 <= average_rating %}
                            <i class="fas fa-star-half-alt text-warning"></i>
                        {% else %}
                            <i class="far fa-star text-warning"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <small class="text-muted">Based on {{ total_ratings }} reviews</small>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Rating Distribution</h5>
            </div>
            <div class="card-body">
                {% for star in range(5, 0, -1) %}
                <div class="d-flex align-items-center mb-2">
                    <span class="me-2">{{ star }} <i class="fas fa-star text-warning"></i></span>
                    <div class="flex-grow-1">
                        <div class="progress" style="height: 10px;">
                            {% set count = rating_distribution.get(star, 0) %}
                            {% set percentage = (count / total_ratings * 100) if total_ratings > 0 else 0 %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ percentage }}%"></div>
                        </div>
                    </div>
                    <span class="ms-2 small">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-comments"></i> Recent Reviews</h5>
            </div>
            <div class="card-body">
                {% if ratings %}
                    <div class="list-group">
                        {% for rating in ratings %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ rating.user.username }}</h6>
                                <small class="text-muted">{{ rating.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                            <div class="mb-2">
                                {% for i in range(1, 6) %}
                                    {% if i <= rating.rating %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if rating.comment %}
                                <p class="mb-1">{{ rating.comment }}</p>
                            {% endif %}
                            <small class="text-muted">
                                For: {{ rating.host.company_name or rating.host.user.username }}'s
                                {% if rating.booking %}{{ rating.booking.car.make }} {{ rating.booking.car.model }}{% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Simple Pagination for Ratings -->
                    {% if ratings_pagination.pages > 1 %}
                    <nav aria-label="Ratings pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            {% if ratings_pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('host.ratings', page=ratings_pagination.prev_num) }}">Previous</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Previous</span>
                                </li>
                            {% endif %}

                            {% for page_num in ratings_pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != ratings_pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('host.ratings', page=page_num) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">&hellip;</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if ratings_pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('host.ratings', page=ratings_pagination.next_num) }}">Next</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Next</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                {% else %}
                    <p class="text-muted text-center">No ratings received yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\bookings\detail.html ---
<!-- templates/host/bookings/detail.html -->
{% extends "host/base.html" %}

{% block title %}Booking #{{ booking.id }} Details{% endblock %}
{% block page_title %}Booking Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-receipt"></i> Booking #{{ booking.id }}</h5>
            </div>
            <div class="card-body">
                <!-- Booking Status -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Status</h6>
                        <span class="badge bg-{% if booking.status == 'completed' %}success
                                            {% elif booking.status == 'active' %}info
                                            {% elif booking.status == 'paid' %}primary
                                            {% elif booking.status == 'approved' %}secondary
                                            {% elif booking.status == 'pending' %}warning
                                            {% elif booking.status == 'cancelled' %}danger
                                            {% else %}light{% endif %}">
                            {{ booking.status|title }}
                        </span>
                    </div>
                    {% if booking.cancelled_by %}
                    <div class="mt-2">
                        <small class="text-muted">
                            Cancelled by: <strong>{{ booking.cancelled_by|title }}</strong>
                            {% if booking.cancelled_at %}on {{ booking.cancelled_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
                        </small>
                        {% if booking.cancellation_reason %}
                        <br><small class="text-muted">Reason: {{ booking.cancellation_reason }}</small>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Car & User Details -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Car Details</h6>
                        <p><strong>{{ booking.car.make }} {{ booking.car.model }}</strong> ({{ booking.car.year }})</p>
                        <p>{{ booking.car.transmission }} • {{ booking.car.fuel_type }} • {{ booking.car.seats }} seats</p>
                        <p>Color: {{ booking.car.color or 'N/A' }}</p>
                        <p>Mileage: {{ booking.car.mileage or 'N/A' }} km</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Customer Details</h6>
                        <p><strong>{{ booking.user.username }}</strong></p>
                        <p>Email: {{ booking.user.email }}</p>
                        <p>Phone: {{ booking.user.phone or 'N/A' }}</p>
                    </div>
                </div>

                <!-- Rental Period -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Rental Period</h6>
                        <p><i class="fas fa-calendar-start"></i> Start: {{ booking.start_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><i class="fas fa-calendar-end"></i> End: {{ booking.end_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><i class="fas fa-clock"></i> Duration: {{ booking.duration_days }} days</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Location</h6>
                        <p><i class="fas fa-map-marker-alt"></i>
                            {% if booking.car.full_address %}
                                {{ booking.car.full_address }}
                            {% else %}
                                {% if booking.car.street_address %}{{ booking.car.street_address }}, {% endif %}
                                {% if booking.car.locality %}{{ booking.car.locality }}, {% endif %}
                                {% if booking.car.city %}{{ booking.car.city }}{% endif %}
                                {% if booking.car.state %}, {{ booking.car.state }}{% endif %}
                                {% if booking.car.pincode %} - {{ booking.car.pincode }}{% endif %}
                            {% endif %}
                        </p>
                        {% if booking.car.latitude and booking.car.longitude %}
                        <div class="mt-2 text-xs text-gray-500">
                            Coordinates: {{ "%.6f"|format(booking.car.latitude) }}, {{ "%.6f"|format(booking.car.longitude) }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Financial Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Financial Summary</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td><strong>Total Amount:</strong></td>
                                        <td class="text-end">₹{{ "%.2f"|format(booking.total_price) }}</td>
                                    </tr>
                                    {% if booking.cancellation_fee_deducted > 0 %}
                                    <tr>
                                        <td><strong>Cancellation Fee (50%):</strong></td>
                                        <td class="text-end text-danger">-₹{{ "%.2f"|format(booking.cancellation_fee_deducted) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.refund_amount > 0 %}
                                    <tr>
                                        <td><strong>Refund Amount:</strong></td>
                                        <td class="text-end text-success">₹{{ "%.2f"|format(booking.refund_amount) }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr class="table-light">
                                        <td><strong>Net Amount:</strong></td>
                                        <td class="text-end">
                                            <strong>
                                                ₹{{ "%.2f"|format(booking.total_price - booking.cancellation_fee_deducted + booking.refund_amount) }}
                                            </strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Transaction Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Transaction Details</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>Payment Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.payment_status == 'completed' %}success
                                                                {% elif booking.payment_status == 'pending' %}warning
                                                                {% elif booking.payment_status == 'failed' %}danger
                                                                {% elif booking.payment_status == 'refunded' %}secondary
                                                                {% else %}light{% endif %}">
                                                {{ booking.payment_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% if booking.payment_date %}
                                    <tr>
                                        <td>Payment Date:</td>
                                        <td class="text-end">{{ booking.payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.razorpay_payment_id %}
                                    <tr>
                                        <td>Razorpay Payment ID:</td>
                                        <td class="text-end">{{ booking.razorpay_payment_id }}</td>
                                    </tr>
                                    {% endif %}
                                    <!-- Add more transaction details as needed -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Extension Details (if applicable) -->
                {% if booking.has_extension_request %}
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Extension Request</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>New End Date:</td>
                                        <td class="text-end">{{ booking.extension_new_end_date.strftime('%Y-%m-%d') }}</td>
                                    </tr>
                                    <tr>
                                        <td>Additional Days:</td>
                                        <td class="text-end">{{ booking.extension_additional_days }}</td>
                                    </tr>
                                    <tr>
                                        <td>Additional Price:</td>
                                        <td class="text-end">₹{{ "%.2f"|format(booking.extension_additional_price) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Extension Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.extension_status == 'approved' %}success
                                                                {% elif booking.extension_status == 'requested' %}warning
                                                                {% elif booking.extension_status == 'cancelled' %}danger
                                                                {% else %}light{% endif %}">
                                                {{ booking.extension_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Extension Payment Status:</td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if booking.extension_payment_status == 'completed' %}success
                                                                {% elif booking.extension_payment_status == 'pending' %}warning
                                                                {% elif booking.extension_payment_status == 'failed' %}danger
                                                                {% elif booking.extension_payment_status == 'refunded' %}secondary
                                                                {% else %}light{% endif %}">
                                                {{ booking.extension_payment_status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% if booking.extension_payment_date %}
                                    <tr>
                                        <td>Extension Payment Date:</td>
                                        <td class="text-end">{{ booking.extension_payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if booking.extension_razorpay_payment_id %}
                                    <tr>
                                        <td>Extension Razorpay Payment ID:</td>
                                        <td class="text-end">{{ booking.extension_razorpay_payment_id }}</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Extension Actions -->
                        {% if booking.extension_status == 'requested' %}
                        <div class="mt-2">
                            <form method="POST" action="{{ url_for('host.approve_extension', booking_id=booking.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Approve this extension request?')">
                                    <i class="fas fa-check"></i> Approve Extension
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('host.reject_extension', booking_id=booking.id) }}" class="d-inline ms-2">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Reject this extension request?')">
                                    <i class="fas fa-times"></i> Reject Extension
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <!-- End Extension Details -->

            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Host Actions</h5>
            </div>
            <div class="card-body">
                {% if booking.can_be_approved() %}
                <form method="POST" action="{{ url_for('host.approve_booking', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-success w-100" onclick="return confirm('Approve this booking request?')">
                        <i class="fas fa-check-circle"></i> Approve Booking
                    </button>
                </form>
                {% elif booking.status == 'approved' and booking.payment_status == 'pending' %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Waiting for customer to complete payment.
                </div>
                {% elif booking.payment_status == 'completed' and not booking.is_active %}
                <form method="POST" action="{{ url_for('host.mark_booking_paid', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-hand-holding-usd"></i> Mark as Paid (Confirm Receipt)
                    </button>
                </form>
                {% elif booking.is_active and not booking.is_completed %}
                <form method="POST" action="{{ url_for('host.complete_booking_trip', booking_id=booking.id) }}" class="d-grid gap-2 mb-2">
                    <button type="submit" class="btn btn-info w-100" onclick="return confirm('Mark this trip as completed?')">
                        <i class="fas fa-flag-checkered"></i> Complete Trip
                    </button>
                </form>
                {% elif booking.is_completed %}
                <button class="btn btn-secondary w-100" disabled>
                    <i class="fas fa-check-double"></i> Trip Completed
                </button>
                {% elif booking.status == 'cancelled' %}
                <button class="btn btn-danger w-100" disabled>
                    <i class="fas fa-ban"></i> Booking Cancelled
                </button>
                {% else %}
                <div class="alert alert-secondary">
                    <i class="fas fa-info-circle"></i> No actions available at this time.
                </div>
                {% endif %}

                {% if booking.status not in ['completed', 'cancelled'] %}
                <hr class="my-3">
                <form method="POST" action="{{ url_for('host.cancel_booking', booking_id=booking.id) }}" class="d-grid gap-2">
                    <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Cancel this booking? This action cannot be undone.')">
                        <i class="fas fa-times-circle"></i> Cancel Booking
                    </button>
                </form>
                {% endif %}

                <hr class="my-3">
                <a href="{{ url_for('host.list_bookings') }}" class="btn btn-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Back to Bookings
                </a>
            </div>
        </div>

        <!-- Car Images -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images"></i> Car Images</h5>
            </div>
            <div class="card-body">
                {% if booking.car.images %}
                    <div id="carImageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for image in booking.car.images %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                     class="d-block w-100" alt="{{ booking.car.make }} {{ booking.car.model }} Image {{ loop.index }}"
                                     style="height: 200px; object-fit: cover;">
                            </div>
                            {% endfor %}
                        </div>
                        {% if booking.car.images|length > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-image fa-3x"></i>
                        <p>No images available for this car.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Optional: Add any specific JavaScript for this page if needed -->
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\cars\add.html ---
<!-- templates/host/cars/add.html -->
{% extends "host/base.html" %}

{% block title %}Add Car{% endblock %}
{% block page_title %}Add New Car{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="addCarForm">
                    <!-- Add the CSRF token field provided by Flask-WTF -->
                    {{ form.csrf_token }} <!-- This renders the hidden input -->
                    <!-- END CRITICAL FIX -->
                    <!-- Car Details Section -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make" class="form-label">Make *</label>
                            <input type="text" class="form-control" id="make" name="make" value="{{ request.form.get('make', '') }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">Model *</label>
                            <input type="text" class="form-control" id="model" name="model" value="{{ request.form.get('model', '') }}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="year" class="form-label">Year *</label>
                            <input type="number" class="form-control" id="year" name="year" min="1900" max="2030" value="{{ request.form.get('year', '') }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="price_per_hour" class="form-label">Price per hour (₹) *</label>
                            <input type="number" class="form-control" id="price_per_hour" name="price_per_hour" step="0.01" min="0" value="{{ request.form.get('price_per_hour', '') }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color" name="color" value="{{ request.form.get('color', '') }}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="mileage" class="form-label">Mileage (km)</label>
                            <input type="number" class="form-control" id="mileage" name="mileage" min="0" value="{{ request.form.get('mileage', '') }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fuel_type" class="form-label">Fuel Type *</label>
                            <select class="form-select" id="fuel_type" name="fuel_type" required>
                                <option value="">Select Fuel Type</option>
                                <option value="Petrol" {% if request.form.get('fuel_type') == 'Petrol' %}selected{% endif %}>Petrol</option>
                                <option value="Diesel" {% if request.form.get('fuel_type') == 'Diesel' %}selected{% endif %}>Diesel</option>
                                <option value="Electric" {% if request.form.get('fuel_type') == 'Electric' %}selected{% endif %}>Electric</option>
                                <option value="CNG" {% if request.form.get('fuel_type') == 'CNG' %}selected{% endif %}>CNG</option>
                                <option value="Hybrid" {% if request.form.get('fuel_type') == 'Hybrid' %}selected{% endif %}>Hybrid</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="transmission" class="form-label">Transmission *</label>
                            <select class="form-select" id="transmission" name="transmission" required>
                                <option value="">Select Transmission</option>
                                <option value="Manual" {% if request.form.get('transmission') == 'Manual' %}selected{% endif %}>Manual</option>
                                <option value="Automatic" {% if request.form.get('transmission') == 'Automatic' %}selected{% endif %}>Automatic</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="seats" class="form-label">Seats *</label>
                            <input type="number" class="form-control" id="seats" name="seats" min="1" max="20" value="{{ request.form.get('seats', '') }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="is_available" class="form-label">Availability</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="is_available" name="is_available" {% if request.form.get('is_available', 'on') == 'on' %}checked{% endif %}>
                                <label class="form-check-label" for="is_available">
                                    Available for booking
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3"></div> <!-- Spacer -->
                    </div>
                    <!-- End Car Details Section -->

                    <!-- NEW LOCATION DETAILS SECTION -->
                    {% include 'host/cars/partials/location_input_section.html' %}
                    <!-- END NEW LOCATION DETAILS SECTION -->

                    <div class="mb-3">
                        <label for="images" class="form-label">Car Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">You can select multiple images. First image will be primary.</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('host.list_cars') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Add Car</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Tips</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Add clear photos from multiple angles</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Set competitive pricing</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Provide accurate specifications</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Enter a precise location for better discoverability</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include the shared location input JavaScript -->
{% include 'host/cars/partials/location_input_js.html' %}
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\cars\detail.html ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\cars\edit.html ---
<!-- templates/host/cars/edit.html -->
{% extends "host/base.html" %}

{% block title %}Edit Car{% endblock %}
{% block page_title %}Edit Car: {{ car.make }} {{ car.model }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="editCarForm">
                    <!-- Car Details Section -->
                     <!-- Add the CSRF token field provided by Flask-WTF -->
                    {{ form.csrf_token }} <!-- This renders the hidden input -->
                    <!-- END CRITICAL FIX -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make" class="form-label">Make *</label>
                            <input type="text" class="form-control" id="make" name="make" value="{{ car.make }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">Model *</label>
                            <input type="text" class="form-control" id="model" name="model" value="{{ car.model }}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="year" class="form-label">Year *</label>
                            <input type="number" class="form-control" id="year" name="year" min="1900" max="2030" value="{{ car.year }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="price_per_day" class="form-label">Price per Day (₹) *</label>
                            <input type="number" class="form-control" id="price_per_day" name="price_per_day" step="0.01" min="0" value="{{ "%.2f"|format(car.price_per_day) }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color" name="color" value="{{ car.color or '' }}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="mileage" class="form-label">Mileage (km)</label>
                            <input type="number" class="form-control" id="mileage" name="mileage" min="0" value="{{ car.mileage or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fuel_type" class="form-label">Fuel Type *</label>
                            <select class="form-select" id="fuel_type" name="fuel_type" required>
                                <option value="">Select Fuel Type</option>
                                <option value="Petrol" {% if car.fuel_type == 'Petrol' %}selected{% endif %}>Petrol</option>
                                <option value="Diesel" {% if car.fuel_type == 'Diesel' %}selected{% endif %}>Diesel</option>
                                <option value="Electric" {% if car.fuel_type == 'Electric' %}selected{% endif %}>Electric</option>
                                <option value="CNG" {% if car.fuel_type == 'CNG' %}selected{% endif %}>CNG</option>
                                <option value="Hybrid" {% if car.fuel_type == 'Hybrid' %}selected{% endif %}>Hybrid</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="transmission" class="form-label">Transmission *</label>
                            <select class="form-select" id="transmission" name="transmission" required>
                                <option value="">Select Transmission</option>
                                <option value="Manual" {% if car.transmission == 'Manual' %}selected{% endif %}>Manual</option>
                                <option value="Automatic" {% if car.transmission == 'Automatic' %}selected{% endif %}>Automatic</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="seats" class="form-label">Seats *</label>
                            <input type="number" class="form-control" id="seats" name="seats" min="1" max="20" value="{{ car.seats }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                             <!-- Placeholder for future use or alignment -->
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="is_available" class="form-label">Availability</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="is_available" name="is_available" {% if car.is_available %}checked{% endif %}>
                                <label class="form-check-label" for="is_available">
                                    Available for booking
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- End Car Details Section -->

                    <!-- UPDATED LOCATION DETAILS SECTION -->
                    {% include 'host/cars/partials/location_input_section.html' %}
                    <!-- END UPDATED LOCATION DETAILS SECTION -->

                    <div class="mb-3">
                        <label for="images" class="form-label">Add More Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">Select new images to add. To remove existing images, use the 'Manage Images' section below.</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('host.list_cars') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Update Car</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images"></i> Manage Existing Images</h5>
            </div>
            <div class="card-body">
                {% if car.images %}
                    <div class="row g-2">
                        {% for image in car.images %}
                        <div class="col-6 col-md-4 position-relative">
                            <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                 class="img-fluid rounded" alt="Car Image">
                            <a href="{{ url_for('host.delete_car_image', image_id=image.id) }}"
                               class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                               onclick="return confirm('Delete this image?')">
                                <i class="fas fa-times"></i>
                            </a>
                            {% if image.is_primary %}
                            <span class="badge bg-success position-absolute bottom-0 start-0 m-1">Primary</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No images uploaded yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Tips</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Keep car details accurate</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Update availability status</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Add new photos if needed</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Review pricing regularly</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Ensure location is up-to-date</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Pre-populate location fields on page load for edit form
document.addEventListener('DOMContentLoaded', function() {
    // --- Pre-populate Location Fields for Editing ---
    // Get existing car location data (passed from the backend route)
    // This assumes your route passes the car object correctly
    const carData = {
        latitude: {{ car.latitude|tojson }},
        longitude: {{ car.longitude|tojson }},
        full_address: {{ car.full_address|tojson }},
        street_address: {{ car.street_address|tojson }},
        locality: {{ car.locality|tojson }},
        city: {{ car.city|tojson }},
        state: {{ car.state|tojson }},
        pincode: {{ car.pincode|tojson }}
    };

    if (carData.latitude && carData.longitude) {
        document.getElementById('latitude').value = carData.latitude;
        document.getElementById('longitude').value = carData.longitude;
        // Set hidden final coordinates
        document.getElementById('final_lat').value = carData.latitude;
        document.getElementById('final_lng').value = carData.longitude;

        // Populate address fields if data exists
        if (carData.full_address) {
            document.getElementById('full_address').value = carData.full_address;
        }
        if (carData.street_address) {
            document.getElementById('street_address').value = carData.street_address;
        }
        if (carData.locality) {
            document.getElementById('locality').value = carData.locality;
        }
        if (carData.city) {
            document.getElementById('city').value = carData.city;
        }
        if (carData.state) {
            document.getElementById('state').value = carData.state;
        }
        if (carData.pincode) {
            document.getElementById('pincode').value = carData.pincode;
        }

        // Indicate that location data is pre-loaded
        document.getElementById('locationStatus').innerHTML = '<span class="text-success"><i class="fas fa-check"></i> Location loaded from car data.</span>';
    }
    // --- End Pre-population ---
});
</script>
<!-- Include the shared location input JavaScript -->
{% include 'host/cars/partials/location_input_js.html' %}
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\cars\list.html ---
{% extends "host/base.html" %}

{% block title %}My Cars{% endblock %}
{% block page_title %}My Cars{% endblock %}

{% block header_buttons %}
<a href="{{ url_for('host.add_car') }}" class="btn btn-sm btn-primary">
    <i class="fas fa-plus"></i> Add Car
</a>
{% endblock %}

{% block content %}
<div class="row">
    {% if cars %}
        {% for car in cars %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card car-card h-100">
                {% if car.images %}
                    <img src="{{ url_for('static', filename='uploads/' + car.images[0].filename) }}"
                         class="card-img-top" alt="{{ car.make }} {{ car.model }}"
                         style="height: 200px; object-fit: cover;">
                {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                         style="height: 200px;">
                        <i class="fas fa-car fa-3x text-muted"></i>
                    </div>
                {% endif %}

                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <h5 class="card-title">{{ car.make }} {{ car.model }}</h5>
                        <span class="badge bg-{% if car.is_available %}success{% else %}secondary{% endif %}">
                            {% if car.is_available %}Available{% else %}Unavailable{% endif %}
                        </span>
                    </div>
                    <p class="card-text">
                        <small class="text-muted">{{ car.year }} • {{ car.fuel_type }} • {{ car.transmission }}</small>
                    </p>
                    <div class="mb-2">
                        <span class="h5 text-primary">₹{{ "%.2f"|format(car.price_per_hour) }}</span>
                        <small class="text-muted">/ day</small>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                        <a href="{{ url_for('host.edit_car', car_id=car.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="{{ url_for('host.delete_car', car_id=car.id) }}"
                           class="btn btn-outline-danger btn-sm"
                           onclick="return confirm('Are you sure you want to delete this car?')">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-car fa-4x text-muted mb-3"></i>
                <h4>No cars listed yet</h4>
                <p class="text-muted">Start by adding your first car to rent out.</p>
                <a href="{{ url_for('host.add_car') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Your First Car
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\cars\partials\location_input_js.html ---
<!-- templates/host/cars/partials/location_input_js.html -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- CRITICAL FIX 1: Correct Element Selection ---
    // Use the exact IDs defined in the HTML
    const addressInput = document.getElementById('addressInput');
    const suggestionsList = document.getElementById('suggestionsList');
    const useCurrentLocationBtn = document.getElementById('useCurrentLocationBtn'); // Updated ID
    const resetLocationBtn = document.getElementById('resetLocationBtn'); // Updated ID
    const locationValidationMessage = document.getElementById('locationValidationMessage');

    // Hidden coordinate fields
    const selectedLat = document.getElementById('selected_lat');
    const selectedLng = document.getElementById('selected_lng');

    // Structured address fields
    const streetAddressInput = document.getElementById('street_address');
    const localityInput = document.getElementById('locality');
    const cityInput = document.getElementById('city');
    const stateInput = document.getElementById('state');
    const pincodeInput = document.getElementById('pincode');
    const fullAddressInput = document.getElementById('full_address');
    // --- CRITICAL FIX 1 END ---

    let debounceTimer;

    // --- Address Suggestion Logic ---
    if (addressInput && suggestionsList) {
        addressInput.addEventListener('input', function() {
            const query = this.value.trim();
            suggestionsList.innerHTML = '';
            suggestionsList.style.display = 'none';

            if (query.length < 3) {
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                // --- CRITICAL FIX 2: Correct AJAX URL ---
                // Ensure this points to your actual suggestion endpoint
                fetch(`/suggest?q=${encodeURIComponent(query)}`)
                // --- CRITICAL FIX 2 END ---
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        suggestionsList.innerHTML = '';
                        if (data.error) {
                             suggestionsList.innerHTML = `<li class="list-group-item text-danger"><i class="fas fa-exclamation-triangle"></i> ${data.error}</li>`;
                             suggestionsList.style.display = 'block';
                             return;
                        }
                        if (data.length === 0) {
                            suggestionsList.innerHTML = '<li class="list-group-item text-muted">No suggestions found.</li>';
                            suggestionsList.style.display = 'block';
                            return;
                        }
                        data.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item list-group-item-action';
                            li.textContent = item.display_name;

                            // --- CRITICAL FIX 3: Store Nominatim data correctly ---
                            // Use dataset attributes to store all relevant Nominatim data
                            li.dataset.lat = item.lat;
                            li.dataset.lon = item.lon;
                            // Map Nominatim keys to potential fields
                            li.dataset.road = item.road || item.pedestrian || '';
                            li.dataset.houseNumber = item.house_number || '';
                            li.dataset.postcode = item.postcode || '';
                            li.dataset.city = item.city || item.town || item.village || '';
                            li.dataset.state = item.state || '';
                            li.dataset.locality = item.locality || item.suburb || item.neighbourhood || item.hamlet || '';
                            // --- CRITICAL FIX 3 END ---

                            li.addEventListener('click', function() {
                                // --- CRITICAL FIX 4: Correctly fill fields on selection ---
                                selectSuggestedAddress(this);
                                // --- CRITICAL FIX 4 END ---
                            });
                            suggestionsList.appendChild(li);
                        });
                        suggestionsList.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Suggestion error:', error);
                        suggestionsList.innerHTML = '<li class="list-group-item text-danger"><i class="fas fa-exclamation-triangle"></i> Failed to fetch suggestions.</li>';
                        suggestionsList.style.display = 'block';
                    });
            }, 300); // Debounce for 300ms
        });

        // Close suggestions if clicked outside
        document.addEventListener('click', function(e) {
            if (!addressInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.style.display = 'none';
            }
        });
    }

    // --- Function to Fill Fields from Suggestion ---
    function selectSuggestedAddress(listItem) {
        // --- CRITICAL FIX 5: Get data from dataset correctly ---
        const displayName = listItem.textContent;
        const lat = listItem.dataset.lat;
        const lon = listItem.dataset.lon;
        const road = listItem.dataset.road;
        const houseNumber = listItem.dataset.houseNumber;
        const postcode = listItem.dataset.postcode;
        const city = listItem.dataset.city;
        const state = listItem.dataset.state;
        const locality = listItem.dataset.locality;
        // --- CRITICAL FIX 5 END ---

        // --- CRITICAL FIX 6: Fill ALL relevant fields ---
        // Fill hidden coordinate fields
        if (selectedLat) selectedLat.value = lat;
        if (selectedLng) selectedLng.value = lon;

        // Fill structured address fields
        if (streetAddressInput) streetAddressInput.value = `${houseNumber} ${road}`.trim();
        if (localityInput) localityInput.value = locality;
        if (cityInput) cityInput.value = city;
        if (stateInput) stateInput.value = state;
        if (pincodeInput) pincodeInput.value = postcode;

        // Construct and fill full address
        const parts = [
            houseNumber, road, locality, city, state, postcode
        ].filter(part => part); // Remove empty/undefined parts
        const fullAddr = parts.join(', ');
        if (fullAddressInput) fullAddressInput.value = fullAddr;

        // Update main input field to show selected address
        if (addressInput) addressInput.value = displayName;

        // Hide suggestions list
        if (suggestionsList) suggestionsList.style.display = 'none';

        // Hide validation message on successful selection
        if (locationValidationMessage) locationValidationMessage.style.display = 'none';
        // --- CRITICAL FIX 6 END ---
    }
    // --- End Function ---

    // --- Use Current Location Logic ---
    if (useCurrentLocationBtn) {
        useCurrentLocationBtn.addEventListener('click', function() {
            const $btn = $(this); // Using jQuery for consistency if available
            // Disable button and show loading state
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Detecting...');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    function(position) {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);

                        // --- CRITICAL FIX 7: Fill hidden coordinate fields ---
                        if (selectedLat) selectedLat.value = lat;
                        if (selectedLng) selectedLng.value = lng;
                        // --- CRITICAL FIX 7 END ---

                        // --- CRITICAL FIX 8: Provide feedback for detected location ---
                        // Since we only have coordinates, we can't auto-fill structured fields
                        // You could use Reverse Geocoding here (see note below)
                        const detectedMsg = `Detected coordinates: Lat ${lat}, Lng ${lng}. Please verify or enter address manually.`;
                        if (addressInput) addressInput.value = detectedMsg; // Show in main input
                        if (fullAddressInput) fullAddressInput.value = detectedMsg; // Show in full address
                        // Clear structured fields as they are unknown from coordinates alone
                        if (streetAddressInput) streetAddressInput.value = '';
                        if (localityInput) localityInput.value = '';
                        if (cityInput) cityInput.value = '';
                        if (stateInput) stateInput.value = '';
                        if (pincodeInput) pincodeInput.value = '';
                        // --- CRITICAL FIX 8 END ---

                        // Hide validation message
                        if (locationValidationMessage) locationValidationMessage.style.display = 'none';

                        // Re-enable button
                        $btn.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Use My Location');
                    },
                    // Error callback
                    function(error) {
                        let errorMsg = 'Unable to retrieve your location.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMsg = 'Location access denied by user.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg = 'Location information is unavailable.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMsg = 'The request to get user location timed out.';
                        }
                        // Show error in main input or a dedicated status area
                        if (addressInput) addressInput.value = `Error: ${errorMsg}`;
                        console.error("Geolocation error:", error);

                        // Show validation message for error
                        if (locationValidationMessage) {
                            locationValidationMessage.textContent = errorMsg;
                            locationValidationMessage.style.display = 'block';
                        }

                        // Re-enable button
                        $btn.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Use My Location');
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    }
                );
            } else {
                // Show error if geolocation not supported
                if (addressInput) addressInput.value = 'Error: Geolocation is not supported by this browser.';
                console.error("Geolocation not supported");

                // Show validation message
                if (locationValidationMessage) {
                    locationValidationMessage.textContent = 'Geolocation is not supported by this browser.';
                    locationValidationMessage.style.display = 'block';
                }

                // Re-enable button
                $btn.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Use My Location');
            }
        });
    }
    // --- End Use Current Location ---

    // --- Reset Location Logic ---
    if (resetLocationBtn) {
        resetLocationBtn.addEventListener('click', function() {
            // --- CRITICAL FIX 9: Clear ALL location-related input fields ---
            if (addressInput) addressInput.value = '';
            if (selectedLat) selectedLat.value = '';
            if (selectedLng) selectedLng.value = '';
            if (streetAddressInput) streetAddressInput.value = '';
            if (localityInput) localityInput.value = '';
            if (cityInput) cityInput.value = '';
            if (stateInput) stateInput.value = '';
            if (pincodeInput) pincodeInput.value = '';
            if (fullAddressInput) fullAddressInput.value = '';
            if (suggestionsList) {
                suggestionsList.innerHTML = '';
                suggestionsList.style.display = 'none';
            }
            if (locationValidationMessage) locationValidationMessage.style.display = 'none';
            // --- CRITICAL FIX 9 END ---
        });
    }
    // --- End Reset Location ---

    // --- Form Submission Validation (if needed directly in JS) ---
    // This is handled by the backend route now, but can be added for immediate feedback
    // const addCarForm = document.getElementById('addCarForm'); // Ensure this ID exists on your form
    // if (addCarForm) {
    //     addCarForm.addEventListener('submit', function(e) {
    //         const lat = selectedLat ? selectedLat.value.trim() : '';
    //         const lng = selectedLng ? selectedLng.value.trim() : '';
    //         const city = cityInput ? cityInput.value.trim() : '';
    //         const state = stateInput ? stateInput.value.trim() : '';
    //
    //         if (!lat || !lng || isNaN(parseFloat(lat)) || isNaN(parseFloat(lng)) || !city || !state) {
    //              e.preventDefault();
    //              if (locationValidationMessage) {
    //                  locationValidationMessage.textContent = 'Please select an address or use your current location.';
    //                  locationValidationMessage.style.display = 'block';
    //              }
    //              // Scroll to the location section for visibility
    //              document.querySelector('label[for="addressInput"]').scrollIntoView({ behavior: 'smooth' });
    //              return false;
    //         }
    //         // If validation passes, form submits normally
    //         if (locationValidationMessage) locationValidationMessage.style.display = 'none';
    //     });
    // }
    // --- End Form Submission Validation ---
});
</script>


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\cars\partials\location_input_section.html ---
<!-- templates/host/cars/partials/location_input_section.html -->
<!-- NEW STRUCTURED ADDRESS SECTION -->
<div class="row mb-3">
    <div class="col-12">
        <label class="form-label">Car Location Details *</label>

        <!-- Location Input with Suggestions -->
        <div class="mb-2">
            <label for="addressInput" class="form-label">Search Address (India) *</label>
            <!-- CRITICAL FIX 1: Ensure unique ID and correct structure -->
            <div class="input-group">
                <input type="text" class="form-control" id="addressInput" name="addressInput" placeholder="Start typing address (e.g., Koramangala, Bangalore)..." autocomplete="off">
                <button class="btn btn-outline-secondary" type="button" id="getCurrentLocationBtn">
                    <i class="fas fa-location-arrow"></i>
                </button>
            </div>
            <!-- CRITICAL FIX 1 END -->
            <!-- Suggestions List -->
            <!-- CRITICAL FIX 2: Ensure unique ID and correct positioning -->
            <ul id="suggestionsList" class="list-group position-absolute z-1000 w-100" style="display:none; max-height: 200px; overflow-y: auto; margin-top: 2px;"></ul>
            <!-- CRITICAL FIX 2 END -->
            <div class="form-text">Type to search for an address. Select one from the suggestions.</div>
        </div>

        <!-- Hidden fields for coordinates -->
        <!-- CRITICAL FIX 3: Use consistent, clear IDs -->
        <input type="hidden" id="selected_lat" name="latitude">
        <input type="hidden" id="selected_lng" name="longitude">
        <!-- CRITICAL FIX 3 END -->

        <!-- Structured Address Fields (Auto-filled) -->
        <div class="row">
            <div class="col-md-6 mb-2">
                <label for="street_address" class="form-label">Street Address</label>
                <input type="text" class="form-control" id="street_address" name="street_address">
            </div>
            <div class="col-md-6 mb-2">
                <label for="locality" class="form-label">Locality/Area</label>
                <input type="text" class="form-control" id="locality" name="locality">
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-2">
                <label for="city" class="form-label">City *</label>
                <input type="text" class="form-control" id="city" name="city" required> <!-- Make city required -->
            </div>
            <div class="col-md-4 mb-2">
                <label for="state" class="form-label">State *</label>
                <input type="text" class="form-control" id="state" name="state" required> <!-- Make state required -->
            </div>
            <div class="col-md-4 mb-2">
                <label for="pincode" class="form-label">Pincode</label>
                <input type="text" class="form-control" id="pincode" name="pincode">
            </div>
        </div>

        <!-- Full Address (Hidden or Read-only for confirmation) -->
        <div class="mb-2">
            <label for="full_address" class="form-label">Full Address (Auto-generated)</label>
            <textarea class="form-control" id="full_address" name="full_address" rows="2" readonly></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 mt-2">
            <!-- CRITICAL FIX 4: Ensure button IDs are unique and correct -->
            <button type="button" class="btn btn-outline-primary btn-sm" id="useCurrentLocationBtn">
                <i class="fas fa-map-marker-alt"></i> Use My Location
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="resetLocationBtn">
                <i class="fas fa-redo"></i> Reset
            </button>
            <!-- CRITICAL FIX 4 END -->
        </div>

        <!-- Validation Message -->
        <div id="locationValidationMessage" class="text-danger mt-2" style="display:none;">
            Please select an address from the suggestions or use 'Use My Location'.
        </div>
    </div>
</div>
<!-- END NEW STRUCTURED ADDRESS SECTION -->


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\payments\list.html ---
<!-- templates/host/payments/list.html -->
{% extends "host/base.html" %}

{% block title %}Payment History{% endblock %}
{% block page_title %}Payment History{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-receipt"></i> Booking & Earnings Records</h5>
            <div>
                <span class="badge bg-success fs-6">Wallet Balance: ₹{{ "%.2f"|format(host.wallet_balance) }}</span>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if bookings %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Car</th>
                            <th>Customer</th>
                            <th>Rental Period</th>
                            <th>Total Amount (₹)</th>
                            <!-- <th>Host Earnings (₹)</th> --> <!-- If you have a commission model -->
                            <th>Booking Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>#{{ booking.id }}</td>
                            <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                            <td>{{ booking.user.username }}</td>
                            <td>
                                {{ booking.start_date.strftime('%Y-%m-%d') }} <br>
                                to {{ booking.end_date.strftime('%Y-%m-%d') }}
                            </td>
                            <td>{{ "%.2f"|format(booking.total_price) }}</td>
                            <!-- <td>{{ "%.2f"|format(booking.total_price * 0.9) }}</td> --> <!-- Example: 90% to host -->
                            <td>{{ booking.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <span class="badge bg-{% if booking.status == 'completed' %}success{% elif booking.status == 'confirmed' %}primary{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                    {{ booking.status|title }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Simple Pagination -->
            {% if bookings_pagination.pages > 1 %}
            <nav aria-label="Bookings pagination">
                <ul class="pagination justify-content-center">
                    {% if bookings_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('host.list_payments', page=bookings_pagination.prev_num) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}

                    {% for page_num in bookings_pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != bookings_pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('host.list_payments', page=page_num) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if bookings_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('host.list_payments', page=bookings_pagination.next_num) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                <h5>No booking records found</h5>
                <p class="text-muted">Payment records will appear here once your cars are booked.</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Earnings Summary</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <h4 class="text-primary">₹{{ "%.2f"|format(total_earnings) }}</h4>
                        <small class="text-muted">Total Earnings (Completed)</small>
                    </div>
                    <div>
                        <h4 class="text-warning">₹{{ "%.2f"|format(pending_earnings) }}</h4>
                        <small class="text-muted">Pending/Upcoming</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wallet"></i> Wallet</h5>
            </div>
            <div class="card-body">
                <p>Current Balance: <strong>₹{{ "%.2f"|format(host.wallet_balance) }}</strong></p>
                <!-- Link to wallet management if you create it -->
                <!-- <a href="{{ url_for('host.wallet') }}" class="btn btn-outline-primary btn-sm">Manage Wallet</a> -->
                <a href="#" class="btn btn-outline-primary btn-sm disabled">Withdrawal (Coming Soon)</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\host\profile\wallet.html ---
<!-- templates/host/profile/wallet.html -->
{% extends "host/base.html" %}

{% block title %}Wallet Management{% endblock %}
{% block page_title %}Wallet Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wallet"></i> Wallet Balance</h5>
            </div>
            <div class="card-body text-center">
                <h2 class="display-4 text-success">₹{{ "%.2f"|format(host.wallet_balance) }}</h2>
                <p class="text-muted">Current Available Balance</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Transaction History</h5>
            </div>
            <div class="card-body">
                {% if transactions %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Amount (₹)</th>
                                    <th>Balance (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if transaction.type == 'credit' %}
                                            <span class="badge bg-success">Credit</span>
                                        {% else %}
                                            <span class="badge bg-danger">Debit</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ transaction.description }}</td>
                                    <td class="{% if transaction.type == 'credit' %}text-success{% else %}text-danger{% endif %}">
                                        {% if transaction.type == 'debit' %}-{% endif %}{{ "%.2f"|format(transaction.amount) }}
                                    </td>
                                    <td>{{ "%.2f"|format(transaction.balance_after) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No transactions recorded yet.</p>
                     <div class="text-center mt-3">
                        <i class="fas fa-info-circle text-info"></i>
                        <small class="text-muted">
                            Earnings from bookings are added to your wallet after the rental period is completed.
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Withdraw Funds</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="#"> <!-- Placeholder action -->
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (₹)</label>
                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="1" max="{{ host.wallet_balance }}" required>
                        <div class="form-text">Max: ₹{{ "%.2f"|format(host.wallet_balance) }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="bank_account" class="form-label">Bank Account</label>
                        <select class="form-select" id="bank_account" name="bank_account" required>
                            <option value="">Select Account</option>
                            <!-- Add host's bank accounts here -->
                            <option value="1234">****1234 (State Bank of India)</option>
                            <option value="5678">****5678 (HDFC Bank)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" {% if host.wallet_balance <= 0 %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i> Request Withdrawal
                    </button>
                     {% if host.wallet_balance <= 0 %}
                        <div class="form-text text-warning">
                            <i class="fas fa-exclamation-triangle"></i> Insufficient balance for withdrawal.
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Wallet Information</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Funds are transferred weekly</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Minimum withdrawal: ₹100</li>
                    <li class="mb-2"><i class="fas fa-exclamation-circle text-warning"></i> 2% fee on withdrawals</li>
                    <li class="mb-2"><i class="fas fa-clock text-info"></i> Processing time: 2-3 business days</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\payment\checkout.html ---
<!-- templates/payment/checkout.html -->
{% extends "base.html" %}

{% block title %}Payment for Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
        <div class="bg-primary text-white p-5">
            <h1 class="text-2xl font-bold"><i class="fas fa-credit-card mr-2"></i>Secure Payment</h1>
            <p class="text-blue-100">Complete your booking for {{ booking.car.make }} {{ booking.car.model }}</p>
        </div>

        <div class="p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-car text-primary"></i> Car Details
                    </h3>
                    <p class="font-medium">{{ booking.car.make }} {{ booking.car.model }} ({{ booking.car.year }})</p>
                    <p class="text-sm text-gray-600">{{ booking.car.transmission }} • {{ booking.car.fuel_type }}</p>
                </div>
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary"></i> Rental Period
                    </h3>
                    <p class="text-sm"><strong>{{ booking.start_date.strftime('%Y-%m-%d') }}</strong> to <strong>{{ booking.end_date.strftime('%Y-%m-%d') }}</strong></p>
                    <p class="text-sm text-gray-600">{{ booking.duration_days }} days</p>
                </div>
            </div>

            <div class="border rounded-xl p-4 mb-6 bg-blue-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">Total Amount:</span>
                    <span class="text-xl font-bold text-primary">₹{{ "%.2f"|format(booking.total_price) }}</span>
                </div>
                <p class="text-xs text-gray-600">This amount will be charged to your payment method.</p>
            </div>

            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-primary"></i> Payment Method
                </h3>
                <div class="text-center py-4">
                    <i class="fas fa-lock text-2xl text-green-500 mb-2"></i>
                    <p class="text-sm text-gray-600 mb-3">Powered by <strong>Razorpay</strong>. Your payment is secured with 128-bit SSL encryption.</p>
                    <button id="rzp-button1" class="bg-primary text-white rounded-xl px-6 py-3 font-medium hover:bg-blue-600 transition-colors">
                        <i class="fas fa-rupee-sign mr-1"></i> Pay ₹{{ "%.2f"|format(booking.total_price) }}
                    </button>
                </div>
            </div>

            <div class="text-center text-xs text-gray-500">
                <p>By proceeding, you agree to our <a href="#" class="text-primary hover:underline">Terms of Service</a> and <a href="#" class="text-primary hover:underline">Privacy Policy</a>.</p>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if Razorpay key and order ID are available
    const razorpayKeyId = "{{ razorpay_key_id }}";
    const razorpayOrderId = "{{ razorpay_order_id }}";
    const totalAmountPaise = {{ total_amount_paise }};
    const totalAmountRupees = {{ total_amount_rupees }};
    const bookingId = {{ booking.id }};
    const carMakeModel = "{{ booking.car.make }} {{ booking.car.model }}";

    if (!razorpayKeyId || !razorpayOrderId || !totalAmountPaise) {
        console.error("Razorpay configuration missing.");
        alert("Payment configuration error. Please try again.");
        return;
    }

    const options = {
        "key": razorpayKeyId,
        "amount": totalAmountPaise,
        "currency": "INR",
        "name": "ZoomCar Clone",
        "description": `Booking for ${carMakeModel}`,
        "image": "https://example.com/your_logo.png", // Add your logo URL
        "order_id": razorpayOrderId,
        "handler": function (response){
            // This function executes after payment is successful
            // Send payment details to your server for verification
            const paymentData = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
            };

            // Submit payment data to your backend for verification
            // We'll create a simple form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("payment.handle_payment") }}'; // Your backend verification endpoint

            for (const key in paymentData) {
                if (paymentData.hasOwnProperty(key)) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = key;
                    hiddenField.value = paymentData[key];
                    form.appendChild(hiddenField);
                }
            }

            document.body.appendChild(form);
            form.submit();
        },
        "prefill": {
            "name": "{{ current_user.username }}",
            "email": "{{ current_user.email }}",
            // "contact": "" // Prefill user's contact number if available
        },
        "notes": {
            "booking_id": bookingId,
            "car": carMakeModel
        },
        "theme": {
            "color": "#00b4d8" // Primary color
        }
    };

    const rzp1 = new Razorpay(options);

    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    };

    // Handle payment failure or closure
    rzp1.on('payment.failed', function (response){
        alert(`Payment failed: ${response.error.description}`);
        console.log(response.error);
        // You can redirect to a failure page or show an error message
        // window.location.href = "{{ url_for('user.booking_detail', booking_id=booking.id) }}";
    });
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\base.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}User Dashboard{% endblock %} - ZoomCar Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
    <style>
        :root {
            --user-primary: #007bff;
            --user-secondary: #6c757d;
            --user-dark: #343a40;
        }

        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--user-dark), #212529);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            margin: 5px 0;
            border-radius: 5px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .booking-card {
            transition: all 0.3s ease;
        }

        .booking-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .status-badge {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4><i class="fas fa-user"></i> User Panel</h4>
                        <small class="text-muted">{{ current_user.username }}</small>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'user.dashboard' %}active{% endif %}"
                               href="{{ url_for('user.dashboard') }}">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'user.wallet' %}active{% endif %}"
                               href="{{ url_for('user.wallet') }}"> <!-- This will now work -->
                                <i class="fas fa-wallet"></i> Wallet
                            </a>
                        </li>
            <!-- --- END WALLET LINK --- -->
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'user.list_bookings' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('user.list_bookings') }}">
                                <i class="fas fa-calendar-check"></i> My Bookings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('user.list_bookings') }}">
                                <i class="fas fa-bell"></i> Notifications
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('user.dashboard') }}">
                                <i class="fas fa-user-circle"></i> Profile
                            </a>
                        </li>
                    </ul>

                    <hr class="my-3">

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('car.home') }}">
                                <i class="fas fa-home"></i> Back to Site
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.logout') }}">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">{% block page_title %}Dashboard{% endblock %}</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        {% block header_buttons %}{% endblock %}
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-info alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Page Content -->
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% block scripts %}{% endblock %}
</body>
</html>


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\dashboard.html ---
<!-- templates/user/dashboard.html -->
{% extends "user/base.html" %}

{% block title %}User Dashboard{% endblock %}
{% block page_title %}Welcome, {{ user.username }}!{% endblock %}

{% block content %}
<div class="row">
    <!-- User Info & Stats -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-circle"></i> My Profile</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Username:</strong> {{ user.username }}</p>
                        <p><strong>Email:</strong> {{ user.email }}</p>
                        <p><strong>Phone:</strong> {{ user.phone or 'Not provided' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Member Since:</strong> {{ user.created_at.strftime('%Y-%m-%d') }}</p>
                        <p><strong>Status:</strong>
                            <span class="badge bg-{% if user.is_active %}success{% else %}secondary{% endif %}">
                                {% if user.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </p>
                        {% if user.is_admin %}
                        <p><strong>Role:</strong> <span class="badge bg-danger">Administrator</span></p>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('user.profile') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit"></i> Edit Profile
                    </a>
                </div>
            </div>
        </div>

        <!-- Upcoming Trips -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-car"></i> Upcoming Trips</h5>
            </div>
            <div class="card-body">
                {% if upcoming_bookings %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Car</th>
                                <th>Start Date & Time</th>
                                <th>Status</th>
                                <th>Time Until Pickup/Dropoff</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in upcoming_bookings %}
                            {% set booking = item.booking %}
                            {% set enable_start_button = item.enable_start_button %}
                            <tr>
                                <td>#{{ booking.id }}</td>
                                <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                                <td>{{ booking.start_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <span class="badge bg-{% if booking.status == 'completed' %}success
                                                        {% elif booking.status == 'active' %}info
                                                        {% elif booking.status == 'paid' %}primary
                                                        {% elif booking.status == 'approved' %}secondary
                                                        {% elif booking.status == 'pending' %}warning
                                                        {% elif booking.status == 'cancelled' %}danger
                                                        {% else %}light{% endif %}">
                                        {{ booking.status|title }}
                                    </span>
                                </td>
                                <td id="countdown-{{ booking.id }}">Calculating...</td>
                                <td>
                                    <!-- Start Trip Button (Conditional) -->
                                    {% if booking.status == 'paid' %}
                                        <button id="start-btn-{{ booking.id }}"
                                                class="btn btn-sm btn-{% if enable_start_button %}success{% else %}secondary{% endif %} {% if not enable_start_button %}disabled{% endif %}"
                                                {% if not enable_start_button %}disabled{% endif %}
                                                onclick="startTrip({{ booking.id }})">
                                            <i class="fas fa-play"></i> Start Trip
                                        </button>
                                    {% elif booking.status == 'active' %}
                                        <button id="complete-btn-{{ booking.id }}"
                                                class="btn btn-sm btn-info"
                                                onclick="completeTrip({{ booking.id }})">
                                            <i class="fas fa-flag-checkered"></i> Complete Trip
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-secondary disabled" disabled>
                                            <i class="fas fa-ban"></i> No Action
                                        </button>
                                    {% endif %}
                                    <a href="{{ url_for('user.booking_detail', booking_id=booking.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="{{ url_for('user.list_bookings') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list"></i> View All Bookings
                    </a>
                </div>
                {% else %}
                <p class="text-muted text-center">No upcoming trips scheduled. <a href="{{ url_for('car.home') }}">Book a car now!</a></p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar Widgets -->
    <div class="col-lg-4">
        <!-- --- WALLET WIDGET --- -->
        {% include 'user/wallet/dashboard_widget.html' %}
        <!-- --- END WALLET WIDGET --- -->

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Notifications</h5>
            </div>
            <div class="card-body">
                <p class="text-muted text-center">Your recent notifications will appear here.</p>
                <div class="text-center">
                    <a href="#" class="btn btn-sm btn-outline-secondary disabled">View All Notifications</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ... (previous HTML content remains the same) ... -->

<!-- ... (previous HTML content remains the same) ... -->

<!-- ... (HTML content before the <script> tag remains unchanged) ... -->

<!-- ... (HTML content before the <script> tag remains unchanged) ... -->

<script>
// --- CRITICAL FIX: Robust Timer using Estimated Server Time ---

// 1. Get initial server time from the template context (when page loaded)
// This is passed from the Python route via context['server_time']
const SERVER_TIME_ISO = "{{ server_time.isoformat() }}"; // Get server time as ISO string from Flask context
const serverStartTime = new Date(SERVER_TIME_ISO); // Convert to JS Date object (server time)

// 2. Get initial client time (when page loaded)
const clientStartTime = new Date(); // Current client time when page loaded

// 3. Calculate the initial offset (Server Time - Client Time) in milliseconds
// This represents how far ahead (+) or behind (-) the server time is compared to the client time
const initialTimeOffset = serverStartTime.getTime() - clientStartTime.getTime();

// --- CRITICAL FIX 2: Generate URL Templates on Client Side ---
// Use url_for with a dummy integer (e.g., 0) to get the base path, then replace the dummy ID with a placeholder string.
// This avoids the int() error that occurs when using a non-integer placeholder directly in url_for.
const startTripUrlBase = "{{ url_for('user.start_trip', booking_id=0) }}".replace('/0/', '/__BOOKING_ID__/');
const completeTripUrlBase = "{{ url_for('user.complete_trip', booking_id=0) }}".replace('/0/', '/__BOOKING_ID__/');
// --- END CRITICAL FIX 2 ---

// Function to calculate and update countdowns based on booking status
// Uses the estimated server time for robustness
function updateCountdowns() {
    // 4. Calculate Estimated Server Time
    // Get the *current* client time
    const currentClientTime = new Date();
    // Add the initial offset to get an estimated server time
    const estimatedServerTime = new Date(currentClientTime.getTime() + initialTimeOffset);

    // --- CRITICAL FIX: Process each booking ---
    // The following block is generated multiple times by Jinja2, once for each booking item.
    // Each iteration handles the logic for a single booking identified by its unique ID.
    {% for item in upcoming_bookings %}
        {% set booking = item.booking %}
        // --- Process Booking ID: {{ booking.id }} ---

        // Get DOM elements for this specific booking
        // Use unique variable names for elements to avoid potential conflicts if IDs are duplicated
        const countdownElement_{{ booking.id }} = document.getElementById('countdown-{{ booking.id }}');
        const startButton_{{ booking.id }} = document.getElementById('start-btn-{{ booking.id }}');
        const completeButton_{{ booking.id }} = document.getElementById('complete-btn-{{ booking.id }}');

        // Check if the primary countdown element exists
        if (!countdownElement_{{ booking.id }}) {
            console.error(`Countdown element not found for booking ID: {{ booking.id }}`);
            // Skip processing this booking if the element is missing
            // In a standard JS loop, 'continue;' would be correct. Here, we mimic it by exiting the block.
            // However, exiting the entire function is too harsh. Let's just skip the rest of this block's logic.
            // We can't easily use 'continue;' as there's no explicit JS loop surrounding this generated block.
            // Let's just proceed carefully, assuming missing elements are logged.
             // Do nothing, let the rest of the logic handle potential undefined elements gracefully or error later.
        } else { // Only process if the element exists

            // --- CRITICAL FIX 3: Correctly Define Booking Dates for this Iteration ---
            // Create Date objects directly from Jinja2-rendered and JS-formatted strings.
            // Use strftime format and replace space with 'T' for ISO string compatibility.
            // Ensure the format matches the Python datetime object's output.
            // Assign to uniquely named variables for this booking's scope to prevent conflicts.
            const bookingStartTime_{{ booking.id }} = new Date('{{ booking.start_date.strftime("%Y-%m-%d %H:%M:%S") }}'.replace(' ', 'T'));
            const bookingEndTime_{{ booking.id }} = new Date('{{ booking.end_date.strftime("%Y-%m-%d %H:%M:%S") }}'.replace(' ', 'T'));
            // --- END CRITICAL FIX 3 ---

            // --- CRITICAL FIX 4: Define Booking Status for this Iteration ---
            // Define booking status directly from the Jinja2 template variable for this iteration.
            // Assign to a uniquely named variable for this booking's scope to prevent conflicts.
            const bookingStatus_{{ booking.id }} = "{{ booking.status }}";
            // --- END CRITICAL FIX 4 ---

            // Determine the target time based on status and handle different states
            let targetTime_{{ booking.id }} = null;
            let statusText_{{ booking.id }} = '';
            let shouldShowCountdown_{{ booking.id }} = true;

            // --- CRITICAL FIX 5: Use the Locally Scoped Status Variable ---
            if (bookingStatus_{{ booking.id }} === 'paid') {
                targetTime_{{ booking.id }} = bookingStartTime_{{ booking.id }};
                statusText_{{ booking.id }} = 'Until Pickup';
            } else if (bookingStatus_{{ booking.id }} === 'active') {
                targetTime_{{ booking.id }} = bookingEndTime_{{ booking.id }};
                statusText_{{ booking.id }} = 'Until Dropoff';
            } else if (bookingStatus_{{ booking.id }} === 'completed') {
                countdownElement_{{ booking.id }}.textContent = 'Trip Completed';
                shouldShowCountdown_{{ booking.id }} = false;
            } else if (bookingStatus_{{ booking.id }} === 'cancelled') {
                countdownElement_{{ booking.id }}.textContent = 'Trip Cancelled';
                shouldShowCountdown_{{ booking.id }} = false;
            } else if (bookingStatus_{{ booking.id }} === 'pending') {
                 countdownElement_{{ booking.id }}.textContent = 'Trip Pending';
                 shouldShowCountdown_{{ booking.id }} = false;
            } else {
                // For other statuses like 'approved' if they have a start time
                targetTime_{{ booking.id }} = bookingStartTime_{{ booking.id }};
                statusText_{{ booking.id }} = 'Until Start';
            }
            // --- END CRITICAL FIX 5 ---

            // Check if the target time is valid
            if (shouldShowCountdown_{{ booking.id }} && isNaN(targetTime_{{ booking.id }}.getTime())) {
                countdownElement_{{ booking.id }}.textContent = 'Invalid Date';
                console.error(`Invalid date for booking ID: {{ booking.id }} (Status: {{ booking.status }})`);
                // Optionally disable buttons if date is invalid
                if (startButton_{{ booking.id }}) {
                    startButton_{{ booking.id }}.disabled = true;
                    startButton_{{ booking.id }}.classList.add('disabled', 'btn-secondary');
                    startButton_{{ booking.id }}.classList.remove('btn-success');
                }
                if (completeButton_{{ booking.id }}) {
                    completeButton_{{ booking.id }}.disabled = true;
                    completeButton_{{ booking.id }}.classList.add('disabled', 'btn-secondary');
                    completeButton_{{ booking.id }}.classList.remove('btn-info');
                }
                // Mimic 'continue;' by skipping the rest of the logic for this booking block
                // Do nothing, let the block end naturally.
            } else if (shouldShowCountdown_{{ booking.id }}) { // Only proceed if status requires countdown and date is valid

                // Calculate and display countdown if target time is valid and status requires it
                // 5. Use Estimated Server Time for calculation
                const timeDiff_{{ booking.id }} = targetTime_{{ booking.id }} - estimatedServerTime; // Use estimated server time

                if (timeDiff_{{ booking.id }} > 0) {
                    const seconds_{{ booking.id }} = Math.floor((timeDiff_{{ booking.id }} / 1000) % 60);
                    const minutes_{{ booking.id }} = Math.floor((timeDiff_{{ booking.id }} / (1000 * 60)) % 60);
                    const hours_{{ booking.id }} = Math.floor((timeDiff_{{ booking.id }} / (1000 * 60 * 60)) % 24);
                    const days_{{ booking.id }} = Math.floor(timeDiff_{{ booking.id }} / (1000 * 60 * 60 * 24));

                    let countdownText_{{ booking.id }} = '';
                    if (days_{{ booking.id }} > 0) {
                        countdownText_{{ booking.id }} = `${days_{{ booking.id }}}d ${hours_{{ booking.id }}}h ${minutes_{{ booking.id }}}m`;
                    } else if (hours_{{ booking.id }} > 0) {
                        countdownText_{{ booking.id }} = `${hours_{{ booking.id }}}h ${minutes_{{ booking.id }}}m ${seconds_{{ booking.id }}}s`;
                    } else {
                        countdownText_{{ booking.id }} = `${minutes_{{ booking.id }}}m ${seconds_{{ booking.id }}}s`;
                    }

                    countdownElement_{{ booking.id }}.textContent = `${countdownText_{{ booking.id }}} (${statusText_{{ booking.id }}})`;
                } else {
                    // Target time has passed (based on estimated server time)
                    // --- CRITICAL FIX 6: Use the Locally Scoped Status Variable ---
                    if (bookingStatus_{{ booking.id }} === 'paid') {
                        countdownElement_{{ booking.id }}.textContent = 'Ready to Start';
                        // --- CRITICAL FIX 9: Ensure Button is Enabled for 'Ready to Start' ---
                        // Explicitly enable the start button if the status is 'paid' and time has passed
                        if (startButton_{{ booking.id }}) {
                             startButton_{{ booking.id }}.disabled = false; // Enable the button
                             startButton_{{ booking.id }}.classList.remove('btn-secondary', 'disabled'); // Remove disabled classes
                             startButton_{{ booking.id }}.classList.add('btn-success'); // Add success class
                        }
                        // --- END CRITICAL FIX 9 ---
                    } else if (bookingStatus_{{ booking.id }} === 'active') {
                        countdownElement_{{ booking.id }}.textContent = 'Trip Ongoing';
                    } else {
                        countdownElement_{{ booking.id }}.textContent = 'Time Passed';
                    }
                    // --- END CRITICAL FIX 6 ---
                }

                // Update button states based on status and time (using estimated server time)
                // Only update if not already handled by the 'Ready to Start' logic above
                if (startButton_{{ booking.id }} && !startButton_{{ booking.id }}.classList.contains('btn-success')) {
                    startButton_{{ booking.id }}.disabled = true; // Default to disabled
                    startButton_{{ booking.id }}.classList.remove('btn-success', 'btn-secondary'); // Reset classes
                    startButton_{{ booking.id }}.classList.add('btn-secondary', 'disabled'); // Default class

                    // --- CRITICAL FIX 7: Use the Locally Scoped Status Variable ---
                    if (bookingStatus_{{ booking.id }} === 'paid') {
                        // Check if within 1 hour (3600000 ms) of pickup time using estimated server time
                        const timeToStart_{{ booking.id }} = bookingStartTime_{{ booking.id }} - estimatedServerTime; // Use estimated server time
                        const enableStartButton_{{ booking.id }} = timeToStart_{{ booking.id }} <= 3600000 && timeToStart_{{ booking.id }} > 0;
                        if (enableStartButton_{{ booking.id }}) {
                            startButton_{{ booking.id }}.disabled = false;
                            startButton_{{ booking.id }}.classList.remove('btn-secondary', 'disabled');
                            startButton_{{ booking.id }}.classList.add('btn-success');
                        }
                    }
                    // --- END CRITICAL FIX 7 ---
                }

                if (completeButton_{{ booking.id }}) {
                    completeButton_{{ booking.id }}.disabled = true; // Default to disabled
                    completeButton_{{ booking.id }}.classList.remove('btn-info', 'btn-secondary'); // Reset classes
                    completeButton_{{ booking.id }}.classList.add('btn-secondary', 'disabled'); // Default class

                    // --- CRITICAL FIX 8: Use the Locally Scoped Status Variable ---
                    if (bookingStatus_{{ booking.id }} === 'active') {
                        // Enable complete button if status is active
                        completeButton_{{ booking.id }}.disabled = false;
                        completeButton_{{ booking.id }}.classList.remove('btn-secondary', 'disabled');
                        completeButton_{{ booking.id }}.classList.add('btn-info');
                    }
                    // --- END CRITICAL FIX 8 ---
                }

            } // End if (shouldShowCountdown && valid date) else block
        } // End if (countdownElement exists) check
        // --- End Process Booking ID: {{ booking.id }} ---
    {% endfor %} // End of Jinja2 loop (This comment is just for clarity, not part of the generated JS)
    // --- END CRITICAL FIX ---
}

// Call updateCountdowns immediately and then every second
updateCountdowns();
setInterval(updateCountdowns, 1000);

// --- CRITICAL FIX 2: Update the startTrip function to use the pre-generated URL base ---
// Navigate to the new start trip page using Flask's url_for and replace the placeholder
// Use a placeholder string that is NOT an integer, e.g., '__BOOKING_ID__'
function startTrip(bookingId) {
    const url = startTripUrlBase.replace('__BOOKING_ID__', bookingId);
    window.location.href = url;
}
// --- END CRITICAL FIX 2 ---

// --- CRITICAL FIX 2: Update the completeTrip function to use the pre-generated URL base ---
// Navigate to the new complete trip page using Flask's url_for and replace the placeholder
// Use a placeholder string that is NOT an integer, e.g., '__BOOKING_ID__'
function completeTrip(bookingId) {
    const url = completeTripUrlBase.replace('__BOOKING_ID__', bookingId);
    window.location.href = url;
}
// --- END CRITICAL FIX 2 ---

// --- Debugging Output ---
console.log("Server Time (ISO format):", SERVER_TIME_ISO);
// --- END Debugging Output ---
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\bookings\complete_trip.html ---
<!-- templates/user/bookings/complete_trip.html -->
{% extends "user/base.html" %}

{% block title %}Complete Trip - Booking #{{ booking.id }}{% endblock %}
{% block page_title %}Complete Your Trip{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-flag-checkered"></i> Upload Drop-off Photos</h4>
            </div>
            <div class="card-body">
                <p class="lead">Please upload photos of the car after completing your trip.</p>

                <div class="mb-4">
                    <h5>Trip Details</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Booking ID:</strong> #{{ booking.id }}</li>
                        <li class="list-group-item"><strong>Car:</strong> {{ booking.car.make }} {{ booking.car.model }} ({{ booking.car.year }})</li>
                        <li class="list-group-item"><strong>Start Date & Time:</strong> {{ booking.start_date.strftime('%Y-%m-%d %H:%M') }} IST</li>
                        <li class="list-group-item"><strong>End Date & Time:</strong> {{ booking.end_date.strftime('%Y-%m-%d %H:%M') }} IST</li>
                        <li class="list-group-item"><strong>Total Price:</strong> ₹{{ "%.2f"|format(booking.total_price) }}</li>
                        <li class="list-group-item"><strong>Status:</strong>
                            <span class="badge bg-{% if booking.status == 'completed' %}success
                                                {% elif booking.status == 'active' %}info
                                                {% elif booking.status == 'paid' %}primary
                                                {% elif booking.status == 'approved' %}secondary
                                                {% elif booking.status == 'pending' %}warning
                                                {% elif booking.status == 'cancelled' %}danger
                                                {% else %}light{% endif %}">
                                {{ booking.status|title }}
                            </span>
                        </li>
                    </ul>
                </div>

                <!-- Photo Upload Form -->
                <form method="POST" enctype="multipart/form-data">
                    <!-- CSRF Token (Essential for security) -->
                    <!-- Assuming manual CSRF token like in start_trip.html -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label for="dropoff_photos" class="form-label">Upload Drop-off Photos (Max 10, Optional)</label>
                        <input class="form-control" type="file" id="dropoff_photos" name="dropoff_photos" accept="image/*" multiple>
                        <div class="form-text">Select up to 10 images showing the car's condition at drop-off. This step is optional but recommended.</div>
                         <!-- Display form errors for the file field if needed -->
                        <!-- You can add error display logic here if passed from the route -->
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('user.booking_detail', booking_id=booking.id) }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-info">Confirm Complete Trip</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\bookings\detail.html ---
<!-- templates/user/bookings/detail.html -->
{% extends "user/base.html" %}

{% block title %}Booking #{{ booking.id }} - Details{% endblock %}
{% block page_title %}Booking #{{ booking.id }} Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-car"></i> Booking Details</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Car:</strong> {{ booking.car.make }} {{ booking.car.model }}</p>
                        <p><strong>Start Date & Time:</strong> {{ booking.start_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><strong>End Date & Time:</strong> {{ booking.end_date.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><strong>Total Price:</strong> ₹{{ "%.2f"|format(booking.total_price) }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong>
                            <span class="badge bg-{% if booking.status == 'completed' %}success
                                                {% elif booking.status == 'active' %}info
                                                {% elif booking.status == 'paid' %}primary
                                                {% elif booking.status == 'approved' %}secondary
                                                {% elif booking.status == 'pending' %}warning
                                                {% elif booking.status == 'cancelled' %}danger
                                                {% else %}light{% endif %}">
                                {{ booking.status|title }}
                            </span>
                        </p>
                        <p><strong>Payment Status:</strong> {{ booking.payment_status|title }}</p>
                        <p><strong>Created At:</strong> {{ booking.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </div>

                <!-- Pickup Photos -->
                {% set pickup_photos = booking.get_pickup_photos() %}
                {% if pickup_photos %}
                    <div class="mt-4">
                        <h5>Pickup Photos:</h5>
                        <div class="row g-2">
                            {% for photo in pickup_photos %}
                                <div class="col-6 col-md-4">
                                    <img src="{{ url_for('static', filename='uploads/' + photo.filename) }}" class="img-fluid rounded" alt="Pickup Photo">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Dropoff Photos -->
                {% set dropoff_photos = booking.get_dropoff_photos() %}
                {% if dropoff_photos %}
                    <div class="mt-4">
                        <h5>Dropoff Photos:</h5>
                        <div class="row g-2">
                            {% for photo in dropoff_photos %}
                                <div class="col-6 col-md-4">
                                    <img src="{{ url_for('static', filename='uploads/' + photo.filename) }}" class="img-fluid rounded" alt="Dropoff Photo">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Actions -->
                                <!-- Actions -->
                <div class="mt-4">
                    {% if booking.status == 'paid' and booking.can_be_activated_by_user() %}
                        <a href="{{ url_for('user.start_trip', booking_id=booking.id) }}" class="btn btn-success">
                            <i class="fas fa-play"></i> Start Trip (Upload Photos)
                        </a>
                    {% elif booking.status == 'active' %}
                         <a href="{{ url_for('user.complete_trip', booking_id=booking.id) }}" class="btn btn-info">
                            <i class="fas fa-flag-checkered"></i> Complete Trip (Upload Photos)
                        </a>
                    {% elif booking.status == 'completed' %}
                        <button class="btn btn-success" disabled>
                            <i class="fas fa-check-circle"></i> Trip Completed
                        </button>
                    {% elif booking.status == 'cancelled' %}
                        <button class="btn btn-danger" disabled>
                            <i class="fas fa-ban"></i> Trip Cancelled
                        </button>
                    {% else %}
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-info-circle"></i> No Action Available
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\bookings\list.html ---
{% extends "user/base.html" %}

{% block title %}My Bookings{% endblock %}
{% block page_title %}My Bookings{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-calendar-check"></i> Booking History</h5>
    </div>
    <div class="card-body">
        {% if bookings %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Car</th>
                            <th>Host</th>
                            <th>Dates</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>#{{ booking.id }}</td>
                            <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                            <td>{{ booking.car.host.company_name or booking.car.host.user.username }}</td>
                            <td>{{ booking.start_date.strftime('%Y-%m-%d') }} to {{ booking.end_date.strftime('%Y-%m-%d') }}</td>
                            <td>₹{{ "%.2f"|format(booking.total_price) }}</td>
                            <td>
                                <span class="badge bg-{% if booking.status == 'pending' %}warning{% elif booking.status == 'approved' %}info{% elif booking.status == 'paid' %}primary{% elif booking.is_active %}success{% elif booking.is_completed %}secondary{% elif booking.status == 'cancelled' %}danger{% else %}light{% endif %} status-badge">
                                    {% if booking.is_active %}Active Trip
                                    {% elif booking.is_completed %}Completed
                                    {% else %}{{ booking.status|title }}
                                    {% endif %}
                                </span>
                                {% if booking.payment_status == 'completed' %}
                                    <span class="badge bg-success status-badge">Paid</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('user.booking_detail', booking_id=booking.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% if booking.status == 'pending' %}
                                    <a href="{{ url_for('user.cancel_booking', booking_id=booking.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Are you sure you want to cancel this booking?')">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                {% endif %}
                                {% if booking.can_be_paid() %}
                                    <a href="{{ url_for('user.pay_booking', booking_id=booking.id) }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-credit-card"></i> Pay Now
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-calendar fa-4x text-muted mb-3"></i>
                <h4>No bookings yet</h4>
                <p class="text-muted">Start by booking your first car.</p>
                <a href="{{ url_for('car.home') }}" class="btn btn-primary">
                    <i class="fas fa-search"></i> Book a Car
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\bookings\payment.html ---
{% extends "user/base.html" %}

{% block title %}Pay for Booking #{{ booking.id }}{% endblock %}
{% block page_title %}Payment for Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-credit-card"></i> Payment Details</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Booking Summary</h6>
                        <p><strong>{{ booking.car.make }} {{ booking.car.model }}</strong></p>
                        <p>{{ booking.start_date.strftime('%Y-%m-%d') }} to {{ booking.end_date.strftime('%Y-%m-%d') }}</p>
                        <p>{{ booking.duration_days }} days</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <h6>Amount to Pay</h6>
                        <h3 class="text-primary">₹{{ "%.2f"|format(booking.total_price) }}</h3>
                    </div>
                </div>

                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="credit_card" checked>
                            <label class="form-check-label" for="credit_card">
                                <i class="fab fa-cc-visa me-1"></i> Credit/Debit Card
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="upi" value="upi">
                            <label class="form-check-label" for="upi">
                                <i class="fas fa-mobile-alt me-1"></i> UPI
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="net_banking" value="net_banking">
                            <label class="form-check-label" for="net_banking">
                                <i class="fas fa-university me-1"></i> Net Banking
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> This is a simulation. In a real application, you would be redirected to a payment gateway.
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('user.booking_detail', booking_id=booking.id) }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-lock"></i> Pay ₹{{ "%.2f"|format(booking.total_price) }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\bookings\razorpaycheckout.html ---
{% extends "base.html" %}

{% block title %}Complete Payment for Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0"><i class="fas fa-credit-card"></i> Secure Payment</h4>
                    <p class="mb-0">Complete your booking for {{ booking.car.make }} {{ booking.car.model }}</p>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-lock fa-3x text-success mb-3"></i>
                        <h5>Redirecting to secure payment gateway...</h5>
                        <p class="text-muted">Please wait while we process your payment.</p>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            Booking ID: #{{ booking.id }}<br>
                            Amount: <strong>₹{{ "%.2f"|format(booking.total_price) }}</strong>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- templates/user/bookings/razorpaycheckout.html (Relevant part - Razorpay handler) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Razorpay Configuration ---
    const razorpayKeyId = "{{ razorpay_key_id }}";
    const razorpayOrderId = "{{ razorpay_order_id }}";
    const totalAmountPaise = {{ total_amount_paise }};
    const totalAmountRupees = {{ total_amount_rupees }};
    const bookingId = {{ booking.id }};
    const carMakeModel = "{{ booking.car.make }} {{ booking.car.model }}";

    if (!razorpayKeyId || !razorpayOrderId || !totalAmountPaise) {
        console.error("Razorpay configuration missing.");
        alert("Payment configuration error. Please try again.");
        window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}"; // Fallback redirect
        return;
    }
    // --- End Configuration ---

    // --- Razorpay Options ---
    const options = {
        "key": razorpayKeyId,
        "amount": totalAmountPaise,
        "currency": "INR",
        "name": "ZoomCar Clone",
        "description": `Booking for ${carMakeModel} (#${bookingId})`,
        // "image": "https://example.com/your_logo.png", // Add your logo URL if available
        "order_id": razorpayOrderId,
        "handler": function (response){
            // This function executes after payment is successful
            console.log("Razorpay Payment Response:", response);
            // Send payment details to your backend for verification
            const paymentData = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
            };

            // --- CRITICAL FIX: Use fetch for AJAX verification ---
            // Submit payment data to your backend verification endpoint
            fetch('{{ url_for("booking.handle_payment") }}', { // <-- Correct backend endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Include CSRF token if you are using Flask-WTF CSRF protection
                    // 'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(paymentData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // --- CRITICAL FIX: Redirect to correct endpoint ---
                    // BEFORE (Incorrect - booking.payment_success doesn't exist)
                    // window.location.href = "{{ url_for('booking.payment_success', booking_id=booking.id) }}";

                    // AFTER (Corrected - Redirect to booking detail page)
                    window.location.href = data.redirect_url; // Use URL from backend response
                    // OR, if backend doesn't provide redirect_url:
                    // window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
                    // --- END CRITICAL FIX ---
                } else {
                    // Handle verification failure
                    alert(data.message || "Payment verification failed. Please contact support.");
                    window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
                }
            })
            .catch(error => {
                console.error('Payment verification error:', error);
                alert("An error occurred during payment verification. Please check your booking status.");
                window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
            });
        },
        "prefill": {
            "name": "{{ current_user.username }}",
            "email": "{{ current_user.email }}",
            // "contact": "{{ current_user.phone }}" // Prefill user's contact number if available
        },
        "notes": {
            "booking_id": bookingId,
            "car": carMakeModel
        },
        "theme": {
            "color": "#00b4d8" // Primary color from your theme
        },
        "modal": {
            "ondismiss": function(){
                // Handle case where user closes the Razorpay popup without paying
                console.log("Razorpay Popup closed by user.");
                alert("Payment was not completed. You can resume payment from the booking details page.");
                window.location.href = "{{ url_for('booking.booking_detail', booking_id=booking.id) }}";
            }
        }
    };
    // --- End Options ---

    // --- Initialize and Open Razorpay Checkout ---
    const rzp1 = new Razorpay(options);

    // Open the checkout form automatically
    rzp1.open();
    // --- End Initialization ---
});
</script>
{% endblock %}


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\bookings\start_trip.html ---
<!-- templates/user/bookings/start_trip.html -->
{% extends "user/base.html" %}

{% block title %}Start Trip - Booking #{{ booking.id }}{% endblock %}
{% block page_title %}Start Your Trip{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-play-circle"></i> Upload Pickup Photos</h4>
            </div>
            <div class="card-body">
                <p class="lead">Please upload photos of the car before starting your trip.</p>

                <div class="mb-4">
                    <h5>Trip Details</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Booking ID:</strong> #{{ booking.id }}</li>
                        <li class="list-group-item"><strong>Car:</strong> {{ booking.car.make }} {{ booking.car.model }} ({{ booking.car.year }})</li>
                        <li class="list-group-item"><strong>Start Date & Time:</strong> {{ booking.start_date.strftime('%Y-%m-%d %H:%M') }} IST</li>
                        <li class="list-group-item"><strong>End Date & Time:</strong> {{ booking.end_date.strftime('%Y-%m-%d %H:%M') }} IST</li>
                        <li class="list-group-item"><strong>Total Price:</strong> ₹{{ "%.2f"|format(booking.total_price) }}</li>
                        <li class="list-group-item"><strong>Status:</strong>
                            <span class="badge bg-{% if booking.status == 'completed' %}success
                                                {% elif booking.status == 'active' %}info
                                                {% elif booking.status == 'paid' %}primary
                                                {% elif booking.status == 'approved' %}secondary
                                                {% elif booking.status == 'pending' %}warning
                                                {% elif booking.status == 'cancelled' %}danger
                                                {% else %}light{% endif %}">
                                {{ booking.status|title }}
                            </span>
                        </li>
                    </ul>
                </div>

                <!-- Photo Upload Form -->
                <!-- CRITICAL FIX: Use WTForm in Template -->
                <form method="POST" enctype="multipart/form-data">
                    <!-- Render the CSRF token field provided by WTForms -->
                    {{ form.hidden_tag() }} <!-- This renders the hidden CSRF input and any other hidden fields -->

                    <!-- Pickup Photos Field -->
                    <div class="mb-3">
                        <!-- Label -->
                        <label for="{{ form.pickup_photos.id }}" class="form-label">
                            {{ form.pickup_photos.label.text }} (Max 10)
                        </label>

                        <!-- File Input (Rendered by WTForms) -->
                        <!-- WTForms will apply classes, attributes (like multiple, accept) defined in the form class -->
                        {{ form.pickup_photos(class="form-control") }}

                        <!-- Help Text -->
                        <div class="form-text">Select up to 10 images showing the car's condition at pickup.</div>

                        <!-- Display Form Errors for the File Field -->
                        {% if form.pickup_photos.errors %}
                            <div class="text-danger">
                                {% for error in form.pickup_photos.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <!-- End Pickup Photos Field -->

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('user.booking_detail', booking_id=booking.id) }}" class="btn btn-secondary">Cancel</a>
                        <!-- Submit Button (Rendered by WTForms) -->
                        {{ form.submit(class="btn btn-success") }}
                    </div>
                </form>
                <!-- END CRITICAL FIX: Use WTForm in Template -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\filter\car_list.html ---
<!-- templates/car_list.html -->
{% extends "base.html" %} <!-- Or your main base template -->

{% block title %}Available Cars - ZoomCar Clone{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-4 px-4 sm:px-6 lg:px-8 py-4">
    <!-- Filters Sidebar -->
    <aside class="hidden lg:block lg:col-span-3">
        <div class="bg-white border rounded-2xl p-4 shadow-sm sticky top-24">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-lg">Filters</h2>
                <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng)) }}" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">
                    Reset
                </a>
            </div>

            <!-- Filter Form -->
            <form id="carFiltersForm" method="GET" action="{{ url_for('car.car_list') }}">
                <!-- Pass through existing NON-FILTER search/location parameters -->
                <!-- This ensures user_lat, user_lng are maintained -->
                {% for key, value in request.args.items() %}
                    {% if key not in ['type', 'transmission', 'fuel', 'min_seats', 'max_seats', 'min_price', 'max_price', 'brand', 'min_year', 'features'] %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
                <!-- Ensure user_lat and user_lng are always passed -->
                <input type="hidden" name="user_lat" value="{{ user_location.lat }}">
                <input type="hidden" name="user_lng" value="{{ user_location.lng }}">

                <!-- Quick Picks (Placeholder - Add sort logic if needed) -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-sliders-h text-primary"></i> Quick Picks
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <!-- These links would apply specific filter combinations -->
                        <a href="#" class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300">Top Rated</a>
                        <a href="#" class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300">Price: Low to High</a>
                        <a href="#" class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300">Price: High to Low</a>
                        <a href="{{ url_for('car.car_list', user_lat=user_location.lat, user_lng=user_location.lng) }}" class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-black text-white border-black">Recommended</a>
                    </div>
                </div>

                <!-- Car Type Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-car text-primary"></i> Car Type
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set car_types = ['SUV', 'Hatchback', 'Sedan', 'MUV', 'Luxury', 'EV'] %}
                        {% for type in car_types %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="type" value="{{ type }}" class="hidden peer" {% if type in active_filters.types %}checked{% endif %}>
                            <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                                {{ type }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Transmission Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-cog text-primary"></i> Transmission
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set transmissions = ['Manual', 'Automatic'] %}
                        {% for trans in transmissions %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="transmission" value="{{ trans }}" class="hidden peer" {% if trans in active_filters.transmissions %}checked{% endif %}>
                            <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                                {{ trans }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Fuel Type Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-gas-pump text-primary"></i> Fuel Type
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set fuels = ['Petrol', 'Diesel', 'CNG', 'EV', 'Electric'] %}
                        {% for fuel in fuels %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="fuel" value="{{ fuel }}" class="hidden peer" {% if fuel in active_filters.fuels %}checked{% endif %}>
                            <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                                {{ fuel }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Seating Capacity Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-users text-primary"></i> Seating Capacity
                    </h3>
                    <div class="flex items-center gap-3">
                        <input type="number" name="min_seats" min="2" max="20" value="{{ active_filters.min_seats or '' }}" placeholder="Min" class="w-20 rounded-lg border px-2 py-1 text-sm">
                        <span class="text-sm text-gray-500">to</span>
                        <input type="number" name="max_seats" min="2" max="20" value="{{ active_filters.max_seats or '' }}" placeholder="Max" class="w-20 rounded-lg border px-2 py-1 text-sm">
                    </div>
                </div>

                <!-- Price Range Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-rupee-sign text-primary"></i> Max Price (₹/day)
                    </h3>
                    <div class="space-y-2">
                        <input type="range" name="max_price_slider" min="500" max="5000" step="100" value="{{ active_filters.max_price or '5000' }}"
                               class="w-full price-slider h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>₹500</span>
                            <span id="priceValue">Up to ₹{{ active_filters.max_price or '5000' }}</span>
                            <span>₹5000</span>
                        </div>
                         <!-- Hidden input to capture the max price value for submission -->
                         <!-- The name 'max_price' matches the filter parameter -->
                         <input type="hidden" name="max_price" id="maxPriceInput" value="{{ active_filters.max_price or '5000' }}">
                         <!-- Optional hidden min_price input -->
                         <input type="hidden" name="min_price" id="minPriceInput" value="{{ active_filters.min_price or '0' }}">
                    </div>
                </div>

                <!-- Brand Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-building text-primary"></i> Brand
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set brands = ['Maruti', 'Hyundai', 'Tata', 'Mahindra', 'Toyota', 'Honda', 'Ford', 'Volkswagen'] %}
                        {% for brand in brands %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="brand" value="{{ brand }}" class="hidden peer" {% if brand in active_filters.brands %}checked{% endif %}>
                            <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                                {{ brand }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Model Year Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary"></i> Model Year
                    </h3>
                    <div class="flex flex-wrap gap-2">
                         {% set years = ['2020', '2021', '2022', '2023'] %} <!-- Use actual years -->
                         {% for year in years %}
                         <label class="cursor-pointer">
                             <input type="checkbox" name="min_year" value="{{ year }}" class="hidden peer" {% if active_filters.min_year == year %}checked{% endif %}> <!-- Use min_year for year filter -->
                             <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                                 {{ year }}+
                             </div>
                         </label>
                         {% endfor %}
                    </div>
                </div>

                <!-- Features Filter -->
                <div class="filter-section mb-4 pb-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-star text-primary"></i> Features
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% set features = ['ac', 'bluetooth', 'sunroof', 'gps'] %}
                        {% set feature_labels = {'ac': 'AC', 'bluetooth': 'Bluetooth', 'sunroof': 'Sunroof', 'gps': 'GPS'} %}
                        {% for feature in features %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="features" value="{{ feature }}" class="hidden peer" {% if feature in active_filters.features %}checked{% endif %}>
                            <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                                {{ feature_labels[feature] }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Apply Filters Button -->
                <div class="pt-2">
                    <button type="submit" class="w-full apply-filters-btn bg-primary text-white rounded-xl px-4 py-2 font-medium hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </aside>

    <!-- Results Section -->
    <section class="lg:col-span-9 space-y-4">
        <!-- Toolbar -->
        <div class="bg-white border rounded-2xl p-3 shadow-sm flex flex-wrap items-center gap-2 justify-between">
            <div class="flex items-center gap-2">
                <button id="mobileFilterToggle" class="md:hidden inline-flex items-center gap-2 px-3 py-2 border rounded-xl">
                    <i class="fas fa-filter"></i> Filters
                </button>
                <div class="text-sm text-gray-600">{{ cars|length }} cars found</div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Simple Sort Dropdown (Tailwind CSS only, no JS) -->
                <div class="sort-dropdown relative">
                    <button class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 text-sm">
                        <i class="fas fa-sort-amount-down"></i> Sort
                        <i class="fas fa-chevron-down ml-1"></i>
                    </button>
                    <div class="sort-dropdown-content absolute right-0 top-full mt-1 w-48 bg-white border rounded-xl shadow-lg py-1 hidden z-10">
                        <a href="?{{ request.args|urlencode }}&sort=recommended" class="block px-4 py-2 text-sm hover:bg-gray-100">Recommended</a>
                        <a href="?{{ request.args|urlencode }}&sort=price_low_high" class="block px-4 py-2 text-sm hover:bg-gray-100">Price: Low to High</a>
                        <a href="?{{ request.args|urlencode }}&sort=price_high_low" class="block px-4 py-2 text-sm hover:bg-gray-100">Price: High to Low</a>
                        <a href="?{{ request.args|urlencode }}&sort=distance" class="block px-4 py-2 text-sm hover:bg-gray-100">Distance</a>
                        <!-- Add more sort options -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Applied Filters Tags -->
        {% if active_filters.types or active_filters.transmissions or active_filters.fuels or
              active_filters.brands or active_filters.features or active_filters.min_seats or
              active_filters.max_seats or active_filters.min_price or active_filters.max_price or
              active_filters.min_year %}
        <div class="bg-white border rounded-2xl p-3 shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-700">Applied Filters</h3>
                <a href="{{ url_for('car.car_list', user_lat=user_location.lat, user_lng=user_location.lng) }}" class="text-xs text-primary font-medium">Clear All</a>
            </div>
            <div class="flex flex-wrap gap-2" id="appliedFiltersContainer">
                {% for type in active_filters.types %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ type }}</span>
                    <!-- Remove filter by rebuilding URL without this type -->
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, type=active_filters.types|reject('equalto', type)|list)) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
                {% for trans in active_filters.transmissions %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ trans }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, transmission=active_filters.transmissions|reject('equalto', trans)|list)) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
                {% for fuel in active_filters.fuels %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ fuel }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, fuel=active_filters.fuels|reject('equalto', fuel)|list)) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
                {% for brand in active_filters.brands %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ brand }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, brand=active_filters.brands|reject('equalto', brand)|list)) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
                {% for feature in active_filters.features %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>{{ feature }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, features=active_filters.features|reject('equalto', feature)|list)) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
                {% if active_filters.min_seats %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Min Seats: {{ active_filters.min_seats }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, min_seats='')) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endif %}
                {% if active_filters.max_seats %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Max Seats: {{ active_filters.max_seats }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, max_seats='')) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endif %}
                {% if active_filters.min_price %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Min Price: ₹{{ active_filters.min_price }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, min_price='')) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endif %}
                {% if active_filters.max_price %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Max Price: ₹{{ active_filters.max_price }}</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, max_price='')) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endif %}
                {% if active_filters.min_year %}
                <div class="filter-tag px-3 py-1.5 rounded-full border text-sm bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-2">
                    <span>Min Year: {{ active_filters.min_year }}+</span>
                    <a href="{{ url_for('car.car_list', **dict(request.args, user_lat=user_location.lat, user_lng=user_location.lng, min_year='')) }}" class="remove cursor-pointer">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <!-- End Applied Filters Tags -->

        <!-- Car Listings Grid -->
        <div class="car-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% if cars %}
                {% for car in cars %}
                <div class="car-card bg-white border rounded-2xl overflow-hidden shadow-sm transition-all duration-300 hover:shadow-md">
                    <!-- Car Image -->
                    <div class="relative h-48 w-full overflow-hidden">
                        {% if car.images and car.images[0] %}
                            <img src="{{ url_for('static', filename='uploads/' + car.images[0].filename) }}"
                                 alt="{{ car.make }} {{ car.model }}"
                                 class="w-full h-full object-cover car-image transition-transform duration-500">
                        {% else %}
                            <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center">
                                <i class="fas fa-car text-gray-400 text-4xl"></i>
                            </div>
                        {% endif %}
                        {% if loop.index == 1 %}
                        <div class="absolute top-2 left-2 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">
                            Top Pick
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-4">
                        <!-- Car Title & Details -->
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div>
                                <h3 class="font-bold text-gray-800 leading-tight">{{ car.make }} {{ car.model }} ({{ car.year }})</h3>
                                <p class="text-xs text-gray-500 mt-1">{{ car.transmission }} • {{ car.fuel_type }} • {{ car.seats }} seats</p>
                            </div>
                            <!-- Rating (Placeholder) -->
                            <div class="flex items-center gap-1 text-sm">
                                <i class="fas fa-star text-yellow-400"></i>
                                <span class="font-semibold">4.5</span>
                                <!-- <span class="text-gray-500">(128)</span> -->
                            </div>
                        </div>

                        <!-- Location & Pricing -->
                        <div class="flex items-center justify-between text-sm mb-3">
                            <div class="text-gray-600">
                                <i class="fas fa-map-marker-alt text-primary mr-1"></i>
                                {% if car.locality %}{{ car.locality }}, {% endif %}
                                {{ car.city }}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-gray-900">₹{{ "%.0f"|format(car.price_per_day) }}</div>
                                <div class="text-xs text-gray-500">/ day</div>
                                {% if car.display_distance_km is defined %}
                                <div class="text-xs text-gray-500">{{ car.display_distance_km }} km away</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex items-center gap-2">
                            <a href="{{ url_for('car.car_detail', car_id=car.id) }}" class="flex-1 text-center text-sm font-medium bg-primary text-white rounded-xl px-3 py-2 transition-all hover:bg-blue-600">
                                <i class="fas fa-info-circle"></i> View Details
                            </a>
                            <button class="text-sm px-3 py-2 rounded-xl border text-gray-700 hover:bg-gray-50">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-span-full text-center py-10">
                    <i class="fas fa-car fa-3x text-gray-300 mb-3"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No cars found</h3>
                    <p class="text-gray-500 mb-4">Try adjusting your filters or search criteria.</p>
                    <a href="{{ url_for('car.home') }}" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-search mr-2"></i> Search Again
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Pagination (Placeholder) -->
        <!--
        <div class="pagination flex justify-center mt-6 gap-2">
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">1</button>
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">2</button>
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">3</button>
            <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
        </div>
        -->
    </section>
</div>

<!-- Mobile Filters Drawer -->
<div id="mobileFilterDrawer" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" id="drawerBackdrop"></div>
    <div class="filter-drawer absolute right-0 top-0 h-full w-full max-w-md bg-white p-4 overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Filters</h3>
            <button id="closeFilterDrawer" class="p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="mobileFiltersContent">
             <!-- Include the same sidebar content here for mobile -->
             <!-- You can copy the filter form content from the aside block above -->
             <p class="text-gray-500">Mobile filter content would go here.</p>
        </div>
        <div class="pt-4 flex items-center gap-2 border-t border-gray-200 mt-4">
            <button id="applyMobileFilters" class="flex-1 bg-primary text-white rounded-xl px-4 py-2 font-medium">
                Apply Filters
            </button>
            <button id="resetMobileFilters" class="px-4 py-2 rounded-xl border text-gray-700 hover:bg-gray-100">
                Reset
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Price Slider Logic ---
    const priceSlider = document.querySelector('input[name="max_price_slider"]');
    const priceValue = document.getElementById('priceValue');
    const maxPriceInput = document.getElementById('maxPriceInput');
    // const minPriceInput = document.getElementById('minPriceInput'); // If using min slider

    if (priceSlider) {
        // Set initial value display
        priceValue.textContent = `Up to ₹${priceSlider.value}`;
        maxPriceInput.value = priceSlider.value;

        priceSlider.addEventListener('input', function() {
            priceValue.textContent = `Up to ₹${this.value}`;
            maxPriceInput.value = this.value;
            // For a true range, you'd also update minPriceInput based on another slider
        });
    }
    // --- End Price Slider ---

    // --- Mobile Filter Drawer Logic ---
    const mobileFilterToggle = document.getElementById('mobileFilterToggle');
    const mobileFilterDrawer = document.getElementById('mobileFilterDrawer');
    const closeFilterDrawer = document.getElementById('closeFilterDrawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    const applyMobileFiltersBtn = document.getElementById('applyMobileFilters');
    const resetMobileFiltersBtn = document.getElementById('resetMobileFilters');

    function openDrawer() {
        mobileFilterDrawer.classList.remove('hidden');
    }

    function closeDrawer() {
        mobileFilterDrawer.classList.add('hidden');
    }

    if (mobileFilterToggle) mobileFilterToggle.addEventListener('click', openDrawer);
    if (closeFilterDrawer) closeFilterDrawer.addEventListener('click', closeDrawer);
    if (drawerBackdrop) drawerBackdrop.addEventListener('click', closeDrawer);

    // Placeholder for Apply/Reset logic (would need form handling)
    if (applyMobileFiltersBtn) applyMobileFiltersBtn.addEventListener('click', function() {
         alert('Apply filters logic would go here (collect form data and submit or reload page)');
         // Example: Collect data, build URL, window.location.href = newUrl;
         closeDrawer();
    });
    if (resetMobileFiltersBtn) resetMobileFiltersBtn.addEventListener('click', function() {
         alert('Reset filters logic would go here (clear form inputs)');
         // Example: Reset all filter inputs to default/empty
    });
    // --- End Mobile Filter Drawer Logic ---

    // --- Simple Sort Dropdown Toggle (Basic Tailwind, no complex JS) ---
    const sortDropdownButton = document.querySelector('.sort-dropdown button');
    const sortDropdownContent = document.querySelector('.sort-dropdown-content');

    if (sortDropdownButton && sortDropdownContent) {
        sortDropdownButton.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            sortDropdownContent.classList.toggle('hidden');
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', function(e) {
            if (!sortDropdownButton.contains(e.target) && !sortDropdownContent.contains(e.target)) {
                sortDropdownContent.classList.add('hidden');
            }
        });
    }
    // --- End Sort Dropdown ---
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\filter\filters_sidebar.html ---
<!-- templates/user/filter/filters_sidebar.html -->
<div class="bg-white border rounded-2xl p-4 shadow-sm sticky top-24">
    <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg">Filters</h2>
        <button id="resetFiltersSidebar" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">
            Reset
        </button>
    </div>

    <!-- Filter Form -->
    <form id="carFiltersForm" method="GET" action="{{ url_for('car.car_list') }}">
        <!-- Pass through existing NON-FILTER search/location parameters -->
        <!-- This ensures user_lat, user_lng, starts, ends are maintained -->
        {% for key, value in request.args.items() %}
            {% if key not in ['type', 'transmission', 'fuel', 'min_seats', 'max_seats', 'min_price', 'max_price', 'brand', 'min_year', 'features'] %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}

        <!-- Car Type Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-car text-primary"></i> Car Type
            </h3>
            <div class="flex flex-wrap gap-2">
                {% set car_types = ['SUV', 'Hatchback', 'Sedan', 'MUV', 'Luxury', 'EV'] %}
                {% for type in car_types %}
                <label class="cursor-pointer">
                    <input type="checkbox" name="type" value="{{ type }}" class="hidden peer" {% if type in request.args.getlist('type') %}checked{% endif %}>
                    <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                        {{ type }}
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Transmission Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-cog text-primary"></i> Transmission
            </h3>
            <div class="flex flex-wrap gap-2">
                {% set transmissions = ['Manual', 'Automatic'] %}
                {% for trans in transmissions %}
                <label class="cursor-pointer">
                    <input type="checkbox" name="transmission" value="{{ trans }}" class="hidden peer" {% if trans in request.args.getlist('transmission') %}checked{% endif %}>
                    <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                        {{ trans }}
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Fuel Type Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-gas-pump text-primary"></i> Fuel Type
            </h3>
            <div class="flex flex-wrap gap-2">
                {% set fuels = ['Petrol', 'Diesel', 'CNG', 'EV', 'Electric'] %}
                {% for fuel in fuels %}
                <label class="cursor-pointer">
                    <input type="checkbox" name="fuel" value="{{ fuel }}" class="hidden peer" {% if fuel in request.args.getlist('fuel') %}checked{% endif %}>
                    <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                        {{ fuel }}
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Seating Capacity Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-users text-primary"></i> Seating Capacity
            </h3>
            <div class="flex items-center gap-3">
                <input type="number" name="min_seats" min="2" max="20" value="{{ request.args.get('min_seats', '') }}" placeholder="Min" class="w-20 rounded-lg border px-2 py-1 text-sm">
                <span class="text-sm text-gray-500">to</span>
                <input type="number" name="max_seats" min="2" max="20" value="{{ request.args.get('max_seats', '') }}" placeholder="Max" class="w-20 rounded-lg border px-2 py-1 text-sm">
            </div>
        </div>

        <!-- Price Range Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-rupee-sign text-primary"></i> Max Price (₹/day)
            </h3>
            <div class="space-y-2">
                <input type="range" name="max_price_slider" min="500" max="5000" step="100" value="{{ request.args.get('max_price', '5000') }}"
                       class="w-full price-slider h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-600">
                    <span>₹500</span>
                    <span id="priceValue">Up to ₹{{ request.args.get('max_price', '5000') }}</span>
                    <span>₹5000</span>
                </div>
                 <!-- Hidden input to capture the max price value for submission -->
                 <!-- The name 'max_price' matches the filter class parameter -->
                 <input type="hidden" name="max_price" id="maxPriceInput" value="{{ request.args.get('max_price', '5000') }}">
                 <!-- Optional hidden min_price input if you add a min slider -->
                 <input type="hidden" name="min_price" id="minPriceInput" value="0">
            </div>
        </div>

        <!-- Brand Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-building text-primary"></i> Brand
            </h3>
            <div class="flex flex-wrap gap-2">
                {% set brands = ['Maruti', 'Hyundai', 'Tata', 'Mahindra', 'Toyota', 'Honda', 'Ford', 'Volkswagen'] %}
                {% for brand in brands %}
                <label class="cursor-pointer">
                    <input type="checkbox" name="brand" value="{{ brand }}" class="hidden peer" {% if brand in request.args.getlist('brand') %}checked{% endif %}>
                    <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                        {{ brand }}
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Model Year Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-calendar-alt text-primary"></i> Model Year
            </h3>
            <div class="flex flex-wrap gap-2">
                 <!-- Use labels for user interaction -->
                 {% set year_labels = ['2020+', '2021+', '2022+', '2023+'] %}
                 {% for label in year_labels %}
                 <label class="cursor-pointer">
                     <input type="checkbox" name="min_year_label" value="{{ label }}" class="hidden peer" {% if label in request.args.getlist('min_year_label') %}checked{% endif %}>
                     <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                         {{ label }}
                     </div>
                 </label>
                 {% endfor %}
            </div>
            <!-- Hidden input to submit the actual year value -->
            <input type="hidden" name="min_year" id="actual_min_year" value="{{ request.args.get('min_year', '') }}">
        </div>

        <!-- Features Filter -->
        <div class="filter-section mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-star text-primary"></i> Features
            </h3>
            <div class="flex flex-wrap gap-2">
                {% set features = ['ac', 'bluetooth', 'sunroof', 'gps'] %}
                {% set feature_labels = {'ac': 'AC', 'bluetooth': 'Bluetooth', 'sunroof': 'Sunroof', 'gps': 'GPS'} %}
                {% for feature in features %}
                <label class="cursor-pointer">
                    <input type="checkbox" name="features" value="{{ feature }}" class="hidden peer" {% if feature in request.args.getlist('features') %}checked{% endif %}>
                    <div class="px-3 py-1.5 rounded-full border text-sm filter-chip bg-white hover:bg-gray-100 border-gray-300 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-colors">
                        {{ feature_labels[feature] }}
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Apply Filters Button (Visible only on desktop sidebar) -->
        <div class="hidden lg:block pt-2">
            <button type="submit" class="w-full apply-filters-btn bg-primary text-white rounded-xl px-4 py-2 font-medium hover:bg-blue-600 transition-colors">
                Apply Filters
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Price Slider Logic ---
    const priceSlider = document.querySelector('input[name="max_price_slider"]');
    const priceValue = document.getElementById('priceValue');
    const maxPriceInput = document.getElementById('maxPriceInput');
    // const minPriceInput = document.getElementById('minPriceInput'); // If using min slider

    if (priceSlider) {
        // Set initial value display
        priceValue.textContent = `Up to ₹${priceSlider.value}`;
        maxPriceInput.value = priceSlider.value;

        priceSlider.addEventListener('input', function() {
            priceValue.textContent = `Up to ₹${this.value}`;
            maxPriceInput.value = this.value;
            // For a true range, you'd also update minPriceInput based on another slider
        });
    }
    // --- End Price Slider ---

    // --- Model Year Filter Logic (Translate label to year) ---
    const yearLabels = document.querySelectorAll('input[name="min_year_label"]');
    const actualMinYearInput = document.getElementById('actual_min_year');

    yearLabels.forEach(labelCheckbox => {
        labelCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Map label to year
                let yearValue = '';
                if (this.value === '2020+') yearValue = '2020';
                else if (this.value === '2021+') yearValue = '2021';
                else if (this.value === '2022+') yearValue = '2022';
                else if (this.value === '2023+') yearValue = '2023';

                if (yearValue) {
                    actualMinYearInput.value = yearValue;
                }
            } else {
                // If unchecked, clear the actual year input
                // Only clear if no other year label is checked
                let anyChecked = false;
                yearLabels.forEach(cb => {
                    if (cb !== this && cb.checked) {
                        anyChecked = true;
                        // Update to the checked one's value
                        let yearVal = '';
                        if (cb.value === '2020+') yearVal = '2020';
                        else if (cb.value === '2021+') yearVal = '2021';
                        else if (cb.value === '2022+') yearVal = '2022';
                        else if (cb.value === '2023+') yearVal = '2023';

                        if (yearVal) {
                            actualMinYearInput.value = yearVal;
                        }
                    }
                });
                if (!anyChecked) {
                     actualMinYearInput.value = '';
                }
            }
        });
    });
    // --- End Model Year Filter Logic ---

    // --- Reset Filters (Sidebar only) ---
    const resetFiltersBtn = document.getElementById('resetFiltersSidebar');
    const filterForm = document.getElementById('carFiltersForm');

    if (resetFiltersBtn && filterForm) {
        resetFiltersBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default button behavior
            // Reset all form elements within the filter form
            filterForm.reset();
            // Specifically handle checkboxes if needed (some browsers don't reset them with .reset())
            const checkboxes = filterForm.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            // Reset slider display and hidden inputs
            if (priceSlider) {
                priceSlider.value = priceSlider.max;
                priceValue.textContent = `Up to ₹${priceSlider.max}`;
                maxPriceInput.value = priceSlider.max;
                // minPriceInput.value = ''; // Or default min if range
            }
            // Reset year filter logic
            actualMinYearInput.value = '';
            yearLabels.forEach(cb => cb.checked = false);
            // Submit the form to refresh results without filters
            // filterForm.submit(); // Optional: uncomment to auto-submit on reset
        });
    }
    // --- End Reset Filters ---
});
</script>

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\filter\list.html ---
<!-- templates/user/filter/list.html -->
{% extends "user/base.html" %} <!-- Or your main base template -->

{% block title %}Available Cars - ZoomCar Clone{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <!-- Header/Toolbar -->
    <div class="bg-white border rounded-2xl p-3 shadow-sm mb-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-2">
                <div class="text-sm text-gray-600">
                    <!-- You can dynamically show the count or filters applied -->
                    {{ cars|length }} cars found
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Simple Sort Dropdown (Tailwind CSS only, no JS) -->
                <div class="sort-dropdown relative">
                    <button class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 text-sm">
                        <i class="fas fa-sort-amount-down"></i> Sort
                        <i class="fas fa-chevron-down ml-1"></i>
                    </button>
                    <div class="sort-dropdown-content absolute right-0 top-full mt-1 w-48 bg-white border rounded-xl shadow-lg py-1 hidden z-10">
                        <!-- These links need to be updated to match your actual sorting/filtering URLs -->
                        <a href="?sort=distance" class="block px-4 py-2 text-sm hover:bg-gray-100">Distance</a>
                        <a href="?sort=price_low_high" class="block px-4 py-2 text-sm hover:bg-gray-100">Price: Low to High</a>
                        <a href="?sort=price_high_low" class="block px-4 py-2 text-sm hover:bg-gray-100">Price: High to Low</a>
                        <a href="?sort=rating" class="block px-4 py-2 text-sm hover:bg-gray-100">Rating</a>
                        <!-- Add more sort options -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Car Listings Grid -->
    <div class="car-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% if cars %}
            {% for car in cars %}
            <div class="car-card bg-white border rounded-2xl overflow-hidden shadow-sm transition-all duration-300 hover:shadow-md">
                <!-- Car Image -->
                <div class="relative h-48 w-full overflow-hidden">
                    {% if car.images and car.images[0] %}
                        <img src="{{ url_for('static', filename='uploads/' + car.images[0].filename) }}"
                             alt="{{ car.make }} {{ car.model }}"
                             class="w-full h-full object-cover car-image transition-transform duration-500">
                    {% else %}
                        <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center">
                            <i class="fas fa-car text-gray-400 text-4xl"></i>
                        </div>
                    {% endif %}
                    {% if loop.index == 1 %}
                    <div class="absolute top-2 left-2 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">
                        Top Pick
                    </div>
                    {% endif %}
                </div>
                <div class="p-4">
                    <!-- Car Title & Details -->
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <div>
                            <h3 class="font-bold text-gray-800 leading-tight">{{ car.make }} {{ car.model }}</h3>
                            <p class="text-xs text-gray-500 mt-1">{{ car.year }} • {{ car.transmission }} • {{ car.fuel_type }}</p>
                        </div>
                        <!-- Rating (Placeholder) -->
                        <div class="flex items-center gap-1 text-sm">
                            <i class="fas fa-star text-yellow-400"></i>
                            <span class="font-semibold">4.5</span>
                            <!-- <span class="text-gray-500">(128)</span> -->
                        </div>
                    </div>

                    <!-- Location & Pricing -->
                    <div class="flex items-center justify-between text-sm mb-3">
                        <div class="text-gray-600">
                            <i class="fas fa-map-marker-alt text-primary mr-1"></i>
                            {% if car.locality %}{{ car.locality }}, {% endif %}
                            {{ car.city }}
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-gray-900">₹{{ "%.0f"|format(car.price_per_day) }}</div>
                            <div class="text-xs text-gray-500">/ day</div>
                            {% if car.display_distance_km is defined %}
                            <div class="text-xs text-gray-500">{{ car.display_distance_km }} km away</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center gap-2">
                        <a href="{{ url_for('car.car_detail', car_id=car.id) }}" class="flex-1 text-center text-sm font-medium bg-primary text-white rounded-xl px-3 py-2 transition-all hover:bg-blue-600">
                            <i class="fas fa-info-circle"></i> View Details
                        </a>
                        <button class="text-sm px-3 py-2 rounded-xl border text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-span-full text-center py-10">
                <i class="fas fa-car fa-3x text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No cars found</h3>
                <p class="text-gray-500 mb-4">Try adjusting your filters or search criteria.</p>
                <a href="{{ url_for('car.home') }}" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-search mr-2"></i> Search Again
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Pagination (Placeholder) -->
    <!--
    <div class="pagination flex justify-center mt-6 gap-2">
        <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">1</button>
        <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">2</button>
        <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100">3</button>
        <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
    </div>
    -->
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Simple Sort Dropdown Toggle (Basic Tailwind, no complex JS) ---
    const sortDropdownButton = document.querySelector('.sort-dropdown button');
    const sortDropdownContent = document.querySelector('.sort-dropdown-content');

    if (sortDropdownButton && sortDropdownContent) {
        sortDropdownButton.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            sortDropdownContent.classList.toggle('hidden');
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', function(e) {
            if (!sortDropdownButton.contains(e.target) && !sortDropdownContent.contains(e.target)) {
                sortDropdownContent.classList.add('hidden');
            }
        });
    }
    // --- End Sort Dropdown ---
});
</script>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\notifications\list.html ---



--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\profile\edit.html ---
<!-- templates/user/profile/edit.html -->
{% extends "user/base.html" %}

{% block title %}Edit Profile - {{ user.username }}{% endblock %}
{% block page_title %}Edit Profile{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-user-edit"></i> Update Your Information</h4>
            </div>
            <div class="card-body">
                <!-- Use the form object passed from the route -->
                <form method="POST">
                    <!-- FlaskForm automatically renders the hidden CSRF token -->
                    {{ form.hidden_tag() }} <!-- Renders csrf_token and any hidden fields -->

                    <!-- Username -->
                    <div class="mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control") }}
                        {% if form.username.errors %}
                            <div class="text-danger">
                                {% for error in form.username.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control") }}
                        {% if form.email.errors %}
                            <div class="text-danger">
                                {% for error in form.email.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Phone -->
                    <div class="mb-3">
                        {{ form.phone.label(class="form-label") }}
                        {{ form.phone(class="form-control") }}
                        {% if form.phone.errors %}
                            <div class="text-danger">
                                {% for error in form.phone.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>

                <!-- Cancel Button -->
                <div class="d-grid mt-2">
                    <a href="{{ url_for('user.profile') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\profile\view.html ---
<!-- templates/user/profile/view.html -->
{% extends "user/base.html" %}

{% block title %}My Profile - {{ user.username }}{% endblock %}
{% block page_title %}My Profile{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-user"></i> Profile Information</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Username:</strong> {{ user.username }}</p>
                        <p><strong>Email:</strong> {{ user.email }}</p>
                        <p><strong>Phone:</strong> {{ user.phone or 'Not provided' }}</p>
                        <p><strong>Wallet Balance:</strong> ₹{{ "%.2f"|format(user.wallet_balance) }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Member Since:</strong> {{ user.created_at.strftime('%Y-%m-%d') }}</p>
                        <p><strong>Status:</strong>
                            <span class="badge bg-{% if user.is_active %}success{% else %}secondary{% endif %}">
                                {% if user.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </p>
                        {% if user.is_admin %}
                        <p><strong>Role:</strong> <span class="badge bg-danger">Administrator</span></p>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{{ url_for('user.edit_profile') }}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Edit Profile
                    </a>
                    <!-- Add other profile-related actions here if needed -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\wallet\dashboard_widget.html ---
<!-- templates/user/wallet/dashboard_widget.html -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-wallet"></i> My Wallet</h5>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h6 class="text-muted">Balance</h6>
                <h3 class="mb-0 text-primary">₹{{ "%.2f"|format(wallet_balance) }}</h3>
            </div>
            <div>
                <a href="{{ url_for('user.wallet') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-history"></i> View History
                </a>
            </div>
        </div>

        {% if recent_transactions %}
        <h6 class="text-muted mb-2">Recent Transactions</h6>
        <ul class="list-group list-group-flush">
            {% for transaction in recent_transactions %}
            <li class="list-group-item px-0 py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-medium">{{ transaction.description[:30] }}{% if transaction.description|length > 30 %}...{% endif %}</span>
                        <br>
                        <small class="text-muted">{{ transaction.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    <div class="text-end">
                        <span class="fw-medium {% if transaction.transaction_type in ['deposit', 'earning', 'refund'] %}text-success{% else %}text-danger{% endif %}">
                            {% if transaction.transaction_type in ['deposit', 'earning', 'refund'] %}+{% else %}-{% endif %}₹{{ "%.2f"|format(transaction.amount) }}
                        </span>
                        <br>
                        <small class="text-muted">Bal: ₹{{ "%.2f"|format(transaction.balance_after) }}</small>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted text-center mb-0">No transactions yet.</p>
        {% endif %}
    </div>
</div>


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\wallet\detail.html ---
<!-- templates/user/wallet/detail.html -->
{% extends "user/base.html" %}

{% block title %}Transaction Details #{{ transaction.id }}{% endblock %}
{% block page_title %}Transaction Details{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-receipt"></i> Transaction #{{ transaction.id }}</h4>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>ID:</strong> {{ transaction.id }}</p>
                        <p><strong>Type:</strong>
                            <span class="badge bg-{% if transaction.transaction_type in ['deposit', 'earning', 'refund', 'bonus'] %}success
                                                {% elif transaction.transaction_type in ['withdrawal', 'deduction', 'penalty'] %}danger
                                                {% else %}secondary{% endif %}">
                                {{ transaction.transaction_type|title }}
                            </span>
                        </p>
                        <p><strong>Amount:</strong>
                            <span class="{% if transaction.transaction_type in ['deposit', 'earning', 'refund', 'bonus'] %}text-success fw-bold
                                        {% elif transaction.transaction_type in ['withdrawal', 'deduction', 'penalty'] %}text-danger fw-bold{% endif %}">
                                {% if transaction.transaction_type in ['deposit', 'earning', 'refund', 'bonus'] %}+
                                {% elif transaction.transaction_type in ['withdrawal', 'deduction', 'penalty'] %}-{% endif %}
                                ₹{{ "%.2f"|format(transaction.amount) }}
                            </span>
                        </p>
                        <p><strong>Balance After:</strong> ₹{{ "%.2f"|format(transaction.balance_after) }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Date & Time:</strong> {{ transaction.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        <p><strong>Description:</strong> {{ transaction.description }}</p>
                        {% if transaction.reference_type %}
                        <p><strong>Reference Type:</strong> {{ transaction.reference_type|title }}</p>
                        {% endif %}
                        {% if transaction.reference_id %}
                        <p><strong>Reference ID:</strong> {{ transaction.reference_id }}</p>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <!-- Related Object Details (if applicable) -->
                {% if related_object %}
                <h5>Related Information</h5>
                {% if transaction.reference_type == 'booking' or transaction.reference_type == 'host_earning' or transaction.reference_type == 'booking_payment' or transaction.reference_type == 'booking_refund' or transaction.reference_type == 'cancellation_fee' %}
                <!-- Display Booking Details -->
                <div class="mb-3">
                    <h6><i class="fas fa-car"></i> Booking #{{ related_object.id }}</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Car:</strong> {{ related_object.car.make }} {{ related_object.car.model }}</li>
                        <li class="list-group-item"><strong>Start Date:</strong> {{ related_object.start_date.strftime('%Y-%m-%d %H:%M') }}</li>
                        <li class="list-group-item"><strong>End Date:</strong> {{ related_object.end_date.strftime('%Y-%m-%d %H:%M') }}</li>
                        <li class="list-group-item"><strong>Total Price:</strong> ₹{{ "%.2f"|format(related_object.total_price) }}</li>
                        <li class="list-group-item"><strong>Status:</strong> {{ related_object.status|title }}</li>
                        <!-- Add more booking details as needed -->
                    </ul>
                    <a href="{{ url_for('user.booking_detail', booking_id=related_object.id) }}" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="fas fa-eye"></i> View Booking Details
                    </a>
                </div>
                {% elif transaction.reference_type == 'admin_adjustment' %}
                 <!-- Display Admin Adjustment Details (if you store admin info) -->
                 <p><strong>Adjusted by Admin:</strong> (Details would be fetched if stored)</p>
                 <p><strong>Reason:</strong> {{ transaction.description.split(': ', 1)[1] if ': ' in transaction.description else transaction.description }}</p> <!-- Extract reason after colon -->
                {% endif %}
                {% else %}
                <p class="text-muted">No specific related object found or type not handled.</p>
                {% endif %}
                <!-- End Related Object Details -->

                <hr>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('user.wallet') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Wallet
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\templates\user\wallet\list.html ---
<!-- templates/user/wallet/list.html -->
{% extends "user/base.html" %}

{% block title %}My Wallet{% endblock %}
{% block page_title %}My Wallet{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wallet"></i> Wallet Balance</h5>
            </div>
            <div class="card-body text-center">
                <h2 class="display-4 text-primary">₹{{ "%.2f"|format(wallet_balance) }}</h2>
                <p class="text-muted">Current Balance</p>
                <!-- Placeholder for Deposit/Withdrawal buttons -->
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-outline-success btn-sm disabled" title="Feature coming soon">
                        <i class="fas fa-plus-circle"></i> Add Money
                    </button>
                    <button class="btn btn-outline-danger btn-sm disabled" title="Feature coming soon">
                        <i class="fas fa-minus-circle"></i> Withdraw Money
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Transaction History</h5>
            </div>
            <div class="card-body">
                {% if transactions %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th class="text-end">Amount (₹)</th>
                                <th class="text-end">Balance (₹)</th>
                                <th>Actions</th> <!-- Column for View Details link -->
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>{{ transaction.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <span class="badge bg-{% if transaction.transaction_type in ['deposit', 'earning', 'refund', 'bonus'] %}success
                                                        {% elif transaction.transaction_type in ['withdrawal', 'deduction', 'penalty'] %}danger
                                                        {% else %}secondary{% endif %}">
                                        {{ transaction.transaction_type|title }}
                                    </span>
                                </td>
                                <td>{{ transaction.description }}</td>
                                <td class="text-end">
                                    <span class="{% if transaction.transaction_type in ['deposit', 'earning', 'refund', 'bonus'] %}text-success fw-bold
                                                {% elif transaction.transaction_type in ['withdrawal', 'deduction', 'penalty'] %}text-danger fw-bold{% endif %}">
                                        {% if transaction.transaction_type in ['deposit', 'earning', 'refund', 'bonus'] %}+
                                        {% elif transaction.transaction_type in ['withdrawal', 'deduction', 'penalty'] %}-{% endif %}
                                        {{ "%.2f"|format(transaction.amount) }}
                                    </span>
                                </td>
                                <td class="text-end">{{ "%.2f"|format(transaction.balance_after) }}</td>
                                <td>
                                    <a href="{{ url_for('user.wallet_transaction_detail', transaction_id=transaction.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if transactions_pagination.pages > 1 %}
                <nav aria-label="Transactions pagination">
                    <ul class="pagination justify-content-center">
                        {% if transactions_pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('user.wallet', page=transactions_pagination.prev_num) }}">Previous</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">Previous</span></li>
                        {% endif %}

                        {% for page_num in transactions_pagination.iter_pages() %}
                        {% if page_num %}
                        {% if page_num != transactions_pagination.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('user.wallet', page=page_num) }}">{{ page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                        {% endif %}
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                        {% endif %}
                        {% endfor %}

                        {% if transactions_pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('user.wallet', page=transactions_pagination.next_num) }}">Next</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">Next</span></li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                <!-- End Pagination -->

                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                    <h5>No transactions found</h5>
                    <p class="text-muted">Your wallet transaction history will appear here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Optional: Summary Card or Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Wallet Information</h5>
            </div>
            <div class="card-body">
                <p>Your wallet balance reflects all deposits, withdrawals, earnings, and deductions.</p>
                <p>Click "View" on any transaction to see detailed information.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\utils\date_utils.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\utils\distance_calculator.py ---
from math import radians, sin, cos, sqrt, atan2


def calculate_distance(lat1, lon1, lat2, lon2):
    """Calculate distance between two points using Haversine formula"""
    R = 6371  # Earth's radius in kilometers

    dlat = radians(lat2 - lat1)
    dlon = radians(lon2 - lon1)

    a = sin(dlat / 2) ** 2 + cos(radians(lat1)) * cos(radians(lat2)) * sin(dlon / 2) ** 2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))

    distance = R * c
    return round(distance, 2)

--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\utils\notification_sender.py ---
# utils/notification_sender.py
import os
from twilio.rest import Client
from flask import current_app


def get_twilio_client():
    """
    Initializes and returns the Twilio client.
    Uses credentials from environment variables.
    """
    # --- CRITICAL FIX: Use os.getenv instead of current_app.config.get for env vars ---
    # BEFORE (Incorrect for env vars):
    # TWILIO_ACCOUNT_SID = current_app.config.get('TWILIO_ACCOUNT_SID')
    # TWILIO_AUTH_TOKEN = current_app.config.get('TWILIO_AUTH_TOKEN')
    # AFTER (Correct for env vars):
    TWILIO_ACCOUNT_SID = os.getenv('TWILIO_ACCOUNT_SID')
    TWILIO_AUTH_TOKEN = os.getenv('TWILIO_AUTH_TOKEN')
    # --- END CRITICAL FIX ---

    if TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN:
        try:
            client = Client(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)
            return client
        except Exception as e:
            print(f"Error initializing Twilio client: {e}")
            return None
    else:
        print("Twilio credentials (TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN) not found in environment variables (.env).")
        return None


def send_whatsapp_notification(to_phone_number, message_body):
    """
    Sends a WhatsApp message using Twilio.

    Args:
        to_phone_number (str): Recipient's phone number in E.164 format (e.g., '+919876543210').
                               The number must be verified in Twilio Sandbox if using trial.
        message_body (str): The text content of the message.

    Returns:
        bool: True if the message was sent successfully, False otherwise.
    """
    # --- CRITICAL FIX: Use os.getenv instead of current_app.config.get for env vars ---
    # BEFORE (Incorrect for env vars):
    # TWILIO_WHATSAPP_NUMBER = current_app.config.get('TWILIO_WHATSAPP_NUMBER')
    # AFTER (Correct for env vars):
    TWILIO_WHATSAPP_NUMBER = os.getenv('TWILIO_WHATSAPP_NUMBER')
    # --- END CRITICAL FIX ---

    if not TWILIO_WHATSAPP_NUMBER:
        print("Twilio WhatsApp number (TWILIO_WHATSAPP_NUMBER) not found in environment variables.")
        return False

    client = get_twilio_client()
    if not client:
        return False

    try:
        # The 'to' number must also be prefixed with 'whatsapp:'
        message = client.messages.create(
            body=message_body,
            from_=TWILIO_WHATSAPP_NUMBER,  # Twilio's WhatsApp-enabled number
            to=f'whatsapp:{to_phone_number}'  # Recipient's number with 'whatsapp:' prefix
        )
        print(f"WhatsApp message sent successfully. SID: {message.sid}")
        return True
    except Exception as e:
        print(f"Error sending WhatsApp notification: {e}")
        # Log the specific Twilio error for debugging
        if hasattr(e, 'code'):
            print(f"Twilio Error Code: {e.code}")
        if hasattr(e, 'msg'):
            print(f"Twilio Error Message: {e.msg}")
        return False

# Example usage (if run directly, for testing):
# if __name__ == "__main__":
#     # Ensure .env is loaded if running standalone
#     # from dotenv import load_dotenv
#     # load_dotenv()
#     success = send_whatsapp_notification(
#         '+919876543210', # Replace with a verified number in Twilio Sandbox
#         'Hello from ZoomCar Clone! This is a test notification.'
#     )
#     if success:
#         print("Test message sent!")
#     else:
#         print("Failed to send test message.")


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\utils\timezone.py ---
# utils/timezone.py
import pytz
from datetime import datetime

# Define commonly used timezones
UTC_TZ = pytz.utc
IST_TZ = pytz.timezone('Asia/Kolkata')

def utc_to_ist(utc_dt):
    """
    Convert a UTC datetime object to IST.
    Args:
        utc_dt (datetime): A timezone-aware datetime object in UTC.
    Returns:
        datetime: A timezone-aware datetime object in IST.
    """
    if utc_dt.tzinfo is None:
        # If naive, assume it's UTC
        utc_dt = UTC_TZ.localize(utc_dt)
    return utc_dt.astimezone(IST_TZ)

def ist_to_utc(ist_dt):
    """
    Convert an IST datetime object to UTC.
    Args:
        ist_dt (datetime): A timezone-aware datetime object in IST.
    Returns:
        datetime: A timezone-aware datetime object in UTC.
    """
    if ist_dt.tzinfo is None:
        # If naive, assume it's IST
        ist_dt = IST_TZ.localize(ist_dt)
    return ist_dt.astimezone(UTC_TZ)

def get_current_ist_time():
    """
    Get the current time in IST.
    Returns:
        datetime: A timezone-aware datetime object representing the current time in IST.
    """
    utc_now = datetime.utcnow()
    utc_now_with_tz = UTC_TZ.localize(utc_now)
    return utc_to_ist(utc_now_with_tz)

# --- CRITICAL FIX: Helper to convert DB UTC datetime to IST ---
def db_utc_to_ist(db_utc_dt):
    """
    Safely convert a datetime object retrieved from the database (assumed UTC)
    to IST. Handles naive datetimes.
    Args:
        db_utc_dt (datetime): A datetime object from the database (treated as UTC).
    Returns:
        datetime: A timezone-aware datetime object in IST.
    """
    if db_utc_dt.tzinfo is None:
        # If naive datetime from DB, localize it as UTC first
        db_utc_dt = UTC_TZ.localize(db_utc_dt)
    # Now convert the UTC datetime to IST
    return utc_to_ist(db_utc_dt)
# --- END CRITICAL FIX ---



--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\utils\validators.py ---


--- File: C:\Users\Ananda M\PycharmProjects\FCars version\working payment gateway FCars\FCars\utils\__init__.py ---

