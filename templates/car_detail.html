<!-- templates/car_detail.html -->
{% extends "base.html" %} <!-- Or your main base template -->

{% block title %}{{ car.make }} {{ car.model }} - ZoomCar Clone{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="bg-white border rounded-2xl overflow-hidden shadow-sm">
        <!-- Car Images Carousel -->
        <div class="relative h-64 md:h-80 w-full overflow-hidden">
            {% if car.images %}
                <div id="carImageCarousel" class="carousel slide relative h-full w-full" data-bs-ride="carousel">
                    <div class="carousel-inner h-full w-full">
                        {% for image in car.images %}
                        <div class="carousel-item h-full w-full {% if loop.first %}active{% endif %}">
                            <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                 class="d-block w-full h-full object-cover car-image transition-transform duration-500"
                                 alt="{{ car.make }} {{ car.model }} Image {{ loop.index }}">
                        </div>
                        {% endfor %}
                    </div>
                    {% if car.images|length > 1 %}
                    <button class="carousel-control-prev absolute top-1/2 left-0 transform -translate-y-1/2 z-10 p-2 text-white bg-black/30 rounded-e-lg" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon inline-block" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next absolute top-1/2 right-0 transform -translate-y-1/2 z-10 p-2 text-white bg-black/30 rounded-s-lg" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon inline-block" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
            {% else %}
                <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center">
                    <i class="fas fa-car text-gray-400 text-4xl"></i>
                </div>
            {% endif %}
            {% if car.badge %}
            <div class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">
                {{ car.badge }}
            </div>
            {% endif %}
        </div>

        <div class="p-6">
            <!-- Car Title & Details -->
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 leading-tight">{{ car.make }} {{ car.model }} ({{ car.year }})</h1>
                    <p class="text-sm text-gray-600 mt-1">{{ car.transmission }} • {{ car.fuel_type }} • {{ car.seats }} seats</p>
                </div>
                <div class="flex flex-col items-end">
                    <!-- --- UPDATED: Pricing Display (Hour-based) --- -->
                    <div class="text-2xl md:text-3xl font-bold text-gray-900">₹{{ "%.2f"|format(car.price_per_hour) }}</div>
                    <div class="text-sm text-gray-500">/ hour</div>
                    <!-- --- END UPDATED: Pricing Display (Hour-based) --- -->
                    {% if car.display_distance_km is defined %}
                    <div class="text-xs text-gray-500 mt-1">{{ car.display_distance_km }} km away</div>
                    {% endif %}
                </div>
            </div>

            <!-- Location & Host Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-primary"></i> Pickup Location
                    </h3>
                    <p class="text-sm">
                        <!-- FIXED: Access location details directly from car object -->
                        {% if car.full_address %}
                            {{ car.full_address }}
                        {% else %}
                            {% if car.street_address %}{{ car.street_address }}, {% endif %}
                            {% if car.locality %}{{ car.locality }}, {% endif %}
                            {% if car.city %}{{ car.city }}{% endif %}
                            {% if car.pincode %} - {{ car.pincode }}{% endif %}
                        {% endif %}
                    </p>
                    {% if car.latitude and car.longitude %}
                    <div class="mt-2 text-xs text-gray-500">
                        Coordinates: {{ "%.6f"|format(car.latitude) }}, {{ "%.6f"|format(car.longitude) }}
                    </div>
                    {% endif %}
                </div>
                <div class="border rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-user-tie text-primary"></i> Hosted By
                    </h3>
                    <p class="text-sm font-medium">{{ car.host.company_name or car.host.user.username }}</p>
                    <p class="text-xs text-gray-500 mt-1">Verified Host</p>
                    <!-- Placeholder for Host Rating -->
                    <div class="flex items-center gap-1 text-sm mt-2">
                        <i class="fas fa-star text-yellow-400"></i>
                        <span class="font-semibold">4.7</span>
                        <span class="text-gray-500">(89 reviews)</span>
                    </div>
                </div>
            </div>

            <!-- Car Specifications -->
            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-info-circle text-primary"></i> Specifications
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div>
                        <span class="font-medium">Make:</span> {{ car.make }}
                    </div>
                    <div>
                        <span class="font-medium">Model:</span> {{ car.model }}
                    </div>
                    <div>
                        <span class="font-medium">Year:</span> {{ car.year }}
                    </div>
                    <div>
                        <span class="font-medium">Color:</span> {{ car.color or 'N/A' }}
                    </div>
                    <div>
                        <span class="font-medium">Mileage:</span> {{ car.mileage or 'N/A' }} km
                    </div>
                    <div>
                        <span class="font-medium">Fuel Type:</span> {{ car.fuel_type }}
                    </div>
                    <div>
                        <span class="font-medium">Transmission:</span> {{ car.transmission }}
                    </div>
                    <div>
                        <span class="font-medium">Seating:</span> {{ car.seats }} seats
                    </div>
                </div>
            </div>

            <!-- Features -->
            {% if car.has_ac or car.has_bluetooth or car.has_sunroof or car.has_gps or car.has_usb_port or car.has_reverse_camera %}
            <div class="border rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-star text-primary"></i> Features
                </h3>
                <div class="flex flex-wrap gap-2">
                    {% if car.has_ac %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">AC</span>{% endif %}
                    {% if car.has_bluetooth %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">Bluetooth</span>{% endif %}
                    {% if car.has_sunroof %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">Sunroof</span>{% endif %}
                    {% if car.has_gps %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">GPS</span>{% endif %}
                    {% if car.has_usb_port %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">USB Port</span>{% endif %}
                    {% if car.has_reverse_camera %}<span class="px-3 py-1.5 rounded-full border text-xs bg-emerald-50 text-emerald-700 border-emerald-200">Reverse Camera</span>{% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Booking Form -->
            <div class="border rounded-xl p-4 bg-blue-50">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-primary"></i> Book This Car
                </h3>

                {% if current_user.is_authenticated %}
                <!-- CRITICAL FIX 2: Corrected the form action URL -->
                <form id="bookingForm" method="POST" action="{{ url_for('booking.initiate_booking', car_id=car.id) }}">
                     <!-- CRITICAL FIX: Manually Add CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- END CRITICAL FIX -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- --- UPDATED: Input Type to datetime-local (Hour-based) --- -->
                        <div>
                            <label for="start_datetime" class="block text-sm font-medium text-gray-700 mb-1">Start Date & Time</label>
                            <input type="datetime-local" id="start_datetime" name="start_datetime"
                                   class="w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                   min="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}"
                                   value="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}" required>
                        </div>
                        <div>
                            <label for="end_datetime" class="block text-sm font-medium text-gray-700 mb-1">End Date & Time</label>
                            <input type="datetime-local" id="end_datetime" name="end_datetime"
                                   class="w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                   min="{{ default_start_datetime.strftime('%Y-%m-%dT%H:%M') if default_start_datetime else '' }}"
                                   value="{{ default_end_datetime.strftime('%Y-%m-%dT%H:%M') if default_end_datetime else '' }}" required>
                        </div>
                        <!-- --- END UPDATED: Input Type to datetime-local (Hour-based) --- -->
                    </div>

                    <div class="mb-4">
                        <!-- --- UPDATED: Labels and Calculation Logic (Hour-based) --- -->
                        <div class="flex justify-between items-center text-sm">
                            <span>Duration (Hours):</span>
                            <span id="numHours">0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-1">
                            <span>Price per Hour:</span>
                            <span>₹{{ "%.2f"|format(car.price_per_hour) }}</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between items-center font-semibold text-base">
                            <span>Total Cost:</span>
                            <span id="totalCost">₹0.00</span>
                        </div>
                        <!-- --- END UPDATED: Labels and Calculation Logic (Hour-based) --- -->
                    </div>

                    <button type="submit" class="w-full bg-primary text-white rounded-xl px-4 py-3 font-medium hover:bg-blue-600 transition-colors">
                        <i class="fas fa-credit-card mr-2"></i> Proceed to Payment
                    </button>
                    <a href="{{ url_for('booking.show_booking_initiation', car_id=car.id) }}" class="btn btn-primary">
                        <i class="fas fa-calendar-plus"></i> Book Now
                    </a>
                </form>
                {% else %}
                <div class="text-center py-4">
                    <p class="text-gray-600 mb-3">Please login to book this car.</p>
                    <a href="{{ url_for('auth.login') }}" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i> Login to Book
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- UPDATED: Variable Names and Input IDs (Hour-based) ---
    const startDateTimeInput = document.getElementById('start_datetime');
    const endDateTimeInput = document.getElementById('end_datetime');
    const numHoursSpan = document.getElementById('numHours'); // Changed ID
    const totalCostSpan = document.getElementById('totalCost');
    const pricePerHour = {{ car.price_per_hour }}; // Use price_per_hour
    // --- END UPDATED: Variable Names and Input IDs (Hour-based) ---

    function updateBookingDetails() {
        // --- UPDATED: Get datetime values (Hour-based) ---
        const startDateTimeStr = startDateTimeInput.value;
        const endDateTimeStr = endDateTimeInput.value;

        if (startDateTimeStr && endDateTimeStr) {
            const startDateTime = new Date(startDateTimeStr);
            const endDateTime = new Date(endDateTimeStr);

            if (endDateTime >= startDateTime) {
                const timeDiff = endDateTime.getTime() - startDateTime.getTime();
                const hoursDiff = timeDiff / (1000 * 3600); // Convert milliseconds to hours
                const numHours = hoursDiff > 0 ? hoursDiff : 0.01; // Minimum e.g., 0.01 hours (36 seconds)

                numHoursSpan.textContent = numHours.toFixed(2); // Display with 2 decimal places
                const totalCost = numHours * pricePerHour;
                totalCostSpan.textContent = `₹${totalCost.toFixed(2)}`; // Display with 2 decimal places
            } else {
                numHoursSpan.textContent = 'Invalid';
                totalCostSpan.textContent = 'Invalid';
            }
        } else {
             numHoursSpan.textContent = '0.00'; // Reset if inputs are empty
             totalCostSpan.textContent = '₹0.00';
        }
    }

    if (startDateTimeInput && endDateTimeInput) {
        startDateTimeInput.addEventListener('change', updateBookingDetails);
        endDateTimeInput.addEventListener('change', updateBookingDetails);
        // Initialize on load
        updateBookingDetails();
    }

    // Set minimum datetime for end datetime based on start datetime
    if (startDateTimeInput) {
        startDateTimeInput.addEventListener('change', function() {
            if (endDateTimeInput) {
                endDateTimeInput.min = this.value; // Set minimum to start datetime
                // If end datetime is before new start datetime, reset it
                if (new Date(endDateTimeInput.value) < new Date(this.value)) {
                    endDateTimeInput.value = this.value;
                }
                updateBookingDetails();
            }
        });
    }
});
</script>
{% endblock %}