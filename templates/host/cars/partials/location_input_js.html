<!-- templates/host/cars/partials/location_input_js.html -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- CRITICAL FIX 1: Correct Element Selection ---
    // Use the exact IDs defined in the HTML
    const addressInput = document.getElementById('addressInput');
    const suggestionsList = document.getElementById('suggestionsList');
    const useCurrentLocationBtn = document.getElementById('useCurrentLocationBtn'); // Updated ID
    const resetLocationBtn = document.getElementById('resetLocationBtn'); // Updated ID
    const locationValidationMessage = document.getElementById('locationValidationMessage');

    // Hidden coordinate fields
    const selectedLat = document.getElementById('selected_lat');
    const selectedLng = document.getElementById('selected_lng');

    // Structured address fields
    const streetAddressInput = document.getElementById('street_address');
    const localityInput = document.getElementById('locality');
    const cityInput = document.getElementById('city');
    const stateInput = document.getElementById('state');
    const pincodeInput = document.getElementById('pincode');
    const fullAddressInput = document.getElementById('full_address');
    // --- CRITICAL FIX 1 END ---

    let debounceTimer;

    // --- Address Suggestion Logic ---
    if (addressInput && suggestionsList) {
        addressInput.addEventListener('input', function() {
            const query = this.value.trim();
            suggestionsList.innerHTML = '';
            suggestionsList.style.display = 'none';

            if (query.length < 3) {
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                // --- CRITICAL FIX 2: Correct AJAX URL ---
                // Ensure this points to your actual suggestion endpoint
                fetch(`/suggest?q=${encodeURIComponent(query)}`)
                // --- CRITICAL FIX 2 END ---
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        suggestionsList.innerHTML = '';
                        if (data.error) {
                             suggestionsList.innerHTML = `<li class="list-group-item text-danger"><i class="fas fa-exclamation-triangle"></i> ${data.error}</li>`;
                             suggestionsList.style.display = 'block';
                             return;
                        }
                        if (data.length === 0) {
                            suggestionsList.innerHTML = '<li class="list-group-item text-muted">No suggestions found.</li>';
                            suggestionsList.style.display = 'block';
                            return;
                        }
                        data.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item list-group-item-action';
                            li.textContent = item.display_name;

                            // --- CRITICAL FIX 3: Store Nominatim data correctly ---
                            // Use dataset attributes to store all relevant Nominatim data
                            li.dataset.lat = item.lat;
                            li.dataset.lon = item.lon;
                            // Map Nominatim keys to potential fields
                            li.dataset.road = item.road || item.pedestrian || '';
                            li.dataset.houseNumber = item.house_number || '';
                            li.dataset.postcode = item.postcode || '';
                            li.dataset.city = item.city || item.town || item.village || '';
                            li.dataset.state = item.state || '';
                            li.dataset.locality = item.locality || item.suburb || item.neighbourhood || item.hamlet || '';
                            // --- CRITICAL FIX 3 END ---

                            li.addEventListener('click', function() {
                                // --- CRITICAL FIX 4: Correctly fill fields on selection ---
                                selectSuggestedAddress(this);
                                // --- CRITICAL FIX 4 END ---
                            });
                            suggestionsList.appendChild(li);
                        });
                        suggestionsList.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Suggestion error:', error);
                        suggestionsList.innerHTML = '<li class="list-group-item text-danger"><i class="fas fa-exclamation-triangle"></i> Failed to fetch suggestions.</li>';
                        suggestionsList.style.display = 'block';
                    });
            }, 300); // Debounce for 300ms
        });

        // Close suggestions if clicked outside
        document.addEventListener('click', function(e) {
            if (!addressInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.style.display = 'none';
            }
        });
    }

    // --- Function to Fill Fields from Suggestion ---
    function selectSuggestedAddress(listItem) {
        // --- CRITICAL FIX 5: Get data from dataset correctly ---
        const displayName = listItem.textContent;
        const lat = listItem.dataset.lat;
        const lon = listItem.dataset.lon;
        const road = listItem.dataset.road;
        const houseNumber = listItem.dataset.houseNumber;
        const postcode = listItem.dataset.postcode;
        const city = listItem.dataset.city;
        const state = listItem.dataset.state;
        const locality = listItem.dataset.locality;
        // --- CRITICAL FIX 5 END ---

        // --- CRITICAL FIX 6: Fill ALL relevant fields ---
        // Fill hidden coordinate fields
        if (selectedLat) selectedLat.value = lat;
        if (selectedLng) selectedLng.value = lon;

        // Fill structured address fields
        if (streetAddressInput) streetAddressInput.value = `${houseNumber} ${road}`.trim();
        if (localityInput) localityInput.value = locality;
        if (cityInput) cityInput.value = city;
        if (stateInput) stateInput.value = state;
        if (pincodeInput) pincodeInput.value = postcode;

        // Construct and fill full address
        const parts = [
            houseNumber, road, locality, city, state, postcode
        ].filter(part => part); // Remove empty/undefined parts
        const fullAddr = parts.join(', ');
        if (fullAddressInput) fullAddressInput.value = fullAddr;

        // Update main input field to show selected address
        if (addressInput) addressInput.value = displayName;

        // Hide suggestions list
        if (suggestionsList) suggestionsList.style.display = 'none';

        // Hide validation message on successful selection
        if (locationValidationMessage) locationValidationMessage.style.display = 'none';
        // --- CRITICAL FIX 6 END ---
    }
    // --- End Function ---

    // --- Use Current Location Logic ---
    if (useCurrentLocationBtn) {
        useCurrentLocationBtn.addEventListener('click', function() {
            const $btn = $(this); // Using jQuery for consistency if available
            // Disable button and show loading state
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Detecting...');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    function(position) {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);

                        // --- CRITICAL FIX 7: Fill hidden coordinate fields ---
                        if (selectedLat) selectedLat.value = lat;
                        if (selectedLng) selectedLng.value = lng;
                        // --- CRITICAL FIX 7 END ---

                        // --- CRITICAL FIX 8: Provide feedback for detected location ---
                        // Since we only have coordinates, we can't auto-fill structured fields
                        // You could use Reverse Geocoding here (see note below)
                        const detectedMsg = `Detected coordinates: Lat ${lat}, Lng ${lng}. Please verify or enter address manually.`;
                        if (addressInput) addressInput.value = detectedMsg; // Show in main input
                        if (fullAddressInput) fullAddressInput.value = detectedMsg; // Show in full address
                        // Clear structured fields as they are unknown from coordinates alone
                        if (streetAddressInput) streetAddressInput.value = '';
                        if (localityInput) localityInput.value = '';
                        if (cityInput) cityInput.value = '';
                        if (stateInput) stateInput.value = '';
                        if (pincodeInput) pincodeInput.value = '';
                        // --- CRITICAL FIX 8 END ---

                        // Hide validation message
                        if (locationValidationMessage) locationValidationMessage.style.display = 'none';

                        // Re-enable button
                        $btn.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Use My Location');
                    },
                    // Error callback
                    function(error) {
                        let errorMsg = 'Unable to retrieve your location.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMsg = 'Location access denied by user.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg = 'Location information is unavailable.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMsg = 'The request to get user location timed out.';
                        }
                        // Show error in main input or a dedicated status area
                        if (addressInput) addressInput.value = `Error: ${errorMsg}`;
                        console.error("Geolocation error:", error);

                        // Show validation message for error
                        if (locationValidationMessage) {
                            locationValidationMessage.textContent = errorMsg;
                            locationValidationMessage.style.display = 'block';
                        }

                        // Re-enable button
                        $btn.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Use My Location');
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    }
                );
            } else {
                // Show error if geolocation not supported
                if (addressInput) addressInput.value = 'Error: Geolocation is not supported by this browser.';
                console.error("Geolocation not supported");

                // Show validation message
                if (locationValidationMessage) {
                    locationValidationMessage.textContent = 'Geolocation is not supported by this browser.';
                    locationValidationMessage.style.display = 'block';
                }

                // Re-enable button
                $btn.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Use My Location');
            }
        });
    }
    // --- End Use Current Location ---

    // --- Reset Location Logic ---
    if (resetLocationBtn) {
        resetLocationBtn.addEventListener('click', function() {
            // --- CRITICAL FIX 9: Clear ALL location-related input fields ---
            if (addressInput) addressInput.value = '';
            if (selectedLat) selectedLat.value = '';
            if (selectedLng) selectedLng.value = '';
            if (streetAddressInput) streetAddressInput.value = '';
            if (localityInput) localityInput.value = '';
            if (cityInput) cityInput.value = '';
            if (stateInput) stateInput.value = '';
            if (pincodeInput) pincodeInput.value = '';
            if (fullAddressInput) fullAddressInput.value = '';
            if (suggestionsList) {
                suggestionsList.innerHTML = '';
                suggestionsList.style.display = 'none';
            }
            if (locationValidationMessage) locationValidationMessage.style.display = 'none';
            // --- CRITICAL FIX 9 END ---
        });
    }
    // --- End Reset Location ---

    // --- Form Submission Validation (if needed directly in JS) ---
    // This is handled by the backend route now, but can be added for immediate feedback
    // const addCarForm = document.getElementById('addCarForm'); // Ensure this ID exists on your form
    // if (addCarForm) {
    //     addCarForm.addEventListener('submit', function(e) {
    //         const lat = selectedLat ? selectedLat.value.trim() : '';
    //         const lng = selectedLng ? selectedLng.value.trim() : '';
    //         const city = cityInput ? cityInput.value.trim() : '';
    //         const state = stateInput ? stateInput.value.trim() : '';
    //
    //         if (!lat || !lng || isNaN(parseFloat(lat)) || isNaN(parseFloat(lng)) || !city || !state) {
    //              e.preventDefault();
    //              if (locationValidationMessage) {
    //                  locationValidationMessage.textContent = 'Please select an address or use your current location.';
    //                  locationValidationMessage.style.display = 'block';
    //              }
    //              // Scroll to the location section for visibility
    //              document.querySelector('label[for="addressInput"]').scrollIntoView({ behavior: 'smooth' });
    //              return false;
    //         }
    //         // If validation passes, form submits normally
    //         if (locationValidationMessage) locationValidationMessage.style.display = 'none';
    //     });
    // }
    // --- End Form Submission Validation ---
});
</script>
