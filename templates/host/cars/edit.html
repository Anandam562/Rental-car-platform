<!-- templates/host/cars/edit.html -->
{% extends "host/base.html" %}

{% block title %}Edit Car{% endblock %}
{% block page_title %}Edit Car: {{ car.make }} {{ car.model }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="editCarForm">
                    <!-- Car Details Section -->
                     <!-- Add the CSRF token field provided by Flask-WTF -->
                    {{ form.csrf_token }} <!-- This renders the hidden input -->
                    <!-- END CRITICAL FIX -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make" class="form-label">Make *</label>
                            <input type="text" class="form-control" id="make" name="make" value="{{ car.make }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">Model *</label>
                            <input type="text" class="form-control" id="model" name="model" value="{{ car.model }}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="year" class="form-label">Year *</label>
                            <input type="number" class="form-control" id="year" name="year" min="1900" max="2030" value="{{ car.year }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="price_per_day" class="form-label">Price per Day (â‚¹) *</label>
                            <input type="number" class="form-control" id="price_per_day" name="price_per_day" step="0.01" min="0" value="{{ "%.2f"|format(car.price_per_day) }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color" name="color" value="{{ car.color or '' }}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="mileage" class="form-label">Mileage (km)</label>
                            <input type="number" class="form-control" id="mileage" name="mileage" min="0" value="{{ car.mileage or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fuel_type" class="form-label">Fuel Type *</label>
                            <select class="form-select" id="fuel_type" name="fuel_type" required>
                                <option value="">Select Fuel Type</option>
                                <option value="Petrol" {% if car.fuel_type == 'Petrol' %}selected{% endif %}>Petrol</option>
                                <option value="Diesel" {% if car.fuel_type == 'Diesel' %}selected{% endif %}>Diesel</option>
                                <option value="Electric" {% if car.fuel_type == 'Electric' %}selected{% endif %}>Electric</option>
                                <option value="CNG" {% if car.fuel_type == 'CNG' %}selected{% endif %}>CNG</option>
                                <option value="Hybrid" {% if car.fuel_type == 'Hybrid' %}selected{% endif %}>Hybrid</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="transmission" class="form-label">Transmission *</label>
                            <select class="form-select" id="transmission" name="transmission" required>
                                <option value="">Select Transmission</option>
                                <option value="Manual" {% if car.transmission == 'Manual' %}selected{% endif %}>Manual</option>
                                <option value="Automatic" {% if car.transmission == 'Automatic' %}selected{% endif %}>Automatic</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="seats" class="form-label">Seats *</label>
                            <input type="number" class="form-control" id="seats" name="seats" min="1" max="20" value="{{ car.seats }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                             <!-- Placeholder for future use or alignment -->
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="is_available" class="form-label">Availability</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="is_available" name="is_available" {% if car.is_available %}checked{% endif %}>
                                <label class="form-check-label" for="is_available">
                                    Available for booking
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- End Car Details Section -->

                    <!-- UPDATED LOCATION DETAILS SECTION -->
                    {% include 'host/cars/partials/location_input_section.html' %}
                    <!-- END UPDATED LOCATION DETAILS SECTION -->

                    <div class="mb-3">
                        <label for="images" class="form-label">Add More Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">Select new images to add. To remove existing images, use the 'Manage Images' section below.</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('host.list_cars') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Update Car</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images"></i> Manage Existing Images</h5>
            </div>
            <div class="card-body">
                {% if car.images %}
                    <div class="row g-2">
                        {% for image in car.images %}
                        <div class="col-6 col-md-4 position-relative">
                            <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                 class="img-fluid rounded" alt="Car Image">
                            <a href="{{ url_for('host.delete_car_image', image_id=image.id) }}"
                               class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                               onclick="return confirm('Delete this image?')">
                                <i class="fas fa-times"></i>
                            </a>
                            {% if image.is_primary %}
                            <span class="badge bg-success position-absolute bottom-0 start-0 m-1">Primary</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No images uploaded yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Tips</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Keep car details accurate</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Update availability status</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Add new photos if needed</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Review pricing regularly</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Ensure location is up-to-date</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Pre-populate location fields on page load for edit form
document.addEventListener('DOMContentLoaded', function() {
    // --- Pre-populate Location Fields for Editing ---
    // Get existing car location data (passed from the backend route)
    // This assumes your route passes the car object correctly
    const carData = {
        latitude: {{ car.latitude|tojson }},
        longitude: {{ car.longitude|tojson }},
        full_address: {{ car.full_address|tojson }},
        street_address: {{ car.street_address|tojson }},
        locality: {{ car.locality|tojson }},
        city: {{ car.city|tojson }},
        state: {{ car.state|tojson }},
        pincode: {{ car.pincode|tojson }}
    };

    if (carData.latitude && carData.longitude) {
        document.getElementById('latitude').value = carData.latitude;
        document.getElementById('longitude').value = carData.longitude;
        // Set hidden final coordinates
        document.getElementById('final_lat').value = carData.latitude;
        document.getElementById('final_lng').value = carData.longitude;

        // Populate address fields if data exists
        if (carData.full_address) {
            document.getElementById('full_address').value = carData.full_address;
        }
        if (carData.street_address) {
            document.getElementById('street_address').value = carData.street_address;
        }
        if (carData.locality) {
            document.getElementById('locality').value = carData.locality;
        }
        if (carData.city) {
            document.getElementById('city').value = carData.city;
        }
        if (carData.state) {
            document.getElementById('state').value = carData.state;
        }
        if (carData.pincode) {
            document.getElementById('pincode').value = carData.pincode;
        }

        // Indicate that location data is pre-loaded
        document.getElementById('locationStatus').innerHTML = '<span class="text-success"><i class="fas fa-check"></i> Location loaded from car data.</span>';
    }
    // --- End Pre-population ---
});
</script>
<!-- Include the shared location input JavaScript -->
{% include 'host/cars/partials/location_input_js.html' %}
{% endblock %}
